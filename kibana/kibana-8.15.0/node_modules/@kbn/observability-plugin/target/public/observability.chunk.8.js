/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.observability_bundle_jsonpfunction=window.observability_bundle_jsonpfunction||[]).push([[8,10,12],{107:function(e,t,a){"use strict";a.r(t),a.d(t,"WithKueryAutocompletion",(function(){return s}));var r=a(9),l=a.n(r),i=a(2),o=a.n(i),n=a(18);class WithKueryAutocompletionComponent extends o.a.Component{constructor(...e){super(...e),l()(this,"state",{currentRequest:null,suggestions:[]}),l()(this,"loadSuggestions",(async(e,t,a,r)=>{const{indexPattern:l}=this.props,i="kuery";if(!this.props.kibana.services.unifiedSearch.autocomplete.hasQuerySuggestions(i))return;this.setState({currentRequest:{expression:e,cursorPosition:t},suggestions:[]});const o=await this.props.kibana.services.unifiedSearch.autocomplete.getQuerySuggestions({language:i,query:e,selectionStart:t,selectionEnd:t,indexPatterns:[l],boolFilter:[]})||[],n=r?r(o):o;this.setState((r=>r.currentRequest&&r.currentRequest.expression!==e&&r.currentRequest.cursorPosition!==t?r:{...r,currentRequest:null,suggestions:a?n.slice(0,a):n}))}))}render(){const{currentRequest:e,suggestions:t}=this.state;return this.props.children({isLoadingSuggestions:null!==e,loadSuggestions:this.loadSuggestions,suggestions:t})}}const s=Object(n.withKibana)(WithKueryAutocompletionComponent);t.default=s},150:function(e,t,a){"use strict";a.r(t),a.d(t,"RuleFlyoutKueryBar",(function(){return u}));var r=a(25),l=a(2),i=a.n(l),o=a(39),n=a(107),s=a(109);function u({derivedIndexPattern:e,onSubmit:t,onChange:a,value:u,placeholder:d,curryLoadSuggestions:m=c,compressed:p}){const[g,h]=Object(l.useState)(u||""),[b,E]=Object(l.useState)(!0);Object(l.useEffect)((()=>{u&&h(u)}),[u]);const{euiTheme:y}=Object(o.useEuiTheme)(),v=e=>{E(function(e){try{Object(r.fromKueryExpression)(e)}catch(e){return!1}return!0}(e)),h(e),a&&a(e)},f={...e,fields:e.fields};return i.a.createElement(n.WithKueryAutocompletion,{indexPattern:f},(({isLoadingSuggestions:e,loadSuggestions:a,suggestions:r})=>i.a.createElement(s.AutocompleteField,{compressed:p,"aria-label":d,isLoadingSuggestions:e,isValid:b,loadSuggestions:m(a),onChange:v,onSubmit:t,placeholder:d,suggestions:r,value:g,theme:y})))}const c=e=>(...t)=>e(...t);t.default=u},196:function(e,t,a){"use strict";a.r(t),a.d(t,"defaultExpression",(function(){return $})),a.d(t,"default",(function(){return X}));var r=a(2),l=a.n(r),i=a(13),o=a(39),n=a(86),s=a(1),u=a(40),c=a(72),d=a(29),m=a(28),p=a(98),g=a(48);const h=(e,t)=>{const a=t?new RegExp(/0?\./):".",r=String(e).replace(a,"").length;return parseFloat((t?100*e:e/100).toPrecision(r))},b=e=>h(e,!0),E=e=>h(e,!1),y=(e,t,a)=>{const r=Boolean(e.every((e=>{var t;return null===(t=e.field)||void 0===t?void 0:t.endsWith(".pct")}))),l=Boolean(t.every((e=>{var t;return null===(t=e.field)||void 0===t?void 0:t.endsWith(".pct")})));return l===r?a:l?a.map((e=>E(e))):r?a.map((e=>b(e))):a};var v=a(69),f=a.n(v),x=a(150);function T({children:e,onClose:t}){return l.a.createElement(o.EuiPopoverTitle,null,l.a.createElement(o.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},l.a.createElement(o.EuiFlexItem,null,e),l.a.createElement(o.EuiFlexItem,{grow:!1},l.a.createElement(o.EuiButtonIcon,{"data-test-subj":"o11yClosablePopoverTitleButton",iconType:"cross",color:"danger","aria-label":s.i18n.translate("xpack.observability.thresholdRule.closablePopoverTitle.closeLabel",{defaultMessage:"Close"}),onClick:()=>t()}))))}const C=s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.equationHelpMessage",{defaultMessage:"Supports basic math equations, valid charaters are: A-Z, +, -, /, *, (, ), ?, !, &, :, |, >, <, ="}),F=s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.labelLabel",{defaultMessage:"Label (optional)"}),O=s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.labelHelpMessage",{defaultMessage:"Custom label will show on the alert chart and in reason"}),S=s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquation",{defaultMessage:"Custom equation"}),k=s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.deleteRowButton",{defaultMessage:"Delete"});function j({onDelete:e,disableDelete:t}){return l.a.createElement(q,{"data-test-subj":"o11yMetricRowControlsButton","aria-label":k,iconType:"cross",color:"text",onClick:e,disabled:t,title:k,size:"xs"})}var q=f()(o.EuiButtonIcon).withConfig({displayName:"_StyledEuiButtonIcon",componentId:"sc-1ia3lqc-0"})({height:16});const w=s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.defaultCountFilterTitle",{defaultMessage:"all documents"});function M({name:e,aggType:t=p.a.COUNT,field:a,onDelete:n,dataView:c,filter:d,disableDelete:m,fields:g,aggregationTypes:h,onChange:b,errors:E}){const y=Object(r.useCallback)((()=>{n(e)}),[e,n]),[v,f]=Object(r.useState)(!1),C=Object(r.useMemo)((()=>g.reduce(((e,a)=>(t&&h[t].validNormalizedTypes.includes(a.normalizedType)&&e.push({label:a.name}),e)),[])),[g,h,t]),F=Object(r.useCallback)((a=>{b({name:e,field:a.length&&a[0].label||void 0,aggType:t})}),[e,t,b]),O=Object(r.useCallback)((t=>{b({name:e,field:t===p.a.COUNT?void 0:a,aggType:t})}),[e,a,b]),S=Object(r.useCallback)((a=>{b({name:e,filter:a,aggType:t})}),[e,t,b]),k=null!=Object(i.get)(E,["metrics",e,"aggType"]),q=null!=Object(i.get)(E,["metrics",e,"field"])||!a;return l.a.createElement(o.EuiFlexGroup,{gutterSize:"xs",alignItems:"flexEnd"},l.a.createElement(o.EuiFlexItem,{grow:!0},l.a.createElement(o.EuiPopover,{button:l.a.createElement(o.EuiFormRow,{fullWidth:!0,label:l.a.createElement(o.EuiFlexGroup,{gutterSize:"s",alignItems:"center"},l.a.createElement(R,{grow:!1},s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.aggregationLabel",{defaultMessage:"Aggregation {name}",values:{name:e}})),!m&&l.a.createElement(o.EuiFlexItem,{grow:!1},l.a.createElement(j,{onDelete:y,disableDelete:m})))},l.a.createElement(o.EuiExpression,{"data-test-subj":"aggregationName",description:h[t].text,value:t===p.a.COUNT?d||w:a,isActive:v,display:"columns",onClick:()=>{f(!0)},isInvalid:t!==p.a.COUNT&&!a})),isOpen:v,closePopover:()=>{f(!1)},display:"block",ownFocus:!0,anchorPosition:"downLeft",repositionOnScroll:!0},l.a.createElement("div",null,l.a.createElement(T,{onClose:()=>f(!1)},l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.aggregationLabel",defaultMessage:"Aggregation {name}",values:{name:e}})),l.a.createElement(o.EuiFlexGroup,{gutterSize:"l",alignItems:"flexEnd"},l.a.createElement(o.EuiFlexItem,{grow:!0},l.a.createElement(o.EuiFormRow,{label:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.aggregationType",{defaultMessage:"Aggregation type"})},l.a.createElement(o.EuiSelect,{"data-test-subj":"aggregationTypeSelect",id:"aggTypeField",value:t,fullWidth:!0,onChange:e=>{O(e.target.value)},options:Object.values(h).map((({text:e,value:t})=>({text:e,value:t}))),isInvalid:k}))),l.a.createElement(o.EuiFlexItem,{style:{minWidth:300}},t===p.a.COUNT?l.a.createElement(o.EuiFormRow,{label:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.filterLabel",{defaultMessage:"KQL Filter {name}",values:{name:e}})},l.a.createElement(x.RuleFlyoutKueryBar,{placeholder:" ",derivedIndexPattern:c,onChange:S,onSubmit:S,value:d})):l.a.createElement(o.EuiFormRow,{label:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.fieldLabel",{defaultMessage:"Field name"})},l.a.createElement(o.EuiComboBox,{fullWidth:!0,isInvalid:q,singleSelection:{asPlainText:!0},options:C,selectedOptions:a?[{label:a}]:[],onChange:F}))))))))}var R=f()(o.EuiFlexItem).withConfig({displayName:"_StyledEuiFlexItem",componentId:"sc-rshk14-0"})({paddingTop:2,paddingBottom:2});const z={name:"A",aggType:p.a.COUNT},B=Object(i.range)(65,91).map((e=>String.fromCharCode(e)));function A({onChange:e,expression:t,fields:a,aggregationTypes:n,errors:c,dataView:d}){var m;const[p,g]=Object(r.useState)(null!==(m=null==t?void 0:t.metrics)&&void 0!==m?m:[z]),[h,b]=Object(r.useState)(!1),[E,v]=Object(r.useState)(null==t?void 0:t.equation),f=Object(r.useMemo)((()=>Object(i.debounce)(e,500)),[e]);Object(r.useEffect)((()=>{var e;g(null!==(e=null==t?void 0:t.metrics)&&void 0!==e?e:[z]),v(null==t?void 0:t.equation)}),[null==t?void 0:t.metrics,null==t?void 0:t.equation]);const x=Object(r.useCallback)((()=>{g((e=>{var a;const r=null!==(a=null==e?void 0:e.map((e=>e.name)))&&void 0!==a?a:[],l=Object(i.first)(Object(i.xor)(B,r)),o=[...e||[],{...z,name:l}];return f({...t,metrics:o,equation:E,threshold:y(e,o,t.threshold)}),o}))}),[f,E,t]),F=Object(r.useCallback)((e=>{g((a=>{var r;const l=null!==(r=null==a?void 0:a.filter((t=>t.name!==e)))&&void 0!==r?r:[z],i=l.length&&l||[z];return f({...t,metrics:i,equation:E,threshold:y(a,l,t.threshold)}),i}))}),[E,t,f]),O=Object(r.useCallback)((e=>{g((a=>{const r=null==a?void 0:a.map((t=>t.name===e.name?e:t));return f({...t,metrics:r,equation:E,threshold:y(a,r,t.threshold)}),r}))}),[E,t,f]),S=Object(r.useCallback)((e=>{v(e.target.value),f({...t,metrics:p,equation:e.target.value})}),[f,t,p]),k=26===(null==p?void 0:p.length),j=1===(null==p?void 0:p.length),q=null==p?void 0:p.map((e=>l.a.createElement(M,{key:e.name,name:e.name,aggType:e.aggType,aggregationTypes:n,field:e.field,filter:e.filter,fields:a,onAdd:x,onDelete:F,disableAdd:k,disableDelete:j,onChange:O,errors:c,dataView:d}))),w=Object(r.useMemo)((()=>null==p?void 0:p.map((e=>e.name)).join(" + ")),[p]);return l.a.createElement("div",{style:{minWidth:"100%"}},l.a.createElement(o.EuiSpacer,{size:"s"}),q,l.a.createElement(o.EuiFlexGroup,null,l.a.createElement(o.EuiButtonEmpty,{"data-test-subj":"thresholdRuleCustomEquationEditorAddAggregationFieldButton",color:"primary",flush:"left",size:"xs",iconType:"plusInCircleFilled",onClick:x,isDisabled:k},l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.addCustomRow",defaultMessage:"Add aggregation/field"}))),l.a.createElement(o.EuiSpacer,{size:"m"}),l.a.createElement(o.EuiFlexItem,null,l.a.createElement(o.EuiPopover,{button:l.a.createElement(o.EuiFormRow,{"data-test-subj":"equationAndThreshold",fullWidth:!0,label:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.equationAndThreshold",{defaultMessage:"Equation and threshold"}),error:[c.equation]},l.a.createElement(l.a.Fragment,null,l.a.createElement(o.EuiSpacer,{size:"xs"}),l.a.createElement(o.EuiExpression,{"data-test-subj":"customEquation",description:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationEditor.equationLabel",{defaultMessage:"Equation"}),value:null!=E?E:w,display:"columns",onClick:()=>{b(!0)},isInvalid:null!=c.equation}))),isOpen:h,closePopover:()=>{b(!1)},display:"block",ownFocus:!0,anchorPosition:"downLeft",repositionOnScroll:!0},l.a.createElement("div",null,l.a.createElement(T,{onClose:()=>b(!1)},l.a.createElement("span",null,l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.customEquationLabel",defaultMessage:"Custom equation"})," ",l.a.createElement(o.EuiIconTip,{content:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.customEquationTooltip",{defaultMessage:"This supports basic math (A + B / C) and boolean logic (A < B ? A : B)."}),position:"top"}))),l.a.createElement(o.EuiFormRow,{fullWidth:!0,helpText:C,isInvalid:null!=c.equation},l.a.createElement(o.EuiFieldText,{"data-test-subj":"thresholdRuleCustomEquationEditorFieldText",isInvalid:null!=c.equation,compressed:!0,fullWidth:!0,placeholder:w,onChange:S,value:null!=E?E:""}))))))}const I=e=>{var t;const{dataView:a,children:n,setRuleParams:u,expression:c,errors:m,expressionId:p,remove:g,fields:h,canDelete:b,title:y}=e,{metrics:v,comparator:f=d.a.GREATER_THAN,threshold:x=[]}=c,T=Object(r.useMemo)((()=>(e=>Boolean(e.every((e=>{var t;return null===(t=e.field)||void 0===t?void 0:t.endsWith(".pct")}))))(v)),[v]),[C,k]=Object(r.useState)((null==c?void 0:c.label)||void 0),j=Object(r.useCallback)((e=>{u(p,{...c,comparator:e})}),[p,c,u]),q=Object(r.useCallback)((e=>T?e.map((e=>E(e))):e),[T]),w=Object(r.useCallback)((e=>{const t=q(e);t.join()!==c.threshold.join()&&u(p,{...c,threshold:t})}),[p,c,q,u]),M=Object(r.useCallback)((e=>{u(p,e)}),[p,u]),R=Object(r.useMemo)((()=>Object(i.debounce)(M,300)),[M]),z=l.a.createElement(D,{comparator:f,threshold:x,updateComparator:j,updateThreshold:w,errors:null!==(t=m.critical)&&void 0!==t?t:{},isMetricPct:T}),B=h.map((e=>({normalizedType:e.type,name:e.name}))),I=Object(r.useCallback)((e=>{k(e.target.value),R({...c,label:e.target.value})}),[R,c]);return l.a.createElement(l.a.Fragment,null,l.a.createElement(o.EuiFlexGroup,{gutterSize:"xs",alignItems:"center"},l.a.createElement(o.EuiFlexItem,{grow:!0},l.a.createElement(o.EuiTitle,{size:"xs"},l.a.createElement("h5",null,y))),b&&l.a.createElement(o.EuiFlexItem,{grow:!1},l.a.createElement(o.EuiButtonIcon,{"data-test-subj":"o11yExpressionRowButton","aria-label":s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.removeCondition",{defaultMessage:"Remove condition"}),color:"text",iconType:"trash",onClick:()=>g(p)}))),l.a.createElement(o.EuiFlexGroup,{gutterSize:"xs"},l.a.createElement(o.EuiFlexItem,{grow:!0},l.a.createElement(l.a.Fragment,null,l.a.createElement(o.EuiSpacer,{size:"xs"}),l.a.createElement(A,{expression:c,fields:B,aggregationTypes:P,onChange:M,errors:m,dataView:a}),z,l.a.createElement(o.EuiSpacer,{size:"s"}),l.a.createElement(o.EuiFlexGroup,null,l.a.createElement(o.EuiFlexItem,null,l.a.createElement(o.EuiFormRow,{label:F,fullWidth:!0,helpText:O},l.a.createElement(o.EuiFieldText,{"data-test-subj":"thresholdRuleCustomEquationEditorFieldText",compressed:!0,fullWidth:!0,value:C,placeholder:S,onChange:I})))),l.a.createElement(o.EuiSpacer,{size:"s"})))),n)},D=({updateComparator:e,updateThreshold:t,threshold:a,isMetricPct:i,comparator:o,errors:n})=>{const s=Object(r.useMemo)((()=>i?a.map((e=>b(e))):a),[a,i]),u=Object(r.useCallback)((()=>o?Object(g.b)(o):d.a.GREATER_THAN),[o]);return l.a.createElement(l.a.Fragment,null,l.a.createElement(c.ThresholdExpression,{thresholdComparator:u(),threshold:s,onChangeSelectedThresholdComparator:e,onChangeSelectedThreshold:t,errors:n,display:"fullWidth",unit:i?"%":""}))},P={avg:{text:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.aggregationText.avg",{defaultMessage:"Average"}),fieldRequired:!0,validNormalizedTypes:["number","histogram"],value:p.a.AVERAGE},max:{text:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.aggregationText.max",{defaultMessage:"Max"}),fieldRequired:!0,validNormalizedTypes:["number","date","histogram"],value:p.a.MAX},min:{text:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.aggregationText.min",{defaultMessage:"Min"}),fieldRequired:!0,validNormalizedTypes:["number","date","histogram"],value:p.a.MIN},cardinality:{text:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.aggregationText.cardinality",{defaultMessage:"Cardinality"}),fieldRequired:!1,value:p.a.CARDINALITY,validNormalizedTypes:["number","string","ip","date"]},count:{text:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.aggregationText.count",{defaultMessage:"Count"}),fieldRequired:!1,value:p.a.COUNT,validNormalizedTypes:["number"]},sum:{text:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.aggregationText.sum",{defaultMessage:"Sum"}),fieldRequired:!1,value:p.a.SUM,validNormalizedTypes:["number","histogram"]},p95:{text:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.aggregationText.p95",{defaultMessage:"95th Percentile"}),fieldRequired:!1,value:p.a.P95,validNormalizedTypes:["number","histogram"]},p99:{text:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.aggregationText.p99",{defaultMessage:"99th Percentile"}),fieldRequired:!1,value:p.a.P99,validNormalizedTypes:["number","histogram"]},rate:{text:s.i18n.translate("xpack.observability..customThreshold.rule.alertFlyout.aggregationText.rate",{defaultMessage:"Rate"}),fieldRequired:!1,value:p.a.RATE,validNormalizedTypes:["number"]}};var N=a(91),L=a.n(N);function W({options:e,onChange:t,fields:a,errorOptions:i,...n}){const u=Object(r.useCallback)((e=>{const a=e.map((e=>e.label));t(a)}),[t]),c=Array.isArray(e.groupBy)?e.groupBy.map((e=>({label:e,color:null!=i&&i.includes(e)?"danger":void 0}))):e.groupBy?[{label:e.groupBy,color:null!=i&&i.includes(e.groupBy)?"danger":void 0}]:[];return l.a.createElement(o.EuiComboBox,L()({"data-test-subj":"thresholdRuleMetricsExplorer-groupBy",placeholder:s.i18n.translate("xpack.observability.threshold.ruleExplorer.groupByLabel",{defaultMessage:"Everything"}),"aria-label":s.i18n.translate("xpack.observability.threshold.ruleExplorer.groupByAriaLabel",{defaultMessage:"Graph per"}),fullWidth:!0,singleSelection:!1,selectedOptions:c,options:a.filter((e=>e.aggregatable&&"string"===e.type)).map((e=>({label:e.name}))),onChange:u,isClearable:!0},n))}var V=a(145),G=a(25);const U={language:"kuery",query:""},Q=s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.searchConfiguration.queryWarning",{defaultMessage:"Custom threshold does not support queries other than Query type, query was changed to default query."}),H=(e,t)=>e.query&&!Object(G.isOfQueryType)(e.query)?(t(Q),_({...e,query:U})):_({...e,query:e.query}),_=e=>{const t=e.filter?e.filter.map((({meta:e,query:t})=>({meta:e,query:t}))):void 0;return{...e,filter:t}},K=500,$={comparator:d.a.GREATER_THAN,metrics:[{name:"A",aggType:p.a.COUNT}],threshold:[100],timeSize:1,timeUnit:"m"};function X(e){var t,a,d;const{setRuleParams:p,ruleParams:g,errors:h,metadata:b,onChangeMetaData:E}=e,{data:y,dataViews:v,dataViewEditor:f,docLinks:x,unifiedSearch:{ui:{SearchBar:T}}}=Object(m.a)().services,[C,F]=Object(r.useState)(1),[O,S]=Object(r.useState)("m"),[k,j]=Object(r.useState)(),[q,w]=Object(r.useState)(),[M,R]=Object(r.useState)(),[z,B]=Object(r.useState)(),[A,D]=Object(r.useState)(),P=Object(r.useMemo)((()=>({fields:(null==k?void 0:k.fields)||[],title:(null==k?void 0:k.getIndexPattern())||"unknown-index"})),[k]);Object(r.useEffect)((()=>{(async()=>{let e=g.searchConfiguration;var t;if(!g.searchConfiguration||!g.searchConfiguration.index)if(null!=b&&null!==(t=b.currentOptions)&&void 0!==t&&t.searchConfiguration){var a,r;e={query:{query:null!==(a=null===(r=g.searchConfiguration)||void 0===r?void 0:r.query)&&void 0!==a?a:"",language:"kuery"},...b.currentOptions.searchConfiguration}}else{const t=y.search.searchSource.createEmpty();t.setField("query",y.query.queryString.getDefaultQuery());const a=await y.dataViews.getDefaultDataView();a&&(t.setField("index",a),j(a)),e=H(t.getSerializedFields(),D)}try{var l;const t=await y.search.searchSource.create(e);if(p("searchConfiguration",H({...e,...(null===(l=g.searchConfiguration)||void 0===l?void 0:l.query)&&{query:g.searchConfiguration.query}},D)),R(t),j(t.getField("index")),t.getField("index")){var i;const e=null===(i=t.getField("index"))||void 0===i?void 0:i.timeFieldName;w(e?void 0:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.dataViewError.noTimestamp",{defaultMessage:"The selected data view does not have a timestamp field, please select another data view."}))}else w(void 0)}catch(e){B(e)}})()}),[y.search.searchSource,y.dataViews,k]),Object(r.useEffect)((()=>{g.criteria&&g.criteria.length?(F(g.criteria[0].timeSize),S(g.criteria[0].timeUnit)):ee(),g.groupBy||te(),void 0===g.alertOnNoData&&p("alertOnNoData",!0),void 0===g.alertOnGroupDisappear&&ae()}),[b]);const N=Object(r.useCallback)((e=>{const t=(g.criteria?g.criteria.slice():[]).map((e=>{var t;return null===(t=e.metrics)||void 0===t||t.forEach((e=>{e.field=void 0})),e}));p("criteria",t),null==M||M.setParent(void 0).setField("index",e),p("searchConfiguration",M&&H(M.getSerializedFields(),D)),j(e)}),[g.criteria,M,p]),L=Object(r.useCallback)(((e,t)=>{const a=g.criteria?g.criteria.slice():[];a[e]=t,p("criteria",a)}),[p,g.criteria]),G=Object(r.useCallback)((()=>{var e;const t=(null===(e=g.criteria)||void 0===e?void 0:e.slice())||[];t.push({...$,timeSize:null!=C?C:$.timeSize,timeUnit:null!=O?O:$.timeUnit}),p("criteria",t)}),[p,g.criteria,C,O]),U=Object(r.useCallback)((e=>{var t;const a=(null===(t=g.criteria)||void 0===t?void 0:t.filter(((t,a)=>a!==e)))||[];p("criteria",a)}),[p,g.criteria]),Q=Object(r.useCallback)((({query:e})=>{D(void 0),p("searchConfiguration",H({...g.searchConfiguration,query:e},D))}),[p,g.searchConfiguration]),_=Object(r.useCallback)(Object(i.debounce)(Q,K),[Q]),X=Object(r.useCallback)((e=>{p("groupBy",e&&e.length?e:"")}),[p]),Y=Object(r.useMemo)((()=>({aggField:[],timeSizeUnit:[],timeWindowSize:[]})),[]),Z=Object(r.useCallback)((e=>{var t;const a=(null===(t=g.criteria)||void 0===t?void 0:t.map((t=>({...t,timeSize:e}))))||[];F(e||void 0),p("criteria",a)}),[g.criteria,p]),J=Object(r.useCallback)((e=>{var t;const a=(null===(t=g.criteria)||void 0===t?void 0:t.map((t=>({...t,timeUnit:e}))))||[];S(e),p("criteria",a)}),[g.criteria,p]),ee=Object(r.useCallback)((()=>{var e,t;const a=b;if(null!=a&&null!==(e=a.currentOptions)&&void 0!==e&&null!==(t=e.criteria)&&void 0!==t&&t.length){const{timeSize:e,timeUnit:t}=a.currentOptions.criteria[0];e&&F(e),t&&S(t),p("criteria",a.currentOptions.criteria.map((e=>({...$,...e}))))}else p("criteria",[$])}),[b,p]),te=Object(r.useCallback)((()=>{var e;const t=b;t&&null!==(e=t.currentOptions)&&void 0!==e&&e.groupBy&&p("groupBy",t.currentOptions.groupBy)}),[b,p]),ae=Object(r.useCallback)((()=>{var e;const t=b;t&&void 0!==(null===(e=t.currentOptions)||void 0===e?void 0:e.alertOnGroupDisappear)?p("alertOnGroupDisappear",t.currentOptions.alertOnGroupDisappear):p("alertOnGroupDisappear",!0)}),[b,p]),re=Object(r.useMemo)((()=>g.groupBy&&g.groupBy.length>0),[g.groupBy]),le=Object(r.useMemo)((()=>g.groupBy?(Array.isArray(g.groupBy)?g.groupBy:[g.groupBy]).map((e=>({groupName:e,pattern:new RegExp(`{"match(_phrase)?":{"${e}":"(.*?)"}}`)}))):null),[g.groupBy]),ie=Object(r.useMemo)((()=>{const{filterQuery:e}=g;return"string"==typeof e&&le?le.map((({groupName:t,pattern:a})=>{if(a.test(e))return t})).filter((e=>"string"==typeof e)):[]}),[g,le]);if(z)return l.a.createElement(l.a.Fragment,null,l.a.createElement(o.EuiCallOut,{color:"danger",iconType:"warning","data-test-subj":"thresholdRuleExpressionError"},l.a.createElement("p",null,z.message)),l.a.createElement(o.EuiSpacer,{size:"m"}));if(!M)return l.a.createElement(l.a.Fragment,null,l.a.createElement(o.EuiEmptyPrompt,{title:l.a.createElement(o.EuiLoadingSpinner,{size:"xl"})}),l.a.createElement(o.EuiSpacer,{size:"m"}));const oe=s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.searchBar.placeholder",{defaultMessage:"Search for observability data… (e.g. host.name:host-1)"});return l.a.createElement(l.a.Fragment,null,!!A&&l.a.createElement(l.a.Fragment,null,l.a.createElement(o.EuiCallOut,{title:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.warning.title",{defaultMessage:"Warning"}),color:"warning",iconType:"warning","data-test-subj":"thresholdRuleExpressionWarning"},A),l.a.createElement(o.EuiSpacer,{size:"s"})),l.a.createElement(o.EuiTitle,{size:"xs"},l.a.createElement("h5",null,l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.selectDataViewPrompt",defaultMessage:"Select a data view"}))),l.a.createElement(o.EuiSpacer,{size:"s"}),l.a.createElement(n.DataViewSelectPopover,{dependencies:{dataViews:v,dataViewEditor:f},dataView:k,metadata:{adHocDataViewList:(null==b?void 0:b.adHocDataViewList)||[]},onSelectDataView:N,onChangeMetaData:({adHocDataViewList:e})=>{E({...b,adHocDataViewList:e})}}),q&&l.a.createElement(o.EuiFormErrorText,{"data-test-subj":"thresholdRuleDataViewErrorNoTimestamp"},q),l.a.createElement(o.EuiSpacer,{size:"l"}),l.a.createElement(o.EuiTitle,{size:"xs"},l.a.createElement("h5",null,l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.defineTextQueryPrompt",defaultMessage:"Define query filter (optional)"}))),l.a.createElement(o.EuiSpacer,{size:"s"}),l.a.createElement(T,{appName:"Custom threshold rule",iconType:"search",placeholder:oe,indexPatterns:k?[k]:void 0,showQueryInput:!0,showQueryMenu:!1,showFilterBar:!(null===(t=g.searchConfiguration)||void 0===t||!t.filter),showDatePicker:!1,showSubmitButton:!1,displayStyle:"inPage",onQueryChange:_,onQuerySubmit:Q,dataTestSubj:"thresholdRuleUnifiedSearchBar",query:null===(a=g.searchConfiguration)||void 0===a?void 0:a.query,filters:null===(d=g.searchConfiguration)||void 0===d?void 0:d.filter,onFiltersUpdated:e=>{p("searchConfiguration",H({...g.searchConfiguration,filter:e},D))}}),h.filterQuery&&l.a.createElement(o.EuiFormErrorText,{"data-test-subj":"thresholdRuleDataViewErrorNoTimestamp"},h.filterQuery),l.a.createElement(o.EuiSpacer,{size:"l"}),g.criteria&&g.criteria.map(((e,t)=>l.a.createElement("div",{key:t},t>0&&l.a.createElement(o.EuiHorizontalRule,{margin:"s"}),l.a.createElement(I,{canDelete:g.criteria&&g.criteria.length>1||!1,fields:P.fields,remove:U,addExpression:G,key:t,expressionId:t,setRuleParams:L,errors:h[t]||Y,expression:e||{},dataView:P,title:1===g.criteria.length?l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.setConditions",defaultMessage:"Set rule conditions"}):l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.condition",defaultMessage:"Condition {conditionNumber}",values:{conditionNumber:t+1}})},l.a.createElement(V.RuleConditionChart,{metricExpression:e,dataView:k,searchConfiguration:g.searchConfiguration,groupBy:g.groupBy,error:h[t]||Y,timeRange:{from:`now-${20*(null!=C?C:1)}${O}`,to:"now"}}))))),l.a.createElement(c.ForLastExpression,{timeWindowSize:C,timeWindowUnit:O,errors:Y,onChangeWindowSize:Z,onChangeWindowUnit:J,display:"fullWidth"}),l.a.createElement(o.EuiSpacer,{size:"m"}),l.a.createElement("div",null,l.a.createElement(o.EuiButtonEmpty,{"data-test-subj":"thresholdRuleExpressionsAddConditionButton",color:"primary",iconSide:"left",flush:"left",iconType:"plusInCircleFilled",onClick:G},l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.addCondition",defaultMessage:"Add condition"}))),l.a.createElement(o.EuiSpacer,{size:"m"}),l.a.createElement(o.EuiFormRow,{label:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.createAlertPerText",{defaultMessage:"Group alerts by (optional)"}),helpText:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.createAlertPerHelpText",{defaultMessage:'Create an alert for every unique value. For example: "host.id" or "cloud.region".'}),fullWidth:!0,display:"rowCompressed"},l.a.createElement(W,{onChange:X,fields:P.fields,options:{groupBy:g.groupBy||null},errorOptions:ie})),ie.length>0&&l.a.createElement(l.a.Fragment,null,l.a.createElement(o.EuiSpacer,{size:"s"}),l.a.createElement(o.EuiText,{size:"xs",color:"danger"},l.a.createElement(u.FormattedMessage,{id:"xpack.observability.customThreshold.rule.alertFlyout.alertPerRedundantFilterError",defaultMessage:"This rule may alert on {matchedGroups} less than expected, because the filter query contains a match for {groupCount, plural, one {this field} other {these fields}}. For more information, refer to {filteringAndGroupingLink}.",values:{matchedGroups:l.a.createElement("strong",null,ie.join(", ")),groupCount:ie.length,filteringAndGroupingLink:l.a.createElement(o.EuiLink,{"data-test-subj":"thresholdRuleExpressionsTheDocsLink",href:`${x.links.observability.metricsThreshold}#filtering-and-grouping`},s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.alertPerRedundantFilterError.docsLink",{defaultMessage:"the docs"}))}}))),l.a.createElement(o.EuiSpacer,{size:"s"}),l.a.createElement(o.EuiCheckbox,{id:"metrics-alert-group-disappear-toggle",label:l.a.createElement(l.a.Fragment,null,s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.alertOnGroupDisappear",{defaultMessage:"Alert me if a group stops reporting data"})," ",l.a.createElement(o.EuiIconTip,{type:"questionInCircle",color:"subdued",content:s.i18n.translate("xpack.observability.customThreshold.rule.alertFlyout.groupDisappearHelpText",{defaultMessage:"Enable this to trigger the action if a previously detected group begins to report no results. This is not recommended for dynamically scaling infrastructures that may rapidly start and stop nodes automatically."})})),disabled:!re,checked:Boolean(re&&g.alertOnGroupDisappear),onChange:e=>p("alertOnGroupDisappear",e.target.checked)}),l.a.createElement(o.EuiSpacer,{size:"m"}))}}}]);