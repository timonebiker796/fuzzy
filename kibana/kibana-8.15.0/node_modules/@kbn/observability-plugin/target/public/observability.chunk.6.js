/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.observability_bundle_jsonpfunction=window.observability_bundle_jsonpfunction||[]).push([[6],{108:function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));const i=e=>Number(e).toLocaleString("en",{maximumFractionDigits:1});let r=function(e){return e.bytesDecimal="bytesDecimal",e.bitsDecimal="bitsDecimal",e.abbreviatedNumber="abbreviatedNumber",e}({});const n={[r.bytesDecimal]:["B","kB","MB","GB","TB","PB","EB","ZB","YB"],[r.bitsDecimal]:["bit","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],[r.abbreviatedNumber]:["","K","M","B","T"]},s={[r.bytesDecimal]:1e3,[r.bitsDecimal]:1e3,[r.abbreviatedNumber]:1e3},o=e=>t=>{const a=n[e],o=s[e],l=e===r.bitsDecimal?8*t:t,c=Math.min(Math.floor(Math.log(Math.abs(l))/Math.log(o)),a.length-1);return c<0?`${i(l)} ${a[0]}`:`${i(l/Math.pow(o,c))} ${a[c]}`},l={number:i,abbreviatedNumber:o(r.abbreviatedNumber),bytes:o(r.bytesDecimal),bits:o(r.bitsDecimal),percent:e=>`${i(100*e)}%`,highPrecision:e=>Number(e).toLocaleString("en",{maximumFractionDigits:5})},c=(e,t="{{value}}")=>a=>{if(null==a)return"";const i=(0,l[e])(Number(a));return t.replace(/{{value}}/g,i)}},112:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=a(2),r="undefined"!=typeof window?i.useLayoutEffect:i.useEffect;t.default=r},113:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));var i=a(1),r=a(108);const n=(e,t="")=>{const a=i.i18n.translate("xpack.observability.customThreshold.rule.alerting.noDataFormattedValue",{defaultMessage:"[NO DATA]"});let n=Object(r.a)("highPrecision");return t.endsWith(".pct")&&(n=Object(r.a)("percent")),t.endsWith(".bytes")&&(n=Object(r.a)("bytes")),null==e?a:n(e)}},187:function(e,t,a){e.exports=a(60)(71)},197:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return Y}));var i=a(187),r=a.n(i),n=a(1),s=a(2),o=a.n(s),l=a(39),c=a(51),u=a(0),d=a(90),m=a(5),h=a.n(m),b=a(30),g=a(21),f=a(16),p=a(97),v=a.n(p),y=a(28);const E=()=>{var e;const{licensing:t}=Object(y.a)().services,a=v()(null!==(e=null==t?void 0:t.license$)&&void 0!==e?e:new f.Observable,null);return{getLicense:()=>a,hasAtLeast:Object(s.useCallback)((e=>{if(a)return!!a&&a.isAvailable&&a.isActive&&a.hasAtLeast(e)}),[a])}};var w=a(113),O=a(70);function j({chartProps:{theme:e,baseTheme:t},comparator:a,id:i,threshold:r,title:s,value:c,valueFormatter:u}){const d=Object(l.useEuiBackgroundColor)("danger");return o.a.createElement(l.EuiPanel,{paddingSize:"none",style:{height:"100%",overflow:"hidden",position:"relative",minWidth:"100%"},hasShadow:!1,"data-test-subj":`thresholdRule-${r.join("-")}-${c}`},o.a.createElement(O.Chart,null,o.a.createElement(O.Settings,{theme:e,baseTheme:t,locale:n.i18n.getLocale()}),o.a.createElement(O.Metric,{id:i,data:[[{title:s,extra:o.a.createElement("span",null,n.i18n.translate("xpack.observability.customThreshold.rule.thresholdExtraTitle",{values:{comparator:a,threshold:r.map((e=>u(e))).join(" - ")},defaultMessage:"Alert when {comparator} {threshold}"})),color:d,value:c,valueFormatter:u,icon:({width:e,height:t,color:a})=>o.a.createElement(l.EuiIcon,{width:e,height:t,color:a,type:"alert"})}]]})))}var A=a(13);const T={SPIKE:"spike",DIP:"dip"};var S=a(88),x=a(40);let D=function(e){return e.color0="color0",e.color1="color1",e.color2="color2",e.color3="color3",e.color4="color4",e.color5="color5",e.color6="color6",e.color7="color7",e.color8="color8",e.color9="color9",e}({});const F=Object(l.euiPaletteColorBlind)(),k={[D.color0]:F[1],[D.color1]:F[2],[D.color2]:F[0],[D.color3]:F[3],[D.color4]:F[4],[D.color5]:F[5],[D.color6]:F[6],[D.color7]:F[7],[D.color8]:F[8],[D.color9]:F[9]},$=(M=k,e=>M[e]);var M,C=a(98),_=a(46);const I=(e,t)=>{let a="";const i=1===e.length&&"count"===e[0].aggType&&e[0].filter;return t&&i?a=`(${t}) and (${e[0].filter})`:i?a=`(${e[0].filter})`:t&&(a=`(${t})`),a},B=(e,t)=>{if(1!==t.criteria.length||1!==t.criteria[0].metrics.length||t.criteria[0].metrics[0].aggType!==C.a.COUNT)return;const a=Object(A.get)(e,'fields["kibana.alert.group"]'),i=Object(A.get)(t.searchConfiguration,"query.query"),r=Object(g.a)(a);return Object(_.a)({kuery:I(t.criteria[0].metrics,i),filters:r})},L=({alertStart:e,intervalFactor:t,alertEnd:a})=>a?e.clone().add(15*t,"minutes").isAfter(a)?a.clone().add(1*t,"minutes"):e.clone().add(15*t,"minutes"):e.clone().add(15*t,"minutes").isAfter(h()(new Date))?h()(new Date):e.clone().add(15*t,"minutes"),P=({alertStart:e,intervalFactor:t,alertEnd:a})=>a?e.clone().add(10*t,"minutes").isAfter(a)?a.clone().subtract(1*t,"minutes").valueOf():e.clone().add(10*t,"minutes").valueOf():e.clone().add(10*t,"minutes").isAfter(h()(new Date))?h()(new Date).valueOf():e.clone().add(10*t,"minutes").valueOf(),R=e=>{const{alertStart:t,intervalFactor:a}=e;return{baselineMin:t.clone().subtract(13*a,"minutes").valueOf(),baselineMax:t.clone().subtract(2*a,"minutes").valueOf(),deviationMin:t.clone().subtract(1*a,"minutes").valueOf(),deviationMax:P(e)}};function V({alert:e,dataView:t,rule:a,services:i}){var r,c;const{observabilityAIAssistant:{ObservabilityAIAssistantContextualInsight:d,getContextualInsightMessages:m}}=i,[b,g]=Object(s.useState)(),[f,p]=Object(s.useState)();Object(s.useEffect)((()=>{const t=B(e,a.params);t&&g(t)}),[e,a.params]);const v=null!==(r=a.params.criteria[0])&&void 0!==r&&r.timeSize&&null!==(c=a.params.criteria[0])&&void 0!==c&&c.timeUnit?h.a.duration(a.params.criteria[0].timeSize,a.params.criteria[0].timeUnit):h.a.duration(1,"m"),y=Math.max(1,v.asSeconds()/60),E=h()(e.start),w=e.fields[u.e]?h()(e.fields[u.e]):void 0,O={min:E.clone().subtract(15*y,"minutes"),max:L({alertStart:E,intervalFactor:y,alertEnd:w})},j=n.i18n.translate("xpack.observability.customThreshold.alertDetails.logRateAnalysisTitle",{defaultMessage:"Possible causes and remediations"}),F=Object(s.useMemo)((()=>{var e;if(!(f&&(null===(e=f.significantFieldValues)||void 0===e?void 0:e.length)>0))return;const{logRateAnalysisType:t}=f,a=f.significantFieldValues.map((e=>Object.values(e).join(","))).join("\n"),i=`You are an observability expert using Elastic Observability Suite on call being consulted about a log threshold alert that got triggered by a ${t} in log messages. Your job is to take immediate action and proceed with both urgency and precision.\n      "Log Rate Analysis" is an AIOps feature that uses advanced statistical methods to identify reasons for increases and decreases in log rates. It makes it easy to find and investigate causes of unusual spikes or dips by using the analysis workflow view.\n      You are using "Log Rate Analysis" and ran the statistical analysis on the log messages which occured during the alert.\n      You received the following analysis results from "Log Rate Analysis" which list statistically significant co-occuring field/value combinations sorted from most significant (lower p-values) to least significant (higher p-values) that ${t===T.SPIKE?"contribute to the log rate spike":"are less or not present in the log rate dip"}:\n\n      ${t===T.SPIKE?'The median log rate in the selected deviation time range is higher than the baseline. Therefore, the results shows statistically significant items within the deviation time range that are contributors to the spike. The "doc count" column refers to the amount of documents in the deviation time range.':'The median log rate in the selected deviation time range is lower than the baseline. Therefore, the analysis results table shows statistically significant items within the baseline time range that are less in number or missing within the deviation time range. The "doc count" column refers to the amount of documents in the baseline time range.'}\n\n      Field name,Field value,Doc count,p-value\n      ${a}\n\n      Based on the above analysis results and your observability expert knowledge, output the following:\n      Analyse the type of these logs and explain their usual purpose (1 paragraph).\n      ${t===T.SPIKE?"Based on the type of these logs do a root cause analysis on why the field and value combinations from the analysis results are causing this log rate spike (2 parapraphs)":"Based on the type of these logs explain why the statistically significant field and value combinations are less in number or missing from the log rate dip with concrete examples based on the analysis results data which contains items that are present in the baseline time range and are missing or less in number in the deviation time range (2 paragraphs)"}.\n      ${t===T.SPIKE?"Recommend concrete remediations to resolve the root cause (3 bullet points).":""}\n\n      Do not mention individual p-values from the analysis results.\n      Do not repeat the full list of field names and field values back to the user.\n      Do not guess, just say what you are sure of. Do not repeat the given instructions in your output.`;return m({message:"Can you identify possible causes and remediations for these log rate analysis results",instructions:i})}),[f,m]);return t&&b?o.a.createElement(l.EuiPanel,{hasBorder:!0,"data-test-subj":"logRateAnalysisAlertDetails"},o.a.createElement(l.EuiFlexGroup,{direction:"column",gutterSize:"none",responsive:!1},o.a.createElement(l.EuiFlexItem,{grow:!1},o.a.createElement(l.EuiTitle,{size:"xs"},o.a.createElement("h2",null,o.a.createElement(x.FormattedMessage,{id:"xpack.observability.customThreshold.alertDetails.logRateAnalysis.sectionTitle",defaultMessage:"Log Rate Analysis"})))),o.a.createElement(l.EuiFlexItem,null,o.a.createElement(S.LogRateAnalysisContent,{embeddingOrigin:"observability_log_threshold_alert_details",dataView:t,timeRange:O,esSearchQuery:b,initialAnalysisStart:R({alertStart:E,intervalFactor:y,alertEnd:w}),barColorOverride:$(D.color0),barHighlightColorOverride:$(D.color1),onAnalysisCompleted:e=>{var t;const a=Object(A.orderBy)(null==e||null===(t=e.significantItems)||void 0===t?void 0:t.map((e=>({field:e.fieldName,value:e.fieldValue,docCount:e.doc_count,pValue:e.pValue}))),["pValue","docCount"],["asc","asc"]).slice(0,50),i=null==e?void 0:e.analysisType;p(a&&i?{logRateAnalysisType:i,significantFieldValues:a}:void 0)},appDependencies:Object(A.pick)(i,["analytics","application","data","executionContext","charts","fieldFormats","http","notifications","share","storage","uiSettings","unifiedSearch","theme","lens","i18n"])}))),o.a.createElement(l.EuiFlexGroup,{direction:"column",gutterSize:"m"},d&&F?o.a.createElement(l.EuiFlexItem,{grow:!1},o.a.createElement(d,{title:j,messages:F})):null)):null}var N=a(145),z=a(55);const G=n.i18n.translate("xpack.observability.customThreshold.alertChartTitle",{defaultMessage:"Equation result for "}),K=(e,t=120)=>{const a={};e.metrics.forEach((e=>a[e.name]=`${e.aggType} (${e.field?e.field:e.filter?e.filter:"all documents"})`));let i=e.equation?e.equation:e.metrics.map((e=>e.name)).join(" + ");Object.keys(a).sort().reverse().forEach((e=>{i=i.replaceAll(e,a[e])}));const r=i.length>t?`${i.substring(0,t)}...`:i;return{tooltip:`${G}${i}`,title:`${G}${r}`}};function Y({alert:e,rule:t,setAlertSummaryFields:a}){const i=Object(y.a)().services,{charts:m,data:f,share:{url:{locators:p}}}=i,{hasAtLeast:v}=E(),{euiTheme:O}=Object(l.useEuiTheme)(),A=v("platinum"),[T,S]=Object(s.useState)(),[,x]=Object(s.useState)(),[D,F]=Object(s.useState)(),[k,$]=Object(s.useState)({from:"now-15m",to:"now"}),M=t.params,C={baseTheme:m.theme.useChartsBaseTheme()},_=e.fields[u.A],I=e.fields[u.e],B=e.fields[d.e],L=[];M.criteria.forEach((e=>{L.push(K(e))}));const P={label:"Alert",type:"manual",key:{type:"point_in_time",timestamp:_},color:O.colors.danger,icon:"alert",id:"custom_threshold_alert_start_annotation"},R={label:I?"Alert duration":"Active alert",type:"manual",key:{type:"range",timestamp:_,endTimestamp:null!=I?I:h()().toISOString()},color:r()(Object(l.transparentize)("#F04E981A",.2)).hex().toUpperCase(),id:`custom_threshold_${I?"recovered":"active"}_alert_range_annotation`},G=[];return G.push(P,R),Object(s.useEffect)((()=>{$(Object(c.a)(_,I))}),[_,I]),Object(s.useEffect)((()=>{var e;const t=Object(z.a)({dataViewId:null==T?void 0:T.id,groups:B,logsExplorerLocator:p.get(b.a),metrics:null===(e=M.criteria[0])||void 0===e?void 0:e.metrics,searchConfiguration:M.searchConfiguration,startedAt:_,endedAt:I});F(t)}),[T,_,I,B,M,p]),Object(s.useEffect)((()=>{const e=[];e.push({label:n.i18n.translate("xpack.observability.customThreshold.rule.alertDetailsAppSection.summaryField.relatedLogs",{defaultMessage:"Related logs"}),value:o.a.createElement("span",null,o.a.createElement(l.EuiLink,{"data-test-subj":"o11yCustomThresholdAlertDetailsViewRelatedLogs",href:D},n.i18n.translate("xpack.observability.alertDetailsAppSection.a.viewRelatedLogsLabel",{defaultMessage:"View related logs"})))}),a(e)}),[D,a]),Object(s.useEffect)((()=>{(async()=>{const e=M.searchConfiguration;try{const t=await f.search.searchSource.create(e);S(t.getField("index"))}catch(e){x(e)}})()}),[f.search.searchSource]),M.criteria?o.a.createElement(l.EuiFlexGroup,{direction:"column","data-test-subj":"thresholdAlertOverviewSection"},M.criteria.map(((t,a)=>o.a.createElement(l.EuiFlexItem,{key:`criterion-${a}`},o.a.createElement(l.EuiPanel,{hasBorder:!0,hasShadow:!1},o.a.createElement(l.EuiToolTip,{content:L[a].tooltip},o.a.createElement(l.EuiTitle,{size:"xs"},o.a.createElement("h4",{"data-test-subj":`chartTitle-${a}`},L[a].title))),o.a.createElement(l.EuiSpacer,{size:"m"}),o.a.createElement(l.EuiFlexGroup,null,o.a.createElement(l.EuiFlexItem,{style:{minHeight:150,minWidth:160},grow:1},o.a.createElement(j,{chartProps:C,id:`threshold-${a}`,threshold:t.threshold,value:e.fields[d.d][a],valueFormatter:e=>Object(w.a)(e,t.metrics[0]?t.metrics[0].name:void 0),title:n.i18n.translate("xpack.observability.customThreshold.rule.alertDetailsAppSection.thresholdTitle",{defaultMessage:"Threshold breached"}),comparator:t.comparator})),o.a.createElement(l.EuiFlexItem,{grow:5},o.a.createElement(N.RuleConditionChart,{additionalFilters:Object(g.a)(B),annotations:G,chartOptions:{seriesType:"bar_stacked"},dataView:T,groupBy:M.groupBy,metricExpression:t,searchConfiguration:M.searchConfiguration,timeRange:k}))))))),A&&o.a.createElement(V,{alert:e,dataView:T,rule:t,services:i})):null}},97:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=a(61),r=a(2),n=i.__importDefault(a(112));t.default=function(e,t){var a=r.useState(t),i=a[0],s=a[1];return n.default((function(){var t=e.subscribe(s);return function(){return t.unsubscribe()}}),[e]),i}}}]);