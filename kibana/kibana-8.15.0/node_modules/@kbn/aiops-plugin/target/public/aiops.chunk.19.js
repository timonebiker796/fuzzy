/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.aiops_bundle_jsonpfunction=window.aiops_bundle_jsonpfunction||[]).push([[19],{128:function(e,t,n){"use strict";async function i(e){const{http:t,path:n,signal:i,...a}=e;return await t.fetch({path:n,method:"POST",body:JSON.stringify(a),version:"1",...i?{signal:i}:{}})}n.d(t,"a",(function(){return i}))},271:function(e,t,n){"use strict";n.r(t),n.d(t,"LogCategorizationWrapper",(function(){return X}));var i=n(1),a=n.n(i),o=n(100),l=n(61),s=n(13),r=n(18),u=n(20),c=n(58),d=n(43),b=n(0),m=n(2),g=n(12),j=n(15),p=n(277),O=n(54),x=n(90),f=n(101),v=n(50),S=n(84),y=n(79),h=n(120),E=n(119),C=n(103),F=n(133),T=n(104),w=n(122),M=n(128),R=n(17),k=n.n(R);const I={"No minimum":{factor:0,unit:"w"},"1 week":{factor:1,unit:"w"},"1 month":{factor:1,unit:"M"},"3 months":{factor:3,unit:"M"},"6 months":{factor:6,unit:"M"}};var z=n(132),q=n(121),P=n(14),A=n(155);const D=Object.keys(I).map((e=>({inputDisplay:e,value:e})));var _={name:"1y0ex1",styles:"max-width:400px"},N={name:"1rey5vk",styles:"text-wrap:nowrap"};const L=({randomSampler:e,minimumTimeRangeOption:t,setMinimumTimeRangeOption:n,categoryCount:o,reload:l})=>{const[s,r]=Object(i.useState)(!1),u=()=>r(!s),c=Object(b.jsx)(m.EuiToolTip,{content:g.i18n.translate("xpack.aiops.logCategorization.embeddableMenu.tooltip",{defaultMessage:"Options"})},Object(b.jsx)(m.EuiButtonIcon,{"data-test-subj":"aiopsEmbeddableMenuOptionsButton",size:"s",iconType:"controlsHorizontal",onClick:()=>u(),color:"subdued","aria-label":g.i18n.translate("xpack.aiops.logCategorization.embeddableMenu.aria",{defaultMessage:"Pattern analysis options"})}));return Object(b.jsx)(m.EuiPopover,{id:"embeddableMenu",button:c,isOpen:s,closePopover:()=>u(),panelPaddingSize:"s",anchorPosition:"downRight"},Object(b.jsx)(m.EuiPanel,{color:"transparent",paddingSize:"s",css:_},Object(b.jsx)(m.EuiTitle,{size:"xxxs"},Object(b.jsx)(m.EuiPopoverTitle,null,Object(b.jsx)(P.FormattedMessage,{id:"xpack.aiops.logCategorization.embeddableMenu.patternAnalysisSettingsTitle",defaultMessage:" Pattern analysis settings"}))),Object(b.jsx)(m.EuiSpacer,{size:"s"}),Object(b.jsx)(m.EuiFormRow,{"data-test-subj":"aiopsRandomSamplerOptionsFormRow",label:Object(b.jsx)(m.EuiFlexGroup,{gutterSize:"s",responsive:!1},Object(b.jsx)(m.EuiFlexItem,{css:N},g.i18n.translate("xpack.aiops.logCategorization.embeddableMenu.minimumTimeRangeOptionsRowLabel",{defaultMessage:"Minimum time range"})),Object(b.jsx)(m.EuiFlexItem,null,Object(b.jsx)(m.EuiToolTip,{content:g.i18n.translate("xpack.aiops.logCategorization.embeddableMenu.minimumTimeRange.tooltip",{defaultMessage:"Adds a wider time range to the analysis to improve pattern accuracy."})},Object(b.jsx)(m.EuiIcon,{type:"questionInCircle",color:"subdued"})))),helpText:Object(b.jsx)(a.a.Fragment,null,void 0!==o&&"No minimum"!==t?Object(b.jsx)(a.a.Fragment,null,Object(b.jsx)(P.FormattedMessage,{id:"xpack.aiops.logCategorization.embeddableMenu.totalPatternsMessage",defaultMessage:"Total patterns in {minimumTimeRangeOption}: {categoryCount}",values:{minimumTimeRangeOption:t,categoryCount:o}})):null)},Object(b.jsx)(m.EuiSuperSelect,{"aria-label":"Select a minimum time range",options:D,valueOfSelected:t,onChange:n})),Object(b.jsx)(m.EuiHorizontalRule,{margin:"m"}),Object(b.jsx)(A.a,{randomSampler:e,reload:l,calloutPosition:"bottom"})))};var V=n(70);const G=({openInDiscover:e})=>{const{labels:t,openFunction:n}=e,[a,o]=Object(i.useState)(!1),l=Object(b.jsx)(m.EuiDataGridToolbarControl,{"data-test-subj":"aiopsEmbeddableMenuOptionsButton",iconType:"documents",onClick:()=>o(!a),badgeContent:e.count},Object(b.jsx)(P.FormattedMessage,{id:"xpack.aiops.logCategorization.selectedResultsButtonLabel",defaultMessage:"Selected",description:"Selected results"}));return Object(b.jsx)(m.EuiPopover,{closePopover:()=>o(!1),isOpen:a,panelPaddingSize:"none",button:l,className:"unifiedDataTableToolbarControlButton"},Object(b.jsx)(m.EuiContextMenuPanel,{items:[Object(b.jsx)(m.EuiContextMenuItem,{key:"in",icon:"plusInCircle",onClick:()=>n(V.a.INCLUDE)},t.multiSelect.in),Object(b.jsx)(m.EuiContextMenuItem,{key:"out",icon:"minusInCircle",onClick:()=>n(V.a.EXCLUDE)},t.multiSelect.out)]}))};var B=n(156),Q={name:"1v0pok0",styles:"min-width:300px"};const U=({fields:e,selectedField:t,setSelectedField:n})=>{const[a,o]=Object(i.useState)(!1),l=Object(i.useMemo)((()=>e.map((e=>({inputDisplay:e.name,value:e})))),[e]),s=Object(b.jsx)(m.EuiDataGridToolbarControl,{"data-test-subj":"aiopsEmbeddableSelectFieldButton",onClick:()=>o(!a)},Object(b.jsx)(m.EuiFlexGroup,{gutterSize:"s",responsive:!1},Object(b.jsx)(m.EuiFlexItem,null,Object(b.jsx)(m.EuiToken,{iconType:"tokenString"})),Object(b.jsx)(m.EuiFlexItem,null,null==t?void 0:t.name)));return Object(b.jsx)(m.EuiPopover,{closePopover:()=>o(!1),isOpen:a,button:s,className:"unifiedDataTableToolbarControlButton"},Object(b.jsx)(m.EuiFormRow,{"data-test-subj":"aiopsEmbeddableMenuSelectedFieldFormRow",label:g.i18n.translate("xpack.aiops.logCategorization.embeddableMenu.selectedFieldRowLabel",{defaultMessage:"Selected field"})},Object(b.jsx)(m.EuiSuperSelect,{"aria-label":"Select a field",options:l,valueOfSelected:null!=t?t:void 0,onChange:n,css:Q})))};var H={name:"1oaeivz",styles:"margin-right:8px"};const K=({renderViewModeToggle:e,randomSampler:t,openInDiscover:n,selectedCategories:i,loadCategories:o,fields:l,setSelectedField:s,selectedField:r,minimumTimeRangeOption:u,setMinimumTimeRangeOption:c,data:d,dataview:g,earliest:j,latest:p,query:O})=>Object(b.jsx)(m.EuiFlexItem,{grow:!1},Object(b.jsx)(m.EuiFlexGroup,{gutterSize:"none"},Object(b.jsx)(m.EuiFlexItem,{grow:!1},e(null==d?void 0:d.categories.length)),Object(b.jsx)(m.EuiFlexItem,null),Object(b.jsx)(m.EuiFlexItem,{grow:!1},Object(b.jsx)(a.a.Fragment,null,Object(b.jsx)(m.EuiSpacer,{size:"s"}),Object(b.jsx)(m.EuiFlexGroup,{gutterSize:"s",responsive:!1},i.length>0?Object(b.jsx)(m.EuiFlexItem,null,Object(b.jsx)(G,{openInDiscover:n})):null,Object(b.jsx)(m.EuiFlexItem,null,Object(b.jsx)(U,{fields:l,setSelectedField:s,selectedField:r})),Object(b.jsx)(m.EuiFlexItem,null,Object(b.jsx)("div",{className:"unifiedDataTableToolbarControlGroup",css:H},Object(b.jsx)("div",{className:"unifiedDataTableToolbarControlIconButton"},Object(b.jsx)(L,{randomSampler:t,reload:()=>o(),minimumTimeRangeOption:u,setMinimumTimeRangeOption:c,categoryCount:null==d?void 0:d.totalCategories})),null!==r&&void 0!==j&&void 0!==p?Object(b.jsx)("div",{className:"unifiedDataTableToolbarControlIconButton"},Object(b.jsx)(B.a,{dataView:g,field:r,query:O,earliest:j,latest:p,iconOnly:!0})):null)))))));var Y={name:"11jtsj0",styles:"overflow-y:auto;.kbnDocTableWrapper{overflow-x:hidden;}"};const W=({input:e,renderViewModeToggle:t})=>{var n,o,s;const{notifications:{toasts:r},data:{query:{getState:u,filterManager:R}},uiSettings:P,embeddingOrigin:A}=Object(d.b)(),D=Object(m.useEuiPaddingSize)("xs"),{dataView:_,savedSearch:N}=e,{runValidateFieldRequest:L,cancelRequest:V}=Object(T.a)(),{getMinimumTimeRange:G,cancelRequest:B,minimumTimeRangeOption:Q,setMinimumTimeRangeOption:U}=function(){const{http:e}=Object(d.b)(),t=Object(i.useRef)(new AbortController),n=Object(i.useCallback)((async(n,i,a,o,l,s,r)=>{const u=I[o],c=k.a.duration(u.factor,u.unit).asMilliseconds(),d=a.to-a.from;if(d>c)return{...a,useSubAgg:!1};const b=await Object(M.a)({http:e,index:n,timeFieldName:i,query:l,runtimeMappings:s,path:"/internal/file_upload/time_field_range",signal:t.current.signal});if(b.end.epoch-b.start.epoch<c)return{from:b.start.epoch,to:b.end.epoch,useSubAgg:!0};const m=c-d,g=Math.max(a.from-m,b.start.epoch);return{from:g,to:Math.min(g+c,b.end.epoch),useSubAgg:!0}}),[e]),[a,o]=Object(l.b)(c.b,"1 week");return{getMinimumTimeRange:n,cancelRequest:Object(i.useCallback)((()=>{t.current.abort(),t.current=new AbortController}),[]),minimumTimeRangeOption:a,setMinimumTimeRangeOption:o}}(),{filters:H,query:W}=Object(i.useMemo)((()=>u()),[u]),J=Object(i.useRef)(!1),{runCategorizeRequest:X,cancelRequest:Z,randomSampler:$}=Object(h.a)(),[ee]=Object(p.b)("logCategorization",Object(f.a)({searchQuery:Object(v.a)(W,H,_,P)})),[te,ne]=Object(i.useState)(null),[ie,ae]=Object(i.useState)([]),[oe,le]=Object(i.useState)(null),[se,re]=Object(i.useState)([]),[ue,ce]=Object(i.useState)(null),[de,be]=Object(i.useState)(0),[me,ge]=Object(i.useState)(null),[je,pe]=Object(i.useState)(null),[Oe,xe]=Object(i.useState)(null),[fe,ve]=Object(i.useState)([]),[Se,ye]=Object(i.useState)(null),[he,Ee]=Object(i.useState)(null),[Ce,Fe]=Object(i.useState)(null),Te=Object(x.a)([],"key");Object(i.useEffect)((function(){ce(null),le(null),xe(null);const{dataViewFields:e,messageField:t}=Object(z.c)(_);re(e),le(t)}),[_]);const we=Object(i.useCallback)((()=>{B(),V(),Z()}),[Z,V,B]);Object(i.useEffect)((function(){return J.current=!0,()=>{J.current=!1,we()}}),[we,J]);const{searchQuery:Me}=Object(y.a)({dataView:_,savedSearch:null!=N?N:null},ee,!0),{documentStats:Re,timefilter:ke,earliest:Ie,latest:ze,intervalMs:qe,forceRefresh:Pe}=Object(S.a)(_,"log_categorization",Me,(()=>{}),void 0,void 0,20,!1),Ae=Object(i.useCallback)(((t,n)=>{if(void 0===e.switchToDocumentView)return;const i=Object(j.buildEmptyFilter)(!1,_.id);n&&(i.meta.alias=n),i.query=t.query,e.switchToDocumentView(),R.addFilters([i])}),[_.id,R,e]),De=Object(q.a)(_.id,null!=oe?oe:void 0,ie,ee,ke,!1,Ae,void 0);Object(i.useEffect)((function(){if(void 0===Re.documentCountStats)return;const e=Object(z.b)(Re);e!==de&&(ce(e),Ee(null),Fe(null))}),[Re,de]),Object(i.useEffect)((function(){if(null==oe||!oe.name)return;const e=Object(z.a)([oe.name,Q]);e!==je&&(ge(e),Ee(null),Fe(null))}),[Q,je,oe]);const _e=Object(i.useCallback)((async()=>{const{getIndexPattern:e,timeFieldName:t}=_,n=e();if(!0===Oe||null===oe||void 0===t||void 0===Ie||void 0===ze||void 0===Q||!0!==J.current)return;we(),xe(!0),Ee(null),Fe(null);const i={from:Ie,to:ze},a=_.getRuntimeMappings();try{const e=await G(n,t,i,Q,Me,a);if(!0!==J.current)return;const[o,l]=await Promise.all([L(n,oe.name,t,e,Me,a,{[O.c.AIOPS_ANALYSIS_RUN_ORIGIN]:A}),X(n,oe.name,t,{to:e.to,from:e.from},Me,a,qe,e.useSubAgg?i:void 0)]);if(!0!==J.current)return;Fe(o);const{categories:s,hasExamples:r}=l;if(e.useSubAgg){const e=l.categories.map((e=>{var t;return{...e,count:null!==(t=e.subFieldCount)&&void 0!==t?t:e.subTimeRangeCount,examples:e.subFieldExamples,sparkline:e.subFieldSparkline}})).filter((e=>e.count>0)).sort(((e,t)=>t.count-e.count));Ee({categories:e,displayExamples:r,totalCategories:s.length})}else Ee({categories:s,displayExamples:r,totalCategories:s.length})}catch(e){"AbortError"===e.name||r.addError(e,{title:g.i18n.translate("xpack.aiops.logCategorization.errorLoadingCategories",{defaultMessage:"Error loading categories"})})}!0===J.current&&xe(!1)}),[_,Oe,oe,Ie,ze,Q,we,G,Me,L,A,X,qe,r]);Object(i.useEffect)((function(){var e;const t=null===(e=Re.documentCountStats)||void 0===e?void 0:e.buckets;void 0!==t&&null!==ue&&(ue!==de||me!==je&&null!==ue)&&($.setDocCount(Re.totalCount),ve(Object.entries(t).map((([e,t])=>({key:+e,docCount:t})))),_e(),be(ue),pe(me))}),[_e,$,de,Ce,ue,me,null===(n=Re.documentCountStats)||void 0===n?void 0:n.buckets,Re.totalCount,je]),Object(i.useEffect)((function(){void 0!==e.lastReloadRequestTime&&(be(0),pe(null),Pe())}),[e.lastReloadRequestTime]);const Ne=Y;return Object(b.jsx)(a.a.Fragment,null,Object(b.jsx)(K,{data:he,fields:se,loadCategories:_e,minimumTimeRangeOption:Q,openInDiscover:De,randomSampler:$,selectedCategories:ie,selectedField:oe,setMinimumTimeRangeOption:U,setSelectedField:le,renderViewModeToggle:t,dataview:_,earliest:Ie,latest:ze,query:Me}),Object(b.jsx)(m.EuiSpacer,{size:"s"}),Object(b.jsx)(m.EuiFlexItem,{css:Ne},Object(b.jsx)(m.EuiFlexGroup,{className:"eui-fullHeight",direction:"column",gutterSize:"none",responsive:!1},Object(b.jsx)(m.EuiFlexItem,{css:Object(b.css)({position:"relative",overflowY:"auto",marginLeft:D},"","")},Object(b.jsx)(a.a.Fragment,null,Object(b.jsx)(w.a,{validationResults:Ce}),!0===(null==Oe||Oe)?Object(b.jsx)(F.a,{onCancel:we}):null,Object(b.jsx)(C.a,{loading:null==Oe||Oe,categoriesLength:null!==(o=null==he||null===(s=he.categories)||void 0===s?void 0:s.length)&&void 0!==o?o:null,eventRateLength:fe.length,fields:se}),!1===Oe&&null!==he&&he.categories.length>0&&null!==oe?Object(b.jsx)(E.a,{categories:he.categories,eventRate:fe,pinnedCategory:Se,setPinnedCategory:ye,highlightedCategory:te,setHighlightedCategory:ne,enableRowActions:!1,displayExamples:he.displayExamples,setSelectedCategories:ae,openInDiscover:De,tableState:Te}):null)))))},J=new u.Storage(window.localStorage),X=({deps:e,props:t,embeddingOrigin:n})=>{const a=e.i18n.Context,u={embeddingOrigin:n,...e},m={...Object(s.pick)(e,["data","http","notifications","theme","uiSettings","i18n"]),uiSettingsKeys:r.UI_SETTINGS};return Object(b.jsx)(a,null,Object(b.jsx)(d.a.Provider,{value:u},Object(b.jsx)(o.a,m,Object(b.jsx)(l.a,{storage:J,storageKeys:c.e},Object(b.jsx)(i.Suspense,{fallback:null},Object(b.jsx)(W,{input:t.input,renderViewModeToggle:t.renderViewModeToggle}))))))};t.default=X},50:function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return d}));var i=n(13),a=n(16),o=n(18),l=n(15);n(167);const s={bool:{must:[{match_all:{}}]}};function r(){return Object(i.cloneDeep)(s)}var u=n(260);function c(e,t,n,i){let s=r();if(Object(o.isQuery)(e)&&e.language===u.a.KUERY){const i=Object(l.fromKueryExpression)(e.query);if(""!==e.query&&(s=Object(l.toElasticsearchQuery)(i,n)),void 0!==s.bool){const e=Object(l.buildQueryFromFilters)(t,n);Array.isArray(s.bool.filter)||(s.bool.filter=void 0===s.bool.filter?[]:[s.bool.filter]),Array.isArray(s.bool.must_not)||(s.bool.must_not=void 0===s.bool.must_not?[]:[s.bool.must_not]),s.bool.filter=[...s.bool.filter,...e.filter],s.bool.must_not=[...s.bool.must_not,...e.must_not]}}else s=Object(l.buildEsQuery)(n,e?[e]:[],t||[],i?Object(a.getEsQueryConfig)(i):void 0);return s}function d({dataView:e,uiSettings:t,savedSearch:n,query:l,filters:s,filterManager:u}){if(!e||!n)return;const d=l,b=s,m=function(e){return e&&"searchSource"in e&&(null==e?void 0:e.searchSource)instanceof a.SearchSource?e.searchSource:void 0}(n);if(m&&void 0!==m.getParent()&&d){var g,j,p;const e=null!==(g=Object(i.cloneDeep)(null===(j=n.searchSource.getSearchRequestBody())||void 0===j?void 0:j.query))&&void 0!==g?g:r(),t=null===(p=n.searchSource.getField("index"))||void 0===p?void 0:p.timeFieldName;return Array.isArray(e.bool.filter)&&void 0!==t&&(e.bool.filter=e.bool.filter.filter((e=>{var n;return!(e.hasOwnProperty("range")&&null!==(n=e.range)&&void 0!==n&&n.hasOwnProperty(t))}))),{searchQuery:e,searchString:d.query,queryLanguage:d.language}}if(!n&&d)return u&&b&&u.addFilters(b),{searchQuery:c(d,Array.isArray(b)?b:[],e,t),searchString:d.query,queryLanguage:d.language};if(m){const n=null==u?void 0:u.getGlobalFilters(),i=null!=d?d:m.getField("query"),a=null!=b?b:Object(o.mapAndFlattenFilters)(m.getField("filter"));return u&&u.setFilters(a),n&&(null==u||u.addFilters(n)),{searchQuery:c(i,u?null==u?void 0:u.getFilters():a,e,t),searchString:i.query,queryLanguage:i.language}}}}}]);