/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.infra_bundle_jsonpfunction=window.infra_bundle_jsonpfunction||[]).push([[11],{116:function(e,t,r){"use strict";r.d(t,"b",(function(){return w})),r.d(t,"d",(function(){return E})),r.d(t,"e",(function(){return y})),r.d(t,"a",(function(){return g})),r.d(t,"c",(function(){return v}));var n=r(117),a=r.n(n),i=r(3),o=r.n(i),s=r(30),c=r(119),u=r(1);const l=u.i18n.translate("xpack.infra.sourceConfiguration.missingHttp",{defaultMessage:"Failed to load source: No HTTP client available."});class MissingHttpClientException extends Error{constructor(){super(l),Object.setPrototypeOf(this,new.target.prototype),this.name="MissingHttpClientException"}}var d=r(31),m=r(148),f=r.n(m),h=r(15),p=r(173);const[g,v]=a()((()=>{const{services:{dataViews:e}}=Object(s.c)(),{source:t}=E(),[r,n]=f()((async()=>{const r=null==t?void 0:t.configuration.metricAlias;return r?Object(p.a)({dataViewsService:e,dataViewId:r,attributes:{name:h.b.name,timeFieldName:h.b.timeFieldName}}):Promise.resolve(void 0)}),[e,null==t?void 0:t.configuration.metricAlias]);Object(i.useEffect)((()=>{n()}),[n]);const{value:a,error:o,loading:c}=r;return{metricsView:a,loading:c,error:o,refetch:n}})),b="/api/metrics/source",[w,E]=a()((({sourceId:e})=>{var t;const{persistSourceConfiguration:r,source:n,error:a,isLoading:o,loadSource:l}=(({sourceId:e})=>{const[t,r]=Object(i.useState)(void 0),{services:{http:n,telemetry:a}}=Object(s.c)(),o=(()=>{const{notifications:e}=Object(d.useKibana)();return{updateFailure:t=>{e.toasts.danger({toastLifeTimeMs:3e3,title:u.i18n.translate("xpack.infra.sourceConfiguration.updateFailureTitle",{defaultMessage:"Configuration update failed"}),body:[u.i18n.translate("xpack.infra.sourceConfiguration.updateFailureBody",{defaultMessage:"We couldn't apply the changes to the Metrics configuration. Try again later."}),t].filter(Boolean).join(" ")})},updateSuccess:()=>{e.toasts.success({toastLifeTimeMs:3e3,title:u.i18n.translate("xpack.infra.sourceConfiguration.updateSuccessTitle",{defaultMessage:"Metrics settings successfully updated"})})}}})(),[l,m]=Object(c.b)({cancelPreviousOn:"resolution",createPromise:async()=>{if(!n)throw new MissingHttpClientException;const t=performance.now(),r=await n.fetch(`${b}/${e}`,{method:"GET"});return null==a||a.reportPerformanceMetricEvent("infra_source_load",performance.now()-t,{},{}),r},onResolve:e=>{e&&r(e.source)}},[n,e]),[f,h]=Object(c.b)({createPromise:async t=>{if(!n)throw new MissingHttpClientException;return await n.patch(`${b}/${e}`,{method:"PATCH",body:JSON.stringify(t)})},onResolve:e=>{e&&(o.updateSuccess(),r(e.source))},onReject:e=>{var t;o.updateFailure(null===(t=e.body)||void 0===t?void 0:t.message)}},[n,e]);Object(i.useEffect)((()=>{m()}),[m,e]);const p="rejected"===l.state?`${l.value}`:void 0,g="uninitialized"===l.state||"pending"===l.state||"pending"===f.state;return{error:p,loadSource:m,isLoading:g,source:t,persistSourceConfiguration:h}})({sourceId:e}),m=n?!!n.version:void 0;return{isLoading:o,error:a,loadSource:l,metricIndicesExist:Boolean(null==n||null===(t=n.status)||void 0===t?void 0:t.metricIndicesExist),source:n,sourceExists:m,sourceId:e,persistSourceConfiguration:r}})),y=e=>(t="default")=>function(r){return o.a.createElement(w,{sourceId:t},o.a.createElement(g,null,o.a.createElement(e,r)))}},117:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3),a={};t.default=function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];var o=[],s=[],c=function(e){var t=n.createContext(a);o.push(t),s.push(function(e){return function(){var t=n.useContext(e);return t}}(t))};r.length?r.forEach((function(e){return c(e.name)})):c(e.name);var u=function(t){for(var a=t.children,i=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(t,["children"]),s=e(i),c=a,u=0;u<o.length;u+=1){var l=o[u],d=r[u]||function(e){return e};c=n.createElement(l.Provider,{value:d(s)},c)}return c};return[u].concat(s)}},119:function(e,t,r){"use strict";r.d(t,"b",(function(){return c})),r.d(t,"a",(function(){return CanceledPromiseError}));var n=r(6),a=r.n(n),i=r(3),o=r(127),s=r.n(o);const c=({createPromise:e,onResolve:t=u,onReject:r=u,cancelPreviousOn:n="never",triggerOrThrow:a="whenMounted"},o)=>{const c=s()(),l=Object(i.useCallback)((()=>{switch(a){case"always":return!0;case"whenMounted":return c()}}),[c,a]),d=Object(i.useRef)([]),[m,f]=Object(i.useState)({state:"uninitialized"}),h=Object(i.useCallback)((()=>{f({state:"uninitialized"})}),[]),p=Object(i.useMemo)((()=>(...a)=>{let i;const o=new Promise(((e,t)=>{i=t})),s=d.current,c=()=>{s.forEach((e=>e.cancel()))},m=e(...a),h=Promise.race([m,o]);f({state:"pending",promise:h}),"creation"===n&&c();const p={cancel:()=>{i(new CanceledPromiseError)},cancelSilently:()=>{i(new SilentCanceledPromiseError)},promise:h.then((e=>(["settlement","resolution"].includes(n)&&c(),d.current=d.current.filter((e=>e.promise!==p.promise)),t&&l()&&t(e),f((t=>"pending"===t.state&&t.promise===h?{state:"resolved",promise:p.promise,value:e}:t)),e)),(e=>{if(!(e instanceof SilentCanceledPromiseError)){if(["settlement","rejection"].includes(n)&&c(),d.current=d.current.filter((e=>e.promise!==p.promise)),l()){if(!r)throw e;r(e)}f((t=>"pending"===t.state&&t.promise===h?{state:"rejected",promise:h,value:e}:t))}}))};return d.current=[...d.current,p],p.promise.catch(u),p.promise}),o);return Object(i.useEffect)((()=>()=>{d.current.forEach((e=>e.cancelSilently()))}),[]),[m,p,h]};class CanceledPromiseError extends Error{constructor(e){super(e),a()(this,"isCanceled",!0),Object.setPrototypeOf(this,new.target.prototype)}}class SilentCanceledPromiseError extends CanceledPromiseError{}const u=()=>{}},127:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3);t.default=function(){var e=n.useRef(!1),t=n.useCallback((function(){return e.current}),[]);return n.useEffect((function(){return e.current=!0,function(){e.current=!1}})),t}},145:function(e,t,r){e.exports=r(64)(71)},148:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(80),a=r(3),i=n.__importDefault(r(127));t.default=function(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={loading:!1});var o=a.useRef(0),s=i.default(),c=a.useState(r),u=c[0],l=c[1],d=a.useCallback((function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var a=++o.current;return l((function(e){return n.__assign(n.__assign({},e),{loading:!0})})),e.apply(void 0,t).then((function(e){return s()&&a===o.current&&l({value:e,loading:!1}),e}),(function(e){return s()&&a===o.current&&l({error:e,loading:!1}),e}))}),t);return[u,d]}},173:function(e,t,r){"use strict";r.d(t,"b",(function(){return a})),r.d(t,"a",(function(){return o}));var n=r(15);const a=({dataViewId:e,dataViewsService:t})=>{try{return i({dataViewsService:t,dataViewId:e})}catch{return o({dataViewsService:t,dataViewId:e,attributes:{timeFieldName:n.m}})}},i=async({dataViewsService:e,dataViewId:t})=>{var r,a;const i=await e.get(t,!1);return{indices:i.getIndexPattern(),timeFieldName:null!==(r=i.timeFieldName)&&void 0!==r?r:n.m,fields:null!==(a=i.fields)&&void 0!==a?a:[],dataViewReference:i}},o=async({dataViewsService:e,dataViewId:t,attributes:r})=>{const{name:n,timeFieldName:a}=r,i=await e.create({id:t,name:n,title:t,timeFieldName:a},!1,!1);return{indices:t,timeFieldName:a,fields:i.fields,dataViewReference:i}}},237:function(e,t,r){"use strict";r.d(t,"a",(function(){return c}));var n=r(3),a=r.n(n),i=r(81),o=r(40),s=r(1);const c=({chartProps:{theme:e,baseTheme:t},comparator:r,id:n,thresholds:c,title:u,value:l,valueFormatter:d,warning:m})=>{const f=Object(o.useEuiBackgroundColor)("danger");return a.a.createElement(o.EuiPanel,{paddingSize:"none",style:{height:"100%",overflow:"hidden",position:"relative",minWidth:"100%"},hasShadow:!1,"data-test-subj":`threshold-${c.join("-")}-${l}`},a.a.createElement(i.Chart,null,a.a.createElement(i.Settings,{theme:e,baseTheme:t,locale:s.i18n.getLocale()}),a.a.createElement(i.Metric,{id:n,data:[[{title:u,extra:a.a.createElement(a.a.Fragment,null,s.i18n.translate("xpack.infra.alerting.thresholdExtraTitle",{values:{comparator:r,threshold:c.map((e=>d(e))).join(" - ")},defaultMessage:"Alert when {comparator} {threshold}"}),a.a.createElement("br",null),m&&s.i18n.translate("xpack.infra.alerting.warningExtraTitle",{values:{comparator:m.comparator,threshold:m.thresholds.map((e=>d(e))).join(" - ")},defaultMessage:"Warn when {comparator} {threshold}"})),color:f,value:l,valueFormatter:d,icon:({width:e,height:t,color:r})=>a.a.createElement(o.EuiIcon,{width:e,height:t,color:r,type:"alert"})}]]})))}},247:function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(76),a=r.n(n);const i=(e,t,r)=>{const n=a.a.duration(a()(t).diff(a()(e))),i=a()().toISOString(),o=n.asMinutes()<160?a.a.duration(20,"minutes").asMilliseconds():n.asMilliseconds()/8,s=r&&a.a.duration(20*r.size,r.unit).asMilliseconds(),c=s&&s-o>0?s:o;return{from:a()(e).subtract(c,"millisecond").toISOString(),to:t&&a()(t).add(c,"millisecond").isBefore(i)?a()(t).add(c,"millisecond").toISOString():i}}},624:function(e,t,r){"use strict";r.d(t,"b",(function(){return a})),r.d(t,"a",(function(){return i})),r.d(t,"c",(function(){return o})),r.d(t,"d",(function(){return s}));var n=r(92);n.h,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.n,n.h,n.h,n.h,n.h,n.h,n.h,n.n,n.h,n.h;const a=`${n.h}.evaluation.value`,i=`${n.h}.context`,o=`${n.h}.evaluation.values`,s=`${n.h}.group`;n.n,n.n,n.A,n.h,n.n,n.C,n.a,n.c,n.d,n.e,n.g,n.f,n.k,n.p,n.i,n.b,n.l,n.m,n.o,n.q,n.r,n.t,n.v,n.u,n.w,n.x,n.y,n.z,n.s,n.j,n.B,n.D},647:function(e,t,r){"use strict";r.r(t),r.d(t,"AlertDetailsAppSection",(function(){return j}));var n=r(1),a=r(83),i=r(3),o=r.n(i),s=r(76),c=r.n(s),u=r(40),l=r(145),d=r.n(l),m=r(35),f=r(624),h=r(92),p=r(247),g=r(45);const v=(e,t="")=>{const r=n.i18n.translate("xpack.infra.metrics.alerting.noDataFormattedValue",{defaultMessage:"[NO DATA]"}),a=t.endsWith(".pct")?Object(g.b)("percent"):Object(g.b)("highPrecision");return null==e?r:a(e)};var b=r(237),w=r(116);const E=e=>{const t=e.metric?`(${e.metric})`:"";return e.aggType+t+e.comparator+e.threshold.join(",")};var y=r(30);function j({alert:e,rule:t,setAlertSummaryFields:r}){const{charts:i}=Object(y.c)().services,{euiTheme:s}=Object(u.useEuiTheme)(),l=e.fields[f.d],{metricsView:g}=Object(w.c)(),j={baseTheme:i.theme.useChartsBaseTheme()},O=e.fields[h.d],C=e.fields[h.t],S={label:"Alert",type:"manual",key:{type:"point_in_time",timestamp:C},color:s.colors.danger,icon:"alert",id:"metric_threshold_alert_start_annotation"},T={label:O?"Alert duration":"Active alert",type:"manual",key:{type:"range",timestamp:C,endTimestamp:null!=O?O:c()().toISOString()},color:d()(Object(u.transparentize)("#F04E981A",.2)).hex().toUpperCase(),id:`metric_threshold_${O?"recovered":"active"}_alert_range_annotation`},x=[];return x.push(S,T),t.params.criteria?o.a.createElement(u.EuiFlexGroup,{direction:"column","data-test-subj":"metricThresholdAppSection"},t.params.criteria.map(((r,i)=>{const s=Object(p.a)(e.fields[h.t],e.fields[h.d],{size:r.timeSize,unit:r.timeUnit});let c=[{aggType:r.aggType,name:String.fromCharCode("A".charCodeAt(0)+i),field:r.metric||""}];return r.customMetrics&&(c=r.customMetrics.map((e=>({name:e.name,aggType:e.aggType,field:e.field||"",filter:e.filter})))),o.a.createElement(u.EuiFlexItem,{key:E(r)},o.a.createElement(u.EuiPanel,{hasBorder:!0,hasShadow:!1},o.a.createElement(u.EuiTitle,{size:"xs"},o.a.createElement("h4",null,r.aggType.toUpperCase()," ","metric"in r?r.metric:void 0)),o.a.createElement(u.EuiSpacer,{size:"m"}),o.a.createElement(u.EuiFlexGroup,null,o.a.createElement(u.EuiFlexItem,{style:{minHeight:150,minWidth:160},grow:1},o.a.createElement(b.a,{chartProps:j,id:`threshold-${E(r)}`,thresholds:r.threshold,value:e.fields[f.c][i],valueFormatter:e=>v(e,"metric"in r?r.metric:void 0),title:n.i18n.translate("xpack.infra.metrics.alertDetailsAppSection.thresholdTitle",{defaultMessage:"Threshold breached"}),comparator:Object(a.convertToBuiltInComparators)(r.comparator),warning:r.warningThreshold&&r.warningComparator&&{thresholds:r.warningThreshold,comparator:Object(a.convertToBuiltInComparators)(r.warningComparator)}})),o.a.createElement(u.EuiFlexItem,{grow:5},g&&o.a.createElement(m.RuleConditionChart,{additionalFilters:Object(m.getGroupFilters)(l),metricExpression:{metrics:c,threshold:r.threshold,comparator:r.comparator,timeSize:r.timeSize,timeUnit:r.timeUnit,warningComparator:r.warningComparator,warningThreshold:r.warningThreshold},chartOptions:{seriesType:"bar_stacked"},searchConfiguration:{query:{query:"",language:""}},timeRange:s,dataView:g.dataViewReference,groupBy:t.params.groupBy,annotations:x})))))}))):null}t.default=Object(w.e)(j)("default")}}]);