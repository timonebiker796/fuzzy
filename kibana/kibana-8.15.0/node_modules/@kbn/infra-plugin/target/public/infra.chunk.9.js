/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.infra_bundle_jsonpfunction=window.infra_bundle_jsonpfunction||[]).push([[9],{115:function(e,t,r){e.exports=r(64)(4)},119:function(e,t,r){"use strict";r.d(t,"b",(function(){return s})),r.d(t,"a",(function(){return CanceledPromiseError}));var a=r(6),n=r.n(a),i=r(3),o=r(127),l=r.n(o);const s=({createPromise:e,onResolve:t=c,onReject:r=c,cancelPreviousOn:a="never",triggerOrThrow:n="whenMounted"},o)=>{const s=l()(),u=Object(i.useCallback)((()=>{switch(n){case"always":return!0;case"whenMounted":return s()}}),[s,n]),d=Object(i.useRef)([]),[m,p]=Object(i.useState)({state:"uninitialized"}),g=Object(i.useCallback)((()=>{p({state:"uninitialized"})}),[]),f=Object(i.useMemo)((()=>(...n)=>{let i;const o=new Promise(((e,t)=>{i=t})),l=d.current,s=()=>{l.forEach((e=>e.cancel()))},m=e(...n),g=Promise.race([m,o]);p({state:"pending",promise:g}),"creation"===a&&s();const f={cancel:()=>{i(new CanceledPromiseError)},cancelSilently:()=>{i(new SilentCanceledPromiseError)},promise:g.then((e=>(["settlement","resolution"].includes(a)&&s(),d.current=d.current.filter((e=>e.promise!==f.promise)),t&&u()&&t(e),p((t=>"pending"===t.state&&t.promise===g?{state:"resolved",promise:f.promise,value:e}:t)),e)),(e=>{if(!(e instanceof SilentCanceledPromiseError)){if(["settlement","rejection"].includes(a)&&s(),d.current=d.current.filter((e=>e.promise!==f.promise)),u()){if(!r)throw e;r(e)}p((t=>"pending"===t.state&&t.promise===g?{state:"rejected",promise:g,value:e}:t))}}))};return d.current=[...d.current,f],f.promise.catch(c),f.promise}),o);return Object(i.useEffect)((()=>()=>{d.current.forEach((e=>e.cancelSilently()))}),[]),[m,f,g]};class CanceledPromiseError extends Error{constructor(e){super(e),n()(this,"isCanceled",!0),Object.setPrototypeOf(this,new.target.prototype)}}class SilentCanceledPromiseError extends CanceledPromiseError{}const c=()=>{}},121:function(e,t,r){"use strict";r.d(t,"k",(function(){return a.b})),r.d(t,"n",(function(){return n.d})),r.d(t,"m",(function(){return i.b})),r.d(t,"l",(function(){return i.a})),r.d(t,"a",(function(){return b.a})),r.d(t,"s",(function(){return b.u})),r.d(t,"q",(function(){return b.s})),r.d(t,"r",(function(){return b.t})),r.d(t,"e",(function(){return b.f})),r.d(t,"x",(function(){return b.B})),r.d(t,"y",(function(){return b.C})),r.d(t,"f",(function(){return b.g})),r.d(t,"z",(function(){return b.D})),r.d(t,"A",(function(){return b.E})),r.d(t,"b",(function(){return b.c})),r.d(t,"o",(function(){return b.q})),r.d(t,"p",(function(){return b.r})),r.d(t,"g",(function(){return b.h})),r.d(t,"B",(function(){return b.F})),r.d(t,"C",(function(){return b.G})),r.d(t,"h",(function(){return b.i})),r.d(t,"D",(function(){return b.H})),r.d(t,"E",(function(){return b.I})),r.d(t,"d",(function(){return b.e})),r.d(t,"w",(function(){return b.A})),r.d(t,"v",(function(){return b.z})),r.d(t,"c",(function(){return b.d})),r.d(t,"t",(function(){return b.x})),r.d(t,"u",(function(){return b.y})),r.d(t,"i",(function(){return b.j})),r.d(t,"F",(function(){return b.M})),r.d(t,"G",(function(){return b.N})),r.d(t,"j",(function(){return b.k})),r.d(t,"I",(function(){return b.P})),r.d(t,"H",(function(){return b.O})),r.d(t,"J",(function(){return b.Q})),r(134);var a=r(20),n=(r(44),r(26)),i=r(139),o=r(259),l=r(114),s=r(62),c=r(0);const u=c.keyof({cpu:null,normalizedLoad1m:null,diskSpaceUsage:null,memory:null,memoryFree:null,rx:null,tx:null}),d=c.type({from:o.a,to:o.a}),m=c.keyof({"cloud.provider":null,"host.ip":null,"host.os.name":null}),p=c.type({name:u,value:c.union([c.number,c.null])}),g=c.type({name:m,value:c.union([c.number,c.string,c.null])}),f=(c.intersection([c.partial({query:c.UnknownRecord}),c.type({type:c.literal("host"),limit:c.union([Object(l.b)(1,500),Object(s.a)(20)]),metrics:c.array(c.type({type:u})),sourceId:c.string,range:d})]),c.intersection([c.type({name:c.string,metrics:c.array(p),metadata:c.array(g)}),c.partial({alertsCount:c.number})]));c.type({type:c.literal("host"),nodes:c.array(f)});var b=r(7);r(47),r(50),r(46),r(49),r(48)},127:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(3);t.default=function(){var e=a.useRef(!1),t=a.useCallback((function(){return e.current}),[]);return a.useEffect((function(){return e.current=!0,function(){e.current=!1}})),t}},128:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(80).__importDefault(r(142));t.default=function(e){a.default((function(){e()}))}},134:function(e,t,r){"use strict";r.d(t,"a",(function(){return v}));var a=r(0),n=r(18);a.type({nodeId:a.string,nodeType:n.ItemTypeRT,sourceId:a.string,timeRange:a.type({from:a.number,to:a.number})});const i=a.type({name:a.string,source:a.string}),o=a.partial({codename:a.string,family:a.string,kernel:a.string,name:a.string,platform:a.string,version:a.string,build:a.string}),l=a.partial({name:a.string,hostname:a.string,id:a.string,ip:a.union([a.array(a.string),a.string]),mac:a.union([a.array(a.string),a.string]),os:o,architecture:a.string,containerized:a.boolean}),s=a.partial({name:a.string,id:a.string,runtime:a.string,image:a.partial({name:a.string})}),c=a.partial({id:a.string,name:a.string}),u=a.partial({id:a.string,name:a.string}),d=a.partial({id:a.string}),m=a.partial({interface:a.string,type:a.string}),p=a.partial({instance:c,provider:a.string,account:u,availability_zone:a.string,project:d,machine:m,region:a.string,imageId:a.string}),g=a.partial({id:a.string,version:a.string,policy:a.string}),f=(a.partial({cloud:p,host:l,container:s,agent:g,"@timestamp":a.string}),a.partial({cloud:p,host:l,container:s,agent:g,timestamp:a.string})),b=a.type({id:a.string,name:a.string,features:a.array(i)}),E=a.partial({info:f}),v=a.intersection([b,E])},139:function(e,t,r){"use strict";r.d(t,"b",(function(){return l})),r.d(t,"a",(function(){return s})),r.d(t,"c",(function(){return O}));var a=r(0),n=r(44);const i=a.type({value:a.number}),o=(a.type({hostTerm:a.record(a.string,a.string),indexPattern:a.string,to:a.number,sortBy:a.type({name:a.string,isAscending:a.boolean}),searchFilter:a.array(a.record(a.string,a.record(a.string,a.unknown)))}),a.type({summaryEvent:a.type({summary:a.type({hits:a.type({hits:a.array(a.type({_source:a.type({system:a.type({process:a.type({summary:a.record(a.string,a.number)})})})}))})})}),processes:a.type({filteredProcs:a.type({buckets:a.array(a.type({key:a.string,cpu:i,memory:i,startTime:a.type({value_as_string:a.string}),meta:a.type({hits:a.type({hits:a.array(a.type({_source:a.type({process:a.type({pid:a.number}),system:a.type({process:a.type({state:a.string})}),user:a.type({name:a.string})})}))})})}))})})}),a.union([a.number,a.string])),l=a.type({processList:a.array(a.type({cpu:a.union([a.null,a.number]),memory:a.union([a.null,a.number]),startTime:a.number,pid:a.number,state:a.string,user:a.string,command:a.string})),summary:a.exact(a.partial({total:o,running:o,sleeping:o,dead:o,stopped:o,idle:o,zombie:o,unknown:o}))}),s=(a.type({hostTerm:a.record(a.string,a.string),indexPattern:a.string,to:a.number,command:a.string}),a.type({process:a.type({filteredProc:a.type({buckets:a.array(a.type({timeseries:a.type({buckets:a.array(a.type({key:a.number,memory:i,cpu:i}))})}))})})}),a.type({cpu:n.a,memory:n.a}));var c=r(114),u=r(62),d=r(259),m=r(82),p=r.n(m),g=r(16),f=r(32);const b=new a.Type("datemath",a.string.is,((e,t)=>Object(f.pipe)(a.string.validate(e,t),Object(g.chain)((e=>(e=>{const t=p.a.parse(e);return!(!t||!t.isValid())})(e)?a.success(e):a.failure(e,t))))),String),E=a.union([Object(c.a)(1,100),Object(u.a)(10)]),v=a.union([d.a,b]),y=a.strict({"host.name":a.string}),h=(a.intersection([a.strict({from:v,to:v,filters:a.string}),a.partial({size:E,validatedFilters:y})]),a.union([a.string,a.null])),x=(a.type({services:a.type({buckets:a.array(a.type({key:a.string,latestAgent:a.type({top:a.array(a.type({sort:a.array(a.string),metrics:a.type({"agent.name":h})}))})}))})}),a.type({serviceName:a.string,agentName:h})),O=a.type({services:a.array(x)})},142:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(3);t.default=function(e){a.useEffect(e,[])}},149:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var a=r(98),n=r.n(a),i=r(31),o=r(84);function l(){const[e]=Object(i.useUiSetting$)(o.UI_SETTINGS.DATEFORMAT_TZ);return e&&"Browser"!==e?e:n.a.tz.guess()}},151:function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var a=r(40),n=r(30);function i(){const{euiTheme:e}=Object(a.useEuiTheme)(),{services:{charts:t}}=Object(n.c)();return{baseTheme:t.theme.useChartsBaseTheme(),theme:{background:{color:"transparent"},crosshair:{band:{fill:e.colors.lightShade}},axes:{gridLine:{horizontal:{visible:!1},vertical:{dash:void 0}}}}}}},201:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(80),n=r(3),i=a.__importDefault(r(234));t.default=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[]);var a=i.default(e,t),o=a[0],l=a[1],s=a[2];return n.useEffect(s,r),[o,l]}},234:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(3);t.default=function(e,t){void 0===t&&(t=0);var r=a.useRef(!1),n=a.useRef(),i=a.useRef(e),o=a.useCallback((function(){return r.current}),[]),l=a.useCallback((function(){r.current=!1,n.current&&clearTimeout(n.current),n.current=setTimeout((function(){r.current=!0,i.current()}),t)}),[t]),s=a.useCallback((function(){r.current=null,n.current&&clearTimeout(n.current)}),[]);return a.useEffect((function(){i.current=e}),[e]),a.useEffect((function(){return l(),s}),[t]),[o,s,l]}},236:function(e,t,r){"use strict";r.d(t,"h",(function(){return p})),r.d(t,"d",(function(){return g})),r.d(t,"f",(function(){return f})),r.d(t,"i",(function(){return b})),r.d(t,"j",(function(){return E})),r.d(t,"g",(function(){return v})),r.d(t,"a",(function(){return h})),r.d(t,"e",(function(){return x})),r.d(t,"c",(function(){return O})),r.d(t,"b",(function(){return C}));var a=r(3),n=r.n(a),i=r(81),o=r(76),l=r.n(o),s=r(1),c=r(40),u=r(73),d=r(13),m=r(21);const p={headerFormatter:({value:e})=>l()(e).format("Y-MM-DD HH:mm:ss")},g=20,f={s:s.i18n.translate("xpack.infra.alerts.timeLabels.seconds",{defaultMessage:"seconds"}),m:s.i18n.translate("xpack.infra.alerts.timeLabels.minutes",{defaultMessage:"minutes"}),h:s.i18n.translate("xpack.infra.alerts.timeLabels.hours",{defaultMessage:"hours"}),d:s.i18n.translate("xpack.infra.alerts.timeLabels.days",{defaultMessage:"days"})},b=(e,t)=>Object(a.useMemo)((()=>"number"==typeof e&&"number"==typeof t?Object(i.niceTimeFormatter)([e,t]):e=>`${e}`),[e,t]),E=m.a,v=(e,t=!1)=>{let r=null,a=null;const n=e.reduce(((e,t)=>(t.points.forEach((t=>{const r=e[t.timestamp]||[];e[t.timestamp]=[...r,t.value]})),e)),{});Object.values(n).forEach((e=>{const n=t?Object(d.sum)(e):Object(d.max)(e),i=Object(d.min)(e);n&&(!a||n>a)&&(a=n),i&&(!r||i<r)&&(r=i)}));const i=Object.keys(n).map(Number),o=Object(d.min)(i)||0,l=Object(d.max)(i)||0;return{yMin:r||0,yMax:a||0,xMin:o,xMax:l}},y=({children:e})=>n.a.createElement("div",{style:{width:"100%",height:150,display:"flex",justifyContent:"center",alignItems:"center"}},e),h=({children:e})=>n.a.createElement("div",{style:{width:"100%",height:150}},e),x=()=>n.a.createElement(y,null,n.a.createElement(c.EuiText,{color:"subdued","data-test-subj":"noChartData"},n.a.createElement(u.FormattedMessage,{id:"xpack.infra.alerts.charts.noDataMessage",defaultMessage:"No chart data available"}))),O=()=>n.a.createElement(y,null,n.a.createElement(c.EuiText,{color:"subdued","data-test-subj":"loadingData"},n.a.createElement(c.EuiLoadingChart,{size:"m"}))),C=()=>n.a.createElement(y,null,n.a.createElement(c.EuiText,{color:"subdued","data-test-subj":"chartErrorState"},n.a.createElement(u.FormattedMessage,{id:"xpack.infra.alerts.charts.errorMessage",defaultMessage:"Uh oh, something went wrong"})))},259:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var a=r(0),n=r(76),i=r.n(n);const o=a.brand(a.string,(e=>i()(e,!0).isValid()),"Date")},644:function(e,t,r){"use strict";r.r(t),r.d(t,"ExpressionEditor",(function(){return me})),r.d(t,"SourceStatusWrapper",(function(){return pe})),r.d(t,"Editor",(function(){return ge})),r.d(t,"ExpressionLike",(function(){return fe}));var a=r(40),n=r(1),i=r(3),o=r.n(i),l=r(128),s=r.n(l),c=r(88),u=r(78),d=r(11),m=r(14),p=r(30);const g=({onChange:e,fields:t,selectedGroups:r=[],label:n,placeholder:l})=>{const s=Object(i.useCallback)((t=>{const r=t.map((e=>e.label));e(r)}),[e]),c=Object(i.useMemo)((()=>r.map((e=>({label:e})))),[r]),u=Object(i.useMemo)((()=>t.filter((e=>e.aggregatable)).map((e=>({label:e.name})))),[t]);return o.a.createElement("div",{style:{minWidth:"300px"}},o.a.createElement(a.EuiComboBox,{placeholder:l,"aria-label":n,fullWidth:!0,singleSelection:!1,selectedOptions:c,options:u,onChange:s,isClearable:!0}))},f=n.i18n.translate("xpack.infra.alerting.alertFlyout.groupByLabel",{defaultMessage:"Group By"}),b=n.i18n.translate("xpack.infra.alerting.alertFlyout.groupBy.placeholder",{defaultMessage:"Nothing (ungrouped)"}),E=({selectedGroups:e=[],fields:t,label:r,onChange:n})=>{const[l,s]=Object(i.useState)(!1),c=Object(i.useMemo)((()=>e.length>0?e.join(", "):b),[e]),u=null!=r?r:f;return o.a.createElement(a.EuiFlexGroup,{gutterSize:"s"},o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiPopover,{id:"groupByExpression",button:o.a.createElement(a.EuiExpression,{description:u,uppercase:!0,value:c,isActive:l,onClick:()=>s(!l)}),isOpen:l,closePopover:()=>s(!1),ownFocus:!0,panelPaddingSize:"s",anchorPosition:"downLeft"},o.a.createElement("div",{style:{zIndex:11e3}},o.a.createElement(a.EuiPopoverTitle,null,u),o.a.createElement(g,{selectedGroups:e,onChange:n,fields:t,label:u,placeholder:b})))))};var v=r(59),y=r(115),h=r.n(y),x=r(73),O=r(13);const C=n.i18n.translate("xpack.infra.logs.alertFlyout.firstCriterionFieldPrefix",{defaultMessage:"with"}),T=n.i18n.translate("xpack.infra.logs.alertFlyout.successiveCriterionFieldPrefix",{defaultMessage:"and"}),j=n.i18n.translate("xpack.infra.logs.alertFlyout.criterionFieldTitle",{defaultMessage:"Field"}),w=n.i18n.translate("xpack.infra.logs.alertFlyout.criterionComparatorValueTitle",{defaultMessage:"Comparison : Value"}),k=e=>"number"===(null==e?void 0:e.type)?[{value:d.a.GT,text:d.b[d.a.GT]},{value:d.a.GT_OR_EQ,text:d.b[d.a.GT_OR_EQ]},{value:d.a.LT,text:d.b[d.a.LT]},{value:d.a.LT_OR_EQ,text:d.b[d.a.LT_OR_EQ]},{value:d.a.EQ,text:d.b[`${d.a.EQ}:number`]},{value:d.a.NOT_EQ,text:d.b[`${d.a.NOT_EQ}:number`]}]:null!=e&&e.aggregatable?[{value:d.a.EQ,text:d.b[d.a.EQ]},{value:d.a.NOT_EQ,text:d.b[d.a.NOT_EQ]}]:[{value:d.a.MATCH,text:d.b[d.a.MATCH]},{value:d.a.NOT_MATCH,text:d.b[d.a.NOT_MATCH]},{value:d.a.MATCH_PHRASE,text:d.b[d.a.MATCH_PHRASE]},{value:d.a.NOT_MATCH_PHRASE,text:d.b[d.a.NOT_MATCH_PHRASE]}],S=(e,t)=>e.find((e=>e.name===t)),F=({idx:e,fields:t,criterion:r,updateCriterion:l,removeCriterion:s,canDelete:c,errors:u})=>{var m,p,g;const[f,b]=Object(i.useState)(!1),[E,v]=Object(i.useState)(!1),y=Object(i.useMemo)((()=>t.map((e=>({label:e.name})))),[t]),h=Object(i.useMemo)((()=>r.field?S(t,r.field):void 0),[t,r]),x=Object(i.useMemo)((()=>k(h)),[h]),F=Object(i.useCallback)((([r])=>{if(!r)return void l(e,{field:""});const a=r.label,n=S(t,a);if((null==h?void 0:h.type)!==(null==n?void 0:n.type)||(null==h?void 0:h.aggregatable)!==(null==n?void 0:n.aggregatable)){const t=k(n);l(e,{field:a,comparator:t[0].value,value:void 0})}else l(e,{field:a});b(!1)}),[h,t,e,l]),M=r.field?[{label:r.field}]:[];return o.a.createElement(a.EuiFlexGroup,{gutterSize:"s"},o.a.createElement(a.EuiFlexItem,{grow:!0},o.a.createElement(a.EuiFlexGroup,{gutterSize:"s"},o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiPopover,{id:"criterion-field",button:o.a.createElement(a.EuiExpression,{description:0===e?C:T,uppercase:!0,value:null!==(m=r.field)&&void 0!==m?m:"a chosen field",isActive:f,color:0===u.field.length?"success":"danger",onClick:e=>{e.stopPropagation(),b(!f)}}),isOpen:f,closePopover:()=>b(!1),onClick:e=>e.stopPropagation(),ownFocus:!0,panelPaddingSize:"s",anchorPosition:"downLeft"},o.a.createElement("div",null,o.a.createElement(a.EuiPopoverTitle,null,j),o.a.createElement(a.EuiFormRow,{style:{minWidth:"300px"},isInvalid:u.field.length>0,error:u.field},o.a.createElement(a.EuiComboBox,{compressed:!0,fullWidth:!0,isClearable:!1,singleSelection:{asPlainText:!0},options:y,selectedOptions:M,onChange:F}))))),o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiPopover,{id:"criterion-comparator-value",button:o.a.createElement(a.EuiExpression,{description:r.comparator&&null!==(p=null!==(g=d.b[`${r.comparator}:${null==h?void 0:h.type}`])&&void 0!==g?g:d.b[r.comparator])&&void 0!==p?p:"",uppercase:!0,value:r.value,isActive:E,color:0===u.comparator.length&&0===u.value.length?"success":"danger",onClick:e=>{e.stopPropagation(),v(!E)}}),isOpen:E,closePopover:()=>v(!1),onClick:e=>e.stopPropagation(),ownFocus:!0,panelPaddingSize:"s",anchorPosition:"downLeft"},o.a.createElement("div",null,o.a.createElement(a.EuiPopoverTitle,null,w),o.a.createElement(a.EuiFlexGroup,{gutterSize:"l"},o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiFormRow,{isInvalid:u.comparator.length>0,error:u.comparator},o.a.createElement(a.EuiSelect,{"data-test-subj":"infraCriterionSelect",compressed:!0,hasNoInitialSelection:null==r.comparator,value:r.comparator,onChange:t=>l(e,{comparator:t.target.value}),options:x}))),o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiFormRow,{isInvalid:u.value.length>0,error:u.value},"number"===(null==h?void 0:h.type)?o.a.createElement(a.EuiFieldNumber,{"data-test-subj":"infraCriterionFieldNumber",compressed:!0,value:r.value,onChange:t=>{const r=parseFloat(t.target.value);l(e,{value:Object(O.isNumber)(r)&&Object(O.isFinite)(r)?r:void 0})}}):o.a.createElement(a.EuiFieldText,{"data-test-subj":"infraCriterionFieldText",compressed:!0,value:r.value,onChange:t=>l(e,{value:t.target.value})}))))))))),c&&o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiButtonIcon,{"data-test-subj":"infraCriterionButton","aria-label":n.i18n.translate("xpack.infra.logs.alertFlyout.removeCondition",{defaultMessage:"Remove condition"}),color:"danger",iconType:"trash",onClick:t=>{t.stopPropagation(),s(e)}})))};var M=r(201),P=r.n(M),R=r(81),_=r(151),L=r(236),z=r(22),A=r(121),B=r(31),G=r(53),I=r(119);const V=async(e,t,r,a,n)=>{const i=await t(A.a,{method:"POST",body:JSON.stringify(A.r.encode({data:{logView:e,alertParams:r,buckets:a,executionTimeRange:n}})),version:"1"});return Object(m.b)(A.s)(i)};var N=r(149);const Q=({ruleParams:e,chartCriterion:t,logViewReference:r,showThreshold:a,executionTimeRange:n,annotations:l,filterSeriesByGroupName:s})=>{const c=Object(i.useMemo)((()=>{const{field:r,comparator:a,value:n}=t,i={criteria:r&&a&&n?[{field:r,comparator:a,value:n}]:[],count:{comparator:e.count.comparator,value:e.count.value},timeSize:e.timeSize,timeUnit:e.timeUnit,groupBy:e.groupBy};try{return Object(m.b)(A.q)(i)}catch(e){return null}}),[e.timeSize,e.timeUnit,e.groupBy,e.count.comparator,e.count.value,t]);return null===c||0===c.criteria.length?null:o.a.createElement(D,{buckets:null!=n&&n.buckets?n.buckets:c.groupBy&&0!==c.groupBy.length?L.d/4:L.d,logViewReference:r,threshold:e.count,chartAlertParams:c,showThreshold:a,executionTimeRange:n,annotations:l,filterSeriesByGroupName:s})},D=({buckets:e,logViewReference:t,threshold:r,chartAlertParams:l,showThreshold:s,executionTimeRange:c,annotations:u,filterSeriesByGroupName:m})=>{const p=Object(_.a)(),g=Object(N.a)(),{getChartPreviewData:f,isLoading:b,hasError:E,chartPreviewData:v}=(({logViewReference:e,ruleParams:t,buckets:r,executionTimeRange:a,filterSeriesByGroupName:n})=>{const{http:o}=Object(B.useKibana)().services,[l,s]=Object(i.useState)([]),[c,u]=Object(i.useState)(!1),[d,m]=Object(I.b)({cancelPreviousOn:"creation",createPromise:async()=>{if(u(!1),Object(G.e)(t.criteria)){var i;const c=await Promise.all([V(e,o.fetch,{...t,criteria:[...t.criteria[0]]},r,a),V(e,o.fetch,{...t,criteria:[...t.criteria[1]]},r,a)]);let u=c[0].data.series[0].points,d=c[1].data.series[0].points,m="ratio";var l,s;null!==(i=t.groupBy)&&void 0!==i&&i.length&&n&&(m=n,u=(null===(l=c[0].data.series.find((e=>e.id===n)))||void 0===l?void 0:l.points)||[],d=(null===(s=c[1].data.series.find((e=>e.id===n)))||void 0===s?void 0:s.points)||[]);const p=[];for(let e=0;e<u.length;e++){const t={timestamp:u[e].timestamp,value:0};if(0===u[e].value||0===d[e].value)p.push(t);else{const r=u[e].value/d[e].value;p.push({...t,value:r})}}return{data:{series:[{id:m,points:p}]}}}return await V(e,o.fetch,t,r,a)},onResolve:({data:{series:e}})=>{u(!1),s(e)},onReject:e=>{u(!0)}},[e,o,t,r]);return{chartPreviewData:l,hasError:c,isLoading:Object(i.useMemo)((()=>"pending"===d.state),[d.state]),getChartPreviewData:m}})({logViewReference:t,ruleParams:l,buckets:e,executionTimeRange:c});P()((()=>{f()}),500,[f]);const{timeSize:y,timeUnit:h,groupBy:O}=l,C=!!(O&&O.length>0),T=!!(s&&r&&r.comparator)&&[d.a.GT,d.a.GT_OR_EQ].includes(r.comparator),j=!!(s&&r&&r.comparator)&&[d.a.LT,d.a.LT_OR_EQ].includes(r.comparator),w=Object(i.useMemo)((()=>{if(!C)return v;if(m&&m.length)return v.filter((e=>m===e.id));const e=v.sort(((e,t)=>{const r=Math.max(...e.points.map((e=>e.value)));return Math.max(...t.points.map((e=>e.value)))-r}));return(!T&&!j||T?e:e.reverse()).slice(0,5)}),[C,m,v,T,j]),k=Object(i.useMemo)((()=>w.reduce(((e,t)=>[...e,...t.points.reduce(((e,r)=>[...e,{...r,groupBy:t.id}]),[])]),[])),[w]),S=y*e,F=v.length>0,{yMin:M,yMax:A,xMin:Q,xMax:D}=Object(L.g)(w,!1),U={max:s&&r?1.1*Math.max(A,r.value):1.1*A,min:s&&r?Math.min(M,r.value):M};s&&r&&U.min===r.value&&(U.min=.9*U.min);const W=O&&O.length>0?O.join(", "):null,H=Object(L.i)(Q,D),$=L.f[h];return b?o.a.createElement(L.c,null):E?o.a.createElement(L.b,null):F?o.a.createElement(o.a.Fragment,null,o.a.createElement(L.a,null,o.a.createElement(R.Chart,null,o.a.createElement(R.BarSeries,{id:"criterion-preview",xScaleType:R.ScaleType.Time,yScaleType:R.ScaleType.Linear,xAccessor:"timestamp",yAccessors:["value"],splitSeriesAccessors:["groupBy"],stackAccessors:void 0,data:k,barSeriesStyle:{rectBorder:{stroke:C?void 0:Object(z.b)(z.a.color0),strokeWidth:1,visible:!0},rect:{opacity:1}},color:C?void 0:Object(z.b)(z.a.color0),timeZone:g}),s&&r?o.a.createElement(R.LineAnnotation,{id:"threshold-line",domainType:R.AnnotationDomainType.YDomain,dataValues:[{dataValue:r.value}],style:{line:{strokeWidth:2,stroke:Object(z.b)(z.a.color1),opacity:1}}}):null,s&&r&&j?o.a.createElement(R.RectAnnotation,{id:"below-threshold",style:{fill:Object(z.b)(z.a.color1),opacity:.3},dataValues:[{coordinates:{x0:Q,x1:D,y0:U.min,y1:r.value}}]}):null,u,s&&r&&T?o.a.createElement(R.RectAnnotation,{id:"above-threshold",style:{fill:Object(z.b)(z.a.color1),opacity:.3},dataValues:[{coordinates:{x0:Q,x1:D,y0:r.value,y1:U.max}}]}):null,o.a.createElement(R.Axis,{id:"timestamp",position:R.Position.Bottom,showOverlappingTicks:!0,tickFormat:H}),o.a.createElement(R.Axis,{id:"values",position:R.Position.Left,tickFormat:L.j,domain:U}),o.a.createElement(R.Settings,{baseTheme:p.baseTheme,theme:{chartMargins:{top:35}},locale:n.i18n.getLocale()}),o.a.createElement(R.Tooltip,L.h))),!c&&o.a.createElement("div",{style:{textAlign:"center"}},null!=W?o.a.createElement(a.EuiText,{size:"xs",color:"subdued"},o.a.createElement(x.FormattedMessage,{id:"xpack.infra.logs.alerts.dataTimeRangeLabelWithGrouping",defaultMessage:"Last {lookback} {timeLabel} of data, grouped by {groupByLabel} (showing {displayedGroups}/{totalGroups} groups)",values:{groupByLabel:W,timeLabel:$,lookback:S,displayedGroups:w.length,totalGroups:v.length}})):o.a.createElement(a.EuiText,{size:"xs",color:"subdued"},o.a.createElement(x.FormattedMessage,{id:"xpack.infra.logs.alerts.dataTimeRangeLabel",defaultMessage:"Last {lookback} {timeLabel} of data",values:{timeLabel:$,lookback:S}})))):o.a.createElement(L.e,null)},U=n.i18n.translate("xpack.infra.logs.alerting.threshold.ratioCriteriaQueryAText",{defaultMessage:"Query A"}),W=n.i18n.translate("xpack.infra.logs.alerting.threshold.ratioCriteriaQueryBText",{defaultMessage:"Query B"}),H=e=>{const{criteria:t,errors:r}=e;return t&&0!==t.length?Object(d.k)(t)?o.a.createElement(q,h()({},e,{criteria:t,errors:r})):o.a.createElement(J,h()({},e,{criteria:t,errors:r})):null},$=e=>{const{updateCriterion:t,removeCriterion:r,addCriterion:n,criteria:i,fields:l,errors:s,ruleParams:c,logViewReference:u,isRatio:d=!1}=e;return o.a.createElement(a.EuiFlexGroup,{gutterSize:"s"},o.a.createElement(a.EuiFlexItem,{grow:!0},i.map(((e,n)=>o.a.createElement(a.EuiAccordion,{id:`criterion-${n}`,buttonContent:o.a.createElement(F,{idx:n,fields:l,criterion:e,updateCriterion:t,removeCriterion:r,canDelete:i.length>1,errors:s[n]}),key:n,arrowDisplay:"right"},o.a.createElement(Q,{ruleParams:c,chartCriterion:e,logViewReference:u,showThreshold:!d})))),o.a.createElement(Z,{addCriterion:n})))},q=e=>{const{criteria:t,defaultCriterion:r,errors:n,updateCriteria:l}=e,s=Object(i.useCallback)((e=>{const r=[e,Object(d.g)(t)];l(r)}),[l,t]),c=Object(i.useCallback)((e=>{const r=[Object(d.h)(t),e];l(r)}),[l,t]),{updateCriterion:u,addCriterion:m,removeCriterion:p}=Y(Object(d.h)(t),r,s),{updateCriterion:g,addCriterion:f,removeCriterion:b}=Y(Object(d.g)(t),r,c);return o.a.createElement(o.a.Fragment,null,o.a.createElement(a.EuiSpacer,{size:"xxl"}),o.a.createElement(fe,{text:U}),o.a.createElement($,h()({},e,{criteria:Object(d.h)(t),updateCriterion:u,addCriterion:m,removeCriterion:p,errors:n[0],isRatio:!0})),o.a.createElement(a.EuiSpacer,{size:"l"}),o.a.createElement(fe,{text:W}),o.a.createElement($,h()({},e,{criteria:Object(d.g)(t),updateCriterion:g,addCriterion:f,removeCriterion:b,errors:n[1],isRatio:!0})))},J=e=>{const{criteria:t,defaultCriterion:r,updateCriteria:a,errors:n}=e,{updateCriterion:i,addCriterion:l,removeCriterion:s}=Y(t,r,a);return o.a.createElement($,h()({},e,{updateCriterion:i,addCriterion:l,removeCriterion:s,errors:n[0]}))},Y=(e,t,r)=>({updateCriterion:Object(i.useCallback)(((t,a)=>{const n=e.map(((e,r)=>t===r?{...e,...a}:e));r(n)}),[e,r]),addCriterion:Object(i.useCallback)((()=>{const a=[...e,t];r(a)}),[e,t,r]),removeCriterion:Object(i.useCallback)((t=>{const a=e.filter(((e,r)=>r!==t));r(a)}),[e,r])}),Z=({addCriterion:e})=>o.a.createElement("div",null,o.a.createElement(a.EuiButtonEmpty,{"data-test-subj":"infraAddCriterionButtonAddConditionButton",color:"primary",iconSide:"left",flush:"left",iconType:"plusInCircleFilled",onClick:e},o.a.createElement(x.FormattedMessage,{id:"xpack.infra.logs.alertFlyout.addCondition",defaultMessage:"Add condition"}))),K=n.i18n.translate("xpack.infra.logs.alertFlyout.thresholdPrefix",{defaultMessage:"is"}),X=n.i18n.translate("xpack.infra.logs.alertFlyout.thresholdPopoverTitle",{defaultMessage:"Threshold"}),ee=({comparator:e,value:t,updateThreshold:r,errors:n})=>{const[l,s]=Object(i.useState)(!1);return o.a.createElement(a.EuiFlexGroup,{gutterSize:"s"},o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiPopover,{id:"threshold",button:o.a.createElement(a.EuiExpression,{description:K,uppercase:!0,value:`${e?d.b[e]:""} ${"number"==typeof t?t:""}`,isActive:l,onClick:()=>s(!l)}),isOpen:l,closePopover:()=>s(!1),ownFocus:!0,panelPaddingSize:"s",anchorPosition:"downLeft"},o.a.createElement(o.a.Fragment,null,o.a.createElement(a.EuiPopoverTitle,null,X),o.a.createElement(a.EuiFlexGroup,null,o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiFormRow,null,o.a.createElement(a.EuiSelect,{"data-test-subj":"infraThresholdSelect",compressed:!0,value:e,onChange:e=>r({comparator:e.target.value}),options:[{value:d.a.LT,text:d.b[d.a.LT]},{value:d.a.LT_OR_EQ,text:d.b[d.a.LT_OR_EQ]},{value:d.a.GT,text:d.b[d.a.GT]},{value:d.a.GT_OR_EQ,text:d.b[d.a.GT_OR_EQ]}]}))),o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiFormRow,{isInvalid:n.value.length>0,error:n.value},o.a.createElement(a.EuiFieldNumber,{"data-test-subj":"infraThresholdFieldNumber",compressed:!0,value:t,onChange:e=>{const t=parseFloat(e.target.value);r({value:Object(O.isNumber)(t)&&Object(O.isFinite)(t)?t:void 0})}}))))))))},te=n.i18n.translate("xpack.infra.logs.alertFlyout.thresholdTypePrefix",{defaultMessage:"when the"}),re=n.i18n.translate("xpack.infra.logs.alertFlyout.thresholdTypeCountSuffix",{defaultMessage:"of log entries"}),ae=n.i18n.translate("xpack.infra.logs.alertFlyout.thresholdTypeRatioSuffix",{defaultMessage:"of Query A to Query B"}),ne=n.i18n.translate("xpack.infra.logs.alertFlyout.thresholdTypeCount",{defaultMessage:"count"}),ie=n.i18n.translate("xpack.infra.logs.alertFlyout.thresholdTypeRatio",{defaultMessage:"ratio"}),oe=({criteria:e,updateType:t})=>{const[r,n]=Object(i.useState)(!1),l=(e=>Object(d.k)(e)?"ratio":"count")(e);return o.a.createElement(a.EuiFlexGroup,{gutterSize:"s"},o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiPopover,{id:"thresholdType",button:o.a.createElement(o.a.Fragment,null,o.a.createElement(a.EuiExpression,{description:te,uppercase:!0,value:"ratio"===l?ie:ne,isActive:r,onClick:()=>n(!r)}),o.a.createElement(fe,{text:"ratio"===l?ae.toUpperCase():re.toUpperCase()})),isOpen:r,closePopover:()=>n(!1),ownFocus:!0,panelPaddingSize:"s",anchorPosition:"downLeft"},o.a.createElement(a.EuiFlexGroup,null,o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiSelect,{"data-test-subj":"infraTypeSwitcherSelect",compressed:!0,value:l,onChange:e=>t("ratio"===l?"count":"ratio"),options:[{value:"ratio",text:ie},{value:"count",text:ne}]}))))))},le=n.i18n.translate("xpack.infra.logs.alertFlyout.logViewDescription",{defaultMessage:"Log View"}),se=({logView:e})=>o.a.createElement(a.EuiFlexGroup,{gutterSize:"s"},o.a.createElement(a.EuiFlexItem,{grow:!1},o.a.createElement(a.EuiToolTip,{content:e.indices},o.a.createElement(a.EuiExpression,{description:le,value:e.name})))),ce={timeSize:5,timeUnit:"m"},ue="log.level",de=(e,t)=>e.some((e=>e.name===ue))?{field:ue,comparator:d.a.EQ,value:t}:{field:void 0,comparator:void 0,value:void 0},me=e=>{var t,r;const a=null!==(t=null===(r=e.metadata)||void 0===r?void 0:r.isInternal)&&void 0!==t&&t,{services:{logsShared:n}}=Object(p.c)();return o.a.createElement(o.a.Fragment,null,a?o.a.createElement(pe,e,o.a.createElement(ge,e)):o.a.createElement(u.LogViewProvider,{logViews:n.logViews.client,initialLogViewReference:e.ruleParams.logView},o.a.createElement(pe,e,o.a.createElement(ge,e))))},pe=({children:e})=>{const{load:t,isLoading:r,hasFailedLoading:i,isUninitialized:l}=Object(u.useLogViewContext)();return o.a.createElement(o.a.Fragment,null,r||l?o.a.createElement("div",null,o.a.createElement(a.EuiSpacer,{size:"m"}),o.a.createElement(a.EuiLoadingSpinner,{size:"l"}),o.a.createElement(a.EuiSpacer,{size:"m"})):i?o.a.createElement(a.EuiCallOut,{title:n.i18n.translate("xpack.infra.logs.alertFlyout.sourceStatusError",{defaultMessage:"Sorry, there was a problem loading field information"}),color:"danger",iconType:"warning"},o.a.createElement(a.EuiButton,{"data-test-subj":"infraSourceStatusWrapperTryAgainButton",onClick:t,iconType:"refresh"},n.i18n.translate("xpack.infra.logs.alertFlyout.sourceStatusErrorTryAgain",{defaultMessage:"Try again"}))):e)},ge=e=>{var t,r;const{setRuleParams:l,ruleParams:p,errors:g}=e,[f,b]=Object(i.useState)(!1),{logViewReference:y,resolvedLogView:h}=Object(u.useLogViewContext)();if("log-view-reference"!==y.type)throw new Error("The Log Threshold rule type only supports persisted Log Views");const{criteria:x,threshold:O,timeSizeUnit:C,timeWindowSize:T}=Object(i.useMemo)((()=>Object(m.b)(v.a)(g)),[g]),j=Object(i.useMemo)((()=>null!=h&&h.fields?h.fields.filter((e=>("string"===e.type||"number"===e.type)&&e.searchable)):[]),[h]),w=Object(i.useMemo)((()=>null!=h&&h.fields?h.fields.filter((e=>"string"===e.type&&e.aggregatable)):[]),[h]),k=Object(i.useCallback)((e=>{const t={...p.count,...e};l("count",t)}),[p.count,l]),S=Object(i.useCallback)((e=>{l("criteria",e)}),[l]),F=Object(i.useCallback)((e=>{l("timeSize",e)}),[l]),M=Object(i.useCallback)((e=>{d.o.is(e)&&l("timeUnit",e)}),[l]),P=Object(i.useCallback)((e=>{l("groupBy",e)}),[l]),R=Object(i.useMemo)((()=>{return e=j,t=y,{...ce,logView:t,count:{value:75,comparator:d.a.GT},criteria:[de(e,"error")]};var e,t}),[j,y]),_=Object(i.useCallback)((e=>{const t="count"===e?R:(r=j,a=y,{...ce,logView:a,count:{value:2,comparator:d.a.GT},criteria:[[de(r,"error")],[de(r,"warning")]]});var r,a;l("count",t.count),l("criteria",t.criteria)}),[R,l,j,y]);s()((()=>{const e={...R,...p};for(const[t,r]of Object.entries(e))l(t,r);b(!0)}));const L=Object(i.useMemo)((()=>p.groupBy&&p.groupBy.length>0&&p.count&&!Object(d.j)(p.count.comparator,p.count.value)),[p]);if(!f)return null;const z=p.criteria?o.a.createElement(H,{fields:j,criteria:p.criteria,defaultCriterion:R.criteria[0],errors:x,ruleParams:p,logViewReference:y,updateCriteria:S}):null;return o.a.createElement(o.a.Fragment,null,h&&o.a.createElement(se,{logView:h}),o.a.createElement(oe,{criteria:p.criteria||[],updateType:_}),p.criteria&&!Object(d.k)(p.criteria)&&z,o.a.createElement(ee,{comparator:null===(t=p.count)||void 0===t?void 0:t.comparator,value:null===(r=p.count)||void 0===r?void 0:r.value,updateThreshold:k,errors:O}),o.a.createElement(c.ForLastExpression,{timeWindowSize:p.timeSize,timeWindowUnit:p.timeUnit,onChangeWindowSize:F,onChangeWindowUnit:M,errors:{timeWindowSize:T,timeSizeUnit:C}}),o.a.createElement(E,{selectedGroups:p.groupBy,onChange:P,fields:w}),p.criteria&&Object(d.k)(p.criteria)&&z,L&&o.a.createElement(o.a.Fragment,null,o.a.createElement(a.EuiSpacer,{size:"l"}),o.a.createElement(a.EuiCallOut,{color:"warning"},n.i18n.translate("xpack.infra.logs.alertFlyout.groupByOptimizationWarning",{defaultMessage:'When setting a "group by" we highly recommend using the "{comparator}" comparator for your threshold. This can lead to significant performance improvements.',values:{comparator:d.a.GT}}))),o.a.createElement(a.EuiSpacer,{size:"l"}))};t.default=me;const fe=({text:e})=>o.a.createElement("div",{className:"euiExpression euiExpression-isUppercase euiExpression--success"},o.a.createElement("span",{className:"euiExpression__description"},e))}}]);