/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.infra_bundle_jsonpfunction=window.infra_bundle_jsonpfunction||[]).push([[16],{233:function(e,t,a){"use strict";a.d(t,"a",(function(){return s}));var r=a(40),l=a(1),i=a(3),n=a.n(i),o=a(116);const s=({options:e,onChange:t,errorOptions:a})=>{var s;const{metricsView:c}=Object(o.c)(),u=Object(i.useCallback)((e=>{const a=e.map((e=>e.label));t(a)}),[t]),d=Array.isArray(e.groupBy)?e.groupBy.map((e=>({label:e,color:null!=a&&a.includes(e)?"danger":void 0}))):e.groupBy?[{label:e.groupBy,color:null!=a&&a.includes(e.groupBy)?"danger":void 0}]:[],m=(null!==(s=null==c?void 0:c.fields)&&void 0!==s?s:[]).filter((e=>e.aggregatable&&"string"===e.type)).map((e=>({label:e.name})));return n.a.createElement(r.EuiComboBox,{"data-test-subj":"metricsExplorer-groupBy",placeholder:l.i18n.translate("xpack.infra.metricsExplorer.groupByLabel",{defaultMessage:"Everything"}),"aria-label":l.i18n.translate("xpack.infra.metricsExplorer.groupByAriaLabel",{defaultMessage:"Graph per"}),fullWidth:!0,singleSelection:!1,selectedOptions:d,options:m,onChange:u,isClearable:!0})}},643:function(e,t,a){"use strict";a.r(t),a.d(t,"defaultExpression",(function(){return U})),a.d(t,"Expressions",(function(){return P}));var r=a(3),l=a.n(r),i=a(40),n=a(1),o=a(73),s=a(13),c=a(88),u=a(28),d=a(35),m=a(17),g=a(116),p=a(30),E=a(233),f=a(174),b=a(175),h=a(74),y=a(152),x=a.n(y),v=a(83);const T=(e,t)=>{const a=t?new RegExp(/0?\./):".",r=String(e).replace(a,"").length;return parseFloat((t?100*e:e/100).toPrecision(r))};let C=function(e){return e.COUNT="count",e.AVERAGE="avg",e.SUM="sum",e.MIN="min",e.MAX="max",e.RATE="rate",e.CARDINALITY="cardinality",e.P95="p95",e.P99="p99",e.CUSTOM="custom",e}({});var F=a(121);const O=n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.equationHelpMessage",{defaultMessage:"Supports basic math expressions"}),k=n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.labelLabel",{defaultMessage:"Label (optional)"}),j=n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.labelHelpMessage",{defaultMessage:"Custom label will show on the alert chart and in reason/alert title"}),M=n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquation",{defaultMessage:"Custom equation"}),w=n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.deleteRowButton",{defaultMessage:"Delete"}),R=({onDelete:e,disableDelete:t})=>l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiFlexItem,{grow:0},l.a.createElement(i.EuiButtonIcon,{"data-test-subj":"infraMetricRowControlsButton",iconType:"trash",color:"danger",style:{marginBottom:"0.2em"},onClick:e,disabled:t,title:w}))),S=({name:e,aggType:t=m.a.AVERAGE,field:a,onDelete:o,disableDelete:c,fields:u,aggregationTypes:d,onChange:g,errors:p})=>{const E=Object(r.useCallback)((()=>{o(e)}),[e,o]),f=Object(r.useMemo)((()=>u.reduce(((e,a)=>(t&&d[t].validNormalizedTypes.includes(a.normalizedType)&&e.push({label:a.name}),e)),[])),[u,d,t]),b=Object(r.useMemo)((()=>Object.values(d).map((e=>({text:e.text,value:e.value})))),[d]),h=Object(r.useCallback)((a=>{g({name:e,field:a.length&&a[0].label||void 0,aggType:t})}),[e,t,g]),y=Object(r.useCallback)((t=>{const r=t.target.value;g({name:e,field:r===m.a.COUNT?void 0:a,aggType:r})}),[e,a,g]),x=null!=Object(s.get)(p,["customMetrics",e,"aggType"]),v=null!=Object(s.get)(p,["customMetrics",e,"field"])||!a;return l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiFlexGroup,{gutterSize:"xs",alignItems:"flexEnd"},l.a.createElement(i.EuiFlexItem,{style:{maxWidth:145}},l.a.createElement(i.EuiFormRow,{label:n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.aggregationLabel",{defaultMessage:"Aggregation {name}",values:{name:e}}),isInvalid:x},l.a.createElement(i.EuiSelect,{"data-test-subj":"infraMetricRowWithAggSelect",compressed:!0,options:b,value:t,isInvalid:x,onChange:y}))),l.a.createElement(i.EuiFlexItem,null,l.a.createElement(i.EuiFormRow,{label:n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.fieldLabel",{defaultMessage:"Field {name}",values:{name:e}}),isInvalid:v},l.a.createElement(i.EuiComboBox,{fullWidth:!0,compressed:!0,isInvalid:v,singleSelection:{asPlainText:!0},options:f,selectedOptions:a?[{label:a}]:[],onChange:h}))),l.a.createElement(R,{onDelete:E,disableDelete:c})),l.a.createElement(i.EuiHorizontalRule,{margin:"xs"}))},A=({name:e,agg:t,filter:a,onDelete:o,disableDelete:s,onChange:c,aggregationTypes:u})=>{const d=Object(r.useMemo)((()=>Object.values(u).filter((e=>e.value!==m.a.CUSTOM)).map((e=>({text:e.text,value:e.value})))),[u]),g=Object(r.useCallback)((()=>{o(e)}),[e,o]),p=Object(r.useCallback)((t=>{c({name:e,filter:a,aggType:t.target.value})}),[e,a,c]),E=Object(r.useCallback)((a=>{c({name:e,filter:a,aggType:t})}),[e,t,c]);return l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiFlexGroup,{gutterSize:"xs",alignItems:"flexEnd"},l.a.createElement(i.EuiFlexItem,{style:{maxWidth:145}},l.a.createElement(i.EuiFormRow,{label:n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.aggregationLabel",{defaultMessage:"Aggregation {name}",values:{name:e}})},l.a.createElement(i.EuiSelect,{"data-test-subj":"infraMetricRowWithCountSelect",compressed:!0,options:d,value:t,onChange:p}))),l.a.createElement(i.EuiFlexItem,null,l.a.createElement(i.EuiFormRow,{label:n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.filterLabel",{defaultMessage:"KQL Filter {name}",values:{name:e}})},l.a.createElement(f.a,{placeholder:" ",compressed:!0,onChange:E,onSubmit:E,value:a}))),l.a.createElement(R,{onDelete:g,disableDelete:s})),l.a.createElement(i.EuiHorizontalRule,{margin:"xs"}))},z={name:"A",aggType:m.a.AVERAGE},B=Object(s.range)(65,91).map((e=>String.fromCharCode(e))),q=({onChange:e,expression:t,fields:a,aggregationTypes:c,errors:u})=>{var d;const[g,p]=Object(r.useState)(null!==(d=null==t?void 0:t.customMetrics)&&void 0!==d?d:[z]),[E,f]=Object(r.useState)((null==t?void 0:t.label)||void 0),[b,h]=Object(r.useState)((null==t?void 0:t.equation)||void 0),y=Object(r.useMemo)((()=>Object(s.debounce)(e,500)),[e]),x=Object(r.useCallback)((()=>{p((e=>{var a;const r=null!==(a=null==e?void 0:e.map((e=>e.name)))&&void 0!==a?a:[],l=Object(s.first)(Object(s.xor)(B,r)),i=[...e||[],{...z,name:l}];return y({...t,customMetrics:i,equation:b,label:E}),i}))}),[y,b,t,E]),v=Object(r.useCallback)((e=>{p((a=>{var r;const l=null!==(r=null==a?void 0:a.filter((t=>t.name!==e)))&&void 0!==r?r:[z],i=l.length&&l||[z];return y({...t,customMetrics:i,equation:b,label:E}),i}))}),[b,t,y,E]),T=Object(r.useCallback)((e=>{p((a=>{const r=null==a?void 0:a.map((t=>t.name===e.name?e:t));return y({...t,customMetrics:r,equation:b,label:E}),r}))}),[b,t,y,E]),C=Object(r.useCallback)((e=>{h(e.target.value),y({...t,customMetrics:g,equation:e.target.value,label:E})}),[y,t,g,E]),w=Object(r.useCallback)((e=>{f(e.target.value),y({...t,customMetrics:g,equation:b,label:e.target.value})}),[y,t,g,b]),R=26===(null==g?void 0:g.length),q=1===(null==g?void 0:g.length),I=Object(s.omit)(c,F.k),D=null==g?void 0:g.map((e=>e.aggType===m.a.COUNT?l.a.createElement(A,{key:e.name,name:e.name,agg:e.aggType,filter:e.filter,onAdd:x,onDelete:v,disableAdd:R,aggregationTypes:I,disableDelete:q,onChange:T,errors:u}):l.a.createElement(S,{key:e.name,name:e.name,aggType:e.aggType,aggregationTypes:I,field:e.field,fields:a,onAdd:x,onDelete:v,disableAdd:R,disableDelete:q,onChange:T,errors:u}))),N=Object(r.useMemo)((()=>null==g?void 0:g.map((e=>e.name)).join(" + ")),[g]);return l.a.createElement("div",{style:{minWidth:"100%"}},l.a.createElement(i.EuiSpacer,{size:"s"}),D,l.a.createElement(i.EuiFlexGroup,null,l.a.createElement(i.EuiButtonEmpty,{"data-test-subj":"infraCustomEquationEditorAddAggregationFieldButton",color:"primary",flush:"left",size:"xs",iconType:"plusInCircleFilled",onClick:x,isDisabled:R},l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.customEquationEditor.addCustomRow",defaultMessage:"Add aggregation/field"}))),l.a.createElement(i.EuiSpacer,{size:"m"}),l.a.createElement(i.EuiFlexGroup,null,l.a.createElement(i.EuiFlexItem,null,l.a.createElement(i.EuiFormRow,{label:n.i18n.translate("xpack.infra.metrics.alertFlyout.customEquationEditor.equation",{defaultMessage:"Equation"}),fullWidth:!0,helpText:O,isInvalid:null!=u.equation,error:[u.equation]},l.a.createElement(i.EuiFieldText,{"data-test-subj":"infraCustomEquationEditorFieldText",isInvalid:null!=u.equation,compressed:!0,fullWidth:!0,placeholder:N,onChange:C,value:null!=b?b:""})))),l.a.createElement(i.EuiSpacer,{size:"s"}),l.a.createElement(i.EuiFlexGroup,null,l.a.createElement(i.EuiFlexItem,null,l.a.createElement(i.EuiFormRow,{label:k,fullWidth:!0,helpText:j},l.a.createElement(i.EuiFieldText,{"data-test-subj":"infraCustomEquationEditorFieldText",compressed:!0,fullWidth:!0,value:E,placeholder:M,onChange:w})))))},I=h.euiStyled.div`margin: 0 -4px;`,D=h.euiStyled.div`
  padding: 0 4px;
`,N=Object(h.euiStyled)(i.EuiHealth)`
  margin-left: 4px;
`,G=({children:e,setRuleParams:t,expression:a,errors:d,expressionId:p,remove:E,canDelete:f})=>{var b,h,y;const[v,F]=x()(!0),{metricsView:O}=Object(g.c)(),{aggType:k=C.MAX,metric:j,comparator:M=u.a.GREATER_THAN,threshold:w=[],warningThreshold:R=[],warningComparator:S}=a,[A,z]=Object(r.useState)(Boolean(null==R?void 0:R.length)),B=Object(r.useMemo)((()=>Boolean(j&&j.endsWith(".pct"))),[j]),G=Object(r.useCallback)((e=>{t(p,{...a,aggType:e,metric:["custom","count"].includes(e)?void 0:a.metric,customMetrics:"custom"===e?a.customMetrics:void 0,equation:"custom"===e?a.equation:void 0,label:"custom"===e?a.label:void 0})}),[p,a,t]),U=Object(r.useCallback)((e=>{t(p,{...a,metric:e})}),[p,a,t]),P=Object(r.useCallback)((e=>{t(p,{...a,comparator:e})}),[p,a,t]),Q=Object(r.useCallback)((e=>{t(p,{...a,warningComparator:e})}),[p,a,t]),V=Object(r.useCallback)((e=>B?e.map((e=>(e=>T(e,!1))(e))):e),[B]),H=Object(r.useCallback)((e=>{const r=V(e);r.join()!==a.threshold.join()&&t(p,{...a,threshold:r})}),[p,a,V,t]),$=Object(r.useCallback)((e=>{var r;const l=V(e);l.join()!==(null===(r=a.warningThreshold)||void 0===r?void 0:r.join())&&t(p,{...a,warningThreshold:l})}),[p,a,V,t]),_=Object(r.useCallback)((()=>{A?(z(!1),t(p,Object(s.omit)(a,"warningComparator","warningThreshold"))):(z(!0),t(p,{...a,warningComparator:M,warningThreshold:[]}))}),[A,z,t,M,a,p]),K=Object(r.useCallback)((e=>{t(p,e)}),[p,t]),X=l.a.createElement(L,{comparator:M,threshold:w,updateComparator:P,updateThreshold:H,errors:null!==(b=d.critical)&&void 0!==b?b:{},isMetricPct:B}),Y=A&&l.a.createElement(L,{comparator:S||M,threshold:R,updateComparator:Q,updateThreshold:$,errors:null!==(h=d.warning)&&void 0!==h?h:{},isMetricPct:B}),J=(null!==(y=null==O?void 0:O.fields)&&void 0!==y?y:[]).map((e=>({normalizedType:e.type,name:e.name})));return l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiFlexGroup,{gutterSize:"xs"},l.a.createElement(i.EuiFlexItem,{grow:!1},l.a.createElement(i.EuiButtonIcon,{iconType:v?"arrowDown":"arrowRight",onClick:F,"data-test-subj":"expandRow","aria-label":n.i18n.translate("xpack.infra.metrics.alertFlyout.expandRowLabel",{defaultMessage:"Expand row."})})),l.a.createElement(i.EuiFlexItem,{grow:!0},l.a.createElement(i.EuiFlexGroup,{component:I,gutterSize:"custom"!==k?"l":"m",alignItems:"center",wrap:!0},l.a.createElement(D,null,l.a.createElement(c.WhenExpression,{customAggTypesOptions:W,aggType:k,onChangeSelectedAggType:G})),!["count","custom"].includes(k)&&l.a.createElement(D,null,l.a.createElement(c.OfExpression,{customAggTypesOptions:W,aggField:j,fields:J,aggType:k,errors:d,onChangeSelectedAggField:U,helpText:l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.ofExpression.helpTextDetail",defaultMessage:"Can't find a metric? {documentationLink}.",values:{documentationLink:l.a.createElement(i.EuiLink,{"data-test-subj":"infraExpressionRowLearnHowToAddMoreDataLink",href:"https://www.elastic.co/guide/en/observability/current/configure-settings.html",target:"BLANK"},l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.ofExpression.popoverLinkLabel",defaultMessage:"Learn how to add more data"}))}}),"data-test-subj":"ofExpression"})),!A&&X,!A&&l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiSpacer,{size:"xs"}),l.a.createElement(i.EuiFlexGroup,{component:I,alignItems:"center"},l.a.createElement(i.EuiButtonEmpty,{"data-test-subj":"infraExpressionRowAddWarningThresholdButton",color:"primary",flush:"left",size:"xs",iconType:"plusInCircleFilled",onClick:_},l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.addWarningThreshold",defaultMessage:"Add warning threshold"}))))),A&&l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiFlexGroup,{component:I,alignItems:"center"},X,l.a.createElement(N,{color:"danger"},l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.criticalThreshold",defaultMessage:"Alert"}))),l.a.createElement(i.EuiFlexGroup,{component:I,alignItems:"center"},Y,l.a.createElement(N,{color:"warning"},l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.warningThreshold",defaultMessage:"Warning"})),l.a.createElement(i.EuiButtonIcon,{"data-test-subj":"infraExpressionRowButton","aria-label":n.i18n.translate("xpack.infra.metrics.alertFlyout.removeWarningThreshold",{defaultMessage:"Remove warningThreshold"}),iconSize:"s",color:"text",iconType:"minusInCircleFilled",onClick:_}))),k===m.a.CUSTOM&&l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiSpacer,{size:"m"}),l.a.createElement(i.EuiFlexGroup,{component:I,alignItems:"center"},l.a.createElement(q,{expression:a,fields:J,aggregationTypes:W,onChange:K,errors:d})),l.a.createElement(i.EuiSpacer,{size:"s"}))),f&&l.a.createElement(i.EuiFlexItem,{grow:!1},l.a.createElement(i.EuiButtonIcon,{"data-test-subj":"infraExpressionRowButton","aria-label":n.i18n.translate("xpack.infra.metrics.alertFlyout.removeCondition",{defaultMessage:"Remove condition"}),color:"danger",iconType:"trash",onClick:()=>E(p)}))),v?l.a.createElement("div",{style:{padding:"0 0 0 28px"}},e):null,l.a.createElement(i.EuiSpacer,{size:"s"}))},L=({updateComparator:e,updateThreshold:t,threshold:a,isMetricPct:n,comparator:o,errors:s})=>{const d=Object(r.useMemo)((()=>n?a.map((e=>(e=>T(e,!0))(e))):a),[a,n]),m=Object(r.useCallback)((()=>o?Object(v.convertToBuiltInComparators)(o):u.a.GREATER_THAN),[o]);return l.a.createElement(l.a.Fragment,null,l.a.createElement(D,null,l.a.createElement(c.ThresholdExpression,{thresholdComparator:m(),threshold:d,onChangeSelectedThresholdComparator:e,onChangeSelectedThreshold:t,errors:s})),n&&l.a.createElement("div",{style:{alignSelf:"center"}},l.a.createElement(i.EuiText,{size:"s"},"%")))},W={avg:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.avg",{defaultMessage:"Average"}),fieldRequired:!0,validNormalizedTypes:["number","histogram"],value:C.AVERAGE},max:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.max",{defaultMessage:"Max"}),fieldRequired:!0,validNormalizedTypes:["number","date","histogram"],value:C.MAX},min:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.min",{defaultMessage:"Min"}),fieldRequired:!0,validNormalizedTypes:["number","date","histogram"],value:C.MIN},cardinality:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.cardinality",{defaultMessage:"Cardinality"}),fieldRequired:!1,value:C.CARDINALITY,validNormalizedTypes:["number","string","ip","date"]},rate:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.rate",{defaultMessage:"Rate"}),fieldRequired:!1,value:C.RATE,validNormalizedTypes:["number"]},count:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.count",{defaultMessage:"Document count"}),fieldRequired:!1,value:C.COUNT,validNormalizedTypes:["number"]},sum:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.sum",{defaultMessage:"Sum"}),fieldRequired:!1,value:C.SUM,validNormalizedTypes:["number","histogram"]},p95:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.p95",{defaultMessage:"95th Percentile"}),fieldRequired:!1,value:C.P95,validNormalizedTypes:["number","histogram"]},p99:{text:n.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.p99",{defaultMessage:"99th Percentile"}),fieldRequired:!1,value:C.P99,validNormalizedTypes:["number","histogram"]},custom:{text:M,fieldRequired:!1,value:C.CUSTOM,validNormalizedTypes:["number","histogram"]}},U={aggType:m.a.AVERAGE,comparator:u.a.GREATER_THAN,threshold:[],timeSize:1,timeUnit:"m"},P=e=>{const{setRuleParams:t,ruleParams:a,errors:h,metadata:y}=e,{docLinks:x}=Object(p.c)().services,{source:v}=Object(g.d)(),{metricsView:T}=Object(g.c)(),[C,F]=Object(r.useState)(1),[O,k]=Object(r.useState)("m"),j=Object(r.useMemo)((()=>{var e;return null!=y&&null!==(e=y.currentOptions)&&void 0!==e&&e.metrics?y.currentOptions:{metrics:[],aggregation:"avg"}}),[y]),M=Object(r.useCallback)(((e,r)=>{const l=a.criteria?a.criteria.slice():[];l[e]=r,t("criteria",l)}),[t,a.criteria]),w=Object(r.useCallback)((()=>{var e;const r=(null===(e=a.criteria)||void 0===e?void 0:e.slice())||[];r.push({...U,timeSize:null!=C?C:U.timeSize,timeUnit:null!=O?O:U.timeUnit}),t("criteria",r)}),[t,a.criteria,C,O]),R=Object(r.useCallback)((e=>{var r;const l=(null===(r=a.criteria)||void 0===r?void 0:r.slice())||[];l.length>1&&(l.splice(e,1),t("criteria",l))}),[t,a.criteria]),S=Object(r.useCallback)((e=>{t("filterQueryText",e);try{t("filterQuery",Object(b.a)(e,null==T?void 0:T.dataViewReference,!1)||"")}catch(e){t("filterQuery",m.d)}}),[t,null==T?void 0:T.dataViewReference]),A=Object(r.useCallback)(Object(s.debounce)(S,500),[S]),z=Object(r.useCallback)((e=>{t("groupBy",e&&e.length?e:"")}),[t]),B=Object(r.useMemo)((()=>({aggField:[],timeSizeUnit:[],timeWindowSize:[]})),[]),q=Object(r.useCallback)((e=>{var r;const l=(null===(r=a.criteria)||void 0===r?void 0:r.map((t=>({...t,timeSize:e}))))||[];F(e||void 0),t("criteria",l)}),[a.criteria,t]),I=Object(r.useCallback)((e=>{var r;const l=(null===(r=a.criteria)||void 0===r?void 0:r.map((t=>({...t,timeUnit:e}))))||[];k(e),t("criteria",l)}),[a.criteria,t]),D=Object(r.useCallback)((()=>{var e,a;const r=y;null!=r&&null!==(e=r.currentOptions)&&void 0!==e&&null!==(a=e.metrics)&&void 0!==a&&a.length?t("criteria",r.currentOptions.metrics.map((e=>({metric:e.field,comparator:u.a.GREATER_THAN,threshold:[],timeSize:C,timeUnit:O,aggType:e.aggregation})))):t("criteria",[U])}),[y,t,C,O]),N=Object(r.useCallback)((()=>{var e,a;const r=y;if(r&&null!==(e=r.currentOptions)&&void 0!==e&&e.filterQuery)t("filterQueryText",r.currentOptions.filterQuery),t("filterQuery",Object(b.a)(r.currentOptions.filterQuery,null==T?void 0:T.dataViewReference)||"");else if(r&&null!==(a=r.currentOptions)&&void 0!==a&&a.groupBy&&r.series){const{groupBy:e}=r.currentOptions,a=Array.isArray(e)?e.map(((e,t)=>{var a,l;return`${e}: "${null===(a=r.series)||void 0===a||null===(l=a.keys)||void 0===l?void 0:l[t]}"`})).join(" and "):`${e}: "${r.series.id}"`;t("filterQueryText",a),t("filterQuery",Object(b.a)(a,null==T?void 0:T.dataViewReference)||"")}}),[y,null==T?void 0:T.dataViewReference,t]),L=Object(r.useCallback)((()=>{var e;const a=y;a&&null!==(e=a.currentOptions)&&void 0!==e&&e.groupBy&&!a.series&&t("groupBy",a.currentOptions.groupBy)}),[y,t]);Object(r.useEffect)((()=>{a.criteria&&a.criteria.length?(F(a.criteria[0].timeSize),k(a.criteria[0].timeUnit)):D(),a.filterQuery||N(),a.groupBy||L(),a.sourceId||t("sourceId",(null==v?void 0:v.id)||"default"),void 0===a.alertOnNoData&&t("alertOnNoData",!0),void 0===a.alertOnGroupDisappear&&t("alertOnGroupDisappear",!0)}),[y,v]);const W=Object(r.useCallback)((e=>S(e.target.value)),[S]),P=Object(r.useMemo)((()=>a.groupBy&&a.groupBy.length>0),[a.groupBy]),V=Object(r.useMemo)((()=>{var e;return null===(e=a.criteria)||void 0===e?void 0:e.every((e=>e.aggType===m.a.COUNT))}),[a.criteria]),H=Object(r.useMemo)((()=>a.groupBy?(Array.isArray(a.groupBy)?a.groupBy:[a.groupBy]).map((e=>({groupName:e,pattern:new RegExp(`{"match(_phrase)?":{"${e}":"(.*?)"}}`)}))):null),[a.groupBy]),$=Object(r.useMemo)((()=>{const{filterQuery:e}=a;return"string"==typeof e&&H?H.map((({groupName:t,pattern:a})=>{if(a.test(e))return t})).filter((e=>"string"==typeof e)):[]}),[a,H]);return l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiSpacer,{size:"m"}),l.a.createElement(i.EuiText,{size:"xs"},l.a.createElement("h4",null,l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.conditions",defaultMessage:"Conditions"}))),l.a.createElement(i.EuiSpacer,{size:"xs"}),T&&a.criteria.map(((e,t)=>{let r=[{aggType:e.aggType,name:String.fromCharCode("A".charCodeAt(0)+t),field:e.metric||""}];return e.customMetrics&&(r=e.customMetrics.map((e=>({name:e.name,aggType:e.aggType,field:e.field||"",filter:e.filter})))),l.a.createElement(G,{canDelete:a.criteria&&a.criteria.length>1||!1,remove:R,addExpression:w,key:t,expressionId:t,setRuleParams:M,errors:h[t]||B,expression:e||{}},l.a.createElement(d.RuleConditionChart,{metricExpression:{metrics:r,threshold:e.threshold,comparator:e.comparator,timeSize:C,timeUnit:O,warningComparator:e.warningComparator,warningThreshold:e.warningThreshold},searchConfiguration:{index:T.dataViewReference.id,query:{query:a.filterQueryText||"",language:"kuery"}},timeRange:{from:`now-${20*(null!=C?C:1)}${O}`,to:"now"},error:h[t]||B,dataView:T.dataViewReference,groupBy:a.groupBy}))})),l.a.createElement("div",{style:{marginLeft:28}},l.a.createElement(c.ForLastExpression,{timeWindowSize:C,timeWindowUnit:O,errors:B,onChangeWindowSize:q,onChangeWindowUnit:I})),l.a.createElement(i.EuiSpacer,{size:"m"}),l.a.createElement("div",null,l.a.createElement(i.EuiButtonEmpty,{"data-test-subj":"infraExpressionsAddConditionButton",color:"primary",iconSide:"left",flush:"left",iconType:"plusInCircleFilled",onClick:w},l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.addCondition",defaultMessage:"Add condition"}))),l.a.createElement(i.EuiSpacer,{size:"m"}),l.a.createElement(i.EuiAccordion,{id:"advanced-options-accordion",buttonContent:n.i18n.translate("xpack.infra.metrics.alertFlyout.advancedOptions",{defaultMessage:"Advanced options"})},l.a.createElement(i.EuiPanel,{color:"subdued"},l.a.createElement(i.EuiCheckbox,{disabled:V,id:"metrics-alert-no-data-toggle",label:l.a.createElement(l.a.Fragment,null,n.i18n.translate("xpack.infra.metrics.alertFlyout.alertOnNoData",{defaultMessage:"Alert me if there's no data"})," ",l.a.createElement(i.EuiIconTip,{type:"questionInCircle",color:"subdued",content:(V?`${Q} `:"")+n.i18n.translate("xpack.infra.metrics.alertFlyout.noDataHelpText",{defaultMessage:"Enable this to trigger the action if the metric(s) do not report any data over the expected time period, or if the alert fails to query Elasticsearch"})})),checked:a.alertOnNoData,onChange:e=>t("alertOnNoData",e.target.checked)}))),l.a.createElement(i.EuiSpacer,{size:"m"}),l.a.createElement(i.EuiFormRow,{label:n.i18n.translate("xpack.infra.metrics.alertFlyout.filterLabel",{defaultMessage:"Filter (optional)"}),helpText:n.i18n.translate("xpack.infra.metrics.alertFlyout.filterHelpText",{defaultMessage:"Use a KQL expression to limit the scope of your alert trigger."}),fullWidth:!0,display:"rowCompressed"},y&&l.a.createElement(f.a,{onChange:A,onSubmit:S,value:a.filterQueryText})||l.a.createElement(i.EuiFieldSearch,{"data-test-subj":"infraExpressionsFieldSearch",onChange:W,value:a.filterQueryText,fullWidth:!0})),l.a.createElement(i.EuiSpacer,{size:"m"}),l.a.createElement(i.EuiFormRow,{label:n.i18n.translate("xpack.infra.metrics.alertFlyout.createAlertPerText",{defaultMessage:"Group alerts by (optional)"}),helpText:n.i18n.translate("xpack.infra.metrics.alertFlyout.createAlertPerHelpText",{defaultMessage:'Create an alert for every unique value. For example: "host.id" or "cloud.region".'}),fullWidth:!0,display:"rowCompressed"},l.a.createElement(E.a,{onChange:z,options:{...j,groupBy:a.groupBy||void 0},errorOptions:$})),$.length>0&&l.a.createElement(l.a.Fragment,null,l.a.createElement(i.EuiSpacer,{size:"s"}),l.a.createElement(i.EuiText,{size:"xs",color:"danger"},l.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.alertPerRedundantFilterError",defaultMessage:"This rule may alert on {matchedGroups} less than expected, because the filter query contains a match for {groupCount, plural, one {this field} other {these fields}}. For more information, refer to {filteringAndGroupingLink}.",values:{matchedGroups:l.a.createElement("strong",null,$.join(", ")),groupCount:$.length,filteringAndGroupingLink:l.a.createElement(i.EuiLink,{"data-test-subj":"infraExpressionsTheDocsLink",href:`${x.links.observability.metricsThreshold}#filtering-and-grouping`},n.i18n.translate("xpack.infra.metrics.alertFlyout.alertPerRedundantFilterError.docsLink",{defaultMessage:"the docs"}))}}))),l.a.createElement(i.EuiSpacer,{size:"s"}),l.a.createElement(i.EuiCheckbox,{id:"metrics-alert-group-disappear-toggle",label:l.a.createElement(l.a.Fragment,null,n.i18n.translate("xpack.infra.metrics.alertFlyout.alertOnGroupDisappear",{defaultMessage:"Alert me if a group stops reporting data"})," ",l.a.createElement(i.EuiIconTip,{type:"questionInCircle",color:"subdued",content:(V?`${Q} `:"")+n.i18n.translate("xpack.infra.metrics.alertFlyout.groupDisappearHelpText",{defaultMessage:"Enable this to trigger the action if a previously detected group begins to report no results. This is not recommended for dynamically scaling infrastructures that may rapidly start and stop nodes automatically."})})),disabled:!P,checked:Boolean(P&&a.alertOnGroupDisappear),onChange:e=>t("alertOnGroupDisappear",e.target.checked)}),l.a.createElement(i.EuiSpacer,{size:"m"}))},Q=n.i18n.translate("xpack.infra.metrics.alertFlyout.docCountNoDataDisabledHelpText",{defaultMessage:"[This setting is not applicable to the Document Count aggregator.]"});t.default=Object(g.e)(P)("default")}}]);