!function(e){function t(t){for(var n,i,o=t[0],r=t[1],s=0,u=[];s<o.length;s++)i=o[s],Object.prototype.hasOwnProperty.call(a,i)&&a[i]&&u.push(a[i][0]),a[i]=0;for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n]);for(l&&l(t);u.length;)u.shift()()}var n={},a={0:0};function i(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.e=function(e){var t=[],n=a[e];if(0!==n)if(n)t.push(n[2]);else{var o=new Promise((function(t,i){n=a[e]=[t,i]}));t.push(n[2]=o);var r,s=document.createElement("script");s.charset="utf-8",s.timeout=120,i.nc&&s.setAttribute("nonce",i.nc),s.src=function(e){return i.p+"eventAnnotation.chunk."+e+".js"}(e);var l=new Error;r=function(t){s.onerror=s.onload=null,clearTimeout(u);var n=a[e];if(0!==n){if(n){var i=t&&("load"===t.type?"missing":t.type),o=t&&t.target&&t.target.src;l.message="Loading chunk "+e+" failed.\n("+i+": "+o+")",l.name="ChunkLoadError",l.type=i,l.request=o,n[1](l)}a[e]=void 0}};var u=setTimeout((function(){r({type:"timeout",target:s})}),12e4);s.onerror=s.onload=r,document.head.appendChild(s)}return Promise.all(t)},i.m=e,i.c=n,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(n,a,function(t){return e[t]}.bind(null,a));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i.oe=function(e){throw console.error(e),e};var o=window.eventAnnotation_bundle_jsonpfunction=window.eventAnnotation_bundle_jsonpfunction||[],r=o.push.bind(o);o.push=t,o=o.slice();for(var s=0;s<o.length;s++)t(o[s]);var l=r;i(i.s=13)}([function(e,t){e.exports=__kbnSharedDeps__.KbnI18n},,function(e,t,n){n.r(t);var a=__kbnBundles__.get("plugin/data/common");Object.defineProperties(t,Object.getOwnPropertyDescriptors(a))},function(e,t){e.exports=__kbnSharedDeps__.Moment},function(e,t){e.exports=__kbnSharedDeps__.Lodash},function(e,t,n){"use strict";n.r(t),n.d(t,"manualPointEventAnnotation",(function(){return o})),n.d(t,"manualRangeEventAnnotation",(function(){return r})),n.d(t,"queryPointEventAnnotation",(function(){return s})),n.d(t,"eventAnnotationGroup",(function(){return l})),n.d(t,"CONTENT_ID",(function(){return u.a})),n.d(t,"ANNOTATIONS_LISTING_VIEW_ID",(function(){return d}));var a=n(0),i=n(7);const o={name:"manual_point_event_annotation",aliases:[],type:"manual_point_event_annotation",help:a.i18n.translate("eventAnnotation.manualAnnotation.description",{defaultMessage:"Configure manual annotation"}),inputTypes:["null"],args:{id:{required:!0,types:["string"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.id",{defaultMessage:"Id for annotation"})},time:{types:["string"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.time",{defaultMessage:"Timestamp for annotation"})},label:{types:["string"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.label",{defaultMessage:"The name of the annotation"})},color:{types:["string"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.color",{defaultMessage:"The color of the line"})},lineStyle:{types:["string"],options:["solid","dotted","dashed"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.lineStyle",{defaultMessage:"The style of the annotation line"})},lineWidth:{types:["number"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.lineWidth",{defaultMessage:"The width of the annotation line"})},icon:{types:["string"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.icon",{defaultMessage:"An optional icon used for annotation lines"}),options:[...Object.values(i.a)],strict:!0},textVisibility:{types:["boolean"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.textVisibility",{defaultMessage:"Visibility of the label on the annotation line"})},isHidden:{types:["boolean"],help:a.i18n.translate("eventAnnotation.manualAnnotation.args.isHidden",{defaultMessage:"Switch to hide annotation"})}},fn:function(e,t){return{type:"manual_point_event_annotation",...t}}},r={name:"manual_range_event_annotation",aliases:[],type:"manual_range_event_annotation",help:a.i18n.translate("eventAnnotation.rangeAnnotation.description",{defaultMessage:"Configure manual annotation"}),inputTypes:["null"],args:{id:{required:!0,types:["string"],help:a.i18n.translate("eventAnnotation.rangeAnnotation.args.id",{defaultMessage:"Id for annotation"})},time:{types:["string"],help:a.i18n.translate("eventAnnotation.rangeAnnotation.args.time",{defaultMessage:"Timestamp for annotation"})},endTime:{types:["string"],help:a.i18n.translate("eventAnnotation.rangeAnnotation.args.endTime",{defaultMessage:"Timestamp for range annotation"}),required:!1},outside:{types:["boolean"],help:"",required:!1},label:{types:["string"],help:a.i18n.translate("eventAnnotation.rangeAnnotation.args.label",{defaultMessage:"The name of the annotation"})},color:{types:["string"],help:a.i18n.translate("eventAnnotation.rangeAnnotation.args.color",{defaultMessage:"The color of the line"})},isHidden:{types:["boolean"],help:a.i18n.translate("eventAnnotation.rangeAnnotation.args.isHidden",{defaultMessage:"Switch to hide annotation"})}},fn:function(e,t){return{type:"manual_range_event_annotation",...t}}},s={name:"query_point_event_annotation",aliases:[],type:"query_point_event_annotation",help:a.i18n.translate("eventAnnotation.queryAnnotation.description",{defaultMessage:"Configure manual annotation"}),inputTypes:["null"],args:{id:{required:!0,types:["string"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.id",{defaultMessage:"The id of the annotation"})},filter:{types:["kibana_query"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.filter",{defaultMessage:"Annotation filter"})},extraFields:{multi:!0,types:["string"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.field",{defaultMessage:"The extra fields of the annotation"})},timeField:{types:["string"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.timeField",{defaultMessage:"The time field of the annotation"})},label:{types:["string"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.label",{defaultMessage:"The name of the annotation"})},color:{types:["string"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.color",{defaultMessage:"The color of the line"})},lineStyle:{types:["string"],options:["solid","dotted","dashed"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.lineStyle",{defaultMessage:"The style of the annotation line"})},lineWidth:{types:["number"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.lineWidth",{defaultMessage:"The width of the annotation line"})},icon:{types:["string"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.icon",{defaultMessage:"An optional icon used for annotation lines"}),options:[...Object.values(i.a)],strict:!0},textVisibility:{types:["boolean"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.textVisibility",{defaultMessage:"Visibility of the label on the annotation line"})},textField:{types:["string"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.textField",{defaultMessage:"Field name used for the annotation label"})},isHidden:{types:["boolean"],help:a.i18n.translate("eventAnnotation.queryAnnotation.args.isHidden",{defaultMessage:"Switch to hide annotation"})}},fn:function(e,t){return{type:"query_point_event_annotation",...t}}};function l(){return{name:"event_annotation_group",aliases:[],type:"event_annotation_group",inputTypes:["null"],help:a.i18n.translate("eventAnnotation.group.description",{defaultMessage:"Event annotation group"}),args:{dataView:{types:["index_pattern"],required:!0,help:a.i18n.translate("eventAnnotation.group.args.annotationConfigs.dataView.help",{defaultMessage:"Data view retrieved with indexPatternLoad"})},ignoreGlobalFilters:{types:["boolean"],default:!0,help:a.i18n.translate("eventAnnotation.group.args.annotationConfigs.ignoreGlobalFilters.help",{defaultMessage:"Switch to ignore global filters for the annotation"})},annotations:{types:["manual_point_event_annotation","manual_range_event_annotation","query_point_event_annotation"],help:a.i18n.translate("eventAnnotation.group.args.annotationConfigs",{defaultMessage:"Annotation configs"}),required:!0,multi:!0}},fn:(e,t)=>({type:"event_annotation_group",annotations:t.annotations.filter((e=>!e.isHidden)),dataView:t.dataView,ignoreGlobalFilters:t.ignoreGlobalFilters})}}var u=n(6);const d="annotations"},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return i}));const a=1,i="event-annotation-group"},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return i}));const a={ASTERISK:"asterisk",ALERT:"alert",BELL:"bell",BOLT:"bolt",BUG:"bug",CIRCLE:"circle",EDITOR_COMMENT:"editorComment",FLAG:"flag",HEART:"heart",MAP_MARKER:"mapMarker",PIN_FILLED:"pinFilled",STAR_EMPTY:"starEmpty",STAR_FILLED:"starFilled",TAG:"tag",TRIANGLE:"triangle"},i="event-annotation-group"},function(e,t,n){e.exports=n(12)(2)},function(e,t){e.exports=__kbnSharedDeps__.KbnDatemath},function(e,t){e.exports=__kbnSharedDeps__.Rxjs},function(e,t){e.exports=__kbnSharedDeps__.ElasticCharts},function(e,t){e.exports=__kbnSharedDeps_npm__},function(e,t,n){n(14),__kbnBundles__.define("plugin/eventAnnotation/public",n,15),__kbnBundles__.define("plugin/eventAnnotation/common",n,5)},function(e,t,n){n.p=window.__kbnPublicPath__.eventAnnotation},function(e,t,n){"use strict";n.r(t),n.d(t,"plugin",(function(){return O})),n.d(t,"EventAnnotationService",(function(){return event_annotation_service_EventAnnotationService}));var a=n(0),i=n(8),o=n.n(i);class event_annotation_service_EventAnnotationService{constructor(e,t){o()(this,"eventAnnotationService",void 0),o()(this,"core",void 0),o()(this,"contentManagement",void 0),this.core=e,this.contentManagement=t}async getService(){if(!this.eventAnnotationService){const{getEventAnnotationService:e}=await n.e(1).then(n.bind(null,24));this.eventAnnotationService=e(this.core,this.contentManagement)}return this.eventAnnotationService}}var r=n(5);var s=n(10),l=n(4),u=n(2),d=n(3),p=n.n(d),c=n(11),g=n(9),f=n.n(g);const m=[{id:"id",name:"id",meta:{type:"string"}},{id:"time",name:"time",meta:{type:"string"}},{id:"endTime",name:"endTime",meta:{type:"string"}},{id:"timebucket",name:"timebucket",meta:{type:"string"}},{id:"type",name:"type",meta:{type:"string"}},{id:"label",name:"label",meta:{type:"string"}},{id:"color",name:"color",meta:{type:"string"}},{id:"lineStyle",name:"lineStyle",meta:{type:"string"}},{id:"lineWidth",name:"lineWidth",meta:{type:"number"}},{id:"icon",name:"icon",meta:{type:"string"}},{id:"textVisibility",name:"textVisibility",meta:{type:"boolean"}},{id:"textField",name:"textField",meta:{type:"string"}},{id:"outside",name:"outside",meta:{type:"number"}},{id:"type",name:"type",meta:{type:"string"}},{id:"skippedCount",name:"skippedCount",meta:{type:"number"}}],v=e=>"endTime"in e,h=e=>"time"in e&&!("endTime"in e);function y(e){const t=f.a.parse(e);return t?t.toDate():void 0}function _(e){const t=f.a.parse(e.from),n=f.a.parse(e.to,{roundUp:!0});if(t&&n)return{from:t.toDate(),to:n.toDate()}}const b=(e,t)=>"time"in e&&"time"in t?e.time.localeCompare(t.time):0,A=(e,t=m)=>({type:"datatable",columns:t,rows:e});function S(e){return{...Object(l.pick)(e,["label","color","icon","lineWidth","lineStyle","textVisibility"])}}const F={rows:[],columns:[],type:"datatable"},M=e=>"manual"===e.type,x=(e,t,n)=>e.annotations.map((e=>{const a=p()(e.time).valueOf(),i=Object(c.roundDateToESInterval)(a,Object(u.parseEsInterval)(t),"start",n);return{timebucket:p()(i).toISOString(),...e,type:h(e)?"point":"range"}})).sort(b),w=(e,t,n)=>e.map((e=>{var a,i;const o=[{type:"agg_type",value:{enabled:!0,schema:"bucket",type:"filters",params:{filters:e.annotations.map((e=>({label:e.id,input:{...e.filter}})))}}},{type:"agg_type",value:{enabled:!0,schema:"bucket",type:"date_histogram",params:{useNormalizedEsInterval:!0,field:e.timeField,interval:t}}},{type:"agg_type",value:{enabled:!0,schema:"metric",type:"count"}},{type:"agg_type",value:{enabled:!0,type:"top_metrics",params:{field:e.timeField,size:10,sortOrder:"asc",sortField:e.timeField}}},...(e.allFields||[]).map((t=>({type:"agg_type",value:{enabled:!0,type:"top_metrics",params:{field:t,size:10,sortOrder:"asc",sortField:e.timeField}}})))],r=n.createAggConfigs(e.dataView,null!==(a=null==o?void 0:o.map((e=>e.value)))&&void 0!==a?a:[]);return{esaggsParams:{dataView:e.dataView,aggConfigs:r,timeFields:[e.timeField],ignoreGlobalFilters:Boolean(e.ignoreGlobalFilters)},fieldsColIdMap:(null===(i=e.allFields)||void 0===i?void 0:i.reduce(((e,t,n)=>({...e,[t]:`col-${n+4}-${n+5}`})),{}))||{}}}));function T({getStartServices:e}){return function({getStartDependencies:e}){return{name:"fetch_event_annotations",aliases:[],type:"datatable",inputTypes:["kibana_context","null"],help:a.i18n.translate("eventAnnotation.fetchEventAnnotations.description",{defaultMessage:"Fetch event annotations"}),args:{groups:{types:["event_annotation_group"],help:a.i18n.translate("eventAnnotation.fetchEventAnnotations.args.annotationConfigs",{defaultMessage:"Annotation configs"}),multi:!0},interval:{required:!0,types:["string"],help:a.i18n.translate("eventAnnotation.fetchEventAnnotations.args.interval.help",{defaultMessage:"Interval to use for this aggregation"})}},fn:(t,n,i)=>((e,t,{inspectorAdapters:n,abortSignal:i,getSearchSessionId:o,getExecutionContext:r},d)=>Object(s.defer)((async()=>{if(null==e||!e.timeRange||!t.groups)return F;const{aggs:c,dataViews:g,searchSource:f,getNow:T,uiSettings:E}=await d(),O=((e,t,n)=>{const a=n&&_(n);if(!a)return;const i=new u.TimeBuckets({"histogram:maxBars":e.get(u.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":e.get(u.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:e.get("dateFormat"),"dateFormat:scaled":e.get("dateFormat:scaled")});return i.setInterval(t),i.setBounds({min:p()(a.from),max:p()(a.to)}),i.getInterval().expression})(E,t.interval,null==e?void 0:e.timeRange);if(!O)return F;const k=t.groups.map((e=>e.dataView.value)).reduce(((e,t)=>e.find((e=>e.id===t.id))?e:[...e,t]),[]),I=await Promise.all(k.map((e=>g.create(e,!0)))),[q,j]=Object(l.partition)(function({groups:e},t,n){const a=e.map((e=>e.annotations.reduce(((a,i)=>{if(v(s=i)||h(s))return((e,t)=>{if(!t)return!1;const{from:n,to:a}=_(t)||{};if(!n||!a)return!1;if(v(e)){const t=y(e.time),i=y(e.endTime);if(t&&i)return!(t>=a||i<n)}if(h(e)){const t=y(e.time);if(t)return t>=n&&t<=a}return!0})(i,null==t?void 0:t.timeRange)?(a.manual||(a.manual={type:"manual",annotations:[]}),a.manual.annotations.push(i),a):a;{var o,r;const t=n.find((t=>t.id===e.dataView.value.id)),s=null!==(o=i.timeField)&&void 0!==o?o:t.timeFieldName||(null===(r=t.fields.find((e=>"date"===e.type&&e.displayName)))||void 0===r?void 0:r.name),l=`${e.dataView.value.id}-${s}-${Boolean(e.ignoreGlobalFilters)}`,u=a[l];if(u){let e=[...u.allFields||[],...i.extraFields||[]];return i.textField&&(e=[...e,i.textField]),{...a,[l]:{...u,allFields:[...new Set(e)],annotations:[...u.annotations,i]}}}let d=i.extraFields||[];return i.textField&&(d=[...d,i.textField]),{...a,[l]:{type:"query",dataView:t,timeField:s,allFields:d,annotations:[i],ignoreGlobalFilters:Boolean(e.ignoreGlobalFilters)}}}var s}),{}))).reduce(((e,t)=>(Object.keys(t).forEach((n=>{if(e[n]){const a=t[n],i=e[n];M(a)||M(i)?e[n]={...i,annotations:[...i.annotations,...a.annotations]}:e[n]={...i,annotations:[...i.annotations,...a.annotations],allFields:[...new Set([...i.allFields||[],...a.allFields||[]])]}}else e[n]=t[n]})),e)),{});return Object.values(a)}(t,e,I),M),C=q.length?x(q[0],O,function(e){const t=e.get("dateFormat:tz");return"Browser"===t?p.a.tz.guess():t}(E)):[];if(!j.length)return C.length?A(C):F;const P=async({dataView:t,aggConfigs:l,timeFields:d,ignoreGlobalFilters:p})=>Object(s.lastValueFrom)((e=>Object(u.handleEsaggsRequest)(e))({aggs:l,indexPattern:t,timeFields:d,filters:p||null==e?void 0:e.filters,query:p||null==e?void 0:e.query,timeRange:null==e?void 0:e.timeRange,abortSignal:i,inspectorAdapters:n,searchSessionId:o(),searchSourceService:f,getNow:T,executionContext:r(),title:a.i18n.translate("eventAnnotation.fetchEventAnnotations.inspector.dataRequest.title",{defaultMessage:"Annotations"}),description:a.i18n.translate("eventAnnotation.fetchEventAnnotations.inspector.dataRequest.description",{defaultMessage:"This request queries Elasticsearch to fetch the data for the annotations."})})),R=await w(j,O,c),D=j.flatMap((e=>e.annotations));return((e,t,n)=>{const a=e.flatMap((({response:e,fieldsColIdMap:t})=>{const n=Object.fromEntries(Object.entries(t).map((([e,t])=>[t,e])));return e.columns.filter((e=>n[e.id])).map((e=>({...e,name:n[e.id],id:`field:${n[e.id]}`})))})).reduce(((e,t)=>(e.find((e=>e.id===t.id))||e.push(t),e)),[]).concat(m),i=e.flatMap((({response:e,fieldsColIdMap:n})=>e.rows.map((e=>{var a;const i=t.find((({id:t})=>t===e["col-0-1"]));if(!i)throw new Error(`Could not find annotation config for id: ${e["col-0-1"]}`);let o={};null!=i&&null!==(a=i.extraFields)&&void 0!==a&&a.length&&(o=i.extraFields.reduce(((t,a)=>(t[`field:${a}`]=e[n[a]],t)),{})),null!=i&&i.textField&&(o[`field:${i.textField}`]=e[n[i.textField]]);let r={...S(i),id:e["col-0-1"],timebucket:p()(e["col-1-2"]).toISOString(),time:e["col-3-4"],type:"point",label:i.label,extraFields:o};const s=e["col-2-3"];return s>10&&(r={skippedCount:s-10,...r}),r})))).concat(...n).sort(((e,t)=>e.timebucket.localeCompare(t.timebucket))),o=i.reduce(((e,t)=>(t.skippedCount&&(e[t.timebucket]=(e[t.timebucket]||0)+t.skippedCount),e)),{}),r=i.reduce(((e,t)=>(Array.isArray(t.time)?t.time.forEach(((n,a)=>{const i={};t.extraFields&&Object.entries(null==t?void 0:t.extraFields).forEach((([e,t])=>{i[e]=Array.isArray(t)?t[a]:t})),e.push({...Object(l.omit)(t,["extraFields","skippedCount"]),...i,label:Array.isArray(t.label)?t.label[a]:t.label,time:n})})):e.push({...Object(l.omit)(t,["extraFields","skippedCount"]),...t.extraFields}),e)),[]).sort(b).reduce(((e,t,n,a)=>n===a.length-1||t.timebucket!==a[n+1].timebucket?(e.push({...t,skippedCount:o[t.timebucket]}),e):(e.push(t),e)),[]);return A(r,a)})(await Promise.all(R.map((async({esaggsParams:e,fieldsColIdMap:t})=>({response:await P(e),fieldsColIdMap:t})))),D,C)})))(t,n,i,e)}}({getStartDependencies:async()=>{const[{uiSettings:t},{data:{search:n,dataViews:a,nowProvider:i}}]=await e();return{aggs:n.aggs,searchSource:n.searchSource,dataViews:a,getNow:()=>i.get(),uiSettings:t}}})}var E=n(6);class plugin_EventAnnotationPlugin{setup(e,t){t.expressions.registerFunction(r.manualPointEventAnnotation),t.expressions.registerFunction(r.manualRangeEventAnnotation),t.expressions.registerFunction(r.queryPointEventAnnotation),t.expressions.registerFunction(r.eventAnnotationGroup),t.expressions.registerFunction(T({getStartServices:e.getStartServices})),t.contentManagement.registry.register({id:E.a,version:{latest:E.b},name:a.i18n.translate("eventAnnotation.content.name",{defaultMessage:"Annotation group"})})}start(e,t){return new event_annotation_service_EventAnnotationService(e,t.contentManagement)}}const O=()=>new plugin_EventAnnotationPlugin},function(e,t){e.exports=__kbnSharedDeps__.EmotionReact},function(e,t){e.exports=__kbnSharedDeps__.React},function(e,t,n){n.r(t);var a=__kbnBundles__.get("plugin/dataViews/common");Object.defineProperties(t,Object.getOwnPropertyDescriptors(a))},function(e,t){e.exports=__kbnSharedDeps__.KbnI18nReact},function(e,t,n){n.r(t);var a=__kbnBundles__.get("plugin/savedObjectsFinder/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(a))},function(e,t){e.exports=__kbnSharedDeps__.ElasticEui},function(e,t){e.exports=__kbnSharedDeps__.KbnUiTheme}]);