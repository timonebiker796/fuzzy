/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[5],{133:function(e,t,i){"use strict";i.d(t,"j",(function(){return b})),i.d(t,"g",(function(){return g})),i.d(t,"h",(function(){return _})),i.d(t,"f",(function(){return m})),i.d(t,"k",(function(){return p})),i.d(t,"n",(function(){return v})),i.d(t,"e",(function(){return y})),i.d(t,"d",(function(){return h})),i.d(t,"l",(function(){return T})),i.d(t,"m",(function(){return E})),i.d(t,"a",(function(){return C})),i.d(t,"b",(function(){return N})),i.d(t,"i",(function(){return j})),i.d(t,"c",(function(){return I}));var n=i(5),r=i(131),a=i(520),o=i(519),s=i(830),l=i(144),c=i(1),d=i(73),u=i(125);const f=e=>t=>{let i=l.b.getFieldById(t);return null===i&&(t===a.b?i=o.c:e.length&&(i=e.find((e=>e.id===t))||null)),i};function b(e,t,i,n=!1){const r=n?function(e,t){return O(e.analysis_config.detectors)}(e):function(e,t){let i=e.analysis_config.detectors;const n=p(e,t);if(void 0!==t.aggregations&&e.analysis_config.detectors[0].function===s.b.NON_ZERO_COUNT&&!1===n){var r,a,l,c,d;const e=null==t||null===(r=t.aggregations)||void 0===r||null===(a=r.buckets)||void 0===a||null===(l=a.aggregations)||void 0===l||null===(c=l.dc_region)||void 0===c||null===(d=c.cardinality)||void 0===d?void 0:d.field;void 0!==e&&(i=[{function:s.b.DISTINCT_COUNT,field_name:e}])}else i=O(i),i=i.map((e=>{switch(e.function){case s.b.NON_ZERO_COUNT:return{...e,field_name:o.a,function:s.b.COUNT};case s.b.HIGH_NON_ZERO_COUNT:return{...e,field_name:o.a,function:s.b.HIGH_COUNT};case s.b.LOW_NON_ZERO_COUNT:return{...e,field_name:o.a,function:s.b.LOW_COUNT};case s.b.NON_NULL_SUM:return{...e,function:s.b.SUM};case s.b.HIGH_NON_NULL_SUM:return{...e,function:s.b.HIGH_SUM};case s.b.LOW_NON_NULL_SUM:return{...e,function:s.b.LOW_SUM};default:return e}}));return i}(e,t),a=f(i);return r.map((e=>{var t,i,n;let r=null,o=null,s=null,c=null;return void 0!==e.field_name&&(r=a(e.field_name)),void 0!==e.by_field_name&&(o=a(e.by_field_name)),void 0!==e.over_field_name&&(s=a(e.over_field_name)),void 0!==e.partition_field_name&&(c=a(e.partition_field_name)),{agg:l.b.getAggById(e.function),field:r,byField:o,overField:s,partitionField:c,excludeFrequent:null!==(t=e.exclude_frequent)&&void 0!==t?t:null,description:null!==(i=e.detector_description)&&void 0!==i?i:null,useNull:null!==(n=e.use_null)&&void 0!==n?n:null}}))}function g(e,t){return[...e.filter((e=>e.id!==o.a)).map((e=>({label:e.name,field:e}))),...t.filter((t=>!1===e.some((e=>e.id===t.id)))).map((e=>({label:e.id,field:e})))].sort(((e,t)=>e.label.localeCompare(t.label)))}function _(e){return null===e?[]:[{label:a.b}]}function m(e){return e?[{label:a.a}]:[{label:a.d}]}function O(e){return e.map((e=>{switch(e.function){case s.b.COUNT:case s.b.HIGH_COUNT:case s.b.LOW_COUNT:case s.b.NON_ZERO_COUNT:case s.b.HIGH_NON_ZERO_COUNT:case s.b.LOW_NON_ZERO_COUNT:case s.b.RARE:case s.b.FREQ_RARE:case s.b.TIME_OF_DAY:case s.b.TIME_OF_WEEK:return{...e,field_name:o.a};default:return e}}))}function p(e,t){var i,n,r,a,o;const l=e.analysis_config.detectors;if(void 0===(null==t||null===(i=t.aggregations)||void 0===i||null===(n=i.buckets)||void 0===n||null===(r=n.aggregations)||void 0===r||null===(a=r.dc_region)||void 0===a||null===(o=a.cardinality)||void 0===o?void 0:o.field))for(const e of l)if(s.c.includes(e.function))return!0;return!1}function v(e,t=!1,i=!1,n=!1){var r;d.mlJobService.tempJobCloningObjects.job=e.jobConfig,d.mlJobService.tempJobCloningObjects.datafeed=e.datafeedConfig,d.mlJobService.tempJobCloningObjects.createdBy=null!==(r=e.createdBy)&&void 0!==r?r:void 0,d.mlJobService.tempJobCloningObjects.skipTimeRangeStep=t,!0===i&&!1===n?(d.mlJobService.tempJobCloningObjects.start=e.start,d.mlJobService.tempJobCloningObjects.end=e.end):!0===n&&(d.mlJobService.tempJobCloningObjects.autoSetTimeRange=!0),d.mlJobService.tempJobCloningObjects.calendars=e.calendars}function y(e,t){e.createdBy=u.a.MULTI_METRIC,e.modelPlot=!1,v(e,!0,!0),t(c.b.ANOMALY_DETECTION_CREATE_JOB_CONVERT_TO_MULTI_METRIC,!0)}function h(e,t){e.createdBy=null,v(e,!0,!0),t(c.b.ANOMALY_DETECTION_CREATE_JOB_CONVERT_TO_ADVANCED,!0)}function T(e,t){e.createdBy=null,v(e,!0,!1),t(c.b.ANOMALY_DETECTION_CREATE_JOB)}function E(e,t){e.jobId="",v(e,!0,!0),t(c.b.ANOMALY_DETECTION_CREATE_JOB)}function C(e,t){null!==e&&v(e,!1,!1),t("/jobs")}function N(e){return!1===e.some((e=>null===e.agg.dslName))}function j(e){switch(e.type){case u.f.SINGLE_METRIC:return n.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.singleMetric",{defaultMessage:"Single metric"});case u.f.MULTI_METRIC:return n.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.multiMetric",{defaultMessage:"Multi-metric"});case u.f.POPULATION:return n.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.population",{defaultMessage:"Population"});case u.f.ADVANCED:return n.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.advanced",{defaultMessage:"Advanced"});case u.f.CATEGORIZATION:return n.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.categorization",{defaultMessage:"Categorization"});case u.f.RARE:return n.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.rare",{defaultMessage:"Rare"});case u.f.GEO:return n.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.geo",{defaultMessage:"Geo"});default:return""}}function I(e,t){for(const i in e)null!==e[i]&&"object"==typeof e[i]&&("aggregations"!==i&&"aggs"!==i||Object.keys(e[i]).forEach((e=>{"aggregations"!==e&&"aggs"!==e&&t.push({id:e,name:e,type:r.a.KEYWORD,aggregatable:!0,counter:!1})})),I(e[i],t))}},144:function(e,t,i){"use strict";i.d(t,"a",(function(){return NewJobCapsService})),i.d(t,"b",(function(){return u}));var n=i(4),r=i.n(n),a=i(131),o=i(519),s=i(100),l=i(159),c=i(11),d=i(282);class NewJobCapsService extends d.a{constructor(e){super(),r()(this,"_catFields",[]),r()(this,"_dateFields",[]),r()(this,"_geoFields",[]),r()(this,"_includeEventRateField",!0),r()(this,"_removeTextFields",!0),r()(this,"_mlApiService",void 0),this._mlApiService=e}get catFields(){return this._catFields}get dateFields(){return this._dateFields}get geoFields(){return this._geoFields}get categoryFields(){return Object(l.c)(this._fields)}async initializeFromDataVIew(e,t=!0,i=!0){try{this._includeEventRateField=t,this._removeTextFields=i;const n=await this._mlApiService.jobs.newJobCaps(e.getIndexPattern(),e.type===s.DataViewType.ROLLUP),{fields:r,aggs:c}=function(e,t){const i=e[t],n=[],r=[],a={},o={};return void 0!==i&&(i.aggs.forEach((e=>{const t={...e,...void 0!==e.fieldIds?{fields:[]}:{}};a[t.id]=t,r.push(t)})),i.fields.forEach((e=>{const t={...e,aggs:[]};void 0!==t.aggIds&&(o[t.id]=t.aggIds),n.push(t)})),n.forEach((e=>{o[e.id].forEach((t=>{!function(e,t){void 0===t.fields&&(t.fields=[]),void 0===e.aggs&&(e.aggs=[]),t.fields.push(e),e.aggs.push(t)}(e,a[t])}))}))),n.forEach((e=>delete e.aggIds)),r.forEach((e=>delete e.fieldIds)),{fields:n,aggs:r}}(n,e.getIndexPattern());!0===this._includeEventRateField&&function(e,t){const i={id:o.a,name:"Event rate",type:a.a.INTEGER,aggregatable:!0,counter:!1,aggs:[]};e.forEach((e=>{void 0!==i.aggs&&void 0===e.fields&&(e.fields=[i],i.aggs.push(e))})),t.splice(0,0,i)}(c,r);const{fieldsPreferringKeyword:u,fieldsPreferringText:f}=Object(d.b)(r),b=f.filter((e=>e.type===a.a.KEYWORD||e.type===a.a.TEXT)),g=f.filter((e=>e.type===a.a.DATE)),_=Object(l.d)(r),m=this._removeTextFields?u:r;this._fields=m,this.removeCounterFields(),this._catFields=b,this._dateFields=g,this._geoFields=_,this._aggs=c}catch(e){console.error("Unable to load new job capabilities",e)}}}const u=new NewJobCapsService(c.ml)},147:function(e,t,i){"use strict";i.d(t,"c",(function(){return f})),i.d(t,"d",(function(){return b})),i.d(t,"b",(function(){return g})),i.d(t,"a",(function(){return _})),i.d(t,"e",(function(){return m}));var n=i(8),r=i(31),a=i.n(r),o=i(75),s=i(82),l=i(247),c=i(166);const d={bool:{must:[{match_all:{}}]}},u={query:"",language:"lucene"};function f(){return Object(n.cloneDeep)(d)}function b(){return Object(n.cloneDeep)(u)}function g(e,t,i){return null===i?{query:b(),combinedQuery:f()}:_(Object(c.c)(i),t,e)}function _(e,t,i){let n=b(),r=f();n=e.query;const a=e.filter,c=Array.isArray(a)?a:[];if(n.language===l.a.KUERY){const e=Object(o.fromKueryExpression)(n.query);""!==n.query&&(r=Object(o.toElasticsearchQuery)(e,t));const i=Object(o.buildQueryFromFilters)(c,t);void 0===r.bool&&(r.bool={},void 0!==r.multi_match&&(r.bool.should={multi_match:r.multi_match},delete r.multi_match)),!1===Array.isArray(r.bool.filter)&&(r.bool.filter=void 0===r.bool.filter?[]:[r.bool.filter]),!1===Array.isArray(r.bool.must_not)&&(r.bool.must_not=void 0===r.bool.must_not?[]:[r.bool.must_not]),r.bool.filter=[...r.bool.filter,...i.filter],r.bool.must_not=[...r.bool.must_not,...i.must_not]}else{const e=Object(s.getEsQueryConfig)(i);r=Object(o.buildEsQuery)(t,[n],c,e)}return{query:n,combinedQuery:r}}function m(e,t){try{return a.a.decode(e)}catch(e){return t}}},154:function(e,t,i){"use strict";i.d(t,"c",(function(){return a})),i.d(t,"b",(function(){return o})),i.d(t,"a",(function(){return s}));var n=i(519),r=i(123);function a(){return{job_id:"",description:"",groups:[],analysis_config:{bucket_span:"",detectors:[],influencers:[]},data_description:{time_field:""}}}function o(e){return{datafeed_id:"",job_id:"",indices:Object(r.w)(e),query:{}}}function s(e,t){const i={function:e.id};return t.id!==n.a&&(i.field_name=t.id),i}},159:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s})),i.d(t,"d",(function(){return c})),i.d(t,"e",(function(){return d})),i.d(t,"c",(function(){return u}));var n=i(131),r=i(519),a=i(830);const o=[n.a.TEXT,n.a.KEYWORD,n.a.IP,n.a.VERSION];function s(e,t,i){const o=function(e){return e.filter((e=>e.type===n.a.KEYWORD||e.type===n.a.VERSION))}(e),s=function(e){return e.filter((e=>e.type===n.a.TEXT))}(e),d=function(e){return e.filter((e=>e.type===n.a.LONG||e.type===n.a.UNSIGNED_LONG||e.type===n.a.INTEGER||e.type===n.a.SHORT||e.type===n.a.BYTE||e.type===n.a.DOUBLE||e.type===n.a.FLOAT||e.type===n.a.HALF_FLOAT||e.type===n.a.SCALED_FLOAT))}(e),u=function(e){return e.filter((e=>e.type===n.a.IP))}(e),f=c(e),b=Object.keys(i).length>0,g=function(e,t){return function(i,n){(!1===e||t[i.id]&&t[i.id].find((e=>e.agg===n.dslName)))&&(void 0!==i.aggs&&i.aggs.push(n),void 0!==n.fields&&n.fields.push(i))}}(b,i);return t.forEach((e=>{if(e.type===r.b&&void 0!==e.fields)switch(e.id){case a.b.LAT_LONG:f.forEach((t=>g(t,e)));break;case a.b.INFO_CONTENT:case a.b.HIGH_INFO_CONTENT:case a.b.LOW_INFO_CONTENT:s.forEach((t=>g(t,e)));case a.b.DISTINCT_COUNT:case a.b.HIGH_DISTINCT_COUNT:case a.b.LOW_DISTINCT_COUNT:o.forEach((t=>g(t,e))),u.forEach((t=>g(t,e)));default:d.forEach((t=>{t.aggregatable&&g(t,e)}))}})),{aggs:t,fields:b?l(e):e}}function l(e){return e.filter((e=>e.aggs&&(e.aggs.length>0||0===e.aggs.length&&e.type===n.a.DATE)))}function c(e){return e.filter((e=>e.type===n.a.GEO_POINT||e.type===n.a.GEO_SHAPE))}function d(e){if(0===e.length)return e;let t;return e[0].id===r.a&&([t]=e.splice(0,1)),e.sort(((e,t)=>e.name.localeCompare(t.name))),void 0!==t&&e.splice(0,0,t),e}function u(e,t=!0){return e.filter((e=>o.includes(e.type)===t))}},166:function(e,t,i){"use strict";i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return r})),i.d(t,"d",(function(){return a})),i.d(t,"a",(function(){return o}));const n=e=>async t=>{var i,n;const r={savedSearch:null,dataView:null};if(void 0===t)return r;const a=await e.savedSearchService.get(t);if(null===a)return r;const o=null===(i=a.references)||void 0===i||null===(n=i.find((e=>"index-pattern"===e.type)))||void 0===n?void 0:n.id;return r.dataView=await e.dataViewsService.get(o),r.savedSearch=a,r};function r(e){return{query:e.searchSource.getField("query"),filter:e.searchSource.getField("filter")}}function a(e){return e.includes(":")}function o(e){const t={message:null,errorMessage:null};for(const r of e.fields){var i,n;"message"===r.name&&null!==(i=r.toSpec().esTypes)&&void 0!==i&&i.includes("text")?t.message=r:"error.message"===r.name&&null!==(n=r.toSpec().esTypes)&&void 0!==n&&n.includes("text")&&(t.errorMessage=r)}return null!==t.message?{dataView:e,field:t.message}:null!==t.errorMessage?{dataView:e,field:t.errorMessage}:null}},171:function(e,t,i){"use strict";i.d(t,"a",(function(){return QuickJobCreatorBase}));var n=i(5),r=i(8),a=i(7),o=i(136),s=i(75),l=i(123),c=i(147);function d(e,t){if(Array.isArray(e)){const i=e.concat(t);return Object(r.uniqWith)(i,r.isEqual)}}class QuickJobCreatorBase{constructor(e,t,i,n,r){this.dataViews=e,this.kibanaConfig=t,this.timeFilter=i,this.dashboardService=n,this.mlApiServices=r}async putJobAndDataFeed({jobId:e,datafeedConfig:t,jobConfig:i,createdByLabel:n,start:r,end:o,startJob:s,runInRealTime:c,dashboard:d}){const u=Object(l.g)(e),f={...t,job_id:e,datafeed_id:u},b={...i,job_id:e,custom_settings:{created_by:n,...d?await this.getCustomUrls(d,f):{}}},g={jobCreated:{success:!1},datafeedCreated:{success:!1},jobOpened:{success:!1},datafeedStarted:{success:!1}};try{if(void 0!==r&&void 0!==o&&void 0!==b.data_description.time_field&&t.indices.length>0){const{modelMemoryLimit:e}=await Object(a.firstValueFrom)(this.mlApiServices.calculateModelMemoryLimit$({datafeedConfig:f,analysisConfig:b.analysis_config,indexPattern:t.indices[0],query:t.query,timeFieldName:b.data_description.time_field,earliestMs:r,latestMs:o}));void 0===b.analysis_limits&&(b.analysis_limits={}),b.analysis_limits.model_memory_limit=e}}catch(e){console.error("could not calculate model memory limit",e)}try{await this.mlApiServices.addJob({jobId:b.job_id,job:b})}catch(e){return g.jobCreated.error=e,g}g.jobCreated.success=!0;try{await this.mlApiServices.addDatafeed({datafeedId:u,datafeedConfig:f})}catch(e){return g.datafeedCreated.error=e,g}if(g.datafeedCreated.success=!0,s){try{await this.mlApiServices.openJob({jobId:e})}catch(e){if(409!==e.body.statusCode)return g.jobOpened.error=e,g}g.jobOpened.success=!0;try{await this.mlApiServices.startDatafeed({datafeedId:u,start:r,...c?{}:{end:o}})}catch(e){return g.datafeedStarted.error=e,g}g.datafeedStarted.success=!0}return g}combineQueriesAndFilters(e,t,i,n){let a;const{combinedQuery:o}=Object(c.a)({query:e.query,filter:e.filters},i,this.kibanaConfig),{combinedQuery:s}=Object(c.a)({query:t.query,filter:t.filters},i,this.kibanaConfig);if(n){const{combinedQuery:e}=Object(c.a)({query:n.query,filter:n.filters},i,this.kibanaConfig);a=Object(r.mergeWith)(s,e,d)}return Object(r.mergeWith)(o,a||s,d)}async createDashboardLink(e,t){var i,r,a;const c=null===(i=e.savedObjectId)||void 0===i?void 0:i.value;if(!c)return null;const d={dashboardId:c,timeRange:{from:"$earliest$",to:"$latest$",mode:"absolute"},filters:Object(l.i)(t.query,void 0,t.job_id,s.FilterStateStore.GLOBAL_STATE)},u=await(null===(r=this.dashboardService.locator)||void 0===r?void 0:r.getLocation(d));if(void 0===u)return null;const f=`${u.app}${u.path}`;return{url_name:n.i18n.translate("xpack.ml.newJob.fromLens.createJob.namedUrlDashboard",{defaultMessage:"Open {dashboardTitle}",values:{dashboardTitle:null!==(a=Object(o.h)(e))&&void 0!==a?a:"dashboard"}}),url_value:f,time_range:"auto"}}async getCustomUrls(e,t){const i=await this.createDashboardLink(e,t);return void 0!==e&&null!==i?{custom_urls:[i]}:{}}}},247:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));const n={KUERY:"kuery",LUCENE:"lucene"}},282:function(e,t,i){"use strict";i.d(t,"b",(function(){return o})),i.d(t,"a",(function(){return NewJobCapabilitiesServiceBase}));var n=i(4),r=i.n(n),a=i(131);function o(e){const t=e.filter((e=>e.type===a.a.KEYWORD)).map((e=>e.id)),i=e.filter((e=>e.type===a.a.TEXT)).map((e=>e.id));return{fieldsPreferringKeyword:e.filter((e=>e.type!==a.a.TEXT||e.type===a.a.TEXT&&!1===t.includes(`${e.id}.keyword`))),fieldsPreferringText:e.filter((e=>e.type!==a.a.KEYWORD||e.type===a.a.KEYWORD&&!1===i.includes(e.id.replace(/\.keyword$/,""))))}}class NewJobCapabilitiesServiceBase{constructor(){r()(this,"_fields",void 0),r()(this,"_aggs",void 0),this._fields=[],this._aggs=[]}get fields(){return this._fields}get aggs(){return this._aggs}get newJobCaps(){return{fields:this._fields,aggs:this._aggs}}getFieldById(e){const t=this._fields.find((t=>t.id===e));return void 0===t?null:t}getAggById(e){const t=this._aggs.find((t=>t.id===e));return void 0===t?null:t}removeCounterFields(){this._fields=this._fields.filter((e=>!1===e.counter))}}}}]);