/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[31,23],{138:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=n(2);t.default=function(){var e=l.useRef(!1),t=l.useCallback((function(){return e.current}),[]);return l.useEffect((function(){return e.current=!0,function(){e.current=!1}})),t}},168:function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var l=n(2),i=n(5),o=n(15),a=n(25),s=n(138),r=n.n(s),c=n(10),u=n(13),d=n(6);const b=({jobsAndGroupIds:e,onChange:t,adJobsApiService:n,errors:s,multiSelect:b=!1,label:f,allowSelectAll:j=!1,createJobUrl:p,options:m})=>{const{services:{notifications:{toasts:v},application:{navigateToUrl:O}}}=Object(c.d)(),E=r()(),[g,S]=Object(l.useState)([]),x=Object(l.useMemo)((()=>new Set),[]),y=Object(l.useMemo)((()=>new Set),[]),I=Object(l.useMemo)((()=>(null!=e?e:[]).map((e=>({label:e})))),[e]),T=Object(l.useCallback)((async()=>{try{const{jobIds:e,groupIds:t}=await n.getAllJobAndGroupIds();if(e.forEach((e=>{x.add(e)})),t.forEach((e=>{y.add(e)})),!E())return;S([...j?[{label:i.i18n.translate("xpack.ml.jobSelector.selectAllGroupLabel",{defaultMessage:"Select all"}),options:[{label:i.i18n.translate("xpack.ml.jobSelector.selectAllOptionLabel",{defaultMessage:"*"}),value:u.e}]}]:[],{label:i.i18n.translate("xpack.ml.jobSelector.jobOptionsLabel",{defaultMessage:"Jobs"}),options:[...p?[{label:i.i18n.translate("xpack.ml.jobSelector.createNewLabel",{defaultMessage:"--- Create new ---"}),value:"createNew"}]:[],...e.map((e=>({label:e})))]},...b?[{label:i.i18n.translate("xpack.ml.jobSelector.groupOptionsLabel",{defaultMessage:"Groups"}),options:t.map((e=>({label:e})))}]:[]])}catch(e){v.addError(e,{title:i.i18n.translate("xpack.ml.jobSelector.fetchJobErrorTitle",{defaultMessage:"Failed to load anomaly detection jobs"})})}}),[n,j,p,y,E,x,b,v]),C=Object(l.useCallback)((async e=>{if(e.some((e=>e.value===u.e)))return void t({jobIds:[u.e]});if(p&&e.some((e=>"createNew"===e.value)))return void await O(p);const n=[],l=[];e.forEach((({label:e})=>{x.has(e)?n.push(e):y.has(e)?l.push(e):null!=m&&m.some((t=>{var n;return null===(n=t.options)||void 0===n?void 0:n.some((t=>t.label===e))}))&&n.push(e)})),t({...n.length>0?{jobIds:n}:{},...l.length>0?{groupIds:l}:{}})}),[x,y,m,p]);return Object(l.useEffect)((()=>{m||T()}),[p]),Object(d.jsx)(a.EuiFormRow,{"data-test-subj":"mlAnomalyJobSelectionControls",fullWidth:!0,label:null!=f?f:Object(d.jsx)(o.FormattedMessage,{id:"xpack.ml.jobSelector.formControlLabel",defaultMessage:"Select job"}),isInvalid:!(null==s||!s.length),error:s},Object(d.jsx)(a.EuiComboBox,{singleSelection:!b,selectedOptions:I,options:null!=m?m:g,onChange:C,fullWidth:!0,"data-test-subj":"mlAnomalyAlertJobSelection",isInvalid:!(null==s||!s.length)}))}},175:function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));const l={CRITICAL:"#fe5050",MAJOR:"#fba740",MINOR:"#fdec25",WARNING:"#8bc8fb",LOW:"#d2e9f7",BLANK:"#ffffff"}},187:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var l=n(73);function i(e,t,n,i){const o=null!=i?i:l.mlJobService.getJob(n),a=[];if(void 0===o)return a;const s=e,r=o.analysis_config.detectors[s],c=t,u=null==r?void 0:r.partition_field_name,d=null==r?void 0:r.over_field_name,b=null==r?void 0:r.by_field_name;if(void 0!==u){var f;const e=null!==(f=null==c?void 0:c[u])&&void 0!==f?f:null;a.push({fieldType:"partition_field",fieldName:u,fieldValue:e})}if(void 0!==d){var j;const e=null!==(j=null==c?void 0:c[d])&&void 0!==j?j:null;a.push({fieldType:"over_field",fieldName:d,fieldValue:e})}if(void 0!==b&&void 0===d){var p;const e=null!==(p=null==c?void 0:c[b])&&void 0!==p?p:null;a.push({fieldType:"by_field",fieldName:b,fieldValue:e})}return a}},195:function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return o})),n.d(t,"d",(function(){return a}));const l={CLEAR:"CLEAR",SET_DETECTOR_INDEX:"SET_DETECTOR_INDEX",SET_ENTITIES:"SET_ENTITIES",SET_FORECAST_ID:"SET_FORECAST_ID",SET_ZOOM:"SET_ZOOM",UNSET_ZOOM:"UNSET_ZOOM",SET_FUNCTION_DESCRIPTION:"SET_FUNCTION_DESCRIPTION"},i=500,o=10,a="timestamp"},213:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var l=n(123);function i(e){const t=e.analysis_config.detectors,n=[];return t.forEach(((t,i)=>{Object(l.q)(e,i)&&n.push({index:i,detector_description:t.detector_description,function:t.function})})),n}},222:function(e,t,n){"use strict";n.r(t),n.d(t,"apiCanAddNewPanel",(function(){return l})),n.d(t,"apiHasRuntimeChildState",(function(){return o})),n.d(t,"apiHasSerializedChildState",(function(){return i})),n.d(t,"apiHasSaveNotification",(function(){return a})),n.d(t,"apiCanDuplicatePanels",(function(){return s})),n.d(t,"apiCanExpandPanels",(function(){return r})),n.d(t,"apiIsPresentationContainer",(function(){return d})),n.d(t,"getContainerParentFromAPI",(function(){return b})),n.d(t,"listenForCompatibleApi",(function(){return f})),n.d(t,"combineCompatibleChildrenApis",(function(){return j})),n.d(t,"apiHasSerializableState",(function(){return p})),n.d(t,"tracksOverlays",(function(){return m})),n.d(t,"canTrackContentfulRender",(function(){return v}));const l=e=>"function"==typeof(null==e?void 0:e.addNewPanel),i=e=>Boolean(e&&e.getSerializedStateForChild),o=e=>Boolean(e&&e.getRuntimeStateForChild),a=e=>Boolean(e&&e.saveNotification$),s=e=>Boolean(void 0!==(null==e?void 0:e.duplicatePanel)),r=e=>Boolean(void 0!==(null==e?void 0:e.expandPanel));var c=n(136),u=n(7);const d=e=>Boolean(l(e)&&"function"==typeof(null==e?void 0:e.removePanel)&&"function"==typeof(null==e?void 0:e.replacePanel)&&"function"==typeof(null==e?void 0:e.addNewPanel)&&(null==e?void 0:e.children$)),b=e=>{const t=Object(c.b)(e)?e.parentApi:null;if(t)return d(t)?t:void 0},f=(e,t,n)=>{if(!e||!d(e))return()=>{};let l,i;const o=e.children$.subscribe((o=>{var a,s;null===(a=l)||void 0===a||a();const r=(()=>{for(const e of Object.keys(o)){const n=o[e];if(t(n))return n}if(t(e))return e})(),u=Object(c.d)(r)?r.uuid:null;u!==i&&(i=u,l=null!==(s=n(r))&&void 0!==s?s:void 0)}));return()=>{var e;o.unsubscribe(),null===(e=l)||void 0===e||e()}},j=(e,t,n,l,i)=>e&&d(e)?e.children$.pipe(Object(u.switchMap)((e=>{const o=[];for(const l of Object.values(e))n(l)&&Object(u.isObservable)(l[t])&&o.push(l[t]);return 0===o.length?Object(u.of)(l):Object(u.combineLatest)(o).pipe(Object(u.map)(i||(e=>e.flat().filter((e=>Boolean(e))))))}))):Object(u.of)(),p=e=>Boolean(null==e?void 0:e.serializeState),m=e=>Boolean(e&&e.openOverlay&&e.clearOverlays),v=e=>null!==e&&"object"==typeof e&&"trackContentfulRender"in e},242:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return c}));var l=n(5),i=n(7),o=n(830),a=n(187),s=n(213);function r(e,t){const n=Object(s.a)(e);if(Array.isArray(n)&&n.length>=t){const n=e.analysis_config.detectors[t];if((null==n?void 0:n.function)===o.b.METRIC)return!0}return!1}const c=async({selectedDetectorIndex:e,selectedEntities:t,selectedJobId:n,selectedJob:s},c,u)=>{if(!r(s,e))return;const d=[{fieldName:"detector_index",fieldValue:e},...Object(a.a)(e,t,n).filter((e=>null!==e.fieldValue))];try{const e=await Object(i.lastValueFrom)(u.getRecordsForCriteria([s.job_id],d,0,null,null,1));if(Array.isArray(null==e?void 0:e.records)&&1===e.records.length){const t=e.records[0];return null==t?void 0:t.function_description}return o.a.AVG}catch(e){c.displayErrorToast(e,l.i18n.translate("xpack.ml.timeSeriesExplorer.highestAnomalyScoreErrorToastTitle",{defaultMessage:"An error occurred getting record with the highest anomaly score"}))}}},376:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var l=n(5);const i=e=>l.i18n.translate("xpack.ml.singleMetricViewerEmbeddable.title",{defaultMessage:"ML single metric viewer chart for {jobId}",values:{jobId:e}})},392:function(e,t,n){"use strict";n.d(t,"a",(function(){return I}));var l=n(2),i=n(15),o=n(25),a=n(8),s=n(7),r=n(189),c=n(199),u=n(73),d=n(10),b=n(195),f=n(187),j=n(179),p=n(213),m=n(5),v=n(830),O=n(242),E=n(71),g=n(80),S=n(6);const x=[{value:"mean",text:m.i18n.translate("xpack.ml.timeSeriesExplorer.plotByAvgOptionLabel",{defaultMessage:"mean"})},{value:"min",text:m.i18n.translate("xpack.ml.timeSeriesExplorer.plotByMinOptionLabel",{defaultMessage:"min"})},{value:"max",text:m.i18n.translate("xpack.ml.timeSeriesExplorer.plotByMaxOptionLabel",{defaultMessage:"max"})}],y=({functionDescription:e,job:t,setFunctionDescription:n,selectedDetectorIndex:i,selectedJobId:a,selectedEntities:s,entityControlsCount:r})=>{const c=Object(E.useToastNotificationService)(),d=Object(g.useMlResultsService)(),b=Object(l.useCallback)((async(e,t,l,i)=>{const o=await Object(O.a)({selectedDetectorIndex:e,selectedEntities:t,selectedJobId:l,selectedJob:i},c,d);n(o)}),[n,c,d]);return Object(l.useEffect)((()=>{if(void 0!==e)return;const n=null!=t?t:u.mlJobService.getJob(a);if((0===r||r>0&&void 0!==s)&&void 0===e&&Object(O.b)(n,i)){const e=n.analysis_config.detectors[i];(null==e?void 0:e.function)===v.b.METRIC&&b(i,s,a,n)}}),[n,i,s,a,e,r]),void 0===e?null:Object(S.jsx)(o.EuiFlexItem,{grow:!1},Object(S.jsx)(o.EuiFormRow,{label:m.i18n.translate("xpack.ml.timeSeriesExplorer.metricPlotByOption",{defaultMessage:"Function"})},Object(S.jsx)(o.EuiSelect,{options:x,value:e,onChange:e=>n(e.target.value),"aria-label":m.i18n.translate("xpack.ml.timeSeriesExplorer.metricPlotByOptionLabel",{defaultMessage:"Pick function to plot by (min, max, or average) if metric function"})})))},I=({appStateHandler:e,bounds:t,children:n,direction:m="row",functionDescription:v,job:O,selectedDetectorIndex:E,selectedEntities:g,selectedJobId:x,setFunctionDescription:I})=>{var T;const{services:{mlServices:{mlApiServices:{results:C}}}}=Object(d.d)(),h=Object(l.useMemo)((()=>null!=O?O:u.mlJobService.getJob(x)),[x]),_=!(null===(T=h.model_plot_config)||void 0===T||!T.enabled),[M,w]=Object(l.useState)(!1),[N,F]=Object(l.useState)({}),A=Object(l.useMemo)((()=>Object(p.a)(h)),[h]),k=Object(l.useMemo)((()=>Object(f.a)(E,g,x,h)),[E,g,x]),[D,R]=Object(r.b)(j.d),J=Object(l.useMemo)((()=>{return{...(e=k.map((e=>e.fieldType)),t=!D||Object.values(D).some((e=>!(null==e||!e.anomalousOnly))),n=!D||Object.values(D).some((e=>!(null==e||!e.applyTimeRange))),e.reduce(((e,l)=>(e[l]={applyTimeRange:n,anomalousOnly:t,sort:{by:"anomaly_score",order:"desc"}},e)),{})),...D||{}};var e,t,n}),[k,D]),P=async(e={})=>{w(!0);const n=E,l=J?Object.fromEntries(Object.entries(J).filter((([e])=>k.some((t=>t.fieldType===e))))):void 0,{partition_field:i,over_field:o,by_field:a}=await Object(s.lastValueFrom)(C.fetchPartitionFieldsValues(h.job_id,e,[{fieldName:"detector_index",fieldValue:n}],t.min.valueOf(),t.max.valueOf(),l)),r={};k.forEach((e=>{let t;(null==i?void 0:i.name)===e.fieldName&&(t=i.values),(null==o?void 0:o.name)===e.fieldName&&(t=o.values),(null==a?void 0:a.name)===e.fieldName&&(t=a.values),r[e.fieldName]=t})),w(!1),F(r)};Object(l.useEffect)((()=>{P()}),[x,E,JSON.stringify(g),J]);const B=Object(a.debounce)((async(e,t)=>{await P({[e.fieldType]:t})}),500),V=(t,n)=>{const l={...k.reduce(((e,t)=>(e[t.fieldName]=t.fieldValue,e)),{}),[t.fieldName]:n};e(b.a.SET_ENTITIES,l)},L=Object(l.useCallback)((t=>{const n=t.target.value;void 0!==n&&e(b.a.SET_DETECTOR_INDEX,+n)}),[e]),G=A.map((e=>({value:e.index,text:e.detector_description}))),U=Object(l.useCallback)(((e,t)=>{var n,l;const i={...J[e]?J[e]:{},...t},o={...J};if((null===(n=J[e])||void 0===n?void 0:n.anomalousOnly)!==i.anomalousOnly)for(const e in o)o.hasOwnProperty(e)&&(o[e].anomalousOnly=i.anomalousOnly);if((null===(l=J[e])||void 0===l?void 0:l.applyTimeRange)!==i.applyTimeRange)for(const e in o)o.hasOwnProperty(e)&&(o[e].applyTimeRange=i.applyTimeRange);R({...o,[e]:i})}),[J,R]);let z=!1;return Object(S.jsx)("div",{"data-test-subj":"mlSingleMetricViewerSeriesControls"},Object(S.jsx)(o.EuiFlexGroup,{direction:m},Object(S.jsx)(o.EuiFlexItem,{grow:!1},Object(S.jsx)(o.EuiFormRow,{label:Object(S.jsx)(i.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.detectorLabel",defaultMessage:"Detector"})},Object(S.jsx)(o.EuiSelect,{onChange:L,value:E,options:G,"data-test-subj":"mlSingleMetricViewerDetectorSelect"}))),k.map((e=>{const t=`${e.fieldName}`,n=!z&&null===e.fieldValue;return z=!z&&n,Object(S.jsx)(c.b,{entity:e,entityFieldValueChanged:V,isLoading:M,onSearchChange:B,config:J[e.fieldType],onConfigChange:U,forceSelection:n,key:t,options:(l=N[e.fieldName],Array.isArray(l)?l.map((e=>({label:""===e.value?c.a:e.value,value:e}))):[]),isModelPlotEnabled:_});var l})),Object(S.jsx)(y,{job:O,selectedJobId:x,selectedDetectorIndex:E,selectedEntities:g,functionDescription:v,setFunctionDescription:I,entityControlsCount:k.length}),n))}},886:function(e,t,n){"use strict";n.r(t),n.d(t,"resolveEmbeddableSingleMetricViewerUserInput",(function(){return y}));var l=n(2),i=n.n(l),o=n(155),a=n(21),s=n(222),r=n(120),c=n.n(r),u=n(25),d=n(15),b=n(138),f=n.n(b),j=n(322),p=n(1),m=n(392),v=n(195),O=n(10),E=n(168),g=n(376),S=n(6);const x=({bounds:e,initialInput:t,onCreate:n,onCancel:o,mlApiServices:a})=>{var s,r;const b=f()(),x=Object(O.f)({page:p.b.ANOMALY_DETECTION_CREATE_JOB}),[y,I]=Object(l.useState)((null==t?void 0:t.jobIds)&&(null==t?void 0:t.jobIds[0])),T=Object(l.useRef)(!(null==t||!t.title)),[C,h]=Object(l.useState)(),[_,M]=Object(l.useState)(null!==(s=null==t?void 0:t.title)&&void 0!==s?s:""),[w,N]=Object(l.useState)(null==t?void 0:t.functionDescription),[F,A]=Object(l.useState)(null!==(r=null==t?void 0:t.selectedDetectorIndex)&&void 0!==r?r:0),[k,D]=Object(l.useState)(null==t?void 0:t.selectedEntities),[R,J]=Object(l.useState)(),P=_.length>0;return Object(l.useEffect)((function(){y&&(T.current||M(Object(g.a)(y)),a&&y&&y!==(null==C?void 0:C.job_id)&&async function(){const{jobs:e}=await a.getJobs({jobId:y});b()&&1===e.length&&(h(e[0]),J(void 0))}().catch((e=>{const t=Object(j.a)(e);J(t)})))}),[b,y,a,_,null==C?void 0:C.job_id]),Object(S.jsx)(i.a.Fragment,null,Object(S.jsx)(u.EuiFlyoutHeader,null,Object(S.jsx)(u.EuiTitle,null,Object(S.jsx)("h2",null,Object(S.jsx)(d.FormattedMessage,{id:"xpack.ml.SingleMetricViewerEmbeddable.setupModal.title",defaultMessage:"Single metric viewer configuration"})))),Object(S.jsx)(u.EuiFlyoutBody,null,Object(S.jsx)(u.EuiForm,null,Object(S.jsx)(E.a,c()({adJobsApiService:a.jobs,createJobUrl:x,jobsAndGroupIds:y?[y]:void 0,onChange:e=>{I((null==e?void 0:e.jobIds)&&(null==e?void 0:e.jobIds[0])),A(0),D(void 0),N(void 0)}},R&&{errors:[R]})),Object(S.jsx)(u.EuiFormRow,{label:Object(S.jsx)(d.FormattedMessage,{id:"xpack.ml.singleMetricViewerEmbeddable.panelTitleLabel",defaultMessage:"Panel title"}),isInvalid:!P,fullWidth:!0},Object(S.jsx)(u.EuiFieldText,{"data-test-subj":"panelTitleInput",id:"panelTitle",name:"panelTitle",value:_,onChange:e=>{T.current=!0,M(e.target.value)},isInvalid:!P,fullWidth:!0})),Object(S.jsx)(u.EuiSpacer,null),null!=C&&C.job_id&&y&&y===C.job_id?Object(S.jsx)(m.a,{selectedJobId:y,job:C,direction:"column",appStateHandler:(e,t)=>{switch(e){case v.a.SET_ENTITIES:D(t);break;case v.a.SET_FUNCTION_DESCRIPTION:N(t);break;case v.a.SET_DETECTOR_INDEX:A(t)}},selectedDetectorIndex:F,selectedEntities:k,bounds:e,functionDescription:w,setFunctionDescription:N}):null)),Object(S.jsx)(u.EuiFlyoutFooter,null,Object(S.jsx)(u.EuiFlexGroup,{justifyContent:"spaceBetween"},Object(S.jsx)(u.EuiFlexItem,{grow:!1},Object(S.jsx)(u.EuiButtonEmpty,{onClick:o,"data-test-subj":"mlsingleMetricViewerInitializerCancelButton"},Object(S.jsx)(d.FormattedMessage,{id:"xpack.ml.singleMetricViewerEmbeddable.setupModal.cancelButtonLabel",defaultMessage:"Cancel"}))),Object(S.jsx)(u.EuiFlexItem,{grow:!1},Object(S.jsx)(u.EuiButton,{"data-test-subj":"mlSingleMetricViewerInitializerConfirmButton",isDisabled:!P||void 0!==R||!y||!C,onClick:n.bind(null,{jobIds:y?[y]:[],functionDescription:w,panelTitle:_,selectedDetectorIndex:F,selectedEntities:k}),fill:!0},Object(S.jsx)(d.FormattedMessage,{id:"xpack.ml.singleMetricViewerEmbeddable.setupModal.confirmButtonLabel",defaultMessage:"Confirm"}))))))};async function y(e,t,n,l,i,r){const{http:c,overlays:u,...d}=e,{data:b,share:f}=l,j=b.query.timefilter.timefilter,p=Object(s.tracksOverlays)(t)?t:void 0;return new Promise((async(l,c)=>{try{const m=u.openFlyout(Object(o.a)(Object(S.jsx)(a.KibanaContextProvider,{services:{mlServices:{mlApiServices:i},data:b,share:f,...e}},Object(S.jsx)(x,{"data-test-subj":"mlSingleMetricViewerEmbeddableInitializer",mlApiServices:i,bounds:j.getBounds(),initialInput:r,onCreate:e=>{l(e),m.close(),null==p||p.clearOverlays()},onCancel:()=>{c(),m.close(),null==p||p.clearOverlays()}})),d),{type:"push",ownFocus:!0,size:"s",onClose:()=>{c(),m.close(),null==p||p.clearOverlays()}});Object(s.tracksOverlays)(t)&&t.openOverlay(m,{focusedPanelId:n})}catch(e){c(e)}}))}}}]);