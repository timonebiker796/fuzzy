/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[85],{193:function(e,t,a){"use strict";var r=a(171);a.d(t,"a",(function(){return r.a}))},272:function(e,t,a){"use strict";a.r(t),a.d(t,"VisualizationExtractor",(function(){return visualization_extractor_VisualizationExtractor})),a.d(t,"resolver",(function(){return I})),a.d(t,"QuickLensJobCreator",(function(){return quick_create_job_QuickLensJobCreator})),a.d(t,"getJobsItemsFromEmbeddable",(function(){return y})),a.d(t,"isCompatibleVisualizationType",(function(){return v})),a.d(t,"redirectToADJobWizards",(function(){return p})),a.d(t,"getChartInfoFromVisualization",(function(){return g}));var r=a(91),n=a(5),o=a(125),i=a(136),s=a(131),l=a(830),c=a(1);const d=["line","bar","bar_stacked","bar_percentage_stacked","bar_horizontal","bar_horizontal_stacked","area","area_stacked","area_percentage_stacked"],u=r.layerTypes.DATA,f="lnsXY",b=[s.b.STRING,s.b.IP];async function p(e,t,a,r){const{query:n,filters:o,to:i,from:s,vis:l}=await y(e,r),d=a.url.locators.get(c.a),u=await(null==d?void 0:d.getUrl({page:c.b.ANOMALY_DETECTION_CREATE_JOB_FROM_LENS,pageState:{vis:l,from:s,to:i,query:n,filters:o,layerIndex:t}}));window.open(u,"_blank")}async function y(e,t){var a,r,o,s,l,c,d;if(!t)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.lensNotFound",{defaultMessage:"Lens is not intialized"}));const u=Object(i.e)(e.parentApi,"dashboard")?e.parentApi:void 0,f=null!==(a=null===(r=e.timeRange$)||void 0===r?void 0:r.value)&&void 0!==a?a:null==u||null===(o=u.timeRange$)||void 0===o?void 0:o.value;if(void 0===f)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noTimeRange",{defaultMessage:"Time range not specified."}));const b=e.getSavedVis();if(void 0===b)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.visNotFound",{defaultMessage:"Visualization cannot be found."}));return{vis:b,chartInfo:await g(t,b),from:f.from,to:f.to,query:null!==(s=null==u||null===(l=u.query$)||void 0===l?void 0:l.value)&&void 0!==s?s:{query:"",language:"kuery"},filters:null!==(c=null==u||null===(d=u.filters$)||void 0===d?void 0:d.value)&&void 0!==c?c:[],dashboard:u}}function m(e){const t=function(e){switch(e){case"average":return l.b.MEAN;case"count":return l.b.COUNT;case"max":return l.b.MAX;case"median":return l.b.MEDIAN;case"min":return l.b.MIN;case"sum":return l.b.SUM;case"unique_count":return l.b.DISTINCT_COUNT;default:return null}}(e);if(null===t)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.incorrectFunction",{defaultMessage:"Selected function {operationType} is not supported by anomaly detection detectors",values:{operationType:e}}));return t}async function v(e){return e.visualizationType===f&&void 0===e.query.esql&&e.layers.some((e=>e.layerType===r.layerTypes.DATA&&void 0!==e.dataView))}function w(e){return e.layerType===u&&e.chartType&&d.includes(e.chartType)}function T(e,t){return e.map((({operation:e})=>{var a,r;const n=m(e.type);return{function:n,..."count"===n?{}:{field_name:null===(a=e.fields)||void 0===a?void 0:a[0]},...t?{partition_field_name:null===(r=t.operation.fields)||void 0===r?void 0:r[0]}:{}}}))}async function g(e,t){const a=await(await(await e.stateHelperApi()).chartInfo).getChartInfo(t);if(!a)throw new Error("Cannot create job, chart info is undefined");return a}class visualization_extractor_VisualizationExtractor{constructor(){}async getResultLayersFromEmbeddable(e,t){const{chartInfo:a}=await y(e,t);return this.getLayers(a,t)}async extractFields(e){var t;if(!w(e))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.incompatibleLayerType",{defaultMessage:"Layer is incompatible. Only chart layers can be used."}));const a=e.dimensions.find((e=>{var t;return"date"===(null===(t=e.operation)||void 0===t?void 0:t.dataType)}));if(void 0===a||null===(t=a.operation.fields)||void 0===t||!t.length)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noDateField",{defaultMessage:"Cannot find a date field."}));const r=e.dimensions.filter((e=>"metric"===e.role));!function(e){if(e.forEach((e=>"date"!==e.operation.dataType&&m(e.operation.type))),e.some((e=>{var t;return!(null!==(t=e.operation.fields)&&void 0!==t&&t.length)})))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.colsNoSourceField",{defaultMessage:"Some columns do not contain a source field."}));if(e.some((e=>function(e){return e.operation.hasTimeShift||e.operation.filter}(e))))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.colsUsingFilterTimeSift",{defaultMessage:"Columns contain settings which are incompatible with ML detectors, time shift and filter by are not supported."}))}(r);const o=e.dimensions.find((e=>"split"===e.role&&"breakdown"===e.dimensionType));if(o&&"terms"===o.operation.type&&o.operation.fields&&o.operation.fields.length>1)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.splitFieldHasMultipleFields",{defaultMessage:"Selected split field contains more than one field."}));if(o&&(i=o,!b.includes(i.operation.dataType)))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.splitFieldMustBeString",{defaultMessage:"Selected split field type must be string."}));var i;if(!e.dataView)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noDataViews",{defaultMessage:"No data views can be found in the visualization."}));if(a.operation.fields[0]!==e.dataView.timeFieldName)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeFieldNotInDataView",{defaultMessage:"Selected time field must be the default time field configured for data view."}));return{fields:r,timeField:a,splitField:o,dataView:e.dataView}}async getLayers(e,t){const a=await async function(e){const t=await e.getXyVisTypes();return e=>{var a;switch(e.layerType){case r.layerTypes.DATA:const o=t.find((t=>t.id===e.chartType));return{label:(null==o?void 0:o.fullLabel)||(null==o?void 0:o.label)||e.layerType,icon:null!==(a=null==o?void 0:o.icon)&&void 0!==a?a:""};case r.layerTypes.ANNOTATIONS:return{label:n.i18n.translate("xpack.ml.newJob.fromLens.createJob.VisType.annotations",{defaultMessage:"Annotations"}),icon:""};case r.layerTypes.REFERENCELINE:return{label:n.i18n.translate("xpack.ml.newJob.fromLens.createJob.VisType.referenceLine",{defaultMessage:"Reference line"}),icon:""};default:return{label:e.layerType,icon:""}}}}(t);return await Promise.all(e.layers.filter((({layerType:e})=>e===r.layerTypes.DATA)).map((async e=>{const{icon:t,label:r}=a(e);try{const{fields:a,splitField:n}=await this.extractFields(e),i=T(a,n),s=n||i.length>1?o.f.MULTI_METRIC:o.f.SINGLE_METRIC;return{id:e.layerId,layerType:e.layerType,label:r,icon:t,jobType:s,isCompatible:!0}}catch(a){return{id:e.layerId,layerType:e.layerType,label:r,icon:t,jobType:null,isCompatible:!1,error:a}}})))}}var h=a(31),_=a.n(h),E=a(154),J=a(133),C=a(193);class quick_create_job_QuickLensJobCreator extends C.a{constructor(e,t,a,r,n,o){super(t,a,r,n,o),this.lens=e}async createAndSaveJob(e,t,a,r,n,i){const{query:s,filters:l,to:c,from:d,dashboard:u,chartInfo:f}=await y(a,this.lens);if(void 0===s||void 0===l)throw new Error("Cannot create job, query and filters are undefined");const{jobConfig:b,datafeedConfig:p,start:m,end:v,jobType:w}=await this.createJob(f,d,c,s,l,t,i),T=w===o.f.SINGLE_METRIC?o.a.SINGLE_METRIC_FROM_LENS:o.a.MULTI_METRIC_FROM_LENS;return await this.putJobAndDataFeed({jobId:e,datafeedConfig:p,jobConfig:b,createdByLabel:T,dashboard:u,start:m,end:v,startJob:r,runInRealTime:n})}async createAndStashADJob(e,t,a,r,n,i){const s=await g(this.lens,e);try{const{jobConfig:e,datafeedConfig:l,jobType:c,start:d,end:u,includeTimeRange:f}=await this.createJob(s,t,a,r,n,o.b,i);Object(J.n)({jobConfig:e,datafeedConfig:l,createdBy:c===o.f.SINGLE_METRIC?o.a.SINGLE_METRIC:o.a.MULTI_METRIC,start:d,end:u},!0,f,!f)}catch(e){console.error(e)}}async createJob(e,t,a,r,o,i,s){const{jobConfig:l,datafeedConfig:c,jobType:d}=await this.createADJobFromLensSavedObject(e,r,o,i,s);let u,f,b=!0;try{const{min:e,max:r}=this.timeFilter.calculateBounds({to:a,from:t});if(u=null==e?void 0:e.valueOf(),f=null==r?void 0:r.valueOf(),void 0===u||void 0===f||isNaN(u)||isNaN(f))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeRange",{defaultMessage:"Incompatible time range"}))}catch(e){console.error(e),b=!1,u=void 0,f=void 0}return{jobConfig:l,datafeedConfig:c,jobType:d,start:u,end:f,includeTimeRange:b}}async createADJobFromLensSavedObject(e,t,a,r,n){var i;const s=e.layers.filter(w),l=void 0!==n?e.layers[n]:s[0],c=new visualization_extractor_VisualizationExtractor,{fields:d,timeField:u,splitField:f,dataView:b}=await c.extractFields(l),p=Object(E.c)(),y=Object(E.b)(b.getIndexPattern()),m=this.combineQueriesAndFilters({query:t,filters:a},{query:e.query,filters:e.filters},b);y.query=m,p.analysis_config.detectors=T(d,f),p.data_description.time_field=null===(i=u.operation.fields)||void 0===i?void 0:i[0],p.analysis_config.bucket_span=r,f&&f.operation.fields&&(p.analysis_config.influencers=[f.operation.fields[0]]);const v=!f&&1===p.analysis_config.detectors.length,g=v?o.f.SINGLE_METRIC:o.f.MULTI_METRIC;return v&&(p.model_plot_config={enabled:!0,annotations_enabled:!0}),{jobConfig:p,datafeedConfig:y,jobType:g}}}var L=a(147);async function I(e,t,a,r,n,o,i){const{dataViews:s,lens:l,mlApiServices:c,timeFilter:d,kibanaConfig:u,dashboardService:f}=e;if(void 0===t)throw new Error("Cannot create visualization");const b=_.a.decode(t);if(!b)throw new Error("Cannot create visualization");const p=Object(L.e)(n,Object(L.d)()),y=Object(L.e)(o,[]),m=Object(L.e)(a,""),v=Object(L.e)(r,""),w=Object(L.e)(i,void 0),T=new quick_create_job_QuickLensJobCreator(l,s,u,d,f,c);await T.createAndStashADJob(b,m,v,p,y,w)}}}]);