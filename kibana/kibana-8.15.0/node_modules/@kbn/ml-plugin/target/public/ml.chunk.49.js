/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[49],{139:function(e,t,n){"use strict";n.d(t,"a",(function(){return O})),n.d(t,"d",(function(){return h})),n.d(t,"n",(function(){return y})),n.d(t,"g",(function(){return x})),n.d(t,"f",(function(){return E})),n.d(t,"k",(function(){return S})),n.d(t,"i",(function(){return M})),n.d(t,"j",(function(){return I})),n.d(t,"o",(function(){return T})),n.d(t,"l",(function(){return w})),n.d(t,"m",(function(){return k})),n.d(t,"p",(function(){return A})),n.d(t,"c",(function(){return R})),n.d(t,"b",(function(){return L})),n.d(t,"h",(function(){return _})),n.d(t,"q",(function(){return V})),n.d(t,"e",(function(){return N}));var r=n(8),a=n(83),o=n.n(a),i=n(7),s=n(131),c=n(37),l=n(322),u=n(252),d=n(830),b=n(162),f=n(123),m=n(40),j=n(11),g=n(73),p=n(17),v=n(132);function O(e){return e.map((e=>{var t;const n=Object(m.a)(e.analysis_config.bucket_span);return{id:e.job_id,selected:!1,bucketSpanSeconds:n.asSeconds(),isSingleMetricViewerJob:Object(f.r)(e),sourceIndices:e.datafeed_config.indices,modelPlotEnabled:!0===(null===(t=e.model_plot_config)||void 0===t?void 0:t.enabled)}}))}function h(){return{selectedCells:void 0}}async function y(e,t,n,a,o,i,s,c){const l={};i.forEach((e=>{const t=e.fieldName;void 0===l[e.fieldName]&&(l[e.fieldName]=[]),l[t].push(e.fieldValue)})),o.forEach((e=>{(e.influencers||[]).forEach((e=>{const t=e.influencer_field_name,n=e.influencer_field_values;void 0===l[t]&&(l[t]=[]),l[t].push(...n)}))}));const u={};Object.keys(l).forEach((e=>{const t=l[e];u[e]=Object(r.uniq)(t)}));const d=[];return Object.keys(u).forEach((e=>{void 0!==i.find((t=>t.fieldName===e))?d.push(...i):u[e].forEach((t=>{d.push({fieldName:e,fieldValue:t})}))})),await A(e,t,n,a,d,s,c)}function x(e){const t=[];return e.forEach((e=>{const n=g.mlJobService.getJob(e.id);void 0!==n&&n.analysis_config&&n.analysis_config.influencers&&t.push(...n.analysis_config.influencers)})),t}function E(){const e=Object(p.g)().get("dateFormat:tz");return"Browser"!==e?e:o.a.tz.guess()}function S(e,t){const n=t;let r=n.min.valueOf(),a=n.max.valueOf();return void 0!==(null==e?void 0:e.times)&&(r=void 0!==e.times[0]?1e3*e.times[0]:n.min.valueOf(),a=n.max.valueOf(),void 0!==e.times[1]&&(a=1e3*e.times[1]-1)),{earliestMs:r,latestMs:a}}function M(e,t){return e&&e.type!==v.h.OVERALL&&void 0!==e.viewByFieldName&&e.viewByFieldName!==v.j?e.lanes.map((e=>({fieldName:t,fieldValue:e}))):[]}function I(e,t){return e&&e.type!==v.h.OVERALL&&void 0!==e.viewByFieldName&&e.viewByFieldName===v.j?e.lanes:t.map((e=>e.id))}function T(e,t){const n=e.map((e=>e.id)),r=S(void 0,t);return new Promise((e=>{Object(i.lastValueFrom)(j.ml.annotations.getAnnotations$({jobIds:n,earliestMs:r.earliestMs,latestMs:r.latestMs,maxAnnotations:b.a})).then((t=>{if(void 0!==t.error||void 0===t.annotations){const n=Object(l.a)(t.error);return e({annotationsData:[],error:""!==n?n:void 0})}const r=[];return n.forEach((e=>{const n=t.annotations[e];void 0!==n&&r.push(...n)})),e({annotationsData:r.sort(((e,t)=>e.timestamp-t.timestamp)).map(((e,t)=>(e.key=(t+1).toString(),e)))})})).catch((t=>{const n=Object(l.a)(t);return e({annotationsData:[],error:""!==n?n:void 0})}))}))}function w(e,t,n){const r=I(e,t),a=S(e,n);return new Promise((e=>{Object(i.lastValueFrom)(j.ml.annotations.getAnnotations$({jobIds:r,earliestMs:a.earliestMs,latestMs:a.latestMs,maxAnnotations:b.a})).then((t=>{if(void 0!==t.error||void 0===t.annotations){const n=Object(l.a)(t.error);return e({annotationsData:[],totalCount:0,error:""!==n?n:void 0})}const n=[];return r.forEach((e=>{const r=t.annotations[e];void 0!==r&&n.push(...r)})),e({annotationsData:n.sort(((e,t)=>e.timestamp-t.timestamp)).map(((e,t)=>(e.key=(t+1).toString(),e))),totalCount:t.totalCount})})).catch((t=>{const n=Object(l.a)(t);return e({annotationsData:[],totalCount:0,error:""!==n?n:void 0})}))}))}async function k(e,t,n,a,o,i,s,c){const l=I(e,t),m=M(e,o),p=S(e,a);return new Promise(((e,t)=>{j.ml.results.getAnomaliesTableData(l,[],m,i,s,p.earliestMs,p.latestMs,n,b.b,v.e,c).toPromise().then((t=>{const n=t.anomalies,a=g.mlJobService.detectorsByJob;n.forEach((e=>{const t=e.jobId,n=Object(r.get)(a,[t,e.detectorIndex]);e.detector=Object(r.get)(n,["detector_description"],e.source.function_description),void 0!==n&&void 0!==n.custom_rules&&(e.rulesLength=n.custom_rules.length);const o=g.mlJobService.getJob(t);let i=Object(f.p)(o,e.detectorIndex);if(!1===i&&Object(f.n)(o,e.detectorIndex)){const t=Object(u.d)(e.source);i=Object(f.o)(o,e.detectorIndex,t)}e.isTimeSeriesViewRecord=i,e.isGeoRecord=void 0!==n&&n.function===d.b.LAT_LONG,void 0!==g.mlJobService.customUrlsByJob[t]&&(e.customUrls=g.mlJobService.customUrlsByJob[t])})),e({anomalies:n,interval:t.interval,examplesByJobId:t.examplesByJobId,showViewSeriesLink:!0,jobIds:l})})).catch((e=>{console.log("Explorer - error loading data for anomalies table:",e),t()}))}))}async function A(e,t,n,r,a,o,i){return new Promise((s=>{!0!==o?e.getTopInfluencers(t,n,r,v.f,10,1,a,i).then((e=>{s(e.influencers)})):s({})}))}function C(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function R(e){return e.replace(/[()]/g,"\\$&")}function L(e){return e.replace(/[\\"]/g,"\\$&")}function _(e,t){const n=C(e),r=C(t);return new RegExp(`(${n})\\s?:\\s?(")?(${r})(")?`,"i")}function V(e,t,n){let r="";const a=_(t,n);return r=e.replace(a,""),r=r.replace(/\s+(and|or)\s+(and|or)\s+/gi," $1 "),r=r.replace(/\s(and|or)\s*$/gi,""),r=r.replace(/^\s*(and|or)\s/gi,""),r}async function N(e,t,n){const r={},a=new Map;if(Array.isArray(e))for(const l of e){let e,u;if(i=l,Object(c.a)(i)&&"string"==typeof i.id&&void 0!==i.selected&&void 0!==i.bucketSpanSeconds?(e=l.sourceIndices,u=l.id):(e=l.datafeed_config.indices,u=l.job_id),Array.isArray(e))for(const i of e){var o;const e=a.get(i),c=null!==(o=null==e?void 0:e.id)&&void 0!==o?o:await n.getDataViewIdFromName(i);if(c){const n=null!=e?e:await t.get(c);if(!n)continue;a.set(i,n);const o=[...n.fields.getByType(s.a.GEO_POINT),...n.fields.getByType(s.a.GEO_SHAPE)];o.length>0&&(void 0===r[u]&&(r[u]={[i]:{geoFields:[],dataViewId:c}}),r[u][i].geoFields.push(...o.map((e=>e.name))))}}}var i;return{sourceIndicesWithGeoFieldsMap:r,dataViews:[...a.values()]}}},150:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(33),a=n(203);const o=[r.euiDarkVars.euiColorVis0,r.euiDarkVars.euiColorVis1,r.euiDarkVars.euiColorVis2,r.euiDarkVars.euiColorVis3,r.euiDarkVars.euiColorVis4,r.euiDarkVars.euiColorVis5,r.euiDarkVars.euiColorVis6,r.euiDarkVars.euiColorVis7,r.euiDarkVars.euiColorVis8,r.euiDarkVars.euiColorVis9,r.euiDarkVars.euiColorDarkShade,r.euiDarkVars.euiColorPrimary],i={};function s(e){if(void 0===i[e]){const t=Object(a.a)(e),n=o[t%o.length];return i[e]=n,n}return i[e]}},162:function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));const r=500,a=500},203:function(e,t,n){"use strict";function r(e){let t=0,n=0;if(0===e.length)return t;for(let r=0;r<e.length;r++)n=e.charCodeAt(r),t=(t<<5)-t+n,t|=0;return t<0?-2*t:t}n.d(t,"a",(function(){return r}))},207:function(e,t,n){"use strict";n.d(t,"c",(function(){return p})),n.d(t,"d",(function(){return O})),n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return y}));var r=n(2),a=n(25),o=n(5),i=n(15),s=n(68),c=n(140),l=n(335),u=n(6);const d=o.i18n.translate("xpack.ml.controls.selectSeverity.warningLabel",{defaultMessage:"warning"}),b=o.i18n.translate("xpack.ml.controls.selectSeverity.minorLabel",{defaultMessage:"minor"}),f=o.i18n.translate("xpack.ml.controls.selectSeverity.majorLabel",{defaultMessage:"major"}),m=o.i18n.translate("xpack.ml.controls.selectSeverity.criticalLabel",{defaultMessage:"critical"}),j={[d]:c.a.LOW,[b]:c.a.MINOR,[f]:c.a.MAJOR,[m]:c.a.CRITICAL},g=[{val:c.a.LOW,display:d,color:Object(l.a)(c.a.LOW)},{val:c.a.MINOR,display:b,color:Object(l.a)(c.a.MINOR)},{val:c.a.MAJOR,display:f,color:Object(l.a)(c.a.MAJOR)},{val:c.a.CRITICAL,display:m,color:Object(l.a)(c.a.CRITICAL)}];function p(e){let t=g.find((t=>t.val===e));return void 0===t&&(t=g[0]),t}const v=g[0],O=()=>Object(s.c)("mlSelectSeverity",v),h=({classNames:e}={classNames:""})=>{const[t,n]=O();return Object(u.jsx)(y,{severity:t,onChange:n})},y=({classNames:e="",severity:t,onChange:n,compressed:s})=>{const c=Object(r.useMemo)((()=>g.map((({color:e,display:t,val:n})=>({value:t,inputDisplay:Object(u.jsx)(r.Fragment,null,Object(u.jsx)(a.EuiHealth,{color:e,style:{lineHeight:"inherit"}},t)),dropdownDisplay:Object(u.jsx)(r.Fragment,null,Object(u.jsx)(a.EuiHealth,{color:e,style:{lineHeight:"inherit"}},t),Object(u.jsx)(a.EuiSpacer,{size:"xs"}),Object(u.jsx)(a.EuiText,{size:"xs",color:"subdued"},Object(u.jsx)("p",null,Object(u.jsx)(i.FormattedMessage,{id:"xpack.ml.controls.selectSeverity.scoreDetailsDescription",defaultMessage:"score {value} and above",values:{value:n}}))))})))),[]);return Object(u.jsx)(a.EuiSuperSelect,{prepend:o.i18n.translate("xpack.ml.explorer.severityThresholdLabel",{defaultMessage:"Severity"}),"data-test-subj":"mlAnomalySeverityThresholdControls",className:e,hasDividers:!0,options:c,valueOfSelected:t.display,onChange:e=>{n(p(j[e]))},compressed:!0})}},219:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(220),a=n(139);function o(e){return{title:r.a,fields:Object(a.g)(e).map((e=>({name:e,type:"string",aggregatable:!0,searchable:!0})))}}},220:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));const r=".ml-anomalies-*"},221:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));const r=e=>t=>{t.currentTarget.blur(),e()}},232:function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"e",(function(){return o})),n.d(t,"a",(function(){return i})),n.d(t,"c",(function(){return s})),n.d(t,"d",(function(){return c}));var r=n(288);const a="SWIM_LANE_SELECTION_TRIGGER",o={id:a,title:"",description:"Swim lane selection triggered"},i="EXPLORER_ENTITY_FIELD_SELECTION_TRIGGER",s={id:i,title:"",description:"Entity field selection triggered"},c=e=>Object(r.a)(e)&&void 0!==e.data},236:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(5),a=n(17);function o(e,t,n,o){let i="",s=`ml-job-${t}`;switch(e){case"explorer":i=r.i18n.translate("xpack.ml.anomalyExplorerPageLabel",{defaultMessage:"Anomaly Explorer"});break;case"timeseriesexplorer":i=r.i18n.translate("xpack.ml.singleMetricViewerPageLabel",{defaultMessage:"Single Metric Viewer"});break;case"jobs/new_job/datavisualizer":i=r.i18n.translate("xpack.ml.dataVisualizerPageLabel",{defaultMessage:"Data Visualizer"}),s=`ml-datavisualizer-${t}`;break;default:return void console.error("addItemToRecentlyAccessed - No page specified")}(null!=o?o:Object(a.e)()).add(n,`ML - ${t} - ${i}`,s)}},247:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));const r={KUERY:"kuery",LUCENE:"lucene"}},288:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(37),a=n(136),o=n(43);function i(e){return Object(r.a)(e,["embeddable"])&&Object(a.e)(e.embeddable,o.c)}},335:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(140),a=n(175);function o(e){return e>=r.a.CRITICAL?a.a.CRITICAL:e>=r.a.MAJOR?a.a.MAJOR:e>=r.a.MINOR?a.a.MINOR:e>=r.a.WARNING?a.a.WARNING:e>=r.a.LOW?a.a.LOW:a.a.BLANK}},380:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(8),a=n(7),o=n(40);function i(e,t,n){return e.pipe(Object(a.distinctUntilChanged)(r.isEqual),Object(a.switchMap)((e=>t.getJobs$(e).pipe(Object(a.catchError)((e=>{var t;return n(null!==(t=e.body)&&void 0!==t?t:e),a.EMPTY}))))),Object(a.map)((e=>e.map((e=>{var t;const n=Object(o.a)(e.analysis_config.bucket_span);return{id:e.job_id,selected:!0,bucketSpanSeconds:n.asSeconds(),modelPlotEnabled:!0===(null===(t=e.model_plot_config)||void 0===t?void 0:t.enabled)}})))))}},381:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(75),a=n(82),o=n(67);function i(e,t,n){const i=null!=e?e:[],s=null!=t?t:Object(a.getDefaultQuery)();let c={};Object(r.isOfAggregateQueryType)(s)||(c="kuery"===s.language?Object(r.toElasticsearchQuery)(Object(r.fromKueryExpression)(s.query)):Object(r.luceneStringToDsl)(s.query));const l=Object(o.a)(c)?[c]:[],u=[];for(const e of i){if(e.meta.disabled||void 0!==n&&e.meta.controlledBy===n)continue;const{meta:{negate:t,type:r,key:a}}=e;let o=e.query;void 0===o&&"exists"===r&&(o={exists:{field:a}}),o&&(t?u.push(o):l.push(o))}return{bool:{must:l,must_not:u}}}},499:function(e,t,n){"use strict";n.r(t);var r=n(2),a=n(25),o=n(15),i=n(8),s=n(86),c=n(140),l=n(318),u=n(26),d=n.n(u),b=n(120),f=n.n(b),m=n(5),j=n(811),g=n(207),p=n(6);const v=m.i18n.translate("xpack.ml.explorer.charts.dashboardTooManyBucketsDescription",{defaultMessage:"This selection contains too many buckets to be displayed. You should shorten the time range of the view."}),O=({id:e,chartsData:t,showCharts:n,severity:r,setSeverity:i,mlLocator:s,timeBuckets:c,timefilter:l,onSelectEntity:u,showSelectedInterval:d,chartsService:b,timeRange:m})=>Object(p.jsx)("div",{"data-shared-item":"","data-rendering-count":1},Object(p.jsx)(a.EuiFlexGroup,{id:e,direction:"row",gutterSize:"l",responsive:!0},Object(p.jsx)(a.EuiFlexItem,{grow:!1},Object(p.jsx)(g.b,{severity:r,onChange:i}))),Object(p.jsx)(a.EuiSpacer,{size:"m"}),Array.isArray(t.seriesToPlot)&&0===t.seriesToPlot.length&&void 0===t.errorMessages&&Object(p.jsx)(a.EuiText,{textAlign:"center","data-test-subj":"mlNoMatchingAnomaliesMessage"},Object(p.jsx)("h4",null,Object(p.jsx)(o.FormattedMessage,{id:"xpack.ml.explorer.noMatchingAnomaliesFoundTitle",defaultMessage:"No matching anomalies found"}))),n&&Object(p.jsx)(j.ExplorerChartsContainer,f()({},t,{severity:r.val,mlLocator:s,timeBuckets:c,timefilter:l,timeRange:m,onSelectEntity:u,tooManyBucketsCalloutMsg:v,showSelectedInterval:d,chartsService:b,id:e})));var h=n(1),y=n(232),x=n(7),E=n(136),S=n(380),M=n(132),I=n(381),T=n(139);t.default=({id:e,timeRange$:t,severityThreshold:n,services:u,onRenderComplete:b,onError:f,onLoading:m,api:j})=>{const[v,w]=Object(r.useState)(0),[k,A]=Object(r.useState)(Object(g.c)(void 0!==n?n:c.a.WARNING)),[C,R]=Object(r.useState)(),[{uiSettings:L},{data:_,share:V,uiActions:N,charts:D}]=u,{timefilter:F}=_.query.timefilter,B=d()(t),P=Object(r.useMemo)((()=>V.url.locators.get(h.a)),[V]),J=Object(r.useMemo)((()=>new l.a({"histogram:maxBars":L.get(s.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":L.get(s.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:L.get("dateFormat"),"dateFormat:scaled":L.get("dateFormat:scaled")})),[]);Object(r.useEffect)((()=>{null!=j&&j.updateSeverityThreshold&&j.updateSeverityThreshold(k.val)}),[k.val,null==j?void 0:j.updateSeverityThreshold]),Object(r.useEffect)((()=>{null!=j&&j.updateSelectedEntities&&j.updateSelectedEntities(C)}),[C,null==j?void 0:j.updateSelectedEntities]);const $=Object(r.useMemo)((()=>({onRenderComplete:b,onError:f,onLoading:m})),[b,f,m]),{chartsData:G,isLoading:W,error:z}=function(e,t,n,a,o){const[,,{anomalyDetectorService:i,anomalyExplorerService:s}]=t,[c,l]=Object(r.useState)(),[u,d]=Object(r.useState)(),[b,f]=Object(r.useState)(!1),m=Object(r.useMemo)((()=>new x.Subject),[]),j=Object(r.useMemo)((()=>new x.Subject),[]);return Object(r.useEffect)((()=>{const t=Object(x.combineLatest)({explorerJobs:Object(S.a)(e.jobIds$,i,d),maxSeriesToPlot:e.maxSeriesToPlot$,chartWidth:m.pipe(Object(x.skipWhile)((e=>!e))),severityValue:j,dataPublishingServices:Object(E.g)(e)}).pipe(Object(x.tap)(f.bind(null,!0)),Object(x.debounceTime)(500),Object(x.tap)((()=>{o.onLoading(!0)})),Object(x.switchMap)((({explorerJobs:e,maxSeriesToPlot:t,chartWidth:n,severityValue:r,dataPublishingServices:a})=>{var o,i;const{timeRange:c,filters:l,query:u}=a;if(!e)return Object(x.of)(void 0);const b=M.g;let f;c&&s.setTimeRange(c);try{(l||u)&&(f=Object(I.a)(l,u))}catch(e){return d(e),Object(x.of)(void 0)}const m=s.getTimeBounds(),j={lanes:[M.g],times:[null===(o=m.min)||void 0===o?void 0:o.unix(),null===(i=m.max)||void 0===i?void 0:i.unix()],type:M.h.OVERALL},g=Object(T.i)(j,b),p=Object(T.j)(j,e),v=Object(T.k)(j,m);return s.getAnomalyData$(p,n,v.earliestMs,v.latestMs,f,g,null!=r?r:0,t)})),Object(x.catchError)((e=>(console.error("Error occured fetching anomaly charts data for embeddable\n",e),d(e.body),Object(x.of)(void 0))))).subscribe((e=>{void 0!==e&&(d(null),l(e),f(!1),o.onRenderComplete())}));return()=>{null==t||t.unsubscribe(),m.complete(),j.complete()}}),[]),Object(r.useEffect)((()=>{m.next(n)}),[n]),Object(r.useEffect)((()=>{j.next(a)}),[a]),Object(r.useEffect)((()=>{u&&o.onError(u)}),[u]),{chartsData:c,isLoading:b,error:u}}(j,u,v,k.val,$),U=Object(r.useRef)(),q=Object(r.useCallback)(Object(i.throttle)((e=>{W||(U.current=e.height),Math.abs(v-e.width)>20&&w(e.width)}),500),[!W,v]),H=Object(r.useMemo)((()=>W?U.current:void 0),[W]);if(z)return Object(p.jsx)(a.EuiCallOut,{title:Object(p.jsx)(o.FormattedMessage,{id:"xpack.ml.anomalyChartsEmbeddable.errorMessage",defaultMessage:"Unable to load the data for the anomaly charts"}),color:"danger",iconType:"warning",style:{width:"100%"}},Object(p.jsx)("p",null,z.message));const Y=(e,t,n)=>{const r=[{fieldName:e,fieldValue:t,operation:n}];R(r),N.getTrigger(y.a).exec({embeddable:j,data:r})};return Object(p.jsx)(a.EuiResizeObserver,{onResize:q},(t=>Object(p.jsx)("div",{id:`mlAnomalyExplorerEmbeddableWrapper-${e}`,style:{width:"100%",overflowY:"auto",overflowX:"hidden",padding:"8px",height:H},"data-test-subj":`mlExplorerEmbeddable_${e}`,ref:t},W&&Object(p.jsx)(a.EuiText,{textAlign:"center",style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%,-50%)"}},Object(p.jsx)(a.EuiLoadingChart,{size:"xl",mono:!0,"data-test-subj":"mlAnomalyExplorerEmbeddableLoadingIndicator"})),void 0!==G&&!1===W?Object(p.jsx)(O,{id:e,showCharts:!0,chartsData:G,severity:k,setSeverity:A,mlLocator:P,timeBuckets:J,timefilter:F,onSelectEntity:Y,showSelectedInterval:!1,chartsService:D,timeRange:B}):null)))}}}]);