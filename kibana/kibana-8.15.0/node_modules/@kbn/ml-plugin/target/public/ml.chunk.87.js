/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[87],{397:function(e,t,a){"use strict";a.d(t,"b",(function(){return quick_create_job_QuickCategorizationJobCreator})),a.d(t,"a",(function(){return u})),a.d(t,"c",(function(){return b}));var i=a(5),n=a(830),o=a(520),s=a(125),r=a(171),c=a(154),l=a(133);const u={COUNT:n.b.COUNT,HIGH_COUNT:n.b.HIGH_COUNT,RARE:n.b.RARE};class quick_create_job_QuickCategorizationJobCreator extends r.a{constructor(e,t,a,i,n,o){super(e,t,a,i,o),this.data=n}async createAndSaveJob(e,t,a,i,n,o,r,c,l,u,d){if(void 0===c)throw new Error("Cannot create job, query and filters are undefined");const{jobConfig:b,datafeedConfig:j,start:m,end:g}=await this.createJob(e,i,n,o,r,l,c,a),O=s.a.CATEGORIZATION_FROM_PATTERN_ANALYSIS;return await this.putJobAndDataFeed({jobId:t,datafeedConfig:j,jobConfig:b,createdByLabel:O,start:m,end:g,startJob:u,runInRealTime:d})}async createAndStashADJob(e,t,a,i,n,o,r,c){try{var u;const d=await this.data.dataViews.get(t),b=d.getFieldByName(a),j=i&&null!==(u=d.getFieldByName(i))&&void 0!==u?u:null;if(void 0===b)throw new Error("Cannot create job, field is undefined");const{jobConfig:m,datafeedConfig:g,start:O,end:f,includeTimeRange:x}=await this.createJob(e,d,b,j,n,{from:o,to:r},c,s.b);Object(l.n)({jobConfig:m,datafeedConfig:g,createdBy:s.a.CATEGORIZATION_FROM_PATTERN_ANALYSIS,start:O,end:f},!0,x,!x)}catch(e){console.error(e)}}async createJob(e,t,a,n,s,r,l,u){const d=Object(c.c)(),b=Object(c.b)(t.getIndexPattern());let j,m;b.query=l,d.analysis_config={categorization_field_name:a.name,per_partition_categorization:{enabled:null!==n,stop_on_warn:s},influencers:[o.b],detectors:[{function:e,by_field_name:o.b}],bucket_span:u},null!==n&&(d.analysis_config.detectors[0].partition_field_name=n.name,d.analysis_config.influencers.push(n.name)),d.data_description.time_field=t.timeFieldName;let g=!0;try{const{min:e,max:t}=this.timeFilter.calculateBounds(r);if(j=null==e?void 0:e.valueOf(),m=null==t?void 0:t.valueOf(),void 0===j||void 0===m||isNaN(j)||isNaN(m))throw Error(i.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeRange",{defaultMessage:"Incompatible time range"}))}catch(e){console.error(e),g=!1,j=void 0,m=void 0}return{jobConfig:d,datafeedConfig:b,start:j,end:m,includeTimeRange:g}}}var d=a(147);async function b(e,t,a,i,n,o,s,r,c){const{mlApiServices:l,timeFilter:b,kibanaConfig:j,dashboardService:m,data:g}=e,O=Object(d.e)(c,Object(d.c)()),f=Object(d.e)(s,""),x=Object(d.e)(r,""),y=Object(d.e)(t,u.COUNT),F=Object(d.e)(a,""),p=Object(d.e)(i,""),C=null===n?"":Object(d.e)(n,""),h=Object(d.e)(o,!1),w=new quick_create_job_QuickCategorizationJobCreator(g.dataViews,j,b,m,g,l);await w.createAndStashADJob(y,F,p,C,h,f,x,O)}},877:function(e,t,a){"use strict";a.r(t),a.d(t,"showPatternAnalysisToADJobFlyout",(function(){return x}));var i=a(2),n=a.n(i),o=a(384),s=a(15),r=a(25),c=a(1),l=a(16),u=a(133),d=a(144),b=a(397),j=a(271),m=a(385),g=a(6);const O=({dataView:e,field:t,query:a,timeRange:o})=>{const{services:{data:O,share:f,uiSettings:x,mlServices:{mlApiServices:y},dashboardService:F}}=Object(j.a)(),[p,C]=Object(i.useState)(b.a.COUNT),[h,w]=Object(i.useState)(!1),[E,A]=Object(i.useState)(!1),[S,_]=Object(i.useState)([]),[k,z]=Object(i.useState)([]),[M,T]=Object(i.useState)(void 0),J=Object(i.useCallback)((()=>w(!h)),[h]),v=Object(i.useCallback)((()=>A(!E)),[E]);Object(i.useMemo)((()=>{const t=new d.a(y);t.initializeFromDataVIew(e).then((()=>{const e=[...Object(u.g)(t.categoryFields,[])].map((e=>({...e})));_(e)}))}),[e,y]);const P=Object(i.useMemo)((()=>new b.b(O.dataViews,x,O.query.timefilter.timefilter,F,O,y)),[F,O,y,x]);return Object(i.useEffect)((()=>{z([]),A(!1)}),[h]),Object(i.useEffect)((()=>{T(!1===h||k.length>0)}),[h,k]),Object(g.jsx)(m.a,{createADJob:async function({jobId:i,bucketSpan:n,startJob:s,runInRealTime:r}){var c;const l=k.length&&null!==(c=e.getFieldByName(k[0].label))&&void 0!==c?c:null;return await P.createAndSaveJob(p,i,n,e,t,l,E,a,o,s,r)},createADJobInWizard:function(){var i;const n=k.length&&null!==(i=e.getFieldByName(k[0].label))&&void 0!==i?i:null;!async function(e,t,a,i,n,o,s,r){const u=r.url.locators.get(c.a),d=await u.getUrl({page:l.a.ANOMALY_DETECTION_CREATE_JOB_FROM_PATTERN_ANALYSIS,pageState:{categorizationType:e,dataViewId:t.id,field:a.name,partitionField:(null==i?void 0:i.name)||null,stopOnWarn:n,from:s.from,to:s.to,query:JSON.stringify(o)}});window.open(d,"_blank")}(p,e,t,n,E,a,o,f)},timeRange:o,layer:void 0,layerIndex:0,outerFormComplete:M},Object(g.jsx)(n.a.Fragment,null,Object(g.jsx)(r.EuiCheckableCard,{id:"count",label:Object(g.jsx)(n.a.Fragment,null,Object(g.jsx)(r.EuiTitle,{size:"xs"},Object(g.jsx)("h5",null,Object(g.jsx)(s.FormattedMessage,{defaultMessage:"Count",id:"xpack.ml.newJobFromPatternAnalysisFlyout.count.title"}))),Object(g.jsx)(r.EuiSpacer,{size:"s"}),Object(g.jsx)(s.FormattedMessage,{defaultMessage:"Look for anomalies in the event rate of a category.",id:"xpack.ml.newJobFromPatternAnalysisFlyout.count.description"}),Object(g.jsx)(r.EuiSpacer,{size:"xs"}),Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.newJobFromPatternAnalysisFlyout.count.description2",defaultMessage:"Recommended for categorizing all messages."})),checked:p===b.a.COUNT,onChange:()=>C(b.a.COUNT)}),Object(g.jsx)(r.EuiSpacer,{size:"m"}),Object(g.jsx)(r.EuiCheckableCard,{id:"highCount",label:Object(g.jsx)(n.a.Fragment,null,Object(g.jsx)(r.EuiTitle,{size:"xs"},Object(g.jsx)("h5",null,Object(g.jsx)(s.FormattedMessage,{defaultMessage:"High count",id:"xpack.ml.newJobFromPatternAnalysisFlyout.highCount.title"}))),Object(g.jsx)(r.EuiSpacer,{size:"s"}),Object(g.jsx)(s.FormattedMessage,{defaultMessage:"Look for unusually high counts of a category in the event rate.",id:"xpack.ml.newJobFromPatternAnalysisFlyout.highCount.description"}),Object(g.jsx)(r.EuiSpacer,{size:"xs"}),Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.newJobFromPatternAnalysisFlyout.highCount.description2",defaultMessage:"Recommended for categorizing error messages."})),checked:p===b.a.HIGH_COUNT,onChange:()=>C(b.a.HIGH_COUNT)}),Object(g.jsx)(r.EuiSpacer,{size:"m"}),Object(g.jsx)(r.EuiCheckableCard,{id:"rare",label:Object(g.jsx)(n.a.Fragment,null,Object(g.jsx)(r.EuiTitle,{size:"xs"},Object(g.jsx)("h5",null,Object(g.jsx)(s.FormattedMessage,{defaultMessage:"Rare",id:"xpack.ml.newJobFromPatternAnalysisFlyout.rare.title"}))),Object(g.jsx)(r.EuiSpacer,{size:"s"}),Object(g.jsx)(s.FormattedMessage,{defaultMessage:"Look for categories that occur rarely in time.",id:"xpack.ml.newJobFromPatternAnalysisFlyout.rare.description"})),checked:p===b.a.RARE,onChange:()=>C(b.a.RARE)}),Object(g.jsx)(r.EuiSpacer,{size:"m"}),Object(g.jsx)(r.EuiSwitch,{name:"categorizationPerPartitionSwitch",disabled:!1,checked:h,onChange:J,"data-test-subj":"mlNewJobFromPatternAnalysisFlyoutSwitchCategorizationPerPartition",label:Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.newJobFromPatternAnalysisFlyout.perPartitionCategorizationSwitchLabel",defaultMessage:"Enable per-partition categorization"})}),h?Object(g.jsx)(n.a.Fragment,null,Object(g.jsx)(r.EuiSpacer,{size:"m"}),Object(g.jsx)(r.EuiCallOut,{size:"s",title:Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.newJobFromPatternAnalysisFlyout.categorizationPerPartitionField.infoCallout",defaultMessage:"Determine categories independently for each value of the partition field."})}),Object(g.jsx)(r.EuiSpacer,{size:"m"}),Object(g.jsx)(r.EuiFormRow,{label:Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.newJobFromPatternAnalysisFlyout.categorizationPerPartitionFieldLabel",defaultMessage:"Partition field"})},Object(g.jsx)(r.EuiComboBox,{singleSelection:{asPlainText:!0},options:S,selectedOptions:k,onChange:z,isClearable:!0})),Object(g.jsx)(r.EuiSpacer,{size:"m"}),Object(g.jsx)(r.EuiSwitch,{name:"categorizationPerPartitionSwitch",disabled:!1,checked:E,onChange:v,label:Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.newJobFromPatternAnalysisFlyout.stopOnWarnSwitchLabel",defaultMessage:"Stop on warn"})})):null,Object(g.jsx)(r.EuiSpacer,{size:"m"}),Object(g.jsx)(r.EuiHorizontalRule,{margin:"m"})))},f=({onClose:e,dataView:t,field:a,query:i,timeRange:o})=>Object(g.jsx)(n.a.Fragment,null,Object(g.jsx)(r.EuiFlyoutHeader,{hasBorder:!0},Object(g.jsx)(r.EuiTitle,{size:"s"},Object(g.jsx)("h3",null,Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.embeddables.newJobFromPatternAnalysisFlyout.title",defaultMessage:"Create anomaly detection job"}))),Object(g.jsx)(r.EuiSpacer,{size:"m"}),Object(g.jsx)(r.EuiText,{size:"s"},Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.embeddables.newJobFromPatternAnalysisFlyout.secondTitle",defaultMessage:"Create a categorization job for {field}",values:{field:a.name}}))),Object(g.jsx)(r.EuiFlyoutBody,null,Object(g.jsx)(O,{dataView:t,field:a,query:i,timeRange:o})),Object(g.jsx)(r.EuiFlyoutFooter,null,Object(g.jsx)(r.EuiFlexGroup,{justifyContent:"spaceBetween"},Object(g.jsx)(r.EuiFlexItem,{grow:!1},Object(g.jsx)(r.EuiButtonEmpty,{iconType:"cross",onClick:e,flush:"left"},Object(g.jsx)(s.FormattedMessage,{id:"xpack.ml.embeddables.newJobFromPatternAnalysisFlyout.closeButton",defaultMessage:"Close"}))))));async function x(e,t,a,i,n,s,r,c,l){return Object(o.a)((({onClose:n})=>Object(g.jsx)(f,{dataView:e,field:t,query:a,timeRange:i,onClose:n})),n,s,r,c,l)}}}]);