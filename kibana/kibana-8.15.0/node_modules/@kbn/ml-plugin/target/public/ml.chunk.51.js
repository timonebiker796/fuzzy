/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[51,93],{187:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var a=s(73);function o(e,t,s,o){const i=null!=o?o:a.mlJobService.getJob(s),n=[];if(void 0===i)return n;const r=e,l=i.analysis_config.detectors[r],c=t,d=null==l?void 0:l.partition_field_name,u=null==l?void 0:l.over_field_name,m=null==l?void 0:l.by_field_name;if(void 0!==d){var h;const e=null!==(h=null==c?void 0:c[d])&&void 0!==h?h:null;n.push({fieldType:"partition_field",fieldName:d,fieldValue:e})}if(void 0!==u){var p;const e=null!==(p=null==c?void 0:c[u])&&void 0!==p?p:null;n.push({fieldType:"over_field",fieldName:u,fieldValue:e})}if(void 0!==m&&void 0===u){var b;const e=null!==(b=null==c?void 0:c[m])&&void 0!==b?b:null;n.push({fieldType:"by_field",fieldName:m,fieldValue:e})}return n}},213:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var a=s(123);function o(e){const t=e.analysis_config.detectors,s=[];return t.forEach(((t,o)=>{Object(a.q)(e,o)&&s.push({index:o,detector_description:t.detector_description,function:t.function})})),s}},214:function(e,t,s){"use strict";s.d(t,"b",(function(){return u})),s.d(t,"d",(function(){return m})),s.d(t,"a",(function(){return h})),s.d(t,"c",(function(){return p})),s.d(t,"e",(function(){return b})),s.d(t,"f",(function(){return f})),s.d(t,"g",(function(){return g})),s.d(t,"h",(function(){return j})),s.d(t,"i",(function(){return S})),s.d(t,"o",(function(){return O})),s.d(t,"p",(function(){return E})),s.d(t,"j",(function(){return y})),s.d(t,"m",(function(){return F})),s.d(t,"k",(function(){return w})),s.d(t,"l",(function(){return I})),s.d(t,"n",(function(){return C}));var a=s(145),o=s.n(a),i=s(252),n=s(135),r=s(39),l=s.n(r),c=s(132),d=s(1);const u=7,m=5,h=10,p=100;function b(e=[],t){let s=1/0,a=-1/0;e.forEach((e=>{let t=e.value;const o=Array.isArray(e.actual)?e.actual[0]:e.actual,i=Array.isArray(e.typical)?e.typical[0]:e.typical;null===t&&void 0!==e.anomalyScore&&void 0!==e.actual&&(t=o),void 0!==e.anomalyScore&&void 0!==o?(s=Math.min(s,t,o,i),a=Math.max(a,t,o,i)):(s=Math.min(s,t),a=Math.max(a,t))}));const o={max:a,min:s};if(o.max===o.min){const e=.05*o.max;o.max+=e,o.min-=e}return"count"===t&&o.min<0&&(o.min=0),o}function f(e,t,s,a=1.5){const o=e.reduce(((t,s,a)=>{const o=e[a-1],i=e[a+1];return(void 0===o||o&&null===o.value)&&null!==s.value&&(void 0===i||i&&null===i.value)&&t.push(s),t}),[]),i=(t.select(".values-dots").empty()?t.append("g").classed("values-dots",!0):t.select(".values-dots")).selectAll("circle").data(o);i.enter().append("circle").attr("r",a),i.attr("cx",s.x()).attr("cy",s.y()),i.exit().remove()}function g(e,t){if(void 0===e||void 0===e.selectAll)throw new Error("Missing selection parameter");e.selectAll(".tick text").text((function(){const e=o.a.select(this.parentNode),s=e.node().getBBox().width,a=o.a.transform(e.attr("transform")).translate[0];if(a-s/2>=0&&a+s/2<=t)return this.textContent;e.remove()}))}const x=!0,v=!0;function j(e){let t=c.b.SINGLE_METRIC;if("lat_long"===e.functionDescription||void 0!==e.mapData)return c.b.GEO_MAP;if(x&&"rare"===e.functionDescription&&!1===e.entityFields.some((e=>"over"===e.fieldType))?t=c.b.EVENT_DISTRIBUTION:v&&"rare"!==e.functionDescription&&e.entityFields.some((e=>"over"===e.fieldType))&&null!==e.metricFunction&&(t=c.b.POPULATION_DISTRIBUTION),(t===c.b.EVENT_DISTRIBUTION||t===c.b.POPULATION_DISTRIBUTION)&&void 0!==e.datafeedConfig&&void 0!==e.datafeedConfig.script_fields){const s=Object.keys(e.datafeedConfig.script_fields),a=e.entityFields.map((e=>e.fieldName));e.metricFieldName&&a.push(e.metricFieldName),!0==(void 0!==a.find((e=>s.includes(e))))&&(t=c.b.SINGLE_METRIC)}return t}async function S(e,t,s){const a=l()(t.plotEarliest).toISOString(),o=l()(t.plotLatest).toISOString();let i;return t.entityFields.length>0&&(i={},t.entityFields.forEach((e=>{i[e.fieldName]=e.fieldValue}))),await e.getUrl({page:d.b.SINGLE_METRIC_VIEWER,pageState:{jobIds:[t.jobId],refreshInterval:{display:"Off",pause:!0,value:0},timeRange:s,zoom:{from:a,to:o},detectorIndex:t.detectorIndex,entities:i,query:{query_string:{analyze_wildcard:!0,query:"*"}}}},{absolute:!0})}function O(e){return!0===e.isMultiBucketAnomaly}function E(e){return!0===e.isMultiBucketAnomaly}function y(e){const t=void 0!==e.multiBucketImpact?Object(i.c)(e.multiBucketImpact):0;return new Array(5).fill("■ ",0,t).fill("□ ",t).join("")}function F(e,t){return e/(1.75*Object(n.a)(l()().format(t),!1))}const M={NEXT:"next",PREVIOUS:"previous"};function w(e,t,s,a){if(t<=0)throw Error("tickInterval must be larger than 0.");const o=[e];function i(e,n){let r,l;switch(n){case M.PREVIOUS:r=e-t,l=r>=s;break;case M.NEXT:r=e+t,l=r<=a}l&&(o.push(r),i(r,n))}return i(e,M.PREVIOUS),i(e,M.NEXT),o.sort(),o}const T=60;function I({detectorLabel:e,entityFields:t}){return e.length+t.map((e=>`${e.fieldName} ${e.fieldValue}`)).join(" ").length>T}function C(e,t,s,a){function i(e){return function(t){switch(e){case M.PREVIOUS:return t-s;case M.NEXT:return t+s}}}function n(t,s){const r=function(t){const s=i(t),a=function(t){const i=e.selectAll(".tick").filter((e=>e===t));if(0===i.length||0===i[0].length)return!1;const n=o.a.selectAll(i[0]),r=n.select("text").node();if(null===r)return a(s(t));const l=r.getBBox().width,c=function(e){const t=/translate\(\s*([^\s,)]+)([ ,]([^\s,)]+))?\)/.exec(e);return Array.isArray(t)&&t.length>=2?Number(t[1]):NaN}(n.attr("transform"));return{tick:n,ts:t,xMinOffset:c-(l/2+15),xMaxOffset:c+(l/2+15)}};return a}(s),l=r(t);if(!1===l)return;const c=r(i(s)(t));!1!==c&&(c.xMinOffset<0||c.xMaxOffset>a||c.xMaxOffset>l.xMinOffset&&s===M.PREVIOUS||c.xMinOffset<l.xMaxOffset&&s===M.NEXT?(c.tick.select("text").remove(),c.tick.select("line").classed("ml-tick-emphasis",!1),n(l.ts,s)):n(c.ts,s))}e.selectAll("g.tick").select("line").classed("ml-tick-emphasis",!0),n(t,M.PREVIOUS),n(t,M.NEXT)}},240:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var a=s(2),o=s.n(a),i=s(25),n=s(6);const r=({height:e,label:t})=>(e=e?+e:100,Object(n.jsx)(i.EuiFlexGroup,{justifyContent:"spaceEvenly"},Object(n.jsx)(i.EuiFlexItem,{grow:!1},Object(n.jsx)("div",{style:{height:`${e}px`},"data-test-subj":"mlLoadingIndicator"},Object(n.jsx)(i.EuiLoadingChart,{size:"xl",mono:!0}),t&&Object(n.jsx)(o.a.Fragment,null,Object(n.jsx)(i.EuiSpacer,{size:"s"}),Object(n.jsx)("div",null,t))))))},242:function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return c}));var a=s(5),o=s(7),i=s(830),n=s(187),r=s(213);function l(e,t){const s=Object(r.a)(e);if(Array.isArray(s)&&s.length>=t){const s=e.analysis_config.detectors[t];if((null==s?void 0:s.function)===i.b.METRIC)return!0}return!1}const c=async({selectedDetectorIndex:e,selectedEntities:t,selectedJobId:s,selectedJob:r},c,d)=>{if(!l(r,e))return;const u=[{fieldName:"detector_index",fieldValue:e},...Object(n.a)(e,t,s).filter((e=>null!==e.fieldValue))];try{const e=await Object(o.lastValueFrom)(d.getRecordsForCriteria([r.job_id],u,0,null,null,1));if(Array.isArray(null==e?void 0:e.records)&&1===e.records.length){const t=e.records[0];return null==t?void 0:t.function_description}return i.a.AVG}catch(e){c.displayErrorToast(e,a.i18n.translate("xpack.ml.timeSeriesExplorer.highestAnomalyScoreErrorToastTitle",{defaultMessage:"An error occurred getting record with the highest anomaly score"}))}}},315:function(e,t,s){"use strict";s.r(t),s.d(t,"AnnotationFlyoutUI",(function(){return annotation_flyout_AnnotationFlyoutUI})),s.d(t,"AnnotationFlyout",(function(){return w}));var a=s(120),o=s.n(a),i=s(4),n=s.n(i),r=s(2),l=s.n(r),c=s(26),d=s.n(c),u=s(8),m=s(25),h=s(5),p=s(15),b=s(349),f=s(197),g=s(153),x=s(415),v=s(6);const j=({annotation:e,detectorDescription:t})=>{const s=[{title:h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.jobIdTitle",{defaultMessage:"Job ID"}),description:e.job_id},{title:h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.startTitle",{defaultMessage:"Start"}),description:Object(x.c)(e.timestamp)}];var a,o,i,n,r;return void 0!==e.end_timestamp&&s.push({title:h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.endTitle",{defaultMessage:"End"}),description:Object(x.c)(e.end_timestamp)}),void 0!==e.create_time&&void 0!==e.modified_time&&(s.push({title:h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.createdTitle",{defaultMessage:"Created"}),description:Object(x.c)(e.create_time)}),s.push({title:h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.createdByTitle",{defaultMessage:"Created by"}),description:null!==(a=e.create_username)&&void 0!==a?a:""}),s.push({title:h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.lastModifiedTitle",{defaultMessage:"Last modified"}),description:Object(x.c)(e.modified_time)}),s.push({title:h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.modifiedByTitle",{defaultMessage:"Modified by"}),description:null!==(o=e.modified_username)&&void 0!==o?o:""})),void 0!==t&&s.push({title:h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.detectorTitle",{defaultMessage:"Detector"}),description:t}),void 0!==e.partition_field_name&&s.push({title:e.partition_field_name,description:null!==(i=e.partition_field_value)&&void 0!==i?i:""}),void 0!==e.over_field_name&&s.push({title:e.over_field_name,description:null!==(n=e.over_field_value)&&void 0!==n?n:""}),void 0!==e.by_field_name&&s.push({title:e.by_field_name,description:null!==(r=e.by_field_value)&&void 0!==r?r:""}),Object(v.jsx)(m.EuiDescriptionList,{"data-test-subj":"mlAnnotationDescriptionList",className:"ml-annotation-description-list",type:"column",columnWidths:[3,7],listItems:s})},S=({cancelAction:e,deleteAction:t,isVisible:s})=>Object(v.jsx)(r.Fragment,null,!0===s&&Object(v.jsx)(m.EuiConfirmModal,{title:h.i18n.translate("xpack.ml.timeSeriesExplorer.deleteAnnotationModal.deleteAnnotationTitle",{defaultMessage:"Delete this annotation?"}),onCancel:e,onConfirm:t,cancelButtonText:h.i18n.translate("xpack.ml.timeSeriesExplorer.deleteAnnotationModal.cancelButtonLabel",{defaultMessage:"Cancel"}),confirmButtonText:h.i18n.translate("xpack.ml.timeSeriesExplorer.deleteAnnotationModal.deleteButtonLabel",{defaultMessage:"Delete"}),buttonColor:"danger",defaultFocusedButton:m.EUI_MODAL_CONFIRM_BUTTON,className:"eui-textBreakWord","data-test-subj":"mlAnnotationFlyoutConfirmDeleteModal"}));var O=s(11),E=s(17);function y(e){return`${e}_name`}function F(e){return`${e}_value`}var M=s(170);class annotation_flyout_AnnotationFlyoutUI extends r.Component{constructor(...e){super(...e),n()(this,"deletionInProgress",!1),n()(this,"state",{isDeleteModalVisible:!1,applyAnnotationToSeries:!0,annotationState:null}),n()(this,"annotationSub",null),n()(this,"annotationTextChangeHandler",(e=>{if(null===this.state.annotationState)return;const{annotationUpdatesService:t}=this.props;t.setValue({...this.state.annotationState,annotation:e.target.value})})),n()(this,"cancelEditingHandler",(()=>{const{annotationUpdatesService:e}=this.props;e.setValue(null)})),n()(this,"deleteConfirmHandler",(()=>{this.setState({isDeleteModalVisible:!0})})),n()(this,"deleteHandler",(async()=>{if(this.deletionInProgress)return;const{annotationState:e}=this.state,t=Object(E.f)();if(null===e||void 0===e._id)return;this.deletionInProgress=!0;try{await O.ml.annotations.deleteAnnotation(e._id),t.addSuccess(h.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.deletedAnnotationNotificationMessage",{defaultMessage:"Deleted annotation for job with ID {jobId}.",values:{jobId:e.job_id}}))}catch(s){t.addDanger(h.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.errorWithDeletingAnnotationNotificationErrorMessage",{defaultMessage:"An error occurred deleting the annotation for job with ID {jobId}: {error}",values:{jobId:e.job_id,error:JSON.stringify(s)}}))}this.closeDeleteModal(),this.deletionInProgress=!1;const{annotationUpdatesService:s}=this.props;s.setValue(null),Object(g.c)()})),n()(this,"closeDeleteModal",(()=>{this.setState({isDeleteModalVisible:!1})})),n()(this,"validateAnnotationText",(()=>{const{annotationState:e}=this.state,t=[];if(null===e)return t;0===e.annotation.trim().length&&t.push(h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationFlyout.noAnnotationTextError",{defaultMessage:"Enter annotation text"}));const s=e.annotation.length;if(s>f.c){const e=s-f.c;t.push(h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationFlyout.maxLengthError",{defaultMessage:"{charsOver, number} {charsOver, plural, one {character} other {characters}} above maximum length of {maxChars}",values:{maxChars:f.c,charsOver:e}}))}return t})),n()(this,"saveOrUpdateAnnotation",(()=>{var e,t;const{annotationState:s}=this.state,{chartDetails:a,detectorIndex:o,annotationUpdatesService:i}=this.props;if(null===s)return;const n=Object(u.cloneDeep)(s);this.state.applyAnnotationToSeries&&null!=a&&null!==(e=a.entityData)&&void 0!==e&&e.entities&&(a.entityData.entities.forEach((e=>{const{fieldName:t,fieldValue:s}=e,a=e.fieldType;n[y(a)]=t,n[F(a)]=s})),n.detector_index=o),this.state.applyAnnotationToSeries||(delete n.detector_index,b.c.forEach((e=>{delete n[y(e)],delete n[F(e)]}))),n.event=null!==(t=n.event)&&void 0!==t?t:f.b,i.setValue(null),O.ml.annotations.indexAnnotation(n).then((()=>{Object(g.c)();const e=Object(E.f)();void 0===n._id?e.addSuccess(h.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.addedAnnotationNotificationMessage",{defaultMessage:"Added an annotation for job with ID {jobId}.",values:{jobId:n.job_id}})):e.addSuccess(h.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.updatedAnnotationNotificationMessage",{defaultMessage:"Updated annotation for job with ID {jobId}.",values:{jobId:n.job_id}}))})).catch((e=>{const t=Object(E.f)();void 0===n._id?t.addDanger(h.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.errorWithCreatingAnnotationNotificationErrorMessage",{defaultMessage:"An error occurred creating the annotation for job with ID {jobId}: {error}",values:{jobId:n.job_id,error:JSON.stringify(e)}})):t.addDanger(h.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.errorWithUpdatingAnnotationNotificationErrorMessage",{defaultMessage:"An error occurred updating the annotation for job with ID {jobId}: {error}",values:{jobId:n.job_id,error:JSON.stringify(e)}}))}))}))}componentDidMount(){const{annotationUpdatesService:e}=this.props;this.annotationSub=e.update$().subscribe((e=>{this.setState({annotationState:e})}))}componentWillUnmount(){this.annotationSub.unsubscribe()}render(){const{detectors:e,detectorIndex:t}=this.props,{annotationState:s,isDeleteModalVisible:a}=this.state;if(!s)return null;const o=void 0!==s._id,i=this.validateAnnotationText(),n=i.length>0;let r=null;!1===n&&s.annotation.length>.95*f.c&&(r=h.i18n.translate("xpack.ml.timeSeriesExplorer.annotationFlyout.approachingMaxLengthWarning",{defaultMessage:"{charsRemaining, number} {charsRemaining, plural, one {character} other {characters}} remaining",values:{charsRemaining:f.c-s.annotation.length}}));const c=e?e.find((e=>e.index===t)):void 0,d=c&&"detector_description"in c?c.detector_description:"";return Object(v.jsx)(l.a.Fragment,null,Object(v.jsx)(m.EuiFlyoutBody,null,Object(v.jsx)(j,{annotation:s,detectorDescription:d}),Object(v.jsx)(m.EuiSpacer,{size:"m"}),Object(v.jsx)(m.EuiFormRow,{label:Object(v.jsx)(p.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.annotationTextLabel",defaultMessage:"Annotation text"}),fullWidth:!0,helpText:r,isInvalid:n,error:i},Object(v.jsx)(m.EuiTextArea,{fullWidth:!0,isInvalid:n,onChange:this.annotationTextChangeHandler,placeholder:"...",value:s.annotation,"data-test-subj":"mlAnnotationsFlyoutTextInput"})),Object(v.jsx)(m.EuiFormRow,null,Object(v.jsx)(m.EuiCheckbox,{id:"xpack.ml.annotationFlyout.applyToPartition",label:Object(v.jsx)(p.FormattedMessage,{id:"xpack.ml.annotationFlyout.applyToPartitionTextLabel",defaultMessage:"Apply annotation to this series"}),checked:this.state.applyAnnotationToSeries,onChange:()=>this.setState({applyAnnotationToSeries:!this.state.applyAnnotationToSeries}),"data-test-subj":"mlAnnotationsFlyoutApplyToSeriesButton"}))),Object(v.jsx)(m.EuiFlyoutFooter,null,Object(v.jsx)(m.EuiFlexGroup,null,Object(v.jsx)(m.EuiFlexItem,{grow:!1},Object(v.jsx)(m.EuiButtonEmpty,{onClick:this.cancelEditingHandler,flush:"left","data-test-subj":"mlAnnotationsFlyoutCancelButton"},Object(v.jsx)(p.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.cancelButtonLabel",defaultMessage:"Cancel"}))),Object(v.jsx)(m.EuiFlexItem,{grow:!1,style:{marginLeft:"auto"}},o&&Object(v.jsx)(m.EuiButtonEmpty,{color:"danger",onClick:this.deleteConfirmHandler,"data-test-subj":"mlAnnotationsFlyoutDeleteButton"},Object(v.jsx)(p.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.deleteButtonLabel",defaultMessage:"Delete"}))),Object(v.jsx)(m.EuiFlexItem,{grow:!1},Object(v.jsx)(m.EuiButton,{fill:!0,isDisabled:!0===n,onClick:this.saveOrUpdateAnnotation,"data-test-subj":"annotationFlyoutUpdateOrCreateButton"},o?Object(v.jsx)(p.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.updateButtonLabel",defaultMessage:"Update"}):Object(v.jsx)(p.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.createButtonLabel",defaultMessage:"Create"}))))),Object(v.jsx)(S,{cancelAction:this.closeDeleteModal,deleteAction:this.deleteHandler,isVisible:a}))}}const w=e=>{const t=Object(r.useContext)(M.a),s=d()(t.isAnnotationInitialized$()),a=Object(r.useCallback)((()=>{t.setValue(null)}),[]);if(null==s)return null;const i=void 0!==s._id;return Object(v.jsx)(m.EuiFlyout,{onClose:a,size:"m","aria-labelledby":"Add annotation","data-test-subj":"mlAnnotationFlyout",className:"mlAnnotationFlyout"},Object(v.jsx)(m.EuiFlyoutHeader,{hasBorder:!0},Object(v.jsx)(m.EuiTitle,{size:"s","data-test-subj":"mlAnnotationFlyoutTitle"},Object(v.jsx)("h2",{id:"mlAnnotationFlyoutTitle"},i?Object(v.jsx)(p.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.editAnnotationTitle",defaultMessage:"Edit annotation"}):Object(v.jsx)(p.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.addAnnotationTitle",defaultMessage:"Add annotation"})))),Object(v.jsx)(annotation_flyout_AnnotationFlyoutUI,o()({},e,{annotationUpdatesService:t})))}},319:function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return l}));var a=s(8),o=s(5),i=s(123),n=s(73);function r(e,t,s,r,l){const c=n.mlJobService.jobs.filter(i.r),d=c.map((e=>e.job_id)),u=Object(a.difference)(t,d),m=Object(a.without)(t,...u);if(1===u.length){const t=u[0],s=e.find((e=>e.id===t));if(void 0!==s&&void 0!==s.isNotSingleMetricViewerJobMessage){const e=o.i18n.translate("xpack.ml.timeSeriesExplorer.canNotViewRequestedJobsWarningWithReasonMessage",{defaultMessage:"You can't view {selectedJobId} in this dashboard because {reason}.",values:{selectedJobId:t,reason:s.isNotSingleMetricViewerJobMessage}});r.addWarning({title:e,"data-test-subj":"mlTimeSeriesExplorerDisabledJobReasonWarningToast"})}}if(u.length>1){let e=o.i18n.translate("xpack.ml.timeSeriesExplorer.canNotViewRequestedJobsWarningMessage",{defaultMessage:"You can't view requested {invalidIdsCount, plural, one {job} other {jobs}} {invalidIds} in this dashboard",values:{invalidIdsCount:u.length,invalidIds:u.join(", ")}});0===m.length&&d.length>0&&(e+=o.i18n.translate("xpack.ml.timeSeriesExplorer.autoSelectingFirstJobText",{defaultMessage:", auto selecting first job"})),r.addWarning(e)}return m.length>1?(r.addWarning(o.i18n.translate("xpack.ml.timeSeriesExplorer.youCanViewOneJobAtTimeWarningMessage",{defaultMessage:"You can only view one job at a time in this dashboard"})),s("ml",{jobIds:[m[0]]}),!0):u.length>0&&m.length>0?(s("ml",{jobIds:[m[0]]}),!0):1===m.length?m[0]:0===m.length&&c.length>0&&(l({singleSelection:!0,timeseriesOnly:!0}).then((({jobIds:e,time:t})=>{s({ml:{jobIds:e},...void 0!==t?{time:t}:{}})})).catch((e=>{})),!0)}function l(){return{chartDetails:void 0,contextAggregationInterval:void 0,contextChartData:void 0,contextForecastData:void 0,dataNotChartable:!1,entitiesLoading:!1,entityValues:{},focusAnnotationData:[],focusAggregationInterval:{},focusChartData:void 0,focusForecastData:void 0,fullRefresh:!0,hasResults:!1,loadCounter:0,loading:!1,modelPlotEnabled:!1,showAnnotations:!0,showAnnotationsCheckbox:!0,showForecast:!0,showForecastCheckbox:!1,showModelBounds:!0,showModelBoundsCheckbox:!1,svgWidth:0,tableData:void 0,zoomFrom:void 0,zoomTo:void 0,zoomFromFocusLoaded:void 0,zoomToFocusLoaded:void 0,chartDataError:void 0,sourceIndicesWithGeoFields:{}}}},324:function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s(2);var a=s(25),o=s(5),i=s(6);const n=({dataNotChartable:e,entities:t})=>Object(i.jsx)(a.EuiEmptyPrompt,{iconType:"iInCircle",title:Object(i.jsx)("h2",null,o.i18n.translate("xpack.ml.timeSeriesExplorer.noResultsFoundLabel",{defaultMessage:"No results found"})),body:e?Object(i.jsx)("p",null,o.i18n.translate("xpack.ml.timeSeriesExplorer.dataNotChartableDescription",{defaultMessage:"Model plot is not collected for the selected {entityCount, plural, one {entity} other {entities}}\nand the source data cannot be plotted for this detector.",values:{entityCount:t.length}})):Object(i.jsx)("p",null,o.i18n.translate("xpack.ml.timeSeriesExplorer.tryWideningTheTimeSelectionDescription",{defaultMessage:"Try widening the time selection or moving further back in time."}))})},374:function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s(2);var a=s(5),o=s(15),i=s(212),n=s(6);const r=({embeddableMode:e})=>Object(n.jsx)(i.a,{anchorPosition:"upCenter",title:a.i18n.translate("xpack.ml.timeSeriesExplorer.popoverTitle",{defaultMessage:"Single time series analysis"})},Object(n.jsx)("p",null,Object(n.jsx)(o.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.popoverBasicExplanation",defaultMessage:"This chart illustrates the actual data values over time for a specific detector. You can examine an event by sliding the time selector and changing its length. For the most accurate view, set the zoom size to auto."})),Object(n.jsx)("p",null,Object(n.jsx)(o.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.popoverAnomalyExplanation",defaultMessage:"An anomaly score is calculated for each bucket time interval, with a value from 0 to 100. Anomalous events are highlighted in colors that indicate their severity. If an anomaly is depicted with a cross symbol instead of a dot, it has a moderate, significant, or high multi-bucket impact. This extra analysis can catch anomalies even when they fall within the bounds of expected behavior."})),Object(n.jsx)("p",null,Object(n.jsx)(o.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.popoverForecastExplanation",defaultMessage:"If you create a forecast, predicted data values are added to the chart. A shaded area around these values represents the confidence level; as you forecast further into the future, the confidence level generally decreases."})),!e&&Object(n.jsx)("p",null,Object(n.jsx)(o.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.popoverAnnotationsExplanation",defaultMessage:"You can also optionally annotate your job results by drag-selecting a period of time in the chart and adding a description. Some annotations are generated automatically to indicate noteworthy occurrences."})),Object(n.jsx)("p",null,Object(n.jsx)(o.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.popoverModelPlotExplanation",defaultMessage:"If model plot is enabled, you can optionally show model bounds, which are represented by a shaded area in the chart. As the job analyzes more data, it learns to more closely predict the expected patterns of behavior."})))},376:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var a=s(5);const o=e=>a.i18n.translate("xpack.ml.singleMetricViewerEmbeddable.title",{defaultMessage:"ML single metric viewer chart for {jobId}",values:{jobId:e}})},377:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=s(2);t.default=function(e){var t=a.useRef();return a.useEffect((function(){t.current=e})),t.current}},392:function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var a=s(2),o=s(15),i=s(25),n=s(8),r=s(7),l=s(189),c=s(199),d=s(73),u=s(10),m=s(195),h=s(187),p=s(179),b=s(213),f=s(5),g=s(830),x=s(242),v=s(71),j=s(80),S=s(6);const O=[{value:"mean",text:f.i18n.translate("xpack.ml.timeSeriesExplorer.plotByAvgOptionLabel",{defaultMessage:"mean"})},{value:"min",text:f.i18n.translate("xpack.ml.timeSeriesExplorer.plotByMinOptionLabel",{defaultMessage:"min"})},{value:"max",text:f.i18n.translate("xpack.ml.timeSeriesExplorer.plotByMaxOptionLabel",{defaultMessage:"max"})}],E=({functionDescription:e,job:t,setFunctionDescription:s,selectedDetectorIndex:o,selectedJobId:n,selectedEntities:r,entityControlsCount:l})=>{const c=Object(v.useToastNotificationService)(),u=Object(j.useMlResultsService)(),m=Object(a.useCallback)((async(e,t,a,o)=>{const i=await Object(x.a)({selectedDetectorIndex:e,selectedEntities:t,selectedJobId:a,selectedJob:o},c,u);s(i)}),[s,c,u]);return Object(a.useEffect)((()=>{if(void 0!==e)return;const s=null!=t?t:d.mlJobService.getJob(n);if((0===l||l>0&&void 0!==r)&&void 0===e&&Object(x.b)(s,o)){const e=s.analysis_config.detectors[o];(null==e?void 0:e.function)===g.b.METRIC&&m(o,r,n,s)}}),[s,o,r,n,e,l]),void 0===e?null:Object(S.jsx)(i.EuiFlexItem,{grow:!1},Object(S.jsx)(i.EuiFormRow,{label:f.i18n.translate("xpack.ml.timeSeriesExplorer.metricPlotByOption",{defaultMessage:"Function"})},Object(S.jsx)(i.EuiSelect,{options:O,value:e,onChange:e=>s(e.target.value),"aria-label":f.i18n.translate("xpack.ml.timeSeriesExplorer.metricPlotByOptionLabel",{defaultMessage:"Pick function to plot by (min, max, or average) if metric function"})})))},y=({appStateHandler:e,bounds:t,children:s,direction:f="row",functionDescription:g,job:x,selectedDetectorIndex:v,selectedEntities:j,selectedJobId:O,setFunctionDescription:y})=>{var F;const{services:{mlServices:{mlApiServices:{results:M}}}}=Object(u.d)(),w=Object(a.useMemo)((()=>null!=x?x:d.mlJobService.getJob(O)),[O]),T=!(null===(F=w.model_plot_config)||void 0===F||!F.enabled),[I,C]=Object(a.useState)(!1),[A,k]=Object(a.useState)({}),D=Object(a.useMemo)((()=>Object(b.a)(w)),[w]),_=Object(a.useMemo)((()=>Object(h.a)(v,j,O,w)),[v,j,O]),[R,N]=Object(l.b)(p.d),B=Object(a.useMemo)((()=>{return{...(e=_.map((e=>e.fieldType)),t=!R||Object.values(R).some((e=>!(null==e||!e.anomalousOnly))),s=!R||Object.values(R).some((e=>!(null==e||!e.applyTimeRange))),e.reduce(((e,a)=>(e[a]={applyTimeRange:s,anomalousOnly:t,sort:{by:"anomaly_score",order:"desc"}},e)),{})),...R||{}};var e,t,s}),[_,R]),z=async(e={})=>{C(!0);const s=v,a=B?Object.fromEntries(Object.entries(B).filter((([e])=>_.some((t=>t.fieldType===e))))):void 0,{partition_field:o,over_field:i,by_field:n}=await Object(r.lastValueFrom)(M.fetchPartitionFieldsValues(w.job_id,e,[{fieldName:"detector_index",fieldValue:s}],t.min.valueOf(),t.max.valueOf(),a)),l={};_.forEach((e=>{let t;(null==o?void 0:o.name)===e.fieldName&&(t=o.values),(null==i?void 0:i.name)===e.fieldName&&(t=i.values),(null==n?void 0:n.name)===e.fieldName&&(t=n.values),l[e.fieldName]=t})),C(!1),k(l)};Object(a.useEffect)((()=>{z()}),[O,v,JSON.stringify(j),B]);const L=Object(n.debounce)((async(e,t)=>{await z({[e.fieldType]:t})}),500),P=(t,s)=>{const a={..._.reduce(((e,t)=>(e[t.fieldName]=t.fieldValue,e)),{}),[t.fieldName]:s};e(m.a.SET_ENTITIES,a)},J=Object(a.useCallback)((t=>{const s=t.target.value;void 0!==s&&e(m.a.SET_DETECTOR_INDEX,+s)}),[e]),V=D.map((e=>({value:e.index,text:e.detector_description}))),W=Object(a.useCallback)(((e,t)=>{var s,a;const o={...B[e]?B[e]:{},...t},i={...B};if((null===(s=B[e])||void 0===s?void 0:s.anomalousOnly)!==o.anomalousOnly)for(const e in i)i.hasOwnProperty(e)&&(i[e].anomalousOnly=o.anomalousOnly);if((null===(a=B[e])||void 0===a?void 0:a.applyTimeRange)!==o.applyTimeRange)for(const e in i)i.hasOwnProperty(e)&&(i[e].applyTimeRange=o.applyTimeRange);N({...i,[e]:o})}),[B,N]);let U=!1;return Object(S.jsx)("div",{"data-test-subj":"mlSingleMetricViewerSeriesControls"},Object(S.jsx)(i.EuiFlexGroup,{direction:f},Object(S.jsx)(i.EuiFlexItem,{grow:!1},Object(S.jsx)(i.EuiFormRow,{label:Object(S.jsx)(o.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.detectorLabel",defaultMessage:"Detector"})},Object(S.jsx)(i.EuiSelect,{onChange:J,value:v,options:V,"data-test-subj":"mlSingleMetricViewerDetectorSelect"}))),_.map((e=>{const t=`${e.fieldName}`,s=!U&&null===e.fieldValue;return U=!U&&s,Object(S.jsx)(c.b,{entity:e,entityFieldValueChanged:P,isLoading:I,onSearchChange:L,config:B[e.fieldType],onConfigChange:W,forceSelection:s,key:t,options:(a=A[e.fieldName],Array.isArray(a)?a.map((e=>({label:""===e.value?c.a:e.value,value:e}))):[]),isModelPlotEnabled:T});var a})),Object(S.jsx)(E,{job:x,selectedJobId:O,selectedDetectorIndex:v,selectedEntities:j,functionDescription:g,setFunctionDescription:y,entityControlsCount:_.length}),s))}},394:function(e,t,s){"use strict";s.d(t,"a",(function(){return se}));var a=s(120),o=s.n(a),i=s(2),n=s.n(i),r=s(5),l=s(322),c=s(309),d=s(4),u=s.n(d),m=s(26),h=s.n(m),p=s(8),b=s(145),f=s.n(b),g=s(39),x=s.n(g),v=s(25),j=s(252),S=s(529),O=s(415),E=s(21),y=s(194),F=s(214),M=s(234),w=s(262);function T(e,t,s,a){this.contextGroup=e,this.data=t,this.drawBounds=s,this.swimlaneHeight=a,this.mask=this.contextGroup.append("g").attr("class","mask"),this.leftGroup=this.mask.append("g").attr("class","left-mask"),this.rightGroup=this.mask.append("g").attr("class","right-mask"),this.leftPolygon=this.leftGroup.append("polygon"),this.rightPolygon=this.rightGroup.append("polygon"),!0===this.drawBounds&&(this.leftGroup.append("path").attr("class","left area bounds"),this.rightGroup.append("path").attr("class","right area bounds")),this.leftGroup.append("path").attr("class","left values-line"),this.rightGroup.append("path").attr("class","right values-line"),this._x=null,this._y=null}T.prototype.style=function(e,t){return this.leftGroup.style(e,t),this.rightGroup.style(e,t),this},T.prototype.x=function(e){return null==e?this._x:(this._x=e,this)},T.prototype.y=function(e){return null==e?this._y:(this._y=e,this)},T.prototype.redraw=function(){const e=this._y.domain(),t=e[0],s=e[1],a=this._x.domain(),o=a[0],i=a[1],n=this,r=this.data.filter((function(e){return e.date<n.from})),l=this.data.filter((function(e){return e.date>n.to}));if(!0===this.drawBounds){const e=f.a.svg.area().x((function(e){return n._x(e.date)||1})).y0((function(e){return n._y(Math.min(s,Math.max(e.lower,t)))})).y1((function(e){return n._y(Math.max(t,Math.min(e.upper,s)))})).defined((e=>null!==e.lower&&null!==e.upper));this.leftGroup.select(".left.area.bounds").attr("d",e(r)),this.rightGroup.select(".right.area.bounds").attr("d",e(l))}const c=f.a.svg.line().x((function(e){return n._x(e.date)})).y((function(e){return n._y(e.value)})).defined((e=>null!==e.value));this.leftGroup.select(".left.values-line").attr("d",c(r)),Object(F.f)(r,this.leftGroup,c,1),this.rightGroup.select(".right.values-line").attr("d",c(l)),Object(F.f)(l,this.rightGroup,c,1);const d=this._x(o),u=this._y(t)+this.swimlaneHeight,m=this._x(this.from),h=this._x(this.to),p=this._y(t)+this.swimlaneHeight,b=this._x(i);return this.leftPolygon.attr("points",d+","+u+"  "+m+","+u+"  "+m+",0  "+d+",0"),this.rightPolygon.attr("points",h+","+p+"  "+b+","+p+"  "+b+",0  "+h+",0"),this},T.prototype.reveal=function(e){return this.from=e[0],this.to=e[1],this.redraw(),this};var I=s(94),C=s(135),A=s(197);const k="mlAnnotationMask";function D(){const{annotationUpdatesService:e}=this.props,t=this.focusXScale,s=f.a.svg.brush().x(t).on("brushend",function(){const{selectedJob:t}=this.props,a=s.extent(),o=a[0].getTime(),i=a[1].getTime();if(o===i)return void e.setValue(null);const n={timestamp:o,end_timestamp:i,annotation:"",job_id:t.job_id,type:A.d.ANNOTATION};e.setValue(n)}.bind(this));return s}function _(e){const t={};return e.forEach(((s,a)=>{if(void 0!==s.key){const o=e.filter(((e,t)=>t<a));t[s.key]=o.reduce(((e,a)=>void 0===s.end_timestamp||void 0===a.end_timestamp||void 0===a.key||a.timestamp<s.timestamp&&a.end_timestamp<s.timestamp||a.timestamp>s.end_timestamp&&a.end_timestamp>s.end_timestamp?e:t[a.key]+1),0)}})),t}function R(e){f.a.selectAll(".mlAnnotation").each((function(t){const s=f.a.select(this);t._id===e._id?s.selectAll(".mlAnnotationRect").classed("mlAnnotationRect-isHighlight",!0):(s.selectAll(".mlAnnotationTextRect").classed("mlAnnotationTextRect-isBlur",!0),s.selectAll(".mlAnnotationText").classed("mlAnnotationText-isBlur",!0),s.selectAll(".mlAnnotationRect").classed("mlAnnotationRect-isBlur",!0))}))}function N(){f.a.selectAll(".mlAnnotation").each((function(){const e=f.a.select(this);e.selectAll(".mlAnnotationTextRect").classed("mlAnnotationTextRect-isBlur",!1),e.selectAll(".mlAnnotationRect").classed("mlAnnotationRect-isHighlight",!1).classed("mlAnnotationRect-isBlur",!1),e.selectAll(".mlAnnotationText").classed("mlAnnotationText-isBlur",!1)}))}var B=s(170),z=s(399),L=s(388),P=s(6);const J=350,V=25,W=310,U=335,H=25,G=F.a+4,q={top:10,right:10,bottom:15,left:40},X=[{duration:x.a.duration(1,"h"),label:"1h"},{duration:x.a.duration(12,"h"),label:"12h"},{duration:x.a.duration(1,"d"),label:"1d"},{duration:x.a.duration(1,"w"),label:"1w"},{duration:x.a.duration(2,"w"),label:"2w"},{duration:x.a.duration(1,"M"),label:"1M"}],Y=f.a.scale.threshold().domain([3,25,50,75,100]).range(["#d2e9f7","#8bc8fb","#ffdd00","#ff7e00","#fe5050"]),$=f.a.scale.threshold().domain([3,25,50,75,100]).range(["#dce7ed","#b0c5d6","#b1a34e","#b17f4e","#c88686"]);function Z(e){const t=e<J?J:e,s=Math.round(.634*t);return{focusChartHeight:s,focusHeight:V+s}}class timeseries_chart_TimeseriesChartIntl extends i.Component{constructor(e){super(e),u()(this,"getTimeBuckets",void 0),u()(this,"mlTimeSeriesExplorer",void 0),u()(this,"rowMouseenterSubscriber",null),u()(this,"rowMouseleaveSubscriber",null),u()(this,"contextChartInitialized",!1),u()(this,"drawContextBrush",(e=>{const{contextChartSelected:t}=this.props,s=this.brush,a=this.contextXScale,o=this.mask;s.x(a).on("brush",d).on("brushend",(function(){const o=s.empty()?a.domain():s.extent(),i=o[0].getTime(),n=o[1].getTime();void 0!==c.selectedBounds&&c.selectedBounds.min.valueOf()===i&&c.selectedBounds.max.valueOf()===n||(e.selectAll(".swimlane-cell").style("fill",(e=>{const t=e.date.getTime();return t<i||t>n?$(e.score):Y(e.score)})),c.selectedBounds={min:x()(i),max:x()(n)},t({from:o[0],to:o[1]}))})),e.append("g").attr("class","x brush").call(s).selectAll("rect").attr("y",-1).attr("height",91).attr("width",this.vizWidth);const i=s.extent();e.selectAll(".w rect").attr("x",-10).attr("width",10),e.selectAll(".e rect").attr("transform",null).attr("width",10);const n=e.append("rect").attr("class","top-border").attr("y",-2).attr("height",3),r=e.append("foreignObject").attr("width",10).attr("height",90).attr("class","brush-handle").attr("x",a(i[0])-10).html('\n        <div class="brush-handle-inner brush-handle-inner-left" style="padding-top: 27px">\n          <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="6" height="9">\n            <polygon points="5,0 5,8 0,4" />\n          </svg>\n        </div>'),l=e.append("foreignObject").attr("width",10).attr("height",90).attr("class","brush-handle").attr("x",a(i[1])+0).html('\n        <div class="brush-handle-inner brush-handle-inner-right" style="padding-top: 27px">\n          <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="6" height="9">\n            <polygon points="0,0 0,8 5,4" />\n          </svg>\n        </div>'),c=this;function d(){const e=s.extent();o.reveal(e),r.attr("x",a(e[0])-10),l.attr("x",a(e[1])+0),n.attr("x",a(e[0])+1);const t=Math.max(0,a(e[1])-a(e[0])-2);n.attr("width",t);const i=s.empty();f.a.select(c.rootNode).selectAll(".brush-handle").style("visibility",i?"hidden":"visible")}d()})),u()(this,"drawSwimlane",((e,t,s)=>{const{contextAggregationInterval:a,swimlaneData:o}=this.props,i=o;if(void 0===i)return;const n=this.calculateContextXAxisDomain(),r=f.a.time.scale().range([0,t]).domain(n),l=f.a.scale.linear().range([s,0]).domain([0,s]),c=f.a.svg.axis().scale(r).orient("bottom").innerTickSize(-s).outerTickSize(0),d=f.a.svg.axis().scale(l).orient("left").tickValues(l.domain()).innerTickSize(-t).outerTickSize(0),u=e.append("g");u.append("g").attr("class","x axis").attr("transform","translate(0,"+s+")").call(c),u.append("g").attr("class","y axis").call(d);const m=n[0].getTime();let h=t/((n[1].getTime()-m)/a.asMilliseconds());h<1&&(h=1),e.append("g").attr("class","swimlane-cells").selectAll("rect").data(i).enter().append("rect").attr("x",(e=>r(e.date))).attr("y",0).attr("rx",0).attr("ry",0).attr("class",(e=>e.score>0?"swimlane-cell":"swimlane-cell-hidden")).attr("width",h).attr("height",s).style("fill",(e=>Y(e.score)))})),u()(this,"calculateContextXAxisDomain",(()=>{const{bounds:e,contextAggregationInterval:t,swimlaneData:s}=this.props;let a=e.min.valueOf();void 0!==s&&s.length>0&&(a=Math.min(s[0].date.getTime(),e.min.valueOf()));const o=t.asMilliseconds(),i=Math.floor(a/o)*o,n=Math.ceil(e.max.valueOf()/o)*o;return[new Date(i),new Date(n)]})),u()(this,"setContextBrushExtent",((e,t)=>{const s=f.a.select(this.rootNode),a=this.brush,o=a.extent(),i=[e,t];a.extent(i),a(s.select(".brush")),i[0].getTime()===o[0].getTime()&&i[1].getTime()===o[1].getTime()||a.event(s.select(".brush"))})),u()(this,"setShowRuleEditorFlyoutFunction",(e=>{this.setState({showRuleEditorFlyout:e})})),u()(this,"unsetShowRuleEditorFlyoutFunction",(()=>{this.setState({showRuleEditorFlyout:()=>{}})})),this.state={popoverData:null,popoverCoords:[0,0],showRuleEditorFlyout:()=>{}}}componentWillUnmount(){f.a.select(this.rootNode).html(""),null!==this.rowMouseenterSubscriber&&this.rowMouseenterSubscriber.unsubscribe(),null!==this.rowMouseleaveSubscriber&&this.rowMouseleaveSubscriber.unsubscribe()}componentDidMount(){this.mlTimeSeriesExplorer=Object(I.timeSeriesExplorerServiceFactory)(this.context.services.uiSettings,this.context.services.mlServices.mlApiServices,this.context.services.mlServices.mlResultsService),this.getTimeBuckets=Object(M.a)(this.context.services.uiSettings).getTimeBuckets;const{svgWidth:e,svgHeight:t}=this.props,{focusHeight:s,focusChartHeight:a}=t?Z(t):{};this.vizWidth=e-q.left-q.right;const o=this.vizWidth;this.focusXScale=f.a.time.scale().range([0,o]),this.focusYScale=f.a.scale.linear().range([null!=s?s:U,V]);const i=this.focusXScale,n=this.focusYScale;this.focusXAxis=f.a.svg.axis().scale(i).orient("bottom").innerTickSize(-(null!=a?a:W)).outerTickSize(0).tickPadding(10),this.focusYAxis=f.a.svg.axis().scale(n).orient("left").innerTickSize(-o).outerTickSize(0).tickPadding(10),this.focusValuesLine=f.a.svg.line().x((function(e){return i(e.date)})).y((function(e){return n(e.value)})).defined((e=>null!==e.value)),this.focusBoundedArea=f.a.svg.area().x((function(e){return i(e.date)||1})).y0((function(e){return n(e.upper)})).y1((function(e){return n(e.lower)})).defined((e=>null!==e.lower&&null!==e.upper)),this.contextXScale=f.a.time.scale().range([0,o]),this.contextYScale=f.a.scale.linear().range([60,3]),this.fieldFormat=void 0,this.annotateBrush=D.call(this),this.brush=f.a.svg.brush(),this.mask=void 0;const r=this.highlightFocusChartAnomaly.bind(this),l=R.bind(this),c=this.unhighlightFocusChartAnomaly.bind(this),d=N.bind(this);this.rowMouseenterSubscriber=w.a.rowMouseenter$.subscribe(function({record:e,type:t="anomaly"}){null===this.state.popoverData&&("anomaly"===t?r(e):"annotation"===t&&l(e))}.bind(this)),this.rowMouseleaveSubscriber=w.a.rowMouseleave$.subscribe((function({record:e,type:t="anomaly"}){"anomaly"===t?c():d(e)})),this.renderChart(),this.drawContextChartSelection(),this.renderFocusChart()}componentDidUpdate(e){!1!==this.props.renderFocusChartOnly&&e.svgWidth===this.props.svgWidth&&e.showAnnotations===this.props.showAnnotations&&e.annotationData===this.props.annotationData||(this.renderChart(),this.drawContextChartSelection()),this.renderFocusChart(),null===this.props.annotation&&f.a.select(this.rootNode).select("g.mlAnnotationBrush").call(this.annotateBrush.extent([0,0]))}renderChart(){const{contextChartData:e,contextForecastData:t,detectorIndex:s,modelPlotEnabled:a,selectedJob:o,svgWidth:i,svgHeight:n,showAnnotations:r}=this.props,l=this.createFocusChart.bind(this),c=this.drawContextElements.bind(this),d=this.focusXScale,u=this.focusYAxis,m=this.focusYScale,h=function(e,t){const s=e?G:0,a=t&&t<J?J:t,{focusHeight:o}=t?Z(a):{};return(null!=o?o:U)+60+30+s+H+q.top+q.bottom}(r,n),{focusHeight:p}=n?Z(n):{},b=f.a.select(this.rootNode);if(b.selectAll("*").remove(),void 0===o)return;if(this.fieldFormat=this.context.services.mlServices.mlFieldFormatService.getFieldFormat(o.job_id,s),void 0===e)return;const g=this.fieldFormat,x=b.append("svg").attr("width",i).attr("height",h);let v,j;if(!0===a||void 0!==t&&t.length>0){const s=void 0===t?e:e.concat(t);v=f.a.min(s,(e=>Math.min(e.value,e.lower))),j=f.a.max(s,(e=>Math.max(e.value,e.upper)))}else v=f.a.min(e,(e=>e.value)),j=f.a.max(e,(e=>e.value));const S=j>0?Math.pow(10,Math.ceil(Math.log10(Math.abs(j)))):j,O=v>=0?v:-1*Math.pow(10,Math.ceil(Math.log10(Math.abs(v))));m.domain([O,S]);let E=0;x.append("g").attr("class","temp-axis-label tick").selectAll("text.temp.axis").data(m.ticks()).enter().append("text").text((e=>void 0!==g?g.convert(e,"text"):m.tickFormat()(e))).each((function(){E=Math.max(this.getBBox().width+u.tickPadding(),E)})).remove(),b.select(".temp-axis-label").remove(),q.left=Math.max(E,40),this.vizWidth=Math.max(i-q.left-q.right,0),d.range([0,this.vizWidth]),u.innerTickSize(-this.vizWidth),void 0!==p&&m.range([p,V]);const y=x.append("g").attr("class","focus-chart").attr("transform","translate("+q.left+","+q.top+")"),F=x.append("g").attr("class","context-chart").attr("transform","translate("+q.left+","+((null!=p?p:U)+q.top+H)+")");x.append("defs").append("mask").attr("id",k).append("rect").attr("x",0).attr("y",0).attr("width",this.vizWidth).attr("height",null!=p?p:U).style("fill","white"),l(y,this.vizWidth,null!=p?p:U),c(F,this.vizWidth,60,30,G)}drawContextChartSelection(){const{contextChartData:e,contextForecastData:t,zoomFrom:s,zoomTo:a}=this.props;if(void 0===e)return;let o,i;const n=this.contextXScale.domain()[0].getTime(),r=this.contextXScale.domain()[1].getTime();let l=e;if(void 0!==t&&(l=l.concat(t)),o=s?s.getTime():Object(p.reduce)(l,((e,t)=>Math.min(e,t.date.getTime())),new Date(2099,12,31).getTime()),o=Math.max(o,n),i=a?a.getTime():Object(p.reduce)(l,((e,t)=>Math.max(e,t.date.getTime())),0),i=Math.min(i,r),o!==n||i!==r){this.setContextBrushExtent(new Date(o),new Date(i));const e={min:x()(new Date(o)),max:x()(o)};this.selectedBounds=e}else{const e=this.contextXScale.domain(),t={min:x()(new Date(e[0])),max:x()(e[1])};Object(p.isEqual)(t,this.selectedBounds)||(this.selectedBounds=t,this.setContextBrushExtent(new Date(e[0]),new Date(e[1])))}}createFocusChart(e,t,s){const{contextForecastData:a}=this.props,{focusChartHeight:o}=this.props.svgHeight?Z(this.props.svgHeight):{},i=e.append("g").attr("class","focus-zoom");i.append("rect").attr("x",0).attr("y",0).attr("width",t).attr("height",V).attr("class","chart-border"),this.createZoomInfoElements(i,t);const n=this.annotateBrush.bind(this);let r=0,l=0;null!==this.props.annotation&&(r=this.focusXScale(this.props.annotation.timestamp),l=function(e,t){const s=t(e.timestamp)+1,a=void 0!==e.end_timestamp?t(e.end_timestamp)-1:s+8;return Math.max(8,a-s)}(this.props.annotation,this.focusXScale)),e.append("g").attr("class","mlAnnotationBrush").call(n).selectAll("rect").attr("x",r).attr("y",V).attr("width",l).attr("height",null!=o?o:W),e.append("g").classed("mlAnnotations",!0),e.append("rect").attr("x",0).attr("y",V).attr("width",t).attr("height",null!=o?o:W).attr("class","chart-border");const c=e.append("g").attr("class","x-axis-background");c.append("rect").attr("x",0).attr("y",s).attr("width",t).attr("height",H),c.append("line").attr("x1",0).attr("y1",s).attr("x2",0).attr("y2",s+H),c.append("line").attr("x1",t).attr("y1",s).attr("x2",t).attr("y2",s+H),c.append("line").attr("x1",0).attr("y1",s+H).attr("x2",t).attr("y2",s+H);const d=e.append("g");d.append("g").attr("class","x axis").attr("transform","translate(0,"+s+")"),d.append("g").attr("class","y axis"),e.append("path").attr("class","area bounds"),e.append("path").attr("class","values-line"),e.append("g").attr("class","focus-chart-markers"),a&&(e.append("path").attr("class","area forecast").attr("data-test-subj","mlForecastArea"),e.append("path").attr("class","values-line forecast").attr("data-test-subj","mlForecastValuesline"),e.append("g").attr("class","focus-chart-markers forecast").attr("data-test-subj","mlForecastMarkers")),e.append("rect").attr("x",0).attr("y",0).attr("width",t).attr("height",s+24).attr("class","chart-border chart-border-highlight")}renderFocusChart(){const{embeddableMode:e,focusAggregationInterval:t,focusAnnotationData:s,focusChartData:a,focusForecastData:o,modelPlotEnabled:i,selectedJob:n,showAnnotations:l,showForecast:c,showModelBounds:d,zoomFromFocusLoaded:u,zoomToFocusLoaded:m}=this.props,h=Array.isArray(s)?s:[];if(void 0===a)return;const p=a,b=this.contextYScale,g=this.showAnomalyPopover.bind(this),v=this.showFocusChartTooltip.bind(this),S=this.props.tooltipService.hide.bind(this.props.tooltipService),O=f.a.select(this.rootNode),E=O.select(".focus-chart"),y=t.expression,M=n.analysis_config.bucket_span;if(O.select(".zoom-aggregation-interval").text(r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.zoomAggregationIntervalLabel",{defaultMessage:"(aggregation interval: {focusAggInt}, bucket span: {bucketSpan})",values:{focusAggInt:y,bucketSpan:M}})),void 0===u||void 0===m)return;const w={min:x()(u.getTime()),max:x()(m.getTime())},T=t.asMilliseconds(),I=x()(Math.floor(w.min.valueOf()/T)*T),C=x()(Math.ceil(w.max.valueOf()/T)*T);if(this.focusXScale.domain([I.toDate(),C.toDate()]),a.length>0||void 0!==o&&o.length>0){void 0!==this.fieldFormat?this.focusYAxis.tickFormat((e=>this.fieldFormat.convert(e,"text"))):this.focusYAxis.tickFormat(null);let e=0,t=0,s=p;if(c&&void 0!==o&&o.length>0&&(s=p.concat(o)),e=f.a.min(s,(e=>{let t=e.value;return null===t&&void 0!==e.anomalyScore&&void 0!==e.actual&&(t=Array.isArray(e.actual)?e.actual[0]:e.actual),void 0!==e.lower?null!=t?Math.min(t,e.lower):e.lower:t||0})),t=f.a.max(s,(e=>{let t=e.value;return null===t&&void 0!==e.anomalyScore&&void 0!==e.actual&&(t=Array.isArray(e.actual)?e.actual[0]:e.actual),void 0!==e.upper?Math.max(t,e.upper):t||0})),t===e&&(this.contextYScale.domain()[0]!==b.domain()[1]&&e>=b.domain()[0]&&t<=b.domain()[1]?(e=b.domain()[0],t=b.domain()[1]):(e-=.05*e,t+=.05*t)),l&&h&&h.length>0){const s=_(h),a=f.a.max(Object.keys(s).map((e=>s[e])));t+=Math.abs(t-e)*((a+1)/5)}this.focusYScale.domain([e,t])}else this.focusYScale.domain([0,10]),this.focusYAxis.tickFormat("");const A=this.getTimeBuckets();A.setInterval("auto"),A.setBounds(w);const D=A.getScaledDateFormat();E.select(".x.axis").call(this.focusXAxis.ticks(Object(F.m)(this.vizWidth),D).tickFormat((e=>x()(e).format(D)))),E.select(".y.axis").call(this.focusYAxis),Object(F.g)(E.select(".x.axis"),this.vizWidth),!0===i&&E.select(".area.bounds").attr("d",this.focusBoundedArea(p)).classed("hidden",!d);const{focusChartHeight:R,focusHeight:N}=this.props.svgHeight?Z(this.props.svgHeight):{};!function(e,t,s,a,o,i,n,r,l){const c={};t.forEach((e=>{if(void 0!==e.key){const t=(e.end_timestamp||0)-e.timestamp;c[e.key]=t}})),t.sort(((e,t)=>void 0===e.key||void 0===t.key?0:c[t.key]-c[e.key]));const d=_(t),u=function(e){n(e,this)},m=e=>{l.setValue(null),l.setValue(e)},h=e.select(".mlAnnotations").selectAll("g.mlAnnotation").data(t||[],(e=>e._id||""));h.enter().append("g").classed("mlAnnotation",!0);const p=h.selectAll(".mlAnnotationRect").data((e=>[e]));p.enter().append("rect").classed("mlAnnotationRect",!0).attr("mask",`url(#${k})`).on("mouseover",u).on("mouseout",r).on("click",m),p.attr("x",(e=>{const t=x()(e.timestamp);return Math.max(o(t),0)})).attr("y",(e=>26+28*(void 0!==e.key?d[e.key]:1))).attr("height",(e=>{const t=void 0!==e.key?d[e.key]:1;return a-2-0-28*t})).attr("width",(e=>{const t=o(x()(e.timestamp))+1,s=void 0!==e.end_timestamp?o(x()(e.end_timestamp))-1:t+8;return Math.max(8,s-t)})),p.exit().remove();const b=h.selectAll(".mlAnnotationTextRect").data((e=>[e])),f=h.selectAll(".mlAnnotationText").data((e=>[e]));function g(e){const t=o.domain()[0],s=o.domain()[1],a=x()(e),i=Math.max(o(t),o(a));return Math.min(o(s)-32,i)}b.enter().append("rect").classed("mlAnnotationTextRect",!0).attr("width",24).attr("height",20).on("mouseover",u).on("mouseout",r).on("click",m),f.enter().append("text").classed("mlAnnotationText",!0).on("mouseover",u).on("mouseout",r).on("click",m),f.attr("x",(e=>g(e.timestamp)+17)).attr("y",(e=>44+28*(void 0!==e.key?d[e.key]:1))).text((e=>e.key)),b.attr("x",(e=>g(e.timestamp)+5)).attr("y",(e=>30+28*(void 0!==e.key?d[e.key]:1))),b.exit().remove(),f.exit().remove(),h.classed("mlAnnotationHidden",!i),h.exit().remove()}(E,h,0,null!=R?R:W,this.focusXScale,l,v,S,this.props.annotationUpdatesService),E.select(".mlAnnotationBrush").style("display",!l||e?"none":null),E.select(".values-line").attr("d",this.focusValuesLine(p)),Object(F.f)(p,E,this.focusValuesLine);const B=O.select(".focus-chart-markers").selectAll(".metric-value").data(p.filter((e=>(null!==e.value||"number"==typeof e.anomalyScore)&&!Object(F.o)(e)))),z=this;B.exit().remove(),B.enter().append("circle").attr("r",F.b).on("click",(function(e){f.a.event.preventDefault(),void 0!==e.anomalyScore&&g(e,this)})).on("mouseover",(function(e){null===z.state.popoverData&&v(e,this)})).on("mouseout",(()=>this.props.tooltipService.hide())),B.attr("cx",(e=>this.focusXScale(e.date))).attr("cy",(e=>this.focusYScale(e.value))).attr("data-test-subj",(e=>void 0!==e.anomalyScore?"mlAnomalyMarker":void 0)).attr("class",(e=>{let t="metric-value";return void 0!==e.anomalyScore&&(t+=` anomaly-marker ${Object(j.e)(e.anomalyScore).id}`),t}));const L=O.select(".focus-chart-markers").selectAll(".multi-bucket").data(p.filter((e=>null!==e.anomalyScore&&!0===Object(F.o)(e))));L.exit().remove(),L.enter().append("path").attr("d",f.a.svg.symbol().size(F.c).type("cross")).on("click",(function(e){f.a.event.preventDefault(),void 0!==e.anomalyScore&&g(e,this)})).on("mouseover",(function(e){v(e,this)})).on("mouseout",(()=>this.props.tooltipService.hide())),L.attr("transform",(e=>`translate(${this.focusXScale(e.date)}, ${this.focusYScale(e.value)})`)).attr("data-test-subj","mlAnomalyMarker").attr("class",(e=>`anomaly-marker multi-bucket ${Object(j.e)(e.anomalyScore).id}`));const P=O.select(".focus-chart-markers").selectAll(".scheduled-event-marker").data(p.filter((e=>void 0!==e.scheduledEvents)));if(P.exit().remove(),P.enter().append("rect").on("mouseover",(function(e){v(e,this)})).on("mouseout",(()=>S())).attr("width",2*F.b).attr("height",F.d).attr("class","scheduled-event-marker").attr("rx",1).attr("ry",1),P.attr("x",(e=>this.focusXScale(e.date)-F.b)).attr("y",(e=>{const t=this.focusYScale(e.value);return isNaN(t)?-(null!=N?N:U)-3:t-3})),void 0!==o){E.select(".area.forecast").attr("d",this.focusBoundedArea(o)).classed("hidden",!c),E.select(".values-line.forecast").attr("d",this.focusValuesLine(o)).classed("hidden",!c);const e=O.select(".focus-chart-markers.forecast").selectAll(".metric-value").data(o);e.exit().remove(),e.enter().append("circle").attr("r",F.b).on("mouseover",(function(e){v(e,this)})).on("mouseout",(()=>this.props.tooltipService.hide())),e.attr("cx",(e=>this.focusXScale(e.date))).attr("cy",(e=>this.focusYScale(e.value))).attr("class","metric-value").classed("hidden",!c)}}createZoomInfoElements(e,t){const{autoZoomDuration:s,bounds:a,modelPlotEnabled:o}=this.props,i=this.setZoomInterval.bind(this),n=a.max.unix()-a.min.unix(),l=10/this.vizWidth*n;let c=10;const d=e.append("text").attr("x",c).attr("y",17).attr("class","zoom-info-text").text(r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.zoomLabel",{defaultMessage:"Zoom:"})),u=[{durationMs:s,label:"auto"}];if(Object(p.each)(X,(e=>{e.duration.asSeconds()>l&&e.duration.asSeconds()<n&&u.push({durationMs:e.duration.asMilliseconds(),label:e.label})})),c+=d.node().getBBox().width+4,Object(p.each)(u,(t=>{const s=e.append("a").attr("data-ms",t.durationMs).attr("href","").append("text").attr("x",c).attr("y",17).attr("class","zoom-info-text").text(t.label);c+=s.node().getBBox().width+4})),e.append("text").attr("x",c+6).attr("y",17).attr("class","zoom-info-text zoom-aggregation-interval").text(r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.zoomGroupAggregationIntervalLabel",{defaultMessage:"(aggregation interval: , bucket span: )"})),!1===o){const s=e.append("text").attr("x",300).attr("y",17).attr("class","zoom-info-text").text(r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.modelBoundsNotAvailableLabel",{defaultMessage:"Model bounds are not available"}));s.attr("x",t-(s.node().getBBox().width+10))}f.a.select(this.rootNode).selectAll(".focus-zoom a").on("click",(function(){f.a.event.preventDefault(),i(this.getAttribute("data-ms"))}))}drawContextElements(e,t,s,a){const{bounds:o,contextChartData:i,contextForecastData:n,modelPlotEnabled:r,annotationData:l}=this.props,c=i,d=Array.isArray(l)?[...l].sort(((e,t)=>e.timestamp-t.timestamp)):[];let u=[];if(d.length>0){u=[{start:d[0].timestamp,end:d[0].end_timestamp,annotations:[d[0]]}];let e=d[0].end_timestamp;for(let t=1;t<d.length;t++){if(d[t].timestamp<e){const s=u.pop(),a={...s,end:e,annotations:[...s.annotations,d[t]]};u.push(a)}else u.push({start:d[t].timestamp,end:d[t].end_timestamp,annotations:[d[t]]});e=d[t].end_timestamp}}const m=this.showFocusChartTooltip.bind(this),h=this.props.tooltipService.hide.bind(this.props.tooltipService);this.contextXScale=f.a.time.scale().range([0,t]).domain(this.calculateContextXAxisDomain());const b=void 0===n?c:c.concat(n),g={min:Number.MAX_VALUE,max:Number.MIN_VALUE};Object(p.each)(b,(e=>{var t,s;const a=null!==(t=e.lower)&&void 0!==t?t:Number.MAX_VALUE,o=null!==(s=e.upper)&&void 0!==s?s:Number.MIN_VALUE;g.min=Math.min(e.value,a,g.min),g.max=Math.max(e.value,o,g.max)}));let v=g.min,j=g.max;const S={min:v,max:j};if(!0===r||void 0!==n&&n.length>0){const e={min:Number.MAX_VALUE,max:Number.MIN_VALUE};Object(p.each)(b,(t=>{e.min=Math.min(t.lower,e.min),e.max=Math.max(t.upper,e.max)})),v=Math.min(v,e.min),j=Math.max(j,e.max),g.max-g.min<.5*(j-v)&&(g.min>v&&(S.min=g.min-.5*(g.max-g.min)),g.max<j&&(S.max=g.max+.5*(g.max-g.min)))}this.contextYScale=f.a.scale.linear().range([s,3]).domain([S.min,S.max]);const O=e.append("g").attr("class","axis"),E=s+a+G;O.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",E),O.append("line").attr("x1",t).attr("y1",0).attr("x2",t).attr("y2",E),O.append("line").attr("x1",0).attr("y1",E).attr("x2",t).attr("y2",E);const y=this.getTimeBuckets();y.setInterval("auto"),y.setBounds(o);const M=y.getScaledDateFormat(),w=f.a.svg.axis().scale(this.contextXScale).orient("top").innerTickSize(-s).outerTickSize(0).tickPadding(0).ticks(Object(F.m)(t,M)).tickFormat((e=>x()(e).format(M)));e.datum(c);const I=f.a.svg.area().x((e=>this.contextXScale(e.date))).y0((e=>this.contextYScale(Math.min(S.max,Math.max(e.lower,S.min))))).y1((e=>this.contextYScale(Math.max(S.min,Math.min(e.upper,S.max))))).defined((e=>null!==e.lower&&null!==e.upper));!0===r&&e.append("path").datum(c).attr("class","area bounds").attr("d",I);const C=f.a.svg.line().x((e=>this.contextXScale(e.date))).y((e=>this.contextYScale(e.value))).defined((e=>null!==e.value));e.append("path").datum(c).attr("class","values-line").attr("d",C),Object(F.f)(c,e,C,1),e.append("g").classed("mlContextAnnotations",!0);const[A,k]=this.contextXScale.range(),D=e.select(".mlContextAnnotations").selectAll("g.mlContextAnnotation").data(u,(e=>`${e.start}-${e.end}`||""));D.enter().append("g").classed("mlContextAnnotation",!0);const _=D.selectAll(".mlContextAnnotationRect").data((e=>[e]));_.enter().append("rect").on("mouseover",(function(e){m(1===e.annotations.length?e.annotations[0]:e,this)})).on("mouseout",(()=>h())).classed("mlContextAnnotationRect",!0),_.attr("x",(e=>{const t=x()(e.start);let s=this.contextXScale(t);return s-F.a<=A&&(s=0),s+F.a>=k&&(s=k-F.a),s})).attr("y",s+a+2).attr("height",F.a).attr("width",(e=>{const t=Math.max(this.contextXScale(x()(e.start))+1,A),s=Math.min(k,void 0!==e.end?this.contextXScale(x()(e.end))-1:t+8);return Math.max(8,s-t)})),_.exit().remove(),void 0!==n&&(e.append("path").datum(n).attr("class","area forecast").attr("d",I),e.append("path").datum(n).attr("class","values-line forecast").attr("d",C));const R=e.append("g").attr("class","swimlane").attr("transform","translate(0,"+s+")");this.drawSwimlane(R,t,a),this.mask=new T(e,i,r,a).x(this.contextXScale).y(this.contextYScale),e.append("g").attr("class","x axis context-chart-axis").call(w),e.selectAll(".x.context-chart-axis text").attr("dy",s-5),Object(F.g)(e.selectAll(".x.context-chart-axis"),t),this.drawContextBrush(e)}setZoomInterval(e){const{bounds:t,zoomTo:s}=this.props,a=t.min.valueOf(),o=t.max.valueOf(),i=+e;let n=s.getTime(),r=n-i;r<a&&(r=a,n=Math.min(a+i,o)),this.setContextBrushExtent(new Date(r),new Date(n))}showAnomalyPopover(e,t){const s=e.date.getTime(),a=this.props.tableData.anomalies.reduce(((e,t)=>{const a=Math.abs(s-e.source.timestamp);return Math.abs(s-t.source.timestamp)<a?t:e}),this.props.tableData.anomalies[0]);if(a){a.source.timestamp=s;const e=t.getBoundingClientRect(),o=this.rootNode.getBoundingClientRect(),i=Math.round(e.x+e.width/2-o.x),n=Math.round(e.y+e.height/2-o.y)-28;this.props.tooltipService.hide(),this.setState({popoverData:a,popoverCoords:[i,n]})}}showFocusChartTooltip(e,t){var s;const{modelPlotEnabled:a}=this.props,o=this.fieldFormat,i="single_metric_viewer",n=[{label:Object(O.c)(e.date)}];if(void 0!==e.anomalyScore){const t=parseInt(e.anomalyScore);if(n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.anomalyScoreLabel",{defaultMessage:"anomaly score"}),value:Object(S.a)(t),color:Y(t),seriesIdentifier:{key:i},valueAccessor:"anomaly_score"}),!0===Object(F.p)(e)&&n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.multiBucketAnomalyLabel",{defaultMessage:"multi-bucket impact"}),value:Object(F.j)(e),seriesIdentifier:{key:i},valueAccessor:"multi_bucket_impact"}),e.metricFunction&&n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.metricActualPlotFunctionLabel",{defaultMessage:"function"}),value:e.metricFunction,seriesIdentifier:{key:i},valueAccessor:"metric_function"}),!1===a){if(void 0!==e.actual&&"rare"!==e.function)n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.actualLabel",{defaultMessage:"actual"}),value:Object(y.b)(e.actual,e.function,o),seriesIdentifier:{key:i},valueAccessor:"actual"}),n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.typicalLabel",{defaultMessage:"typical"}),value:Object(y.b)(e.typical,e.function,o),seriesIdentifier:{key:i},valueAccessor:"typical"});else if(void 0!==e.value&&n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.valueLabel",{defaultMessage:"value"}),value:Object(y.b)(e.value,e.function,o),seriesIdentifier:{key:i},valueAccessor:"value"}),void 0!==e.byFieldName&&void 0!==e.numberOfCauses){const t=e.numberOfCauses,s=Object(C.f)(e.byFieldName);n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.moreThanOneUnusualByFieldValuesLabel",{defaultMessage:"{numberOfCauses}{plusSign} unusual {byFieldName} values",values:{numberOfCauses:t,byFieldName:s,plusSign:t<10?"":"+"}}),seriesIdentifier:{key:i},valueAccessor:"numberOfCauses"})}}else e.annotations||(n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.modelPlotEnabled.actualLabel",{defaultMessage:"actual"}),value:Object(y.b)(e.actual,e.function,o),seriesIdentifier:{key:i},valueAccessor:"actual"}),n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.modelPlotEnabled.upperBoundsLabel",{defaultMessage:"upper bounds"}),value:Object(y.b)(e.upper,e.function,o),seriesIdentifier:{key:i},valueAccessor:"upper_bounds"}),n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.modelPlotEnabled.lowerBoundsLabel",{defaultMessage:"lower bounds"}),value:Object(y.b)(e.lower,e.function,o),seriesIdentifier:{key:i},valueAccessor:"lower_bounds"}))}else!0===Object(p.get)(e,"isForecast",!1)?n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.withoutAnomalyScore.predictionLabel",{defaultMessage:"prediction"}),value:Object(y.b)(e.value,e.function,o),seriesIdentifier:{key:i},valueAccessor:"prediction"}):void 0!==e.value&&null!==e.value&&n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.withoutAnomalyScore.valueLabel",{defaultMessage:"value"}),value:Object(y.b)(e.value,e.function,o),seriesIdentifier:{key:i},valueAccessor:"value"}),e.annotations||!0!==a||(n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.withoutAnomalyScoreAndModelPlotEnabled.upperBoundsLabel",{defaultMessage:"upper bounds"}),value:Object(y.b)(e.upper,e.function,o),seriesIdentifier:{key:i},valueAccessor:"upper_bounds"}),n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.withoutAnomalyScoreAndModelPlotEnabled.lowerBoundsLabel",{defaultMessage:"lower bounds"}),value:Object(y.b)(e.lower,e.function,o),seriesIdentifier:{key:i},valueAccessor:"lower_bounds"}));if(void 0!==e.scheduledEvents&&e.scheduledEvents.forEach(((t,s)=>{n.push({label:r.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.scheduledEventsLabel",{defaultMessage:"scheduled event{counter}",values:{counter:e.scheduledEvents.length>1?` #${s+1}`:""}}),value:t,seriesIdentifier:{key:i},valueAccessor:`scheduled_events_${s+1}`})})),void 0!==e.annotation){n.length=0,n.push({label:e.annotation});let t=x()(e.timestamp).format("MMMM Do YYYY, HH:mm");void 0!==e.end_timestamp&&(t+=` - ${x()(e.end_timestamp).format("MMMM Do YYYY, HH:mm")}`),n.push({label:t,seriesIdentifier:{key:i},valueAccessor:"timespan"})}(null===(s=e.annotations)||void 0===s?void 0:s.length)>1&&e.annotations.forEach((e=>{var t;let s=x()(e.timestamp).format("MMMM Do YYYY, HH:mm");void 0!==e.end_timestamp&&(s+=` - ${x()(e.end_timestamp).format("HH:mm")}`),n.push({label:s,value:`${e.annotation}`,seriesIdentifier:{key:"anomaly_timeline",specId:null!==(t=e._id)&&void 0!==t?t:`${e.annotation}-${e.timestamp}-label`},valueAccessor:"annotation"})}));let l=2*F.b;if("rect"===t.tagName.toLowerCase()){const e=Number(t.getAttribute("x"));e<0&&(l=Math.abs(e))}this.props.tooltipService.show(n,t,{x:l,y:0})}highlightFocusChartAnomaly(e){const{focusChartData:t,focusAggregationInterval:s}=this.props,a=this.focusXScale,o=this.focusYScale,i=this.showFocusChartTooltip.bind(this),n=e.source.timestamp,r=this.mlTimeSeriesExplorer.findChartPointForAnomalyTime(t,n,s),l=f.a.select(this.rootNode);if(void 0!==r){const e=l.select(".focus-chart-markers").selectAll(".focus-chart-highlighted-marker").data([r]);!0===Object(F.o)(r)?e.enter().append("path").attr("d",f.a.svg.symbol().size(F.c).type("cross")).attr("transform",(e=>`translate(${a(e.date)}, ${o(e.value)})`)).attr("data-test-subj","mlAnomalyMarker").attr("class",(e=>`anomaly-marker multi-bucket ${Object(j.e)(e.anomalyScore).id} highlighted`)):e.enter().append("circle").attr("r",F.b).attr("cx",(e=>a(e.date))).attr("cy",(e=>o(e.value))).attr("data-test-subj","mlAnomalyMarker").attr("class",(e=>`anomaly-marker metric-value ${Object(j.e)(e.anomalyScore).id} highlighted`));const t=l.selectAll(".focus-chart-markers .anomaly-marker.highlighted");t.length&&i(r,t[0][0])}}unhighlightFocusChartAnomaly(){f.a.select(this.rootNode).select(".focus-chart-markers").selectAll(".anomaly-marker.highlighted").remove(),this.props.tooltipService.hide()}shouldComponentUpdate(){return!0}setRef(e){this.rootNode=e}closePopover(){this.setState({popoverData:null,popoverCoords:[0,0]})}render(){return Object(P.jsx)(n.a.Fragment,null,Object(P.jsx)(L.a,{setShowFunction:this.setShowRuleEditorFlyoutFunction,unsetShowFunction:this.unsetShowRuleEditorFlyoutFunction}),null!==this.state.popoverData&&Object(P.jsx)("div",{style:{position:"absolute",marginLeft:this.state.popoverCoords[0],marginTop:this.state.popoverCoords[1]}},Object(P.jsx)(v.EuiPopover,{isOpen:!0,closePopover:()=>this.closePopover(),panelPaddingSize:"none",anchorPosition:"upLeft"},Object(P.jsx)(z.b,{anomaly:this.state.popoverData,bounds:this.props.bounds,showMapsLink:!1,showViewSeriesLink:!1,isAggregatedData:"second"!==this.props.tableData.interval,interval:this.props.tableData.interval,showRuleEditorFlyout:this.state.showRuleEditorFlyout,onItemClick:()=>this.closePopover(),sourceIndicesWithGeoFields:this.props.sourceIndicesWithGeoFields}))),Object(P.jsx)("div",{className:"ml-timeseries-chart-react",ref:this.setRef.bind(this)}))}}u()(timeseries_chart_TimeseriesChartIntl,"contextType",E.context);const K=e=>{const t=Object(i.useContext)(B.a),s=h()(t.isAnnotationInitialized$());return void 0===s?null:Object(P.jsx)(timeseries_chart_TimeseriesChartIntl,o()({annotation:s},e,{annotationUpdatesService:t}))};var Q=s(162),ee=s(10),te=s(187);const se=({bounds:e,detectorIndex:t,embeddableMode:s,renderFocusChartOnly:a,selectedJob:n,selectedEntities:d,showAnnotations:u,showForecast:m,showModelBounds:h,chartProps:p,lastRefresh:b,contextAggregationInterval:f,tableData:g={anomalies:[],interval:"second"},sourceIndicesWithGeoFields:x})=>{const{toasts:v}=Object(ee.i)(),{services:{mlServices:{mlApiServices:j}}}=Object(ee.d)(),S=Object(i.useContext)(B.a),[O,E]=Object(i.useState)([]),y=Object(i.useCallback)((e=>{v.addDanger({title:r.i18n.translate("xpack.ml.timeSeriesExplorer.mlSingleMetricViewerChart.annotationsErrorTitle",{defaultMessage:"An error occurred fetching annotations"}),...e?{text:Object(l.a)(e)}:{}})}),[]),F=Object(M.b)();return Object(i.useEffect)((()=>{let s=!1;const a=Object(te.a)(t,d,n.job_id),o=Array.isArray(a)?a.filter((e=>null!==e.fieldValue)):void 0,i=F.getBoundsRoundedToInterval(e,f,!1);return(async e=>{try{const a=await j.annotations.getAnnotations({jobIds:[e],earliestMs:i.min.valueOf(),latestMs:i.max.valueOf(),maxAnnotations:Q.a,detectorIndex:t,entities:o});s||Array.isArray(a.annotations[e])&&E(a.annotations[e])}catch(e){y(e)}})(n.job_id),()=>{s=!0}}),[n.job_id,t,b,d,e,f]),p.svgHeight&&(p.svgHeight-=32),Object(P.jsx)("div",{className:"ml-timeseries-chart","data-test-subj":"mlSingleMetricViewerChart"},Object(P.jsx)(c.a,null,(i=>Object(P.jsx)(K,o()({},p,{annotationUpdatesService:S,annotationData:O,bounds:e,detectorIndex:t,embeddableMode:s,renderFocusChartOnly:a,selectedJob:n,showAnnotations:u,showForecast:m,showModelBounds:h,tooltipService:i,tableData:g,sourceIndicesWithGeoFields:x})))))}},402:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var a=s(25),o=(s(2),s(6));const i=({errorMsg:e})=>Object(o.jsx)(a.EuiEmptyPrompt,{iconType:"warning",title:Object(o.jsx)("h2",null,e)})},865:function(e,t,s){"use strict";s.r(t),s.d(t,"TimeSeriesExplorerUrlStateManager",(function(){return Ge}));var a=s(8),o=s(2),i=s.n(o),n=s(377),r=s.n(n),l=s(39),c=s.n(l),d=s(68),u=s(517),m=s(213),h=s(10),p=s(123),b=s(4),f=s.n(b),g=s(83),x=s.n(g),v=s(7),j=s(25),S=s(5),O=s(15),E=s(21),y=s(318),F=s(3),M=s(374),w=s(162),T=s(315),I=s(404),C=s(490),A=s(322),k=s(30);const D={ERROR:"error",INFO:"info",SUCCESS:"success",WARNING:"warning"};var _=s(40),R=s(210),N=s.n(R),B=s(120),z=s.n(B),L=s(6);function P({message:e,status:t,...s}){return Object(L.jsx)(j.EuiCallOut,z()({size:"s"},function(e,t){switch(t){case D.ERROR:return{title:e,iconType:"cross",color:"danger"};case D.WARNING:return{title:e,iconType:"warning",color:"warning"};case D.SUCCESS:return{title:e,iconType:"check",color:"success"};case D.INFO:return{title:e,iconType:"iInCircle",color:"primary"}}}(e,t),s))}var J=s(415);function V(e){return[{field:"forecast_create_timestamp",name:S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastsList.createdColumnName",{defaultMessage:"Created"}),dataType:"date",render:e=>Object(J.c)(e),sortable:!0},{field:"forecast_start_timestamp",name:S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastsList.fromColumnName",{defaultMessage:"From"}),dataType:"date",render:e=>Object(J.c)(e),sortable:!0},{field:"forecast_end_timestamp",name:S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastsList.toColumnName",{defaultMessage:"To"}),dataType:"date",render:e=>Object(J.c)(e),sortable:!0},{name:S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastsList.viewColumnName",{defaultMessage:"View"}),width:"60px",render:t=>{const s=S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastsList.viewForecastAriaLabel",{defaultMessage:"View forecast created at {createdDate}",values:{createdDate:Object(J.c)(t.forecast_create_timestamp)}});return Object(L.jsx)(j.EuiButtonIcon,{onClick:()=>e(t.forecast_id),iconType:"visLine","aria-label":s})}}]}function W({forecasts:e,viewForecast:t}){return Object(L.jsx)(j.EuiText,null,Object(L.jsx)("h3",{"aria-describedby":"ml_aria_description_forecasting_modal_view_list",style:{display:"inline",paddingRight:"5px"}},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.forecastsList.previousForecastsTitle",defaultMessage:"Previous forecasts"})),Object(L.jsx)(j.EuiToolTip,{position:"right",content:Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.forecastsList.listsOfFiveRecentlyRunForecastsTooltip",defaultMessage:"Lists a maximum of five of the most recently run forecasts."})},Object(L.jsx)(j.EuiIcon,{type:"questionInCircle",size:"s"})),Object(L.jsx)(j.EuiInMemoryTable,{items:e,columns:V(t),pagination:!1,"data-test-subj":"mlModalForecastTable",rowProps:e=>({"data-test-subj":`mlForecastsListRow row-${e.rowId}`})}))}W.propType={forecasts:N.a.array,viewForecast:N.a.func.isRequired};const U={UNSET:-1,WAITING:0,DONE:1,ERROR:-10};function H({state:e}){return e===U.WAITING?Object(L.jsx)(j.EuiLoadingSpinner,{size:"m"}):e===U.DONE?Object(L.jsx)(j.EuiIcon,{type:"check",size:"m",color:"primary"}):e===U.ERROR?Object(L.jsx)(j.EuiIcon,{type:"cross",size:"m",color:"danger"}):void 0}function G({forecastProgress:e,jobOpeningState:t,jobClosingState:s}){return Object(L.jsx)("div",null,t!==U.UNSET&&Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)(j.EuiFlexGroup,{gutterSize:"s",alignItems:"center"},Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(j.EuiText,{size:"m"},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.forecastingModal.openingJobTitle",defaultMessage:"Opening job…"}))),Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(H,{state:t}))),Object(L.jsx)(j.EuiSpacer,{size:"s"})),e!==U.UNSET&&Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)(j.EuiFlexGroup,{gutterSize:"s",alignItems:"center"},Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(j.EuiText,{size:"m"},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.forecastingModal.runningForecastTitle",defaultMessage:"Running forecast…"}))),e>=0&&Object(L.jsx)(j.EuiFlexItem,null,Object(L.jsx)(j.EuiToolTip,{position:"top",content:e+"%"},Object(L.jsx)(j.EuiProgress,{size:"l",value:e,max:100}))),e===U.ERROR&&Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(H,{state:U.ERROR}))),Object(L.jsx)(j.EuiSpacer,{size:"s"})),s!==U.UNSET&&Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)(j.EuiFlexGroup,{gutterSize:"s",alignItems:"center"},Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(j.EuiText,{size:"m"},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.forecastingModal.closingJobTitle",defaultMessage:"Closing job…"}))),Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(H,{state:s})))))}G.propType={forecastProgress:N.a.number,jobOpeningState:N.a.number,jobClosingState:N.a.number};var q=s(23),X=s(70);function Y({job:e,newForecastDuration:t,isNewForecastDurationValid:s,newForecastDurationErrors:a,onNewForecastDurationChange:o,runForecast:i,isForecastRequested:n,forecastProgress:r,jobOpeningState:l,jobClosingState:c}){const d=function(e,t){return!1===Object(q.a)()?{isDisabled:!0,isDisabledToolTipText:S.i18n.translate("xpack.ml.timeSeriesExplorer.runControls.noMLNodesAvailableTooltip",{defaultMessage:"There are no ML nodes available."})}:!1===Object(X.checkPermission)("canForecastJob")?{isDisabled:!0,isDisabledToolTipText:Object(X.createPermissionFailureMessage)("canForecastJob")}:e.state!==k.c.OPENED&&e.state!==k.c.CLOSED?{isDisabled:!0,isDisabledToolTipText:S.i18n.translate("xpack.ml.timeSeriesExplorer.runControls.forecastsCanNotBeRunOnJobsTooltip",{defaultMessage:"Forecasts cannot be run on {jobState} jobs",values:{jobState:e.state}})}:{isDisabled:t}}(e,n),u=Object(L.jsx)(j.EuiFieldText,{name:"forecastDuration",value:t,disabled:d.isDisabled,isInvalid:!s,onChange:o,fullWidth:!0}),m=Object(L.jsx)(j.EuiButton,{onClick:i,isDisabled:d.isDisabled||!s,"data-test-subj":"mlModalForecastButtonRun"},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.runControls.runButtonLabel",defaultMessage:"Run"}));return Object(L.jsx)("div",null,Object(L.jsx)(j.EuiText,null,Object(L.jsx)("h3",null,Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.runControls.runNewForecastTitle",defaultMessage:"Run a new forecast"}))),Object(L.jsx)(j.EuiSpacer,{size:"s"}),Object(L.jsx)(j.EuiForm,null,Object(L.jsx)(j.EuiFlexGroup,null,Object(L.jsx)(j.EuiFlexItem,null,Object(L.jsx)(j.EuiFormRow,{label:Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.runControls.durationLabel",defaultMessage:"Duration"}),fullWidth:!0,isInvalid:!s,error:a,helpText:Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.runControls.forecastMaximumLengthHelpText",defaultMessage:"Length of forecast, up to a maximum of {maximumForecastDurationDays} days. Use s for seconds, m for minutes, h for hours, d for days, w for weeks.",values:{maximumForecastDurationDays:ee}})},void 0===d.isDisabledToolTipText?u:Object(L.jsx)(j.EuiToolTip,{position:"right",content:d.isDisabledToolTipText},u))),Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(j.EuiFormRow,{hasEmptyLabelSpace:!0},void 0===d.isDisabledToolTipText?m:Object(L.jsx)(j.EuiToolTip,{position:"left",content:d.isDisabledToolTipText},m))))),Object(L.jsx)(j.EuiSpacer,{size:"s"}),!0===n&&Object(L.jsx)(G,{forecastProgress:r,jobOpeningState:l,jobClosingState:c}))}function $(e){return Object(L.jsx)(j.EuiModal,{onClose:e.close,maxWidth:860,"data-test-subj":"mlModalForecast"},Object(L.jsx)(j.EuiModalHeader,null,Object(L.jsx)(j.EuiModalHeaderTitle,null,Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.forecastingModal.forecastingTitle",defaultMessage:"Forecasting"}))),Object(L.jsx)(j.EuiModalBody,null,e.messages.map(((e,t)=>Object(L.jsx)(i.a.Fragment,{key:t},Object(L.jsx)(P,e),Object(L.jsx)(j.EuiSpacer,{size:"m"})))),e.forecasts.length>0&&Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)(W,{forecasts:e.forecasts,viewForecast:e.viewForecast}),Object(L.jsx)(j.EuiSpacer,null)),Object(L.jsx)(Y,e)),Object(L.jsx)(j.EuiModalFooter,null,Object(L.jsx)(j.EuiButtonEmpty,{onClick:e.close,size:"s","data-test-subj":"mlModalForecastButtonClose"},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.forecastingModal.closeButtonLabel",defaultMessage:"Close"}))))}Y.propType={job:N.a.object,newForecastDuration:N.a.string,isNewForecastDurationValid:N.a.bool,newForecastDurationErrors:N.a.array,onNewForecastDurationChange:N.a.func.isRequired,runForecast:N.a.func.isRequired,isForecastRequested:N.a.bool,forecastProgress:N.a.number,jobOpeningState:N.a.number,jobClosingState:N.a.number},$.propType={job:N.a.object,forecasts:N.a.array,close:N.a.func.isRequired,viewForecast:N.a.func.isRequired,runForecast:N.a.func.isRequired,newForecastDuration:N.a.string,isNewForecastDurationValid:N.a.bool,newForecastDurationErrors:N.a.array,onNewForecastDurationChange:N.a.func.isRequired,isForecastRequested:N.a.bool,forecastProgress:N.a.number,jobOpeningState:N.a.number,jobClosingState:N.a.number,messages:N.a.array};var Z=s(11),K=s(73),Q=s(235);const ee=3650,te="6.1.0",se=864e5*ee,ae=12e4;function oe(){return{isModalVisible:!1,previousForecasts:[],isForecastRequested:!1,forecastProgress:U.UNSET,jobOpeningState:U.UNSET,jobClosingState:U.UNSET,newForecastDuration:"1d",isNewForecastDurationValid:!0,newForecastDurationErrors:[],messages:[]}}class forecasting_modal_ForecastingModal extends o.Component{constructor(e){super(e),f()(this,"addMessage",((e,t,s=!1)=>{const a={message:e,status:t};this.setState((e=>({messages:s?[a]:[...e.messages,a]})))})),f()(this,"viewForecast",(e=>{this.props.setForecastId(e),this.closeModal()})),f()(this,"onNewForecastDurationChange",(e=>{const t=[];let s=!0;const a=Object(_.a)(e.target.value);null===a?(s=!1,t.push(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.invalidDurationFormatErrorMessage",{defaultMessage:"Invalid duration format"}))):a.asMilliseconds()>se?(s=!1,t.push(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.forecastDurationMustNotBeGreaterThanMaximumErrorMessage",{defaultMessage:"Forecast duration must not be greater than {maximumForecastDurationDays} days",values:{maximumForecastDurationDays:ee}}))):0===a.asMilliseconds()&&(s=!1,t.push(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.forecastDurationMustNotBeZeroErrorMessage",{defaultMessage:"Forecast duration must not be zero"}))),this.setState({newForecastDuration:e.target.value,isNewForecastDurationValid:s,newForecastDurationErrors:t})})),f()(this,"checkJobStateAndRunForecast",(()=>{this.setState({isForecastRequested:!0,messages:[]}),this.props.job.state===k.c.CLOSED?this.openJobAndRunForecast():this.runForecast(!1)})),f()(this,"openJobAndRunForecast",(()=>{this.setState({jobOpeningState:U.WAITING}),K.mlJobService.openJob(this.props.job.job_id).then((()=>{this.setState({jobOpeningState:U.DONE}),this.runForecast(!0)})).catch((e=>{console.log("Time series forecast modal - could not open job:",e),this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.errorWithOpeningJobBeforeRunningForecastErrorMessage",{defaultMessage:"Error opening job before running forecast"}),D.ERROR),this.setState({jobOpeningState:U.ERROR})}))})),f()(this,"runForecastErrorHandler",((e,t)=>{this.setState({forecastProgress:U.ERROR}),console.log("Time series forecast modal - error running forecast:",e);const s=e?Object(A.a)(e):void 0;s&&s.length>0?this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.errorRunningForecastMessage",{defaultMessage:"An error has occurred running the forecast: {errorMessage}",values:{errorMessage:s}}),D.ERROR,!0):this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.unexpectedResponseFromRunningForecastErrorMessage",{defaultMessage:"Unexpected response from running forecast. The request may have failed."}),D.ERROR,!0),!0===t&&(this.setState({jobClosingState:U.WAITING}),K.mlJobService.closeJob(this.props.job.job_id).then((()=>{this.setState({jobClosingState:U.DONE})})).catch((e=>{console.log("Time series forecast modal - could not close job:",e),this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.errorWithClosingJobErrorMessage",{defaultMessage:"Error closing job"}),D.ERROR),this.setState({jobClosingState:U.ERROR})})))})),f()(this,"runForecast",(e=>{this.setState({forecastProgress:0});const t=Object(_.a)(this.state.newForecastDuration).asSeconds();this.mlForecastService.runForecast(this.props.job.job_id,`${t}s`).then((t=>{void 0!==t.forecast_id?this.waitForForecastResults(t.forecast_id,e):this.runForecastErrorHandler(t,e)})).catch((t=>this.runForecastErrorHandler(t,e)))})),f()(this,"waitForForecastResults",((e,t)=>{let s=0,o=0;this.forecastChecker=setInterval((()=>{this.mlForecastService.getForecastRequestStats(this.props.job,e).then((i=>{const n=Object(a.get)(i,["stats","forecast_progress"],s),r=Object(a.get)(i,["stats","forecast_status"]);n>s&&this.setState({forecastProgress:Math.round(100*n)});let l=Object(a.get)(i,["stats","forecast_messages"],[]);l=l.map((e=>({message:e,status:D.WARNING}))),this.setState({messages:l}),r===k.b.FINISHED?(clearInterval(this.forecastChecker),!0===t?(this.setState({jobClosingState:U.WAITING}),K.mlJobService.closeJob(this.props.job.job_id).then((()=>{this.setState({jobClosingState:U.DONE}),this.props.setForecastId(e),this.closeAfterRunningForecast()})).catch((t=>{console.log("Time series forecast modal - could not close job:",t),this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.errorWithClosingJobAfterRunningForecastErrorMessage",{defaultMessage:"Error closing job after running forecast"}),D.ERROR),this.setState({jobClosingState:U.ERROR}),this.props.setForecastId(e)}))):(this.props.setForecastId(e),this.closeAfterRunningForecast())):n===s?(o+=250,o>ae&&(console.log("Forecast request has not progressed for 120000ms. Cancelling check."),this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.noProgressReportedForNewForecastErrorMessage",{defaultMessage:"No progress reported for the new forecast for {WarnNoProgressMs}ms.An error may have occurred whilst running the forecast.",values:{WarnNoProgressMs:ae}}),D.ERROR),this.props.setForecastId(e),this.setState({forecastProgress:U.ERROR}),clearInterval(this.forecastChecker))):(n>s&&(s=n),o=0)})).catch((e=>{console.log("Time series forecast modal - error loading stats of forecast from elasticsearch:",e),this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.errorWithLoadingStatsOfRunningForecastErrorMessage",{defaultMessage:"Error loading stats of running forecast."}),D.ERROR),this.setState({forecastProgress:U.ERROR}),clearInterval(this.forecastChecker)}))}),250)})),f()(this,"openModal",(()=>{const e=this.props.job;if("object"==typeof e){const{timefilter:t}=this.context.services.data.query.timefilter,s=t.getActiveBounds(),a={term:{forecast_status:k.b.FINISHED}};this.mlForecastService.getForecastsSummary(e,a,s.min.valueOf(),5).then((e=>{this.setState({previousForecasts:e.forecasts})})).catch((e=>{console.log("Time series forecast modal - error obtaining forecasts summary:",e),this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.errorWithObtainingListOfPreviousForecastsErrorMessage",{defaultMessage:"Error obtaining list of previous forecasts"}),D.ERROR)}));const o=this.props.entities.map((e=>e.fieldName));o.length>0&&Z.ml.getCardinalityOfFields({index:e.datafeed_config.indices,fieldNames:o,query:e.datafeed_config.query,timeFieldName:e.data_description.time_field,earliestMs:e.data_counts.earliest_record_timestamp,latestMs:e.data_counts.latest_record_timestamp}).then((e=>{let t=1;Object.values(e).forEach((e=>{t*=e})),t>100&&this.addMessage(S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.dataContainsMorePartitionsMessage",{defaultMessage:"Note that this data contains more than {warnNumPartitions} partitions so running a forecast may take a long time and consume a high amount of resource",values:{warnNumPartitions:100}}),D.WARNING)})).catch((e=>{console.log("Time series forecast modal - error obtaining cardinality of fields:",e)})),this.setState({isModalVisible:!0})}})),f()(this,"closeAfterRunningForecast",(()=>{0===this.state.messages.length&&setTimeout((()=>{this.closeModal()}),1e3)})),f()(this,"closeModal",(()=>{null!==this.forecastChecker&&clearInterval(this.forecastChecker),this.setState(oe())})),this.state=oe(),this.forecastChecker=null,this.mlForecastService}componentDidMount(){this.mlForecastService=Object(Q.a)(this.context.services.mlServices.mlApiServices)}render(){let e=!1,t=null;const{job:s}=this.props;void 0!==s&&(void 0!==s.analysis_config.detectors[this.props.detectorIndex].over_field_name?(e=!0,t=S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.forecastingNotAvailableForPopulationDetectorsMessage",{defaultMessage:"Forecasting is not available for population detectors with an over field"})):!1===Object(p.m)(s,te)&&(e=!0,t=S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastingModal.forecastingOnlyAvailableForJobsCreatedInSpecifiedVersionMessage",{defaultMessage:"Forecasting is only available for jobs created in version {minVersion} or later",values:{minVersion:te}})));const a=Object(L.jsx)(j.EuiButton,{onClick:this.openModal,isDisabled:e,"data-test-subj":"mlSingleMetricViewerButtonForecast"},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.forecastingModal.forecastButtonLabel",defaultMessage:"Forecast"}));return Object(L.jsx)("div",null,e?Object(L.jsx)(j.EuiToolTip,{position:"left",content:t},a):a,this.state.isModalVisible&&Object(L.jsx)($,{job:this.props.job,forecasts:this.state.previousForecasts,close:this.closeModal,viewForecast:this.viewForecast,runForecast:this.checkJobStateAndRunForecast,newForecastDuration:this.state.newForecastDuration,onNewForecastDurationChange:this.onNewForecastDurationChange,isNewForecastDurationValid:this.state.isNewForecastDurationValid,newForecastDurationErrors:this.state.newForecastDurationErrors,isForecastRequested:this.state.isForecastRequested,forecastProgress:this.state.forecastProgress,jobOpeningState:this.state.jobOpeningState,jobClosingState:this.state.jobClosingState,messages:this.state.messages}))}}f()(forecasting_modal_ForecastingModal,"contextType",E.context);var ie=s(240),ne=s(268),re=s(207),le=s(324),ce=s(503),de=s(485),ue=s(142),me=s(134),he=s(323);const pe=({children:e,dateFormatTz:t,resizeRef:s,noSingleMetricJobsFound:a})=>{var o,n;const{services:{cases:r,docLinks:l,presentationUtil:c}}=Object(h.d)(),d=null!==(o=null==c?void 0:c.ContextProvider)&&void 0!==o?o:i.a.Fragment,u=null!==(n=null==r?void 0:r.ui.getCasesContext())&&void 0!==n?n:i.a.Fragment,m=null==r?void 0:r.helpers.canUseCases(),p=l.links.ml.anomalyDetection;return Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)("div",{className:"ml-time-series-explorer",ref:s,"data-test-subj":"mlPageSingleMetricViewer"},Object(L.jsx)(me.a,null,Object(L.jsx)(j.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(ce.a,{viewId:"timeseriesexplorer"})),Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(he.a,{title:S.i18n.translate("xpack.ml.timeSeriesExplorer.pageTitle",{defaultMessage:"Single Metric Viewer"})})))),a?null:Object(L.jsx)(de.a,{dateFormatTz:t,singleSelection:!0,timeseriesOnly:!0}),Object(L.jsx)(u,{owner:[],permissions:m},Object(L.jsx)(d,null,e)),Object(L.jsx)(ue.a,{docLink:p})))};var be=s(94),fe=s(80),ge=s(195),xe=s(106),ve=s(319),je=s(332),Se=s(187),Oe=s(392),Ee=s(394),ye=s(252),Fe=s(242),Me=s(402),we=s(493),Te=s(139),Ie=s(77),Ce=s(112),Ae=s(375),ke=s(376),De=s(43);const _e=Object(Ce.withSuspense)(Ce.LazySavedObjectSaveModalDashboard);var Re={name:"1np9cuq",styles:"margin-left:auto !important;align-self:baseline"};const Ne=({selectedDetectorIndex:e,selectedEntities:t,selectedJobId:s,showAnnotations:a,showAnnotationsCheckbox:n,showForecast:r,showForecastCheckbox:l,showModelBounds:c,showModelBoundsCheckbox:d,onShowAnnotationsChange:m,onShowModelBoundsChange:p,onShowForecastChange:b})=>{var f,g;const[x,v]=Object(o.useState)(!1),[E,y]=Object(o.useState)(!1),{services:{application:{capabilities:F},cases:M,embeddable:w}}=Object(h.d)(),T=Object(u.b)(!0),I=null!==(f=null===(g=F.dashboard)||void 0===g?void 0:g.createNew)&&void 0!==f&&f,C=Object(o.useCallback)((e=>()=>{v(!1),e()}),[v]),A=Object(Ae.a)(De.b),k=[{id:0,items:[{name:Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeseriesExplorer.addToDashboardLabel",defaultMessage:"Add to dashboard"}),onClick:C((()=>{y(!0)}))}]}],D=null==M?void 0:M.helpers.canUseCases();(null!=D&&D.create||null!=D&&D.update)&&k[0].items.push({name:Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeseriesExplorer.addToCaseLabel",defaultMessage:"Add to case"}),onClick:C((()=>{A({jobIds:[s],selectedDetectorIndex:e,selectedEntities:t,timeRange:T})}))});const _=Object(o.useCallback)((({dashboardId:a,newTitle:o,newDescription:i})=>{const n=w.getStateTransfer();var r;const l={input:{id:(r=s,{title:Object(ke.a)(r).concat(""),id:Object(j.htmlIdGenerator)()()}).id,title:o,description:i,jobIds:[s],selectedDetectorIndex:e,selectedEntities:t},type:De.b},c="new"===a?"#/create":`#/view/${a}`;n.navigateToWithEmbeddablePackage("dashboards",{state:l,path:c})}),[w,s,e,t]);return Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)(j.EuiFlexGroup,{style:{float:"right"},alignItems:"center"},d&&Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(j.EuiCheckbox,{id:"toggleModelBoundsCheckbox",label:S.i18n.translate("xpack.ml.timeSeriesExplorer.showModelBoundsLabel",{defaultMessage:"show model bounds"}),checked:c,onChange:p})),n&&Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(j.EuiCheckbox,{id:"toggleAnnotationsCheckbox",label:S.i18n.translate("xpack.ml.timeSeriesExplorer.annotationsLabel",{defaultMessage:"annotations"}),checked:a,onChange:m})),l&&Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(j.EuiCheckbox,{id:"toggleShowForecastCheckbox",label:Object(L.jsx)("span",{"data-test-subj":"mlForecastCheckbox"},S.i18n.translate("xpack.ml.timeSeriesExplorer.showForecastLabel",{defaultMessage:"show forecast"})),checked:r,onChange:b})),I?Object(L.jsx)(j.EuiFlexItem,{grow:!1,css:Re},Object(L.jsx)(j.EuiPopover,{button:Object(L.jsx)(j.EuiButtonIcon,{size:"s","aria-label":S.i18n.translate("xpack.ml.explorer.swimlaneActions",{defaultMessage:"Actions"}),color:"text",iconType:"boxesHorizontal",onClick:v.bind(null,!x),"data-test-subj":"mlAnomalyTimelinePanelMenu"}),isOpen:x,closePopover:v.bind(null,!1),panelPaddingSize:"none",anchorPosition:"downLeft"},Object(L.jsx)(j.EuiContextMenu,{initialPanelId:0,panels:k}))):null),E?Object(L.jsx)(_e,{canSaveByReference:!1,objectType:S.i18n.translate("xpack.ml.cases.singleMetricViewer.displayName",{defaultMessage:"Single Metric Viewer"}),documentInfo:{title:Object(ke.a)(s)},onClose:()=>y(!1),onSave:_}):null)},Be=S.i18n.translate("xpack.ml.timeSeriesExplorer.allPartitionValuesLabel",{defaultMessage:"all"});class timeseriesexplorer_TimeSeriesExplorer extends i.a.Component{constructor(...e){super(...e),f()(this,"state",Object(ve.a)()),f()(this,"subscriptions",new v.Subscription),f()(this,"resizeRef",Object(o.createRef)()),f()(this,"resizeChecker",void 0),f()(this,"resizeHandler",(()=>{this.setState({svgWidth:null!==this.resizeRef.current?this.resizeRef.current.offsetWidth-34:0})})),f()(this,"unmounted",!1),f()(this,"contextChart$",new v.Subject),f()(this,"mlTimeSeriesExplorer",void 0),f()(this,"mlTimeSeriesSearchService",void 0),f()(this,"mlForecastService",void 0),f()(this,"mlResultsService",void 0),f()(this,"mlIndexUtils",void 0),f()(this,"getFieldNamesWithEmptyValues",(()=>this.getControlsForDetector().filter((({fieldValue:e})=>null===e)).map((({fieldName:e})=>e)))),f()(this,"arePartitioningFieldsProvided",(()=>0===this.getFieldNamesWithEmptyValues().length)),f()(this,"toggleShowAnnotationsHandler",(()=>{this.setState((e=>({showAnnotations:!e.showAnnotations})))})),f()(this,"toggleShowForecastHandler",(()=>{this.setState((e=>({showForecast:!e.showForecast})))})),f()(this,"toggleShowModelBoundsHandler",(()=>{this.setState({showModelBounds:!this.state.showModelBounds})})),f()(this,"setFunctionDescription",(e=>{this.props.appStateHandler(ge.a.SET_FUNCTION_DESCRIPTION,e)})),f()(this,"previousChartProps",{}),f()(this,"previousShowAnnotations",void 0),f()(this,"previousShowForecast",void 0),f()(this,"previousShowModelBounds",void 0),f()(this,"tableFilter",((e,t,s)=>{const a=this.getControlsForDetector(),o=a.find((({fieldName:t})=>t===e));if(void 0===o)return;const{appStateHandler:i}=this.props;let n="";if("+"===s&&o.fieldValue!==t)n=t;else{if("-"!==s||o.fieldValue!==t)return;n=null}const r={...a.reduce(((e,t)=>(e[t.fieldName]=t.fieldValue,e)),{}),[o.fieldName]:n};i(ge.a.SET_ENTITIES,r)})),f()(this,"contextChartSelectedInitCallDone",!1),f()(this,"contextChartSelected",(e=>{const t={from:e.from.toISOString(),to:e.to.toISOString()};Object(a.isEqual)(this.props.zoom,t)&&void 0!==this.state.focusChartData&&this.props.previousRefresh===this.props.lastRefresh||(this.contextChart$.next(e),this.props.appStateHandler(ge.a.SET_ZOOM,t))})),f()(this,"loadAnomaliesTableData",((e,t)=>{const{dateFormatTz:s,selectedDetectorIndex:o,selectedJobId:i,tableInterval:n,tableSeverity:r,functionDescription:l}=this.props,c=K.mlJobService.getJob(i),d=this.getControlsForDetector();return Z.ml.results.getAnomaliesTableData([c.job_id],this.getCriteriaFields(o,d),[],n,r,e,t,s,w.b,void 0,void 0,l).pipe(Object(v.map)((e=>{const t=e.anomalies,s=K.mlJobService.detectorsByJob;return t.forEach((e=>{const t=e.jobId,o=Object(a.get)(s,[t,e.detectorIndex]);e.detector=Object(a.get)(o,["detector_description"],e.source.function_description);const i=o.custom_rules;void 0!==i&&(e.rulesLength=i.length),Object(a.has)(K.mlJobService.customUrlsByJob,t)&&(e.customUrls=K.mlJobService.customUrlsByJob[t])})),{tableData:{anomalies:t,interval:e.interval,examplesByJobId:e.examplesByJobId,showViewSeriesLink:!1}}})))})),f()(this,"setForecastId",(e=>{this.props.appStateHandler(ge.a.SET_FORECAST_ID,e)})),f()(this,"displayErrorToastMessages",((e,t)=>{this.props.toastNotificationService&&this.props.toastNotificationService.displayErrorToast(e,t,2e3),this.setState({loading:!1,chartDataError:t})})),f()(this,"loadSingleMetricData",((e=!0)=>{const{autoZoomDuration:t,bounds:s,selectedDetectorIndex:a,selectedForecastId:o,selectedJobId:i,zoom:n,functionDescription:r}=this.props,{loadCounter:l}=this.state,c=K.mlJobService.getJob(i);if(void 0===c)return;if(Object(Fe.b)(c,a)&&void 0===r)return;const d=ye.b.toES(r);this.contextChartSelectedInitCallDone=!1;const u=this.getControlsForDetector();this.setState({fullRefresh:e,loadCounter:l+1,loading:!0,chartDataError:void 0,...e?{chartDetails:void 0,contextChartData:void 0,contextForecastData:void 0,focusChartData:void 0,focusForecastData:void 0,modelPlotEnabled:Object(p.n)(c,a)&&Object(p.o)(c,a,u),hasResults:!1,dataNotChartable:!1}:{}},(()=>{const{loadCounter:e,modelPlotEnabled:r}=this.state,l=K.mlJobService.getJob(i),c=a;let m=3;const h={},b=a=>{if(m--,0===m&&a===e){if(h.hasResults=Array.isArray(h.contextChartData)&&h.contextChartData.length>0||Array.isArray(h.contextForecastData)&&h.contextForecastData.length>0,h.loading=!1,h.contextChartData.length&&!0===this.arePartitioningFieldsProvided()){let e=this.mlTimeSeriesExplorer.calculateInitialFocusRange(n,h.contextAggregationInterval,s);void 0!==n&&void 0!==e||(e=this.mlTimeSeriesExplorer.calculateDefaultFocusRange(t,h.contextAggregationInterval,h.contextChartData,h.contextForecastData),this.previousSelectedForecastId=this.props.selectedForecastId),void 0!==e&&this.contextChartSelected({from:e[0],to:e[1]})}this.setState(h)}},f=u.filter((e=>null!==e.fieldValue));if(!1===r&&!1===Object(p.p)(l,c)&&f.length>0)return h.hasResults=!1,h.loading=!1,h.dataNotChartable=!0,void this.setState(h);h.contextAggregationInterval=this.mlTimeSeriesExplorer.calculateAggregationInterval(s,ge.b,l);const g=Object(y.b)(s,h.contextAggregationInterval,!1),x=e;if(this.mlTimeSeriesSearchService.getMetricData(l,c,f,g.min.valueOf(),g.max.valueOf(),h.contextAggregationInterval.asMilliseconds(),d).toPromise().then((e=>{const t=this.mlTimeSeriesExplorer.processMetricPlotResults(e.results,r);h.contextChartData=t,b(x)})).catch((e=>{const t=S.i18n.translate("xpack.ml.timeSeriesExplorer.metricDataErrorMessage",{defaultMessage:"Error getting metric data"});this.displayErrorToastMessages(e,t)})),this.mlResultsService.getRecordMaxScoreByTime(l.job_id,this.getCriteriaFields(c,u),g.min.valueOf(),g.max.valueOf(),h.contextAggregationInterval.asMilliseconds(),d).then((e=>{const t=this.mlTimeSeriesExplorer.processRecordScoreResults(e.results);h.swimlaneData=t,b(x)})).catch((e=>{const t=S.i18n.translate("xpack.ml.timeSeriesExplorer.bucketAnomalyScoresErrorMessage",{defaultMessage:"Error getting bucket anomaly scores"});this.displayErrorToastMessages(e,t)})),this.mlTimeSeriesSearchService.getChartDetails(l,c,u,g.min.valueOf(),g.max.valueOf(),this.props.functionDescription).then((e=>{h.chartDetails=e.results,b(x)})).catch((e=>{this.displayErrorToastMessages(e,S.i18n.translate("xpack.ml.timeSeriesExplorer.entityCountsErrorMessage",{defaultMessage:"Error getting entity counts"}))})),void 0!==o){let e;m++;const t=l.analysis_config.detectors[c],s=Object(p.s)(t.function);!1!==r||"sum"!==s&&"count"!==s||(e={avg:"sum",max:"sum",min:"sum"}),this.mlForecastService.getForecastData(l,c,o,f,g.min.valueOf(),g.max.valueOf(),h.contextAggregationInterval.asMilliseconds(),e).toPromise().then((e=>{h.contextForecastData=this.mlTimeSeriesExplorer.processForecastResults(e.results),b(x)})).catch((e=>{this.displayErrorToastMessages(e,S.i18n.translate("xpack.ml.timeSeriesExplorer.forecastDataErrorMessage",{defaultMessage:"Error loading forecast data for forecast ID {forecastId}",values:{forecastId:o}}))}))}}))})),f()(this,"getControlsForDetector",(()=>{const{selectedDetectorIndex:e,selectedEntities:t,selectedJobId:s}=this.props;return Object(Se.a)(e,t,s)}))}getFocusAggregationInterval(e){const{selectedJobId:t}=this.props,s=K.mlJobService.getJob(t),a={min:x()(e.from),max:x()(e.to)};return this.mlTimeSeriesExplorer.calculateAggregationInterval(a,ge.b,s)}getFocusData(e){const{selectedJobId:t,selectedForecastId:s,selectedDetectorIndex:a,functionDescription:o}=this.props,{modelPlotEnabled:i}=this.state,n=K.mlJobService.getJob(t);if(Object(Fe.b)(n,a)&&void 0===o)return;const r=this.getControlsForDetector(),l={min:x()(e.from),max:x()(e.to)},c=this.getFocusAggregationInterval(e),d=Object(y.b)(l,c,!1);return this.mlTimeSeriesExplorer.getFocusData(this.getCriteriaFields(a,r),a,c,s,i,r.filter((e=>null!==e.fieldValue)),d,n,o,ge.d)}getCriteriaFields(e,t){return[{fieldName:"detector_index",fieldValue:e},...t.filter((e=>null!==e.fieldValue))]}loadForJobId(e){const{appStateHandler:t,selectedDetectorIndex:s}=this.props,o=K.mlJobService.getJob(e);if(void 0===o)return;const i=Object(m.a)(o);let n=void 0!==s?s:i[0].index;if(void 0===Object(a.find)(i,{index:n})){const e=S.i18n.translate("xpack.ml.timeSeriesExplorer.requestedDetectorIndexNotValidWarningMessage",{defaultMessage:"Requested detector index {detectorIndex} is not valid for job {jobId}",values:{detectorIndex:n,jobId:o.job_id}});this.props.toastNotificationService&&this.props.toastNotificationService.displayWarningToast(e),n=i[0].index}const r=n;r!==s&&t(ge.a.SET_DETECTOR_INDEX,r),this.context.services.mlServices.mlFieldFormatService.populateFormats([e])}componentDidMount(){const{mlApiServices:e}=this.context.services.mlServices;this.mlResultsService=Object(fe.mlResultsServiceProvider)(e),this.mlTimeSeriesSearchService=Object(xe.timeSeriesSearchServiceFactory)(this.mlResultsService,e),this.mlTimeSeriesExplorer=Object(be.timeSeriesExplorerServiceFactory)(this.context.services.uiSettings,e,this.mlResultsService),this.mlIndexUtils=Object(Ie.indexServiceFactory)(this.context.services.data.dataViews),this.mlForecastService=Object(Q.a)(e);const{invalidTimeRangeError:t}=this.props;t&&this.props.toastNotificationService&&this.props.toastNotificationService.displayWarningToast(S.i18n.translate("xpack.ml.timeSeriesExplorer.invalidTimeRangeInUrlCallout",{defaultMessage:"The time filter was changed to the full range for this job due to an invalid default time filter. Check the advanced settings for {field}.",values:{field:je.a}})),this.resizeChecker=new F.ResizeChecker(this.resizeRef.current),this.resizeChecker.on("resize",(()=>{this.resizeHandler()})),this.resizeHandler(),this.subscriptions.add(this.contextChart$.pipe(Object(v.tap)((e=>{this.setState({zoomFrom:e.from,zoomTo:e.to})})),Object(v.debounceTime)(500),Object(v.tap)((e=>{const{contextChartData:t,contextForecastData:s,focusChartData:a,zoomFromFocusLoaded:o,zoomToFocusLoaded:i}=this.state;(void 0!==t&&0!==t.length||void 0!==s&&0!==s.length)&&(!1===this.contextChartSelectedInitCallDone&&void 0===a||o.getTime()!==e.from.getTime()||i.getTime()!==e.to.getTime())&&(this.contextChartSelectedInitCallDone=!0,this.setState({loading:!0,fullRefresh:!1}))})),Object(v.switchMap)((e=>{const{selectedJobId:t}=this.props,s=K.mlJobService.getJob(t),a={min:x()(e.from),max:x()(e.to)},o=this.mlTimeSeriesExplorer.calculateAggregationInterval(a,ge.b,s),i=Object(y.b)(a,o,!1);return Object(v.forkJoin)([this.getFocusData(e),this.loadAnomaliesTableData(i.min.valueOf(),i.max.valueOf())])})),Object(v.withLatestFrom)(this.contextChart$)).subscribe((([[e,t],s])=>{const{modelPlotEnabled:a}=this.state;this.setState({focusAggregationInterval:this.getFocusAggregationInterval({from:s.from,to:s.to}),loading:!1,showModelBoundsCheckbox:a&&e.focusChartData.length>0,zoomFromFocusLoaded:s.from,zoomToFocusLoaded:s.to,...e,...t})}))),this.componentDidUpdate()}componentDidUpdate(e){if(void 0===e||e.selectedJobId!==this.props.selectedJobId){const e=K.mlJobService.getJob(this.props.selectedJobId);this.contextChartSelectedInitCallDone=!1,Object(Te.e)([e],this.props.dataViewsService,this.mlIndexUtils).then((({getSourceIndicesWithGeoFieldsResp:e})=>this.setState({fullRefresh:!1,loading:!0,sourceIndicesWithGeoFields:e},(()=>{this.loadForJobId(this.props.selectedJobId)})))).catch(console.error)}if(void 0!==e&&e.selectedForecastId===this.props.selectedForecastId||void 0!==this.props.selectedForecastId&&(this.setState({showForecast:!0}),void 0!==e&&(this.previousSelectedForecastId=e.selectedForecastId)),void 0===e||!Object(a.isEqual)(e.bounds,this.props.bounds)||!Object(a.isEqual)(e.lastRefresh,this.props.lastRefresh)&&0!==e.lastRefresh||!Object(a.isEqual)(e.selectedDetectorIndex,this.props.selectedDetectorIndex)||!Object(a.isEqual)(e.selectedEntities,this.props.selectedEntities)||e.selectedForecastId!==this.props.selectedForecastId||e.selectedJobId!==this.props.selectedJobId||e.functionDescription!==this.props.functionDescription){const t=void 0===e||!Object(a.isEqual)(e.bounds,this.props.bounds)||!Object(a.isEqual)(e.selectedDetectorIndex,this.props.selectedDetectorIndex)||!Object(a.isEqual)(e.selectedEntities,this.props.selectedEntities)||e.selectedForecastId!==this.props.selectedForecastId||e.selectedJobId!==this.props.selectedJobId||e.functionDescription!==this.props.functionDescription;this.loadSingleMetricData(t)}if(void 0===e)return;e.tableInterval===this.props.tableInterval&&e.tableSeverity===this.props.tableSeverity||(()=>{const{zoomFrom:e,zoomTo:t}=this.state;void 0!==e&&void 0!==t&&this.loadAnomaliesTableData(e.getTime(),t.getTime()).subscribe((e=>this.setState(e)))})()}componentWillUnmount(){this.subscriptions.unsubscribe(),this.resizeChecker.destroy(),this.unmounted=!0}render(){const{autoZoomDuration:e,bounds:t,dateFormatTz:s,lastRefresh:n,selectedDetectorIndex:r,selectedEntities:l,selectedJobId:c}=this.props,{chartDetails:d,contextAggregationInterval:u,contextChartData:h,contextForecastData:b,dataNotChartable:f,focusAggregationInterval:g,focusAnnotationError:x,focusAnnotationData:v,focusChartData:E,focusForecastData:y,fullRefresh:F,hasResults:w,loading:A,modelPlotEnabled:k,showAnnotations:D,showAnnotationsCheckbox:_,showForecast:R,showForecastCheckbox:N,showModelBounds:B,showModelBoundsCheckbox:z,svgWidth:P,swimlaneData:J,tableData:V,zoomFrom:W,zoomTo:U,zoomFromFocusLoaded:H,zoomToFocusLoaded:G,chartDataError:q,sourceIndicesWithGeoFields:X}=this.state,Y={modelPlotEnabled:k,contextChartData:h,contextChartSelected:this.contextChartSelected,contextForecastData:b,contextAggregationInterval:u,swimlaneData:J,focusAnnotationData:v,focusChartData:E,focusForecastData:y,focusAggregationInterval:g,svgWidth:P,zoomFrom:W,zoomTo:U,zoomFromFocusLoaded:H,zoomToFocusLoaded:G,autoZoomDuration:e},$=K.mlJobService.jobs.filter(p.r);if(void 0===r||void 0===K.mlJobService.getJob(c))return Object(L.jsx)(pe,{dateFormatTz:s,resizeRef:this.resizeRef},Object(L.jsx)(we.a,null));const Z=K.mlJobService.getJob(c),Q=this.getControlsForDetector(),ee=this.getFieldNamesWithEmptyValues(),te=this.arePartitioningFieldsProvided(),se=Object(m.a)(Z);let ae=!0;return Object(a.isEqual)(this.previousChartProps.focusForecastData,Y.focusForecastData)&&Object(a.isEqual)(this.previousChartProps.focusChartData,Y.focusChartData)&&Object(a.isEqual)(this.previousChartProps.focusAnnotationData,Y.focusAnnotationData)&&this.previousShowForecast===R&&this.previousShowModelBounds===B&&this.props.previousRefresh===n&&(ae=!1),this.previousChartProps=Y,this.previousShowForecast=R,this.previousShowModelBounds=B,Object(L.jsx)(pe,{dateFormatTz:s,resizeRef:this.resizeRef},ee.length>0&&Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)(j.EuiCallOut,{title:Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.singleMetricRequiredMessage",defaultMessage:"To view a single metric, select {missingValuesCount, plural, one {a value for {fieldName1}} other {values for {fieldName1} and {fieldName2}}}.",values:{missingValuesCount:ee.length,fieldName1:ee[0],fieldName2:ee[1]}}),iconType:"help",size:"s"}),Object(L.jsx)(j.EuiSpacer,{size:"m"})),Object(L.jsx)(Oe.a,{selectedJobId:c,appStateHandler:this.props.appStateHandler,selectedDetectorIndex:r,selectedEntities:this.props.selectedEntities,bounds:t,functionDescription:this.props.functionDescription,setFunctionDescription:this.setFunctionDescription},te&&Object(L.jsx)(j.EuiFlexItem,{style:{textAlign:"right"}},Object(L.jsx)(j.EuiFormRow,{hasEmptyLabelSpace:!0,style:{maxWidth:"100%"}},Object(L.jsx)(forecasting_modal_ForecastingModal,{job:Z,detectorIndex:r,entities:Q,setForecastId:this.setForecastId,className:"forecast-controls"})))),Object(L.jsx)(j.EuiSpacer,{size:"m"}),F&&!0===A&&Object(L.jsx)(ie.a,{label:S.i18n.translate("xpack.ml.timeSeriesExplorer.loadingLabel",{defaultMessage:"Loading"})}),!1===A&&void 0!==q&&Object(L.jsx)(Me.a,{errorMsg:q}),te&&$.length>0&&(!1===F||!1===A)&&!1===w&&void 0===q&&Object(L.jsx)(le.a,{dataNotChartable:f,entities:Q}),te&&$.length>0&&(!1===F||!1===A)&&!0===w&&Object(L.jsx)("div",null,Object(L.jsx)(j.EuiFlexGroup,{gutterSize:"xs",alignItems:"center"},Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(j.EuiTitle,{size:"xs"},Object(L.jsx)("h2",null,Object(L.jsx)("span",null,S.i18n.translate("xpack.ml.timeSeriesExplorer.singleTimeSeriesAnalysisTitle",{defaultMessage:"Single time series analysis of {functionLabel}",values:{functionLabel:d.functionLabel}}))," ",1===d.entityData.count&&Object(L.jsx)(j.EuiTextColor,{color:"success",size:"s",component:"span"},d.entityData.entities.length>0&&"(",d.entityData.entities.map((e=>`${e.fieldName}: ${e.fieldValue}`)).join(", "),d.entityData.entities.length>0&&")"),1!==d.entityData.count&&Object(L.jsx)(j.EuiTextColor,{color:"success",size:"s",component:"span"},d.entityData.entities.map(((e,t)=>Object(L.jsx)(o.Fragment,{key:e.fieldName},S.i18n.translate("xpack.ml.timeSeriesExplorer.countDataInChartDetailsDescription",{defaultMessage:"{openBrace}{cardinalityValue} distinct {fieldName} {cardinality, plural, one {} other { values}}{closeBrace}",values:{openBrace:0===t?"(":"",closeBrace:t===d.entityData.entities.length-1?")":"",cardinalityValue:0===e.cardinality?Be:e.cardinality,cardinality:e.cardinality,fieldName:e.fieldName}}),t!==d.entityData.entities.length-1?", ":""))))))),Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(M.a,null))),Object(L.jsx)(Ne,{selectedDetectorIndex:r,selectedEntities:l,selectedJobId:c,showAnnotationsCheckbox:_,showAnnotations:D,showForecastCheckbox:N,showForecast:R,showModelBoundsCheckbox:z,showModelBounds:B,onShowModelBoundsChange:this.toggleShowModelBoundsHandler,onShowAnnotationsChange:this.toggleShowAnnotationsHandler,onShowForecastChange:this.toggleShowForecastHandler}),Object(L.jsx)(Ee.a,{chartProps:Y,contextAggregationInterval:u,bounds:t,detectorIndex:r,renderFocusChartOnly:ae,selectedJob:Z,selectedEntities:this.props.selectedEntities,showAnnotations:D,showForecast:R,showModelBounds:B,lastRefresh:n,tableData:V,sourceIndicesWithGeoFields:X}),void 0!==x&&Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)(j.EuiTitle,{"data-test-subj":"mlAnomalyExplorerAnnotations error",size:"xs"},Object(L.jsx)("h2",null,Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationsErrorTitle",defaultMessage:"Annotations"}))),Object(L.jsx)(j.EuiPanel,null,Object(L.jsx)(j.EuiCallOut,{title:S.i18n.translate("xpack.ml.timeSeriesExplorer.annotationsErrorCallOutTitle",{defaultMessage:"An error occurred loading annotations:"}),color:"danger",iconType:"warning"},Object(L.jsx)("p",null,x))),Object(L.jsx)(j.EuiSpacer,{size:"m"})),v&&v.length>0&&Object(L.jsx)(i.a.Fragment,null,Object(L.jsx)(j.EuiAccordion,{id:"mlAnnotationsAccordion",buttonContent:Object(L.jsx)(j.EuiTitle,{size:"xs"},Object(L.jsx)("h2",null,Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationsTitle",defaultMessage:"Annotations {badge}",values:{badge:Object(L.jsx)(j.EuiBadge,{color:"hollow"},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.explorer.annotationsTitleTotalCount",defaultMessage:"Total: {count}",values:{count:v.length}}))}}))),"data-test-subj":"mlAnomalyExplorerAnnotations loaded"},Object(L.jsx)(I.a,{chartDetails:d,detectorIndex:r,detectors:se,jobIds:[this.props.selectedJobId],annotations:v,isSingleMetricViewerLinkVisible:!1,isNumberBadgeVisible:!0})),Object(L.jsx)(j.EuiSpacer,{size:"m"})),Object(L.jsx)(T.AnnotationFlyout,{chartDetails:d,detectorIndex:r,detectors:se}),Object(L.jsx)(j.EuiTitle,{size:"xs"},Object(L.jsx)("h2",null,Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.anomaliesTitle",defaultMessage:"Anomalies"}))),Object(L.jsx)(j.EuiSpacer,{size:"s"}),Object(L.jsx)(j.EuiFlexGroup,{direction:"row",gutterSize:"l",responsive:!0},Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(re.a,null)),Object(L.jsx)(j.EuiFlexItem,{grow:!1},Object(L.jsx)(ne.a,null))),Object(L.jsx)(j.EuiSpacer,{size:"m"})),te&&$.length>0&&!0===w&&Object(L.jsx)(C.a,{bounds:t,tableData:V,filter:this.tableFilter,sourceIndicesWithGeoFields:this.state.sourceIndicesWithGeoFields,selectedJobs:[{id:Z.job_id,modelPlotEnabled:k}]}))}}f()(timeseriesexplorer_TimeSeriesExplorer,"contextType",E.context);var ze=s(1),Le=s(28);const Pe=()=>{const e=Object(h.f)({page:ze.b.ANOMALY_DETECTION_CREATE_JOB}),t=!Object(X.usePermissionCheck)("canCreateJob")||!Object(Le.c)();return Object(L.jsx)(j.EuiEmptyPrompt,{"data-test-subj":"mlNoSingleMetricJobsFound",iconType:"warning",title:Object(L.jsx)("h2",null,Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.noSingleMetricJobsFoundLabel",defaultMessage:"No single metric jobs found"})),actions:Object(L.jsx)(j.EuiButton,{color:"primary",fill:!0,href:e,disabled:t},Object(L.jsx)(O.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.createNewSingleMetricJobLinkText",defaultMessage:"Create new single metric job"}))})};var Je=s(486),Ve=s(285),We=s(71),Ue=s(504),He=s(160);const Ge=({config:e,jobsWithTimeRange:t})=>{var s,i,n,l,b,f,g,x,v,j,S,O,E,y,F,M,w;const{services:{data:{dataViews:T}}}=Object(h.d)(),{toasts:I}=Object(h.i)(),C=Object(Q.b)(),A=Object(We.useToastNotificationService)(),[k,D]=Object(d.c)(ze.b.SINGLE_METRIC_VIEWER),[_,R]=Object(d.d)("_g"),[N,B]=Object(o.useState)(),z=Object(u.c)({timeRangeSelector:!0,autoRefreshSelector:!0}),[P,J]=Object(o.useState)(!1),V=Object(He.a)(),W=r()(null!==(s=null==V?void 0:V.lastRefresh)&&void 0!==s?s:0),U=Object(be.useTimeSeriesExplorerService)(),[H,G]=Object(o.useState)(void 0);Object(o.useEffect)((()=>{if(void 0!==(null==_?void 0:_.time)){"invalid"===_.time.mode&&J(!0);const e=z.getBounds();void 0!==(null==e?void 0:e.min)&&void 0!==(null==e?void 0:e.max)&&G(z.getBounds())}}),[null==_||null===(i=_.time)||void 0===i?void 0:i.from,null==_||null===(n=_.time)||void 0===n?void 0:n.to,null==_||null===(l=_.time)||void 0===l?void 0:l.ts]);const q=null==_||null===(b=_.ml)||void 0===b?void 0:b.jobIds;Array.isArray(q)&&q.sort();const X=r()(q),Y=!Object(a.isEqual)(X,q),$=Y||null==k||null===(f=k.mlTimeSeriesExplorer)||void 0===f?void 0:f.entities,Z=Y||null==k||null===(g=k.mlTimeSeriesExplorer)||void 0===g?void 0:g.forecastId,ee=Y||null==k||null===(x=k.mlTimeSeriesExplorer)||void 0===x?void 0:x.functionDescription,te=Y||null==k||null===(v=k.mlTimeSeriesExplorer)||void 0===v?void 0:v.zoom,se=void 0!==N?K.mlJobService.getJob(N):void 0,ae=K.mlJobService.jobs.filter(p.r),oe=se&&null!==(j=null===(S=Object(m.a)(se)[0])||void 0===S?void 0:S.index)&&void 0!==j?j:0,ie=Y?oe:null!==(O=null==k||null===(E=k.mlTimeSeriesExplorer)||void 0===E?void 0:E.detectorIndex)&&void 0!==O?O:oe;let ne;void 0!==N&&void 0!==se&&(ne=U.getAutoZoomDuration(se));const re=Object(o.useCallback)(((e,t)=>{var s;const a=void 0===(null==k||null===(s=k.mlTimeSeriesExplorer)||void 0===s?void 0:s.zoom),o=void 0!==(null==k?void 0:k.mlTimeSeriesExplorer)?{...k.mlTimeSeriesExplorer}:{};switch(e){case ge.a.CLEAR:delete o.detectorIndex,delete o.entities,delete o.forecastId,delete o.zoom,delete o.functionDescription;break;case ge.a.SET_DETECTOR_INDEX:o.detectorIndex=t,delete o.functionDescription;break;case ge.a.SET_ENTITIES:o.entities=t,delete o.functionDescription;break;case ge.a.SET_FORECAST_ID:o.forecastId=t,delete o.zoom;break;case ge.a.SET_ZOOM:o.zoom=t;break;case ge.a.UNSET_ZOOM:delete o.zoom;break;case ge.a.SET_FUNCTION_DESCRIPTION:o.functionDescription=t}D({mlTimeSeriesExplorer:o},a)}),[JSON.stringify(null==k?void 0:k.mlTimeSeriesExplorer),D]),ce=Object(Ue.a)();Object(o.useEffect)((()=>{void 0!==q&&void 0!==X&&re(ge.a.CLEAR);const e=Object(ve.b)(t,q,R,I,ce);"string"==typeof e&&B(e)}),[JSON.stringify(q)]);const de=null==H||null===(y=H.min)||void 0===y?void 0:y.valueOf(),ue=null==H||null===(F=H.max)||void 0===F?void 0:F.valueOf(),[me,he]=Object(o.useState)(null==k||null===(M=k.mlTimeSeriesExplorer)||void 0===M?void 0:M.forecastId);Object(o.useEffect)((()=>{void 0!==ne&&void 0!==de&&void 0!==ue&&void 0!==se&&void 0!==Z&&(me!==Z&&he(void 0),C.getForecastDateRange(se,Z).then((e=>{if(void 0===ne)return;const t=c()(e.earliest||de),s=c()(e.latest||ue);if(t.isBefore(c()(de))||s.isAfter(c()(ue))){const e=Math.min(t.valueOf(),de),a=Math.max(s.valueOf(),ue);R("time",{from:c()(e).toISOString(),to:c()(a).toISOString()})}he(Z)})).catch((e=>{console.error("Time series explorer - error loading time range of forecast from elasticsearch:",e)})))}),[Z]);const[fe]=Object(Je.a)(),[xe]=Object(Ve.a)(),je=e.get("dateFormat:tz"),Se="Browser"!==je?je:c.a.tz.guess();if(0===ae.length)return Object(L.jsx)(pe,{dateFormatTz:Se,noSingleMetricJobsFound:!0},Object(L.jsx)(Pe,null));if(!H)return Object(L.jsx)(pe,{dateFormatTz:Se},Object(L.jsx)(le.a,null));const Oe="string"==typeof Z&&void 0===me?void 0:te;return Object(L.jsx)(timeseriesexplorer_TimeSeriesExplorer,{dataViewsService:T,toastNotificationService:A,appStateHandler:re,autoZoomDuration:ne,bounds:H,dateFormatTz:Se,lastRefresh:null!==(w=null==V?void 0:V.lastRefresh)&&void 0!==w?w:0,previousRefresh:W,selectedJobId:N,selectedDetectorIndex:ie,selectedEntities:$,selectedForecastId:me,tableInterval:fe.val,tableSeverity:xe.val,timefilter:z,zoom:Oe,invalidTimeRangeError:P,functionDescription:ee})}}}]);