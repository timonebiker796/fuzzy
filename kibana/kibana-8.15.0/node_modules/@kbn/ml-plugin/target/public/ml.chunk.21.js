/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[21],{106:function(e,t,i){"use strict";i.r(t),i.d(t,"timeSeriesSearchServiceFactory",(function(){return f})),i.d(t,"useTimeSeriesSearchService",(function(){return m}));var a=i(2),n=i(8),o=i(7),s=i(80),c=i(830),r=i(520),l=i(123);function u(e,t,i){const a=e.analysis_config,o=a.detectors[t],s={jobId:e.job_id,detectorIndex:t,metricFunction:o.function===c.b.LAT_LONG?c.b.LAT_LONG:Object(l.s)(o.function),timeField:e.data_description.time_field,interval:e.analysis_config.bucket_span,datafeedConfig:e.datafeed_config,summaryCountFieldName:e.analysis_config.summary_count_field_name};o.function===c.b.METRIC&&void 0!==i&&(s.metricFunction=i),void 0!==o.field_name&&(s.metricFieldName=o.field_name);const u=a.summary_count_field_name;if(s.metricFunction===c.a.COUNT&&void 0!==u&&u!==r.a&&u!==r.d){let t;const i=Object(n.get)(e.datafeed_config,"aggregations")||Object(n.get)(e.datafeed_config,"aggs");void 0!==i&&Object.values(i).length>0&&(t=Object(n.get)(Object.values(i)[0],["aggregations",u,c.a.CARDINALITY,"field"])||Object(n.get)(Object.values(i)[0],["aggs",u,c.a.CARDINALITY,"field"])),o.function!==c.b.NON_ZERO_COUNT&&o.function!==c.b.LOW_NON_ZERO_COUNT&&o.function!==c.b.HIGH_NON_ZERO_COUNT&&o.function!==c.b.COUNT&&o.function!==c.b.HIGH_COUNT&&o.function!==c.b.LOW_COUNT||void 0===t?(s.metricFunction=c.a.SUM,s.metricFieldName=u):(s.metricFunction=c.a.CARDINALITY,s.metricFieldName=void 0)}return s}var d=i(10);function f(e,t){return{getMetricData:function(t,i,a,s,c,r,d){if(Object(l.n)(t,i)&&Object(l.o)(t,i,a)){const o=[],l=t.analysis_config.detectors[i];if(void 0!==l.partition_field_name){const e=Object(n.find)(a,{fieldName:l.partition_field_name});void 0!==e&&o.push({fieldName:"partition_field_name",fieldValue:e.fieldName},{fieldName:"partition_field_value",fieldValue:e.fieldValue})}if(void 0!==l.over_field_name){const e=Object(n.find)(a,{fieldName:l.over_field_name});void 0!==e&&o.push({fieldName:"over_field_name",fieldValue:e.fieldName},{fieldName:"over_field_value",fieldValue:e.fieldValue})}if(void 0!==l.by_field_name){const e=Object(n.find)(a,{fieldName:l.by_field_name});void 0!==e&&o.push({fieldName:"by_field_name",fieldValue:e.fieldName},{fieldName:"by_field_value",fieldValue:e.fieldValue})}return e.getModelPlotOutput(t.job_id,i,o,s,c,r)}{const l={success:!0,results:{}},f=u(t,i);return e.getMetricData(f.datafeedConfig.indices.join(","),a,f.datafeedConfig.query,null!=d?d:f.metricFunction,f.metricFieldName,f.summaryCountFieldName,f.timeField,s,c,r,null==f?void 0:f.datafeedConfig).pipe(Object(o.map)((e=>(Object(n.each)(e.results,((e,t)=>{l.results[t]={actual:e}})),l))))}},getChartDetails:function(e,i,a,o,s,c){return new Promise(((r,l)=>{const d={success:!0,results:{functionLabel:"",entityData:{entities:[]}}},f=u(e,i,c);let m=f.metricFunction;void 0!==f.metricFieldName&&(m+=` ${f.metricFieldName}`),d.results.functionLabel=m;const _=Object(n.filter)(a,(e=>null===e.fieldValue));if(0===_.length)d.results.entityData.count=1,d.results.entityData.entities=a,r(d);else{const e=_.map((e=>e.fieldName));t.getCardinalityOfFields({index:f.datafeedConfig.indices.join(","),fieldNames:e,query:f.datafeedConfig.query,timeFieldName:f.timeField,earliestMs:o,latestMs:s}).then((e=>{Object(n.each)(_,(t=>{d.results.entityData.entities.push({fieldName:t.fieldName,cardinality:Object(n.get)(e,t.fieldName,0)})})),r(d)})).catch((e=>{l(e)}))}}))}}}function m(){const{services:{mlServices:{mlApiServices:e}}}=Object(d.d)(),t=Object(s.mlResultsServiceProvider)(e);return Object(a.useMemo)((()=>f(t,e)),[e,t])}},195:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return s}));const a={CLEAR:"CLEAR",SET_DETECTOR_INDEX:"SET_DETECTOR_INDEX",SET_ENTITIES:"SET_ENTITIES",SET_FORECAST_ID:"SET_FORECAST_ID",SET_ZOOM:"SET_ZOOM",UNSET_ZOOM:"UNSET_ZOOM",SET_FUNCTION_DESCRIPTION:"SET_FUNCTION_DESCRIPTION"},n=500,o=10,s="timestamp"},234:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return u}));var a=i(2),n=i(82),o=i(39),s=i.n(o),c=i(318),r=i(10);function l(e){return{getTimeBuckets:function(){return new c.a({[n.UI_SETTINGS.HISTOGRAM_MAX_BARS]:e.get(n.UI_SETTINGS.HISTOGRAM_MAX_BARS),[n.UI_SETTINGS.HISTOGRAM_BAR_TARGET]:e.get(n.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:e.get("dateFormat"),"dateFormat:scaled":e.get("dateFormat:scaled")})},getBoundsRoundedToInterval:function(e,t,i=!1){const a=t.asMilliseconds(),n=Math.floor(e.min.valueOf()/a)*a;let o=Math.ceil(e.max.valueOf()/a)*a;return!1===i&&(o-=1),{min:s()(n),max:s()(o)}}}}function u(){const{services:{uiSettings:e}}=Object(r.d)();return Object(a.useMemo)((()=>l(e)),[e])}},235:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return r}));var a=i(2),n=i(8),o=i(7),s=i(10);function c(e){return{getForecastsSummary:function(t,i,a,n){return new Promise(((o,s)=>{const c={success:!0,forecasts:[]},r=[{term:{result_type:"model_forecast_request_stats"}},{term:{job_id:t.job_id}},{range:{timestamp:{gte:a,format:"epoch_millis"}}}];i&&r.push(i),e.results.anomalySearch({size:n,body:{query:{bool:{filter:r}},sort:[{forecast_create_timestamp:{order:"desc"}}]}},[t.job_id]).then((e=>{e.hits.total.value>0&&(c.forecasts=e.hits.hits.map((e=>e._source))),o(c)})).catch((e=>{s(e)}))}))},getForecastDateRange:function(t,i){return new Promise(((a,o)=>{const s={success:!0,earliest:null,latest:null},c=[{query_string:{query:"result_type:model_forecast",analyze_wildcard:!0}},{term:{job_id:t.job_id}},{term:{forecast_id:i}}];e.results.anomalySearch({size:0,body:{query:{bool:{filter:c}},aggs:{earliest:{min:{field:"timestamp"}},latest:{max:{field:"timestamp"}}}}},[t.job_id]).then((e=>{s.earliest=Object(n.get)(e,"aggregations.earliest.value",null),s.latest=Object(n.get)(e,"aggregations.latest.value",null),null===s.earliest||null===s.latest?o(e):a(s)})).catch((e=>{o(e)}))}))},getForecastData:function(t,i,a,s,c,r,l,u){const d=[],f=t.analysis_config.detectors[i];if(void 0!==f.partition_field_name){const e=Object(n.find)(s,{fieldName:f.partition_field_name});void 0!==e&&d.push({fieldName:"partition_field_name",fieldValue:e.fieldName},{fieldName:"partition_field_value",fieldValue:e.fieldValue})}if(void 0!==f.over_field_name){const e=Object(n.find)(s,{fieldName:f.over_field_name});void 0!==e&&d.push({fieldName:"over_field_name",fieldValue:e.fieldName},{fieldName:"over_field_value",fieldValue:e.fieldValue})}if(void 0!==f.by_field_name){const e=Object(n.find)(s,{fieldName:f.by_field_name});void 0!==e&&d.push({fieldName:"by_field_name",fieldValue:e.fieldName},{fieldName:"by_field_value",fieldValue:e.fieldValue})}const m={success:!0,results:{}},_=[{query_string:{query:"result_type:model_forecast",analyze_wildcard:!0}},{term:{job_id:t.job_id}},{term:{forecast_id:a}},{term:{detector_index:i}},{range:{timestamp:{gte:c,lte:r,format:"epoch_millis"}}}];Object(n.each)(d,(e=>{_.push({term:{[e.fieldName]:e.fieldValue}})}));const g=void 0===u?{avg:"avg",max:"max",min:"min"}:{avg:u.avg,max:u.max,min:u.min};return e.results.anomalySearch$({size:0,body:{query:{bool:{filter:_}},aggs:{times:{date_histogram:{field:"timestamp",fixed_interval:`${l}ms`,min_doc_count:1},aggs:{prediction:{[g.avg]:{field:"forecast_prediction"}},forecastUpper:{[g.max]:{field:"forecast_upper"}},forecastLower:{[g.min]:{field:"forecast_lower"}}}}}}},[t.job_id]).pipe(Object(o.map)((e=>{const t=Object(n.get)(e,["aggregations","times","buckets"],[]);return Object(n.each)(t,(e=>{const t=e.key;m.results[t]={prediction:Object(n.get)(e,["prediction","value"]),forecastUpper:Object(n.get)(e,["forecastUpper","value"]),forecastLower:Object(n.get)(e,["forecastLower","value"])}})),m})))},runForecast:function(t,i){return console.log("ML forecast service run forecast with duration:",i),new Promise(((a,n)=>{e.forecast({jobId:t,duration:i}).then((e=>{a(e)})).catch((e=>{n(e)}))}))},getForecastRequestStats:function(t,i){return new Promise(((a,n)=>{const o={success:!0,stats:{}},s=[{query_string:{query:"result_type:model_forecast_request_stats",analyze_wildcard:!0}},{term:{job_id:t.job_id}},{term:{forecast_id:i}}];e.results.anomalySearch({size:1,body:{query:{bool:{filter:s}}}},[t.job_id]).then((e=>{e.hits.total.value>0&&(o.stats=e.hits.hits[0]._source),a(o)})).catch((e=>{n(e)}))}))}}}function r(){const{services:{mlServices:{mlApiServices:e}}}=Object(s.d)();return Object(a.useMemo)((()=>c(e)),[e])}},94:function(e,t,i){"use strict";i.r(t),i.d(t,"timeSeriesExplorerServiceFactory",(function(){return h})),i.d(t,"useTimeSeriesExplorerService",(function(){return j}));var a=i(2),n=i(252),o=i(830),s=i(322),c=i(39),r=i.n(c),l=i(7),u=i(8),d=i(40),f=i(123),m=i(162),_=i(195),g=i(234),v=i(80),b=i(235),O=i(106),p=i(10);function h(e,t,i){const a=Object(g.a)(e),c=Object(b.a)(t),v=Object(O.timeSeriesSearchServiceFactory)(i,t);function p(e,t){const i=[];return!0===t?Object(u.each)(e,((e,t)=>{i.push({date:new Date(+t),lower:e.modelLower,value:e.actual,upper:e.modelUpper})})):Object(u.each)(e,((e,t)=>{i.push({date:new Date(+t),value:e.actual})})),i}function h(e){const t=[];return Object(u.each)(e,((e,i)=>{t.push({date:new Date(+i),isForecast:!0,lower:e.forecastLower,value:e.prediction,upper:e.forecastUpper})})),t}function j(e,t,i){let a;if(void 0===e)return a;for(let i=0;i<e.length;i++)if(e[i].date.getTime()===t){a=e[i];break}if(void 0===a){let n;const o=i.asMilliseconds();for(let i=0;i<e.length;i++)if(t-e[i].date.getTime()<o){n=e[i];break}a=n}return a}function T(e,t,i,a,s){const c=[],r=i.asMilliseconds();let l;return void 0!==e&&e.length>0&&(l=e[e.length-1].date.getTime()),t.forEach((t=>{const a=t[_.d];if(void 0===j(e,a,i)){const e=Math.floor(a/r)*r;-1===c.indexOf(e)&&e!==l&&c.push(e)}})),c.sort(((e,t)=>e-t)),c.forEach((t=>{const i={date:new Date(t),value:null};!0===a&&(i.upper=null,i.lower=null),e.push(i)})),t.forEach((t=>{const a=t[_.d];if(t.function===o.b.METRIC&&t.function_description!==s)return;const c=j(e,a,i);if(void 0!==c){const e=t.record_score,i=c.anomalyScore;if(void 0===i||i<e){if(c.anomalyScore=e,c.function=t.function,void 0!==t.actual)null!==c.value&&t.function!==o.b.METRIC||(c.value=Array.isArray(t.actual)?t.actual[0]:t.actual),c.actual=t.actual,c.typical=t.typical;else{const e=Object(u.get)(t,"causes",[]);if(e.length>0&&(c.byFieldName=t.by_field_name,c.numberOfCauses=e.length,1===e.length)){const e=t.causes[0];c.actual=e.actual,c.typical=e.typical,null===c.value&&(c.value=e.actual)}}void 0!==t.anomaly_score_explanation&&void 0!==t.anomaly_score_explanation.multi_bucket_impact&&(c.multiBucketImpact=t.anomaly_score_explanation.multi_bucket_impact),c.isMultiBucketAnomaly=Object(n.g)(t)}}})),e}function y(e,t){let i;if(void 0===e)return i;for(let a=0;a<e.length;a++)if(e[a].date.getTime()===t){i=e[a];break}return i}function S(e,t,i){if(void 0!==t){const a=[],n=i.asMilliseconds();let o;void 0!==e&&e.length>0&&(o=e[e.length-1].date.getTime());let s=!1;Object(u.each)(t,((t,i)=>{const c=y(e,+i);if(void 0!==c)c.scheduledEvents=t;else{const c=Math.floor(i/n)*n;if(-1===a.indexOf(c)&&c!==o){const i={date:new Date(c),value:null,scheduledEvents:t};e.push(i),s=!0}}})),s&&e.sort(((e,t)=>e.date.getTime()-t.date.getTime()))}return e}return{getAutoZoomDuration:function(e){let t;if(e.analysis_config.bucket_span){const i=Object(d.a)(e.analysis_config.bucket_span).asSeconds();t=1e3*i*(_.b-1);const n=Math.floor(1.1*_.b),o=a.getTimeBuckets();o.setInterval("auto"),o.setBarTarget(Math.floor(_.b)),o.setMaxBars(n);const s=(new Date).getTime(),c=r()(s),l=r()(s-t);o.setBounds({min:l,max:c});const u=o.getIntervalToNearestMultiple(i).asSeconds();u!==i&&(t*=i/u)}return t},calculateAggregationInterval:function(e,t,i){const n=void 0!==t?t:100,o=Math.floor(1.1*n),s=a.getTimeBuckets();let c;if(s.setInterval("auto"),s.setBounds(e),s.setBarTarget(Math.floor(n)),s.setMaxBars(o),i.analysis_config.bucket_span){const e=Object(d.a)(i.analysis_config.bucket_span).asSeconds();c=s.getIntervalToNearestMultiple(e),c.asSeconds()<e&&(s.setInterval(e+"s"),c=s.getInterval())}return c},calculateInitialFocusRange:function(e,t,i){if(void 0!==e){const n=r()(e.from,"YYYY-MM-DDTHH:mm:ss.SSSZ",!0),o=r()(e.to,"YYYY-MM-DDTHH:mm:ss.SSSZ",!0),s=a.getBoundsRoundedToInterval(i,t,!0),c=s.min,l=s.max;if(n.isValid()&&o.isValid()&&o.isAfter(n)&&n.isBetween(c,l,null,"[]")&&o.isBetween(c,l,null,"[]"))return[n.toDate(),o.toDate()]}},calculateDefaultFocusRange:function(e,t,i,a){const n=void 0!==a&&a.length>0,o=!1===n?i:i.concat(a),s=o[0].date,c=o[o.length-1].date;let r,l;if(!0===n){const t=a[0].date,i=a[a.length-1].date;l=Math.min(t.getTime()+e/2,i.getTime()),r=Math.max(l-e,s.getTime())}else l=c.getTime()+t.asMilliseconds(),r=Math.max(s.getTime(),l-e);return[new Date(r),new Date(l)]},processRecordScoreResults:function(e){const t=[];return Object(u.each)(e,((e,i)=>{t.push({date:new Date(+i),score:e.score})})),t},processMetricPlotResults:p,processForecastResults:h,findChartPointForAnomalyTime:j,processDataForFocusAnomalies:T,findChartPointForScheduledEvent:y,processScheduledEventsForChart:S,getFocusData:function(e,a,o,r,u,d,g,b,O){const j=void 0!==O?n.b.toES(O):O;return Object(l.forkJoin)([v.getMetricData(b,a,d,g.min.valueOf(),g.max.valueOf(),o.asMilliseconds(),j),t.results.getAnomalyRecords$([b.job_id],e,0,g.min.valueOf(),g.max.valueOf(),o.expression,O),i.getScheduledEventsByBucket([b.job_id],g.min.valueOf(),g.max.valueOf(),o.asMilliseconds(),1,_.c),t.annotations.getAnnotations$({jobIds:[b.job_id],earliestMs:g.min.valueOf(),latestMs:g.max.valueOf(),maxAnnotations:m.a,detectorIndex:a,entities:d}).pipe(Object(l.catchError)((e=>Object(l.of)({annotations:{},totalCount:0,error:Object(s.a)(e),success:!1})))),void 0!==r?(()=>{let e;const t=b.analysis_config.detectors[a],i=Object(f.s)(t.function);return u||"sum"!==i&&"count"!==i||(e={avg:"sum",max:"sum",min:"sum"}),c.getForecastData(b,a,r,d,g.min.valueOf(),g.max.valueOf(),o.asMilliseconds(),e)})():Object(l.of)(null)]).pipe(Object(l.map)((([e,t,i,a,n])=>{const s=null==t?void 0:t.records.sort(((e,t)=>e[_.d]-t[_.d])).reverse(),c=null==i?void 0:i.events[b.job_id];let r=p(e.results,u);r=T(r,s,o,u,O),r=S(r,c,o);const l={scheduledEvents:c,anomalyRecords:s,focusChartData:r};var d;return a&&(void 0!==a.error?(l.focusAnnotationError=a.error,l.focusAnnotationData=[]):l.focusAnnotationData=(null!==(d=a.annotations[b.job_id])&&void 0!==d?d:[]).sort(((e,t)=>e.timestamp-t.timestamp)).map(((e,t)=>(e.key=(t+1).toString(),e)))),n&&(l.focusForecastData=h(n.results),l.showForecastCheckbox=l.focusForecastData.length>0),l})))}}}function j(){const{services:{uiSettings:e,mlServices:{mlApiServices:t}}}=Object(p.d)(),i=Object(v.mlResultsServiceProvider)(t);return Object(a.useMemo)((()=>h(e,t,i)),[e,t,i])}}}]);