/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[76,86],{193:function(e,t,a){"use strict";var o=a(171);a.d(t,"a",(function(){return o.a}))},273:function(e,t,a){"use strict";a.r(t),a.d(t,"resolver",(function(){return m})),a.d(t,"QuickGeoJobCreator",(function(){return quick_create_job_QuickGeoJobCreator})),a.d(t,"getJobsItemsFromEmbeddable",(function(){return c})),a.d(t,"isCompatibleMapVisualization",(function(){return u})),a.d(t,"redirectToGeoJobWizard",(function(){return d})),a.d(t,"VisualizationExtractor",(function(){return visualization_extractor_VisualizationExtractor}));var o=a(5),i=a(125),l=a(154),r=a(133),s=a(136),n=a(1);async function d(e,t,a,o,i,l){var r,s,d;const{query:u,filters:b,to:j,from:m}=await c(e),g=null===(r=e.query$)||void 0===r?void 0:r.value,y=null!==(s=null===(d=e.filters$)||void 0===d?void 0:d.value)&&void 0!==s?s:[],f=l.url.locators.get(n.a),v={dashboard:{query:u,filters:b},dataViewId:t,embeddable:{query:g,filters:y},geoField:a,splitField:i,from:m,to:j,...o?{layer:{query:o}}:{}},p=await(null==f?void 0:f.getUrl({page:n.b.ANOMALY_DETECTION_CREATE_JOB_FROM_MAP,pageState:v}));window.open(p,"_blank")}function u(e){return e.getLayerList().some((e=>e.getGeoFieldNames().length&&e.getIndexPatternIds().length))}async function c(e){var t,a,i,l,r,n,d;const u=Object(s.e)(e.parentApi,"dashboard")?e.parentApi:void 0,c=null!==(t=null===(a=e.timeRange$)||void 0===a?void 0:a.value)&&void 0!==t?t:null==u||null===(i=u.timeRange$)||void 0===i?void 0:i.value;if(void 0===c)throw Error(o.i18n.translate("xpack.ml.newJob.fromGeo.createJob.error.noTimeRange",{defaultMessage:"Time range not specified."}));return{from:c.from,to:c.to,query:null!==(l=null==u||null===(r=u.query$)||void 0===r?void 0:r.value)&&void 0!==l?l:{query:"",language:"kuery"},filters:null!==(n=null==u||null===(d=u.filters$)||void 0===d?void 0:d.value)&&void 0!==n?n:[],dashboard:u}}var b=a(193),j=a(147);class quick_create_job_QuickGeoJobCreator extends b.a{constructor(e,t,a,o,i){super(e,t,a,o,i)}async createAndSaveGeoJob({jobId:e,bucketSpan:t,embeddable:a,startJob:o,runInRealTime:l,dataViewId:r,sourceDataView:s,geoField:n,splitField:d,layerLevelQuery:u}){var b,m,g,y;const{query:f,filters:v,to:p,from:x,dashboard:O}=await c(a),F=null!==(b=null===(m=a.query$)||void 0===m?void 0:m.value)&&void 0!==b?b:Object(j.d)(),w=null!==(g=null===(y=a.filters$)||void 0===y?void 0:y.value)&&void 0!==g?g:[];if(void 0===f||void 0===v)throw new Error("Cannot create job, query and filters are undefined");const{jobConfig:E,datafeedConfig:h,start:I,end:C}=await this.createGeoJob({dataViewId:r,sourceDataView:s,from:x,to:p,query:f,filters:v,embeddableQuery:F,embeddableFilters:w,layerLevelQuery:u,geoField:n,splitField:d,bucketSpan:t});return await this.putJobAndDataFeed({jobId:e,datafeedConfig:h,jobConfig:E,createdByLabel:i.a.GEO_FROM_LENS,dashboard:O,start:I,end:C,startJob:o,runInRealTime:l})}async createAndStashGeoJob(e,t,a,o,l,s,n,d,u=null,c){try{const{jobConfig:b,datafeedConfig:j,start:m,end:g,includeTimeRange:y}=await this.createGeoJob({dataViewId:e,from:t,to:a,query:o,filters:l,embeddableQuery:s,embeddableFilters:n,geoField:d,splitField:u,layerLevelQuery:c});Object(r.n)({jobConfig:b,datafeedConfig:j,createdBy:i.a.GEO,start:m,end:g},!0,y,!y)}catch(e){console.error(e)}}async createGeoJob({dataViewId:e,sourceDataView:t,from:a,to:i,query:l,filters:r,embeddableQuery:s,embeddableFilters:n,layerLevelQuery:d,geoField:u,splitField:c,bucketSpan:b}){const{jobConfig:j,datafeedConfig:m,jobType:g}=await this.createGeoJobFromMapEmbeddable({sourceDataView:t,dataViewId:e,dashboard:{query:l,filters:r},embeddable:{query:s,filters:n},layerLevelQuery:d,geoField:u,splitField:c,...b?{bucketSpan:b}:{}});let y,f,v=!0;try{const{min:e,max:t}=this.timeFilter.calculateBounds({to:i,from:a});if(y=null==e?void 0:e.valueOf(),f=null==t?void 0:t.valueOf(),void 0===y||void 0===f||isNaN(y)||isNaN(f))throw Error(o.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeRange",{defaultMessage:"Incompatible time range"}))}catch(e){console.error(e),v=!1,y=void 0,f=void 0}return{jobConfig:j,datafeedConfig:m,jobType:g,start:y,end:f,includeTimeRange:v}}async createGeoJobFromMapEmbeddable({sourceDataView:e,dataViewId:t,dashboard:a,embeddable:o,layerLevelQuery:r,bucketSpan:s,geoField:n,splitField:d}){const u=e||await this.dataViews.get(t,!0),c=Object(l.c)(),b=Object(l.b)(u.getIndexPattern()),j=this.combineQueriesAndFilters(a,o,u,r?{query:r,filters:[]}:void 0);return b.query=j,c.analysis_config.detectors=[{function:"lat_long",field_name:n,...d?{partition_field_name:d}:{}}],c.data_description.time_field=u.timeFieldName,c.analysis_config.bucket_span=null!=s?s:i.b,d&&(c.analysis_config.influencers=[d]),{jobConfig:c,datafeedConfig:b,jobType:i.f.GEO}}}async function m(e,t,a,o,i,l,r,s,n){const{dataViews:d,kibanaConfig:u,timeFilter:c,dashboardService:b,mlApiServices:m}=e,g={query:Object(j.d)(),filters:[]},y=Object(j.e)(t,g),f=Object(j.e)(o,g),v=void 0!==n?Object(j.e)(n,g):g,p=Object(j.e)(i,""),x=Object(j.e)(l,null),O=Object(j.e)(a,""),F=Object(j.e)(r,""),w=Object(j.e)(s,""),E=new quick_create_job_QuickGeoJobCreator(d,u,c,b,m);await E.createAndStashGeoJob(O,F,w,y.query,y.filters,f.query,f.filters,p,x,null==v?void 0:v.query)}var g=a(102),y=a(159);class visualization_extractor_VisualizationExtractor{constructor(){}async getResultLayersFromEmbeddable(e){var t,a;const o=[],i=null!==(t=null===(a=e.dataViews)||void 0===a?void 0:a.value)&&void 0!==t?t:[],l={};return await Object(g.asyncForEach)(e.getLayerList(),(async e=>{const t=e.getGeoFieldNames().length?e.getGeoFieldNames()[0]:void 0,a=e.getIndexPatternIds().length?e.getIndexPatternIds()[0]:void 0,r=await e.getDisplayName(),s=e.getId(),n=e.getQuery();if(t&&a&&void 0===l[t]){l[t]=!0;const e=i.find((e=>e.id===a));o.push({layerId:s,layerDisplayName:r,geoField:t,dataViewId:a,dataView:e,query:n,...e?{splitFieldOptions:await this.getSplitFieldOptions(e)}:{splitFieldOptions:[]}})}})),o}async getSplitFieldOptions(e){var t;return(null!==(t=e.fields.getAll().sort(((e,t)=>e.name.localeCompare(t.name))))&&void 0!==t?t:[]).filter((e=>y.a.some((t=>{var a;return null===(a=e.esTypes)||void 0===a?void 0:a.includes(t)})))).map((e=>({label:e.name,field:e.name})))}}},874:function(e,t,a){"use strict";a.r(t),a.d(t,"showMapVisToADJobFlyout",(function(){return v}));var o=a(2),i=a.n(o),l=a(6),r=a(15),s=a(25),n=a(136),d=a(5),u=a(273),c=a(271),b=a(385);const j=({embeddable:e,layer:t,layerIndex:a})=>{var n,j,m,g;const[y,f]=Object(o.useState)(null),[v,p]=Object(o.useState)(),{services:{data:x,share:O,uiSettings:F,dashboardService:w,mlServices:{mlApiServices:E}}}=Object(c.a)(),h=Object(o.useMemo)((()=>new u.QuickGeoJobCreator(x.dataViews,F,x.query.timefilter.timefilter,w,E)),[x,F]),I=Object(o.useCallback)((()=>{Object(u.redirectToGeoJobWizard)(e,t.dataView.id,t.geoField,t.query,y,O)}),[null==t||null===(n=t.dataView)||void 0===n?void 0:n.id,e,y]),C=Object(o.useCallback)((async({jobId:a,bucketSpan:o,startJob:i,runInRealTime:l})=>{try{return await h.createAndSaveGeoJob({jobId:a,bucketSpan:o,embeddable:e,startJob:i,runInRealTime:l,sourceDataView:t.dataView,geoField:t.geoField,layerLevelQuery:t.query,splitField:y})}catch(e){var r;return console.error(e),p({text:d.i18n.translate("xpack.ml.embeddables.geoJobFlyout.jobCreationError",{defaultMessage:"Job could not be created."}),errorText:null!==(r=e.message)&&void 0!==r?r:e}),{jobCreated:{success:!1},datafeedCreated:{success:!1},jobOpened:{success:!1},datafeedStarted:{success:!1}}}}),[h,e,y]),J=Object(o.useMemo)((()=>{const e=[];return y&&e.push({label:y,field:y}),e}),[y]),S=Object(o.useCallback)((e=>{const t=e[0];f(void 0!==t?t.field:null)}),[]);return Object(l.jsx)(i.a.Fragment,null,Object(l.jsx)(b.a,{layerIndex:a,createADJob:C,createADJobInWizard:I,timeRange:null===(j=e.timeRange$)||void 0===j?void 0:j.value,incomingCreateError:v},Object(l.jsx)(i.a.Fragment,null,Object(l.jsx)(s.EuiFlexGroup,{gutterSize:"s","data-test-subj":"mlMapLayerCompatible"},Object(l.jsx)(s.EuiFlexItem,{grow:!1},Object(l.jsx)(s.EuiText,{size:"s"},Object(l.jsx)(s.EuiIcon,{type:"checkInCircleFilled",color:"success"}))),Object(l.jsx)(s.EuiFlexItem,null,Object(l.jsx)(s.EuiText,{size:"s"},Object(l.jsx)(r.FormattedMessage,{id:"xpack.ml.embeddables.geoJobFlyout.createJobCalloutTitle.multiMetric",defaultMessage:"The {geoField} field can be used to create a geo job for {sourceDataViewTitle}",values:{geoField:t.geoField,sourceDataViewTitle:null===(m=t.dataView)||void 0===m?void 0:m.getIndexPattern()}})))),null!==(g=t.splitFieldOptions)&&void 0!==g&&g.length?Object(l.jsx)(i.a.Fragment,null,Object(l.jsx)(s.EuiSpacer,{size:"m"}),Object(l.jsx)(s.EuiAccordion,{"data-test-subj":"mlGeoJobAdditionalSettingsButton",id:"additional-section",buttonContent:d.i18n.translate("xpack.ml.embeddables.geoJobFlyout.createJobCallout.splitField.title",{defaultMessage:"Optionally select a field to split the data"})},Object(l.jsx)(s.EuiFormRow,{label:Object(l.jsx)(r.FormattedMessage,{id:"xpack.ml.embeddables.geoJobFlyout.selectSplitField",defaultMessage:"Split field"})},Object(l.jsx)(s.EuiComboBox,{singleSelection:{asPlainText:!0},options:t.splitFieldOptions,selectedOptions:J,onChange:S,isClearable:!0,"data-test-subj":"mlGeoJobSplitFieldSelect"})))):null)))},m=({noDataView:e})=>Object(l.jsx)(s.EuiFlexGroup,{gutterSize:"s",color:"subdued","data-test-subj":"mlMapLayerIncompatible"},Object(l.jsx)(s.EuiFlexItem,{grow:!1},Object(l.jsx)(s.EuiText,{size:"s"},Object(l.jsx)(s.EuiIcon,{type:"error",color:"subdued"}))),Object(l.jsx)(s.EuiFlexItem,null,Object(l.jsx)(s.EuiText,{color:"subdued",size:"s"},!0===e?Object(l.jsx)(r.FormattedMessage,{id:"xpack.ml.embeddables.geoJobFlyout.noDataViewError",defaultMessage:"There is no source data view for this layer. It cannot be used to create an anomaly detection job"}):Object(l.jsx)(r.FormattedMessage,{id:"xpack.ml.embeddables.geoJobFlyout.noTimeFieldError",defaultMessage:"The source data view for this layer does not contain a timestamp field. It cannot be used to create an anomaly detection job"})))),g=({layer:e,layerIndex:t,embeddable:a})=>{var o;return Object(l.jsx)(i.a.Fragment,null,Object(l.jsx)(s.EuiSplitPanel.Outer,{grow:!0},Object(l.jsx)(s.EuiSplitPanel.Inner,null,Object(l.jsx)(s.EuiFlexGroup,{gutterSize:"s",alignItems:"center",responsive:!1},Object(l.jsx)(s.EuiFlexItem,{grow:!1},Object(l.jsx)(s.EuiIcon,{type:"tokenGeo"})),Object(l.jsx)(s.EuiFlexItem,{grow:!0},Object(l.jsx)(s.EuiText,{color:null!==(o=e.dataView)&&void 0!==o&&o.timeFieldName?"":"subdued"},Object(l.jsx)("h5",null,e.layerDisplayName))))),Object(l.jsx)(s.EuiHorizontalRule,{margin:"none"}),Object(l.jsx)(s.EuiSplitPanel.Inner,{grow:!1,color:"plain"},e.dataView&&e.dataView.timeFieldName?Object(l.jsx)(j,{embeddable:a,layer:e,layerIndex:t}):Object(l.jsx)(m,{noDataView:void 0===e.dataView}))),Object(l.jsx)(s.EuiSpacer,null))},y=({onClose:e,embeddable:t})=>{var a;const{euiTheme:d}=Object(s.useEuiTheme)(),[c,b]=Object(o.useState)([]);return Object(o.useEffect)((()=>{(new u.VisualizationExtractor).getResultLayersFromEmbeddable(t).then(b).catch((t=>{console.error("Layers could not be extracted from embeddable",t),e()}))}),[t,e]),Object(l.jsx)(i.a.Fragment,null,Object(l.jsx)(s.EuiFlyoutHeader,{hasBorder:!0},Object(l.jsx)(s.EuiTitle,{size:"s"},Object(l.jsx)("h3",null,Object(l.jsx)(r.FormattedMessage,{id:"xpack.ml.embeddables.geoJobFlyout.title",defaultMessage:"Create anomaly detection job"}))),Object(l.jsx)(s.EuiSpacer,{size:"m"}),Object(l.jsx)(s.EuiText,{size:"s"},Object(l.jsx)(r.FormattedMessage,{id:"xpack.ml.embeddables.geoJobFlyout.secondTitle",defaultMessage:"Create an anomaly detection lat_long job from map visualization {title}.",values:{title:null!==(a=Object(n.h)(t))&&void 0!==a?a:""}}))),Object(l.jsx)(s.EuiFlyoutBody,{css:Object(l.css)({backgroundColor:d.colors.lightestShade},"","")},c.map(((e,a)=>Object(l.jsx)(g,{key:`${e.layerId}`,layer:e,layerIndex:a,embeddable:t})))),Object(l.jsx)(s.EuiFlyoutFooter,null,Object(l.jsx)(s.EuiFlexGroup,{justifyContent:"spaceBetween"},Object(l.jsx)(s.EuiFlexItem,{grow:!1},Object(l.jsx)(s.EuiButtonEmpty,{iconType:"cross",onClick:e,flush:"left"},Object(l.jsx)(r.FormattedMessage,{id:"xpack.ml.embeddables.geoJobFlyout.closeButton",defaultMessage:"Close"}))))))};var f=a(384);async function v(e,t,a,o,i){return Object(f.a)((({onClose:t})=>Object(l.jsx)(y,{embeddable:e,onClose:t})),t,a,o,i)}}}]);