/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[75,85],{193:function(e,t,a){"use strict";var r=a(171);a.d(t,"a",(function(){return r.a}))},272:function(e,t,a){"use strict";a.r(t),a.d(t,"VisualizationExtractor",(function(){return visualization_extractor_VisualizationExtractor})),a.d(t,"resolver",(function(){return F})),a.d(t,"QuickLensJobCreator",(function(){return quick_create_job_QuickLensJobCreator})),a.d(t,"getJobsItemsFromEmbeddable",(function(){return y})),a.d(t,"isCompatibleVisualizationType",(function(){return j})),a.d(t,"redirectToADJobWizards",(function(){return m})),a.d(t,"getChartInfoFromVisualization",(function(){return v}));var r=a(91),n=a(5),o=a(125),i=a(136),s=a(131),l=a(830),c=a(1);const d=["line","bar","bar_stacked","bar_percentage_stacked","bar_horizontal","bar_horizontal_stacked","area","area_stacked","area_percentage_stacked"],u=r.layerTypes.DATA,b="lnsXY",f=[s.b.STRING,s.b.IP];async function m(e,t,a,r){const{query:n,filters:o,to:i,from:s,vis:l}=await y(e,r),d=a.url.locators.get(c.a),u=await(null==d?void 0:d.getUrl({page:c.b.ANOMALY_DETECTION_CREATE_JOB_FROM_LENS,pageState:{vis:l,from:s,to:i,query:n,filters:o,layerIndex:t}}));window.open(u,"_blank")}async function y(e,t){var a,r,o,s,l,c,d;if(!t)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.lensNotFound",{defaultMessage:"Lens is not intialized"}));const u=Object(i.e)(e.parentApi,"dashboard")?e.parentApi:void 0,b=null!==(a=null===(r=e.timeRange$)||void 0===r?void 0:r.value)&&void 0!==a?a:null==u||null===(o=u.timeRange$)||void 0===o?void 0:o.value;if(void 0===b)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noTimeRange",{defaultMessage:"Time range not specified."}));const f=e.getSavedVis();if(void 0===f)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.visNotFound",{defaultMessage:"Visualization cannot be found."}));return{vis:f,chartInfo:await v(t,f),from:b.from,to:b.to,query:null!==(s=null==u||null===(l=u.query$)||void 0===l?void 0:l.value)&&void 0!==s?s:{query:"",language:"kuery"},filters:null!==(c=null==u||null===(d=u.filters$)||void 0===d?void 0:d.value)&&void 0!==c?c:[],dashboard:u}}function p(e){const t=function(e){switch(e){case"average":return l.b.MEAN;case"count":return l.b.COUNT;case"max":return l.b.MAX;case"median":return l.b.MEDIAN;case"min":return l.b.MIN;case"sum":return l.b.SUM;case"unique_count":return l.b.DISTINCT_COUNT;default:return null}}(e);if(null===t)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.incorrectFunction",{defaultMessage:"Selected function {operationType} is not supported by anomaly detection detectors",values:{operationType:e}}));return t}async function j(e){return e.visualizationType===b&&void 0===e.query.esql&&e.layers.some((e=>e.layerType===r.layerTypes.DATA&&void 0!==e.dataView))}function x(e){return e.layerType===u&&e.chartType&&d.includes(e.chartType)}function g(e,t){return e.map((({operation:e})=>{var a,r;const n=p(e.type);return{function:n,..."count"===n?{}:{field_name:null===(a=e.fields)||void 0===a?void 0:a[0]},...t?{partition_field_name:null===(r=t.operation.fields)||void 0===r?void 0:r[0]}:{}}}))}async function v(e,t){const a=await(await(await e.stateHelperApi()).chartInfo).getChartInfo(t);if(!a)throw new Error("Cannot create job, chart info is undefined");return a}class visualization_extractor_VisualizationExtractor{constructor(){}async getResultLayersFromEmbeddable(e,t){const{chartInfo:a}=await y(e,t);return this.getLayers(a,t)}async extractFields(e){var t;if(!x(e))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.incompatibleLayerType",{defaultMessage:"Layer is incompatible. Only chart layers can be used."}));const a=e.dimensions.find((e=>{var t;return"date"===(null===(t=e.operation)||void 0===t?void 0:t.dataType)}));if(void 0===a||null===(t=a.operation.fields)||void 0===t||!t.length)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noDateField",{defaultMessage:"Cannot find a date field."}));const r=e.dimensions.filter((e=>"metric"===e.role));!function(e){if(e.forEach((e=>"date"!==e.operation.dataType&&p(e.operation.type))),e.some((e=>{var t;return!(null!==(t=e.operation.fields)&&void 0!==t&&t.length)})))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.colsNoSourceField",{defaultMessage:"Some columns do not contain a source field."}));if(e.some((e=>function(e){return e.operation.hasTimeShift||e.operation.filter}(e))))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.colsUsingFilterTimeSift",{defaultMessage:"Columns contain settings which are incompatible with ML detectors, time shift and filter by are not supported."}))}(r);const o=e.dimensions.find((e=>"split"===e.role&&"breakdown"===e.dimensionType));if(o&&"terms"===o.operation.type&&o.operation.fields&&o.operation.fields.length>1)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.splitFieldHasMultipleFields",{defaultMessage:"Selected split field contains more than one field."}));if(o&&(i=o,!f.includes(i.operation.dataType)))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.splitFieldMustBeString",{defaultMessage:"Selected split field type must be string."}));var i;if(!e.dataView)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noDataViews",{defaultMessage:"No data views can be found in the visualization."}));if(a.operation.fields[0]!==e.dataView.timeFieldName)throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeFieldNotInDataView",{defaultMessage:"Selected time field must be the default time field configured for data view."}));return{fields:r,timeField:a,splitField:o,dataView:e.dataView}}async getLayers(e,t){const a=await async function(e){const t=await e.getXyVisTypes();return e=>{var a;switch(e.layerType){case r.layerTypes.DATA:const o=t.find((t=>t.id===e.chartType));return{label:(null==o?void 0:o.fullLabel)||(null==o?void 0:o.label)||e.layerType,icon:null!==(a=null==o?void 0:o.icon)&&void 0!==a?a:""};case r.layerTypes.ANNOTATIONS:return{label:n.i18n.translate("xpack.ml.newJob.fromLens.createJob.VisType.annotations",{defaultMessage:"Annotations"}),icon:""};case r.layerTypes.REFERENCELINE:return{label:n.i18n.translate("xpack.ml.newJob.fromLens.createJob.VisType.referenceLine",{defaultMessage:"Reference line"}),icon:""};default:return{label:e.layerType,icon:""}}}}(t);return await Promise.all(e.layers.filter((({layerType:e})=>e===r.layerTypes.DATA)).map((async e=>{const{icon:t,label:r}=a(e);try{const{fields:a,splitField:n}=await this.extractFields(e),i=g(a,n),s=n||i.length>1?o.f.MULTI_METRIC:o.f.SINGLE_METRIC;return{id:e.layerId,layerType:e.layerType,label:r,icon:t,jobType:s,isCompatible:!0}}catch(a){return{id:e.layerId,layerType:e.layerType,label:r,icon:t,jobType:null,isCompatible:!1,error:a}}})))}}var T=a(31),w=a.n(T),E=a(154),h=a(133),O=a(193);class quick_create_job_QuickLensJobCreator extends O.a{constructor(e,t,a,r,n,o){super(t,a,r,n,o),this.lens=e}async createAndSaveJob(e,t,a,r,n,i){const{query:s,filters:l,to:c,from:d,dashboard:u,chartInfo:b}=await y(a,this.lens);if(void 0===s||void 0===l)throw new Error("Cannot create job, query and filters are undefined");const{jobConfig:f,datafeedConfig:m,start:p,end:j,jobType:x}=await this.createJob(b,d,c,s,l,t,i),g=x===o.f.SINGLE_METRIC?o.a.SINGLE_METRIC_FROM_LENS:o.a.MULTI_METRIC_FROM_LENS;return await this.putJobAndDataFeed({jobId:e,datafeedConfig:m,jobConfig:f,createdByLabel:g,dashboard:u,start:p,end:j,startJob:r,runInRealTime:n})}async createAndStashADJob(e,t,a,r,n,i){const s=await v(this.lens,e);try{const{jobConfig:e,datafeedConfig:l,jobType:c,start:d,end:u,includeTimeRange:b}=await this.createJob(s,t,a,r,n,o.b,i);Object(h.n)({jobConfig:e,datafeedConfig:l,createdBy:c===o.f.SINGLE_METRIC?o.a.SINGLE_METRIC:o.a.MULTI_METRIC,start:d,end:u},!0,b,!b)}catch(e){console.error(e)}}async createJob(e,t,a,r,o,i,s){const{jobConfig:l,datafeedConfig:c,jobType:d}=await this.createADJobFromLensSavedObject(e,r,o,i,s);let u,b,f=!0;try{const{min:e,max:r}=this.timeFilter.calculateBounds({to:a,from:t});if(u=null==e?void 0:e.valueOf(),b=null==r?void 0:r.valueOf(),void 0===u||void 0===b||isNaN(u)||isNaN(b))throw Error(n.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeRange",{defaultMessage:"Incompatible time range"}))}catch(e){console.error(e),f=!1,u=void 0,b=void 0}return{jobConfig:l,datafeedConfig:c,jobType:d,start:u,end:b,includeTimeRange:f}}async createADJobFromLensSavedObject(e,t,a,r,n){var i;const s=e.layers.filter(x),l=void 0!==n?e.layers[n]:s[0],c=new visualization_extractor_VisualizationExtractor,{fields:d,timeField:u,splitField:b,dataView:f}=await c.extractFields(l),m=Object(E.c)(),y=Object(E.b)(f.getIndexPattern()),p=this.combineQueriesAndFilters({query:t,filters:a},{query:e.query,filters:e.filters},f);y.query=p,m.analysis_config.detectors=g(d,b),m.data_description.time_field=null===(i=u.operation.fields)||void 0===i?void 0:i[0],m.analysis_config.bucket_span=r,b&&b.operation.fields&&(m.analysis_config.influencers=[b.operation.fields[0]]);const j=!b&&1===m.analysis_config.detectors.length,v=j?o.f.SINGLE_METRIC:o.f.MULTI_METRIC;return j&&(m.model_plot_config={enabled:!0,annotations_enabled:!0}),{jobConfig:m,datafeedConfig:y,jobType:v}}}var I=a(147);async function F(e,t,a,r,n,o,i){const{dataViews:s,lens:l,mlApiServices:c,timeFilter:d,kibanaConfig:u,dashboardService:b}=e;if(void 0===t)throw new Error("Cannot create visualization");const f=w.a.decode(t);if(!f)throw new Error("Cannot create visualization");const m=Object(I.e)(n,Object(I.d)()),y=Object(I.e)(o,[]),p=Object(I.e)(a,""),j=Object(I.e)(r,""),x=Object(I.e)(i,void 0),g=new quick_create_job_QuickLensJobCreator(l,s,u,d,b,c);await g.createAndStashADJob(f,p,j,m,y,x)}},872:function(e,t,a){"use strict";a.r(t),a.d(t,"showLensVisToADJobFlyout",(function(){return g}));var r=a(2),n=a.n(r),o=a(384),i=a(15),s=a(25),l=a(136),c=a(272),d=a(125),u=a(271),b=a(385),f=a(6);const m=({layer:e,layerIndex:t,embeddable:a})=>{var o;const{services:{data:l,share:m,uiSettings:y,mlServices:{mlApiServices:p},lens:j,dashboardService:x}}=Object(u.a)(),g=Object(r.useMemo)((()=>new c.QuickLensJobCreator(j,l.dataViews,y,l.query.timefilter.timefilter,x,p)),[l,y]);return Object(f.jsx)(n.a.Fragment,null,Object(f.jsx)(b.a,{createADJob:async function({jobId:e,bucketSpan:r,startJob:n,runInRealTime:o}){return await g.createAndSaveJob(e,r,a,n,o,t)},createADJobInWizard:function(){Object(c.redirectToADJobWizards)(a,t,m,j)},timeRange:null===(o=a.timeRange$)||void 0===o?void 0:o.value,layer:e,layerIndex:t},Object(f.jsx)(s.EuiFlexGroup,{gutterSize:"s","data-test-subj":"mlLensLayerCompatible"},Object(f.jsx)(s.EuiFlexItem,{grow:!1},Object(f.jsx)(s.EuiText,{size:"s"},Object(f.jsx)(s.EuiIcon,{type:"checkInCircleFilled",color:"success"}))),Object(f.jsx)(s.EuiFlexItem,null,Object(f.jsx)(s.EuiText,{size:"s"},e.jobType===d.f.MULTI_METRIC?Object(f.jsx)(i.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.createJobCalloutTitle.multiMetric",defaultMessage:"This layer can be used to create a multi-metric job"}):Object(f.jsx)(i.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.createJobCalloutTitle.singleMetric",defaultMessage:"This layer can be used to create a single metric job"}))))))};var y=a(322);const p=({layer:e})=>Object(f.jsx)(s.EuiFlexGroup,{gutterSize:"s",color:"subdued","data-test-subj":"mlLensLayerIncompatible"},Object(f.jsx)(s.EuiFlexItem,{grow:!1},Object(f.jsx)(s.EuiText,{size:"s"},Object(f.jsx)(s.EuiIcon,{type:"error",color:"subdued"}))),Object(f.jsx)(s.EuiFlexItem,null,Object(f.jsx)(s.EuiText,{color:"subdued",size:"s"},e.error?Object(y.a)(e.error):Object(f.jsx)(i.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.defaultLayerError",defaultMessage:"This layer cannot be used to create an anomaly detection job"})))),j=({layer:e,layerIndex:t,embeddable:a})=>Object(f.jsx)(n.a.Fragment,null,Object(f.jsx)(s.EuiSplitPanel.Outer,{grow:!0},Object(f.jsx)(s.EuiSplitPanel.Inner,null,Object(f.jsx)(s.EuiFlexGroup,{gutterSize:"s",alignItems:"center",responsive:!1},e.icon&&Object(f.jsx)(s.EuiFlexItem,{grow:!1},Object(f.jsx)(s.EuiIcon,{type:e.icon})),Object(f.jsx)(s.EuiFlexItem,{grow:!0},Object(f.jsx)(s.EuiText,{color:e.isCompatible?"":"subdued"},Object(f.jsx)("h5",null,e.label))))),Object(f.jsx)(s.EuiHorizontalRule,{margin:"none"}),Object(f.jsx)(s.EuiSplitPanel.Inner,{grow:!1,color:"plain"},e.isCompatible?Object(f.jsx)(m,{layer:e,layerIndex:t,embeddable:a}):Object(f.jsx)(p,{layer:e}))),Object(f.jsx)(s.EuiSpacer,null)),x=({onClose:e,embeddable:t})=>{var a;const{services:{data:o,lens:d}}=Object(u.a)(),[b,m]=Object(r.useState)([]);return Object(r.useEffect)((()=>{(new c.VisualizationExtractor).getResultLayersFromEmbeddable(t,d).then(m).catch((t=>{console.error("Layers could not be extracted from embeddable",t),e()}))}),[o,d,t]),Object(f.jsx)(n.a.Fragment,null,Object(f.jsx)(s.EuiFlyoutHeader,{hasBorder:!0},Object(f.jsx)(s.EuiTitle,{size:"s"},Object(f.jsx)("h3",null,Object(f.jsx)(i.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.title",defaultMessage:"Create anomaly detection job"}))),Object(f.jsx)(s.EuiSpacer,{size:"m"}),Object(f.jsx)(s.EuiText,{size:"s"},Object(f.jsx)(i.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.secondTitle",defaultMessage:"Select a compatible layer from the visualization {title} to create an anomaly detection job.",values:{title:null!==(a=Object(l.h)(t))&&void 0!==a?a:""}}))),Object(f.jsx)(s.EuiFlyoutBody,null,b.map(((e,a)=>Object(f.jsx)(j,{layer:e,layerIndex:a,key:e.id,embeddable:t})))),Object(f.jsx)(s.EuiFlyoutFooter,null,Object(f.jsx)(s.EuiFlexGroup,{justifyContent:"spaceBetween"},Object(f.jsx)(s.EuiFlexItem,{grow:!1},Object(f.jsx)(s.EuiButtonEmpty,{iconType:"cross",onClick:e,flush:"left"},Object(f.jsx)(i.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.closeButton",defaultMessage:"Close"}))))))};async function g(e,t,a,r,n,i){return Object(o.a)((({onClose:t})=>Object(f.jsx)(x,{embeddable:e,onClose:t})),t,a,r,n,i)}}}]);