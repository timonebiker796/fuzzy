/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[86],{193:function(e,t,a){"use strict";var i=a(171);a.d(t,"a",(function(){return i.a}))},273:function(e,t,a){"use strict";a.r(t),a.d(t,"resolver",(function(){return v})),a.d(t,"QuickGeoJobCreator",(function(){return quick_create_job_QuickGeoJobCreator})),a.d(t,"getJobsItemsFromEmbeddable",(function(){return c})),a.d(t,"isCompatibleMapVisualization",(function(){return u})),a.d(t,"redirectToGeoJobWizard",(function(){return s})),a.d(t,"VisualizationExtractor",(function(){return visualization_extractor_VisualizationExtractor}));var i=a(5),o=a(125),r=a(154),n=a(133),l=a(136),d=a(1);async function s(e,t,a,i,o,r){var n,l,s;const{query:u,filters:b,to:f,from:v}=await c(e),m=null===(n=e.query$)||void 0===n?void 0:n.value,y=null!==(l=null===(s=e.filters$)||void 0===s?void 0:s.value)&&void 0!==l?l:[],g=r.url.locators.get(d.a),p={dashboard:{query:u,filters:b},dataViewId:t,embeddable:{query:m,filters:y},geoField:a,splitField:o,from:v,to:f,...i?{layer:{query:i}}:{}},w=await(null==g?void 0:g.getUrl({page:d.b.ANOMALY_DETECTION_CREATE_JOB_FROM_MAP,pageState:p}));window.open(w,"_blank")}function u(e){return e.getLayerList().some((e=>e.getGeoFieldNames().length&&e.getIndexPatternIds().length))}async function c(e){var t,a,o,r,n,d,s;const u=Object(l.e)(e.parentApi,"dashboard")?e.parentApi:void 0,c=null!==(t=null===(a=e.timeRange$)||void 0===a?void 0:a.value)&&void 0!==t?t:null==u||null===(o=u.timeRange$)||void 0===o?void 0:o.value;if(void 0===c)throw Error(i.i18n.translate("xpack.ml.newJob.fromGeo.createJob.error.noTimeRange",{defaultMessage:"Time range not specified."}));return{from:c.from,to:c.to,query:null!==(r=null==u||null===(n=u.query$)||void 0===n?void 0:n.value)&&void 0!==r?r:{query:"",language:"kuery"},filters:null!==(d=null==u||null===(s=u.filters$)||void 0===s?void 0:s.value)&&void 0!==d?d:[],dashboard:u}}var b=a(193),f=a(147);class quick_create_job_QuickGeoJobCreator extends b.a{constructor(e,t,a,i,o){super(e,t,a,i,o)}async createAndSaveGeoJob({jobId:e,bucketSpan:t,embeddable:a,startJob:i,runInRealTime:r,dataViewId:n,sourceDataView:l,geoField:d,splitField:s,layerLevelQuery:u}){var b,v,m,y;const{query:g,filters:p,to:w,from:F,dashboard:_}=await c(a),j=null!==(b=null===(v=a.query$)||void 0===v?void 0:v.value)&&void 0!==b?b:Object(f.d)(),h=null!==(m=null===(y=a.filters$)||void 0===y?void 0:y.value)&&void 0!==m?m:[];if(void 0===g||void 0===p)throw new Error("Cannot create job, query and filters are undefined");const{jobConfig:O,datafeedConfig:q,start:C,end:I}=await this.createGeoJob({dataViewId:n,sourceDataView:l,from:F,to:w,query:g,filters:p,embeddableQuery:j,embeddableFilters:h,layerLevelQuery:u,geoField:d,splitField:s,bucketSpan:t});return await this.putJobAndDataFeed({jobId:e,datafeedConfig:q,jobConfig:O,createdByLabel:o.a.GEO_FROM_LENS,dashboard:_,start:C,end:I,startJob:i,runInRealTime:r})}async createAndStashGeoJob(e,t,a,i,r,l,d,s,u=null,c){try{const{jobConfig:b,datafeedConfig:f,start:v,end:m,includeTimeRange:y}=await this.createGeoJob({dataViewId:e,from:t,to:a,query:i,filters:r,embeddableQuery:l,embeddableFilters:d,geoField:s,splitField:u,layerLevelQuery:c});Object(n.n)({jobConfig:b,datafeedConfig:f,createdBy:o.a.GEO,start:v,end:m},!0,y,!y)}catch(e){console.error(e)}}async createGeoJob({dataViewId:e,sourceDataView:t,from:a,to:o,query:r,filters:n,embeddableQuery:l,embeddableFilters:d,layerLevelQuery:s,geoField:u,splitField:c,bucketSpan:b}){const{jobConfig:f,datafeedConfig:v,jobType:m}=await this.createGeoJobFromMapEmbeddable({sourceDataView:t,dataViewId:e,dashboard:{query:r,filters:n},embeddable:{query:l,filters:d},layerLevelQuery:s,geoField:u,splitField:c,...b?{bucketSpan:b}:{}});let y,g,p=!0;try{const{min:e,max:t}=this.timeFilter.calculateBounds({to:o,from:a});if(y=null==e?void 0:e.valueOf(),g=null==t?void 0:t.valueOf(),void 0===y||void 0===g||isNaN(y)||isNaN(g))throw Error(i.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeRange",{defaultMessage:"Incompatible time range"}))}catch(e){console.error(e),p=!1,y=void 0,g=void 0}return{jobConfig:f,datafeedConfig:v,jobType:m,start:y,end:g,includeTimeRange:p}}async createGeoJobFromMapEmbeddable({sourceDataView:e,dataViewId:t,dashboard:a,embeddable:i,layerLevelQuery:n,bucketSpan:l,geoField:d,splitField:s}){const u=e||await this.dataViews.get(t,!0),c=Object(r.c)(),b=Object(r.b)(u.getIndexPattern()),f=this.combineQueriesAndFilters(a,i,u,n?{query:n,filters:[]}:void 0);return b.query=f,c.analysis_config.detectors=[{function:"lat_long",field_name:d,...s?{partition_field_name:s}:{}}],c.data_description.time_field=u.timeFieldName,c.analysis_config.bucket_span=null!=l?l:o.b,s&&(c.analysis_config.influencers=[s]),{jobConfig:c,datafeedConfig:b,jobType:o.f.GEO}}}async function v(e,t,a,i,o,r,n,l,d){const{dataViews:s,kibanaConfig:u,timeFilter:c,dashboardService:b,mlApiServices:v}=e,m={query:Object(f.d)(),filters:[]},y=Object(f.e)(t,m),g=Object(f.e)(i,m),p=void 0!==d?Object(f.e)(d,m):m,w=Object(f.e)(o,""),F=Object(f.e)(r,null),_=Object(f.e)(a,""),j=Object(f.e)(n,""),h=Object(f.e)(l,""),O=new quick_create_job_QuickGeoJobCreator(s,u,c,b,v);await O.createAndStashGeoJob(_,j,h,y.query,y.filters,g.query,g.filters,w,F,null==p?void 0:p.query)}var m=a(102),y=a(159);class visualization_extractor_VisualizationExtractor{constructor(){}async getResultLayersFromEmbeddable(e){var t,a;const i=[],o=null!==(t=null===(a=e.dataViews)||void 0===a?void 0:a.value)&&void 0!==t?t:[],r={};return await Object(m.asyncForEach)(e.getLayerList(),(async e=>{const t=e.getGeoFieldNames().length?e.getGeoFieldNames()[0]:void 0,a=e.getIndexPatternIds().length?e.getIndexPatternIds()[0]:void 0,n=await e.getDisplayName(),l=e.getId(),d=e.getQuery();if(t&&a&&void 0===r[t]){r[t]=!0;const e=o.find((e=>e.id===a));i.push({layerId:l,layerDisplayName:n,geoField:t,dataViewId:a,dataView:e,query:d,...e?{splitFieldOptions:await this.getSplitFieldOptions(e)}:{splitFieldOptions:[]}})}})),i}async getSplitFieldOptions(e){var t;return(null!==(t=e.fields.getAll().sort(((e,t)=>e.name.localeCompare(t.name))))&&void 0!==t?t:[]).filter((e=>y.a.some((t=>{var a;return null===(a=e.esTypes)||void 0===a?void 0:a.includes(t)})))).map((e=>({label:e.name,field:e.name})))}}}}]);