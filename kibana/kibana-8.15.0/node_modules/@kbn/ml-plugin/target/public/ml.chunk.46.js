/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[46,33,66],{132:function(e,t,n){"use strict";n.d(t,"c",(function(){return r})),n.d(t,"d",(function(){return o})),n.d(t,"h",(function(){return i})),n.d(t,"b",(function(){return s})),n.d(t,"e",(function(){return l})),n.d(t,"f",(function(){return c})),n.d(t,"j",(function(){return u})),n.d(t,"g",(function(){return d})),n.d(t,"a",(function(){return p})),n.d(t,"i",(function(){return m}));var a=n(5);const r={CLEAR_EXPLORER_DATA:"clearExplorerData",CLEAR_INFLUENCER_FILTER_SETTINGS:"clearInfluencerFilterSettings",CLEAR_JOBS:"clearJobs",JOB_SELECTION_CHANGE:"jobSelectionChange",SET_CHARTS_DATA_LOADING:"setChartsDataLoading",SET_EXPLORER_DATA:"setExplorerData"},o={ADD:"+",REMOVE:"-"},i={OVERALL:"overall",VIEW_BY:"viewBy"},s={EVENT_DISTRIBUTION:"event_distribution",POPULATION_DISTRIBUTION:"population_distribution",SINGLE_METRIC:"single_metric",GEO_MAP:"geo_map"},l=10,c=10,u=a.i18n.translate("xpack.ml.explorer.jobIdLabel",{defaultMessage:"job ID"}),d=a.i18n.translate("xpack.ml.explorer.overallLabel",{defaultMessage:"Overall"}),p=1e3,m=10},139:function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"d",(function(){return A})),n.d(t,"n",(function(){return v})),n.d(t,"g",(function(){return O})),n.d(t,"f",(function(){return S})),n.d(t,"k",(function(){return E})),n.d(t,"i",(function(){return j})),n.d(t,"j",(function(){return C})),n.d(t,"o",(function(){return I})),n.d(t,"l",(function(){return L})),n.d(t,"m",(function(){return T})),n.d(t,"p",(function(){return M})),n.d(t,"c",(function(){return N})),n.d(t,"b",(function(){return x})),n.d(t,"h",(function(){return w})),n.d(t,"q",(function(){return P})),n.d(t,"e",(function(){return F}));var a=n(8),r=n(83),o=n.n(r),i=n(7),s=n(131),l=n(37),c=n(322),u=n(252),d=n(830),p=n(162),m=n(123),f=n(40),y=n(11),_=n(73),b=n(17),g=n(132);function h(e){return e.map((e=>{var t;const n=Object(f.a)(e.analysis_config.bucket_span);return{id:e.job_id,selected:!1,bucketSpanSeconds:n.asSeconds(),isSingleMetricViewerJob:Object(m.r)(e),sourceIndices:e.datafeed_config.indices,modelPlotEnabled:!0===(null===(t=e.model_plot_config)||void 0===t?void 0:t.enabled)}}))}function A(){return{selectedCells:void 0}}async function v(e,t,n,r,o,i,s,l){const c={};i.forEach((e=>{const t=e.fieldName;void 0===c[e.fieldName]&&(c[e.fieldName]=[]),c[t].push(e.fieldValue)})),o.forEach((e=>{(e.influencers||[]).forEach((e=>{const t=e.influencer_field_name,n=e.influencer_field_values;void 0===c[t]&&(c[t]=[]),c[t].push(...n)}))}));const u={};Object.keys(c).forEach((e=>{const t=c[e];u[e]=Object(a.uniq)(t)}));const d=[];return Object.keys(u).forEach((e=>{void 0!==i.find((t=>t.fieldName===e))?d.push(...i):u[e].forEach((t=>{d.push({fieldName:e,fieldValue:t})}))})),await M(e,t,n,r,d,s,l)}function O(e){const t=[];return e.forEach((e=>{const n=_.mlJobService.getJob(e.id);void 0!==n&&n.analysis_config&&n.analysis_config.influencers&&t.push(...n.analysis_config.influencers)})),t}function S(){const e=Object(b.g)().get("dateFormat:tz");return"Browser"!==e?e:o.a.tz.guess()}function E(e,t){const n=t;let a=n.min.valueOf(),r=n.max.valueOf();return void 0!==(null==e?void 0:e.times)&&(a=void 0!==e.times[0]?1e3*e.times[0]:n.min.valueOf(),r=n.max.valueOf(),void 0!==e.times[1]&&(r=1e3*e.times[1]-1)),{earliestMs:a,latestMs:r}}function j(e,t){return e&&e.type!==g.h.OVERALL&&void 0!==e.viewByFieldName&&e.viewByFieldName!==g.j?e.lanes.map((e=>({fieldName:t,fieldValue:e}))):[]}function C(e,t){return e&&e.type!==g.h.OVERALL&&void 0!==e.viewByFieldName&&e.viewByFieldName===g.j?e.lanes:t.map((e=>e.id))}function I(e,t){const n=e.map((e=>e.id)),a=E(void 0,t);return new Promise((e=>{Object(i.lastValueFrom)(y.ml.annotations.getAnnotations$({jobIds:n,earliestMs:a.earliestMs,latestMs:a.latestMs,maxAnnotations:p.a})).then((t=>{if(void 0!==t.error||void 0===t.annotations){const n=Object(c.a)(t.error);return e({annotationsData:[],error:""!==n?n:void 0})}const a=[];return n.forEach((e=>{const n=t.annotations[e];void 0!==n&&a.push(...n)})),e({annotationsData:a.sort(((e,t)=>e.timestamp-t.timestamp)).map(((e,t)=>(e.key=(t+1).toString(),e)))})})).catch((t=>{const n=Object(c.a)(t);return e({annotationsData:[],error:""!==n?n:void 0})}))}))}function L(e,t,n){const a=C(e,t),r=E(e,n);return new Promise((e=>{Object(i.lastValueFrom)(y.ml.annotations.getAnnotations$({jobIds:a,earliestMs:r.earliestMs,latestMs:r.latestMs,maxAnnotations:p.a})).then((t=>{if(void 0!==t.error||void 0===t.annotations){const n=Object(c.a)(t.error);return e({annotationsData:[],totalCount:0,error:""!==n?n:void 0})}const n=[];return a.forEach((e=>{const a=t.annotations[e];void 0!==a&&n.push(...a)})),e({annotationsData:n.sort(((e,t)=>e.timestamp-t.timestamp)).map(((e,t)=>(e.key=(t+1).toString(),e))),totalCount:t.totalCount})})).catch((t=>{const n=Object(c.a)(t);return e({annotationsData:[],totalCount:0,error:""!==n?n:void 0})}))}))}async function T(e,t,n,r,o,i,s,l){const c=C(e,t),f=j(e,o),b=E(e,r);return new Promise(((e,t)=>{y.ml.results.getAnomaliesTableData(c,[],f,i,s,b.earliestMs,b.latestMs,n,p.b,g.e,l).toPromise().then((t=>{const n=t.anomalies,r=_.mlJobService.detectorsByJob;n.forEach((e=>{const t=e.jobId,n=Object(a.get)(r,[t,e.detectorIndex]);e.detector=Object(a.get)(n,["detector_description"],e.source.function_description),void 0!==n&&void 0!==n.custom_rules&&(e.rulesLength=n.custom_rules.length);const o=_.mlJobService.getJob(t);let i=Object(m.p)(o,e.detectorIndex);if(!1===i&&Object(m.n)(o,e.detectorIndex)){const t=Object(u.d)(e.source);i=Object(m.o)(o,e.detectorIndex,t)}e.isTimeSeriesViewRecord=i,e.isGeoRecord=void 0!==n&&n.function===d.b.LAT_LONG,void 0!==_.mlJobService.customUrlsByJob[t]&&(e.customUrls=_.mlJobService.customUrlsByJob[t])})),e({anomalies:n,interval:t.interval,examplesByJobId:t.examplesByJobId,showViewSeriesLink:!0,jobIds:c})})).catch((e=>{console.log("Explorer - error loading data for anomalies table:",e),t()}))}))}async function M(e,t,n,a,r,o,i){return new Promise((s=>{!0!==o?e.getTopInfluencers(t,n,a,g.f,10,1,r,i).then((e=>{s(e.influencers)})):s({})}))}function R(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function N(e){return e.replace(/[()]/g,"\\$&")}function x(e){return e.replace(/[\\"]/g,"\\$&")}function w(e,t){const n=R(e),a=R(t);return new RegExp(`(${n})\\s?:\\s?(")?(${a})(")?`,"i")}function P(e,t,n){let a="";const r=w(t,n);return a=e.replace(r,""),a=a.replace(/\s+(and|or)\s+(and|or)\s+/gi," $1 "),a=a.replace(/\s(and|or)\s*$/gi,""),a=a.replace(/^\s*(and|or)\s/gi,""),a}async function F(e,t,n){const a={},r=new Map;if(Array.isArray(e))for(const c of e){let e,u;if(i=c,Object(l.a)(i)&&"string"==typeof i.id&&void 0!==i.selected&&void 0!==i.bucketSpanSeconds?(e=c.sourceIndices,u=c.id):(e=c.datafeed_config.indices,u=c.job_id),Array.isArray(e))for(const i of e){var o;const e=r.get(i),l=null!==(o=null==e?void 0:e.id)&&void 0!==o?o:await n.getDataViewIdFromName(i);if(l){const n=null!=e?e:await t.get(l);if(!n)continue;r.set(i,n);const o=[...n.fields.getByType(s.a.GEO_POINT),...n.fields.getByType(s.a.GEO_SHAPE)];o.length>0&&(void 0===a[u]&&(a[u]={[i]:{geoFields:[],dataViewId:l}}),a[u][i].geoFields.push(...o.map((e=>e.name))))}}}var i;return{sourceIndicesWithGeoFieldsMap:a,dataViews:[...r.values()]}}},140:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));let a=function(e){return e[e.CRITICAL=75]="CRITICAL",e[e.MAJOR=50]="MAJOR",e[e.MINOR=25]="MINOR",e[e.WARNING=3]="WARNING",e[e.LOW=0]="LOW",e}({})},150:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var a=n(33),r=n(203);const o=[a.euiDarkVars.euiColorVis0,a.euiDarkVars.euiColorVis1,a.euiDarkVars.euiColorVis2,a.euiDarkVars.euiColorVis3,a.euiDarkVars.euiColorVis4,a.euiDarkVars.euiColorVis5,a.euiDarkVars.euiColorVis6,a.euiDarkVars.euiColorVis7,a.euiDarkVars.euiColorVis8,a.euiDarkVars.euiColorVis9,a.euiDarkVars.euiColorDarkShade,a.euiDarkVars.euiColorPrimary],i={};function s(e){if(void 0===i[e]){const t=Object(r.a)(e),n=o[t%o.length];return i[e]=n,n}return i[e]}},162:function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return r}));const a=500,r=500},173:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var a=n(5),r=n(174);const o={critical:{id:r.a.CRITICAL,label:a.i18n.translate("xpack.ml.anomalyUtils.severity.criticalLabel",{defaultMessage:"critical"})},major:{id:r.a.MAJOR,label:a.i18n.translate("xpack.ml.anomalyUtils.severity.majorLabel",{defaultMessage:"major"})},minor:{id:r.a.MINOR,label:a.i18n.translate("xpack.ml.anomalyUtils.severity.minorLabel",{defaultMessage:"minor"})},warning:{id:r.a.WARNING,label:a.i18n.translate("xpack.ml.anomalyUtils.severity.warningLabel",{defaultMessage:"warning"})},unknown:{id:r.a.UNKNOWN,label:a.i18n.translate("xpack.ml.anomalyUtils.severity.unknownLabel",{defaultMessage:"unknown"})},low:{id:r.a.LOW,label:a.i18n.translate("xpack.ml.anomalyUtils.severityWithLow.lowLabel",{defaultMessage:"low"})}}},174:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));let a=function(e){return e.CRITICAL="critical",e.MAJOR="major",e.MINOR="minor",e.WARNING="warning",e.LOW="low",e.UNKNOWN="unknown",e}({})},175:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));const a={CRITICAL:"#fe5050",MAJOR:"#fba740",MINOR:"#fdec25",WARNING:"#8bc8fb",LOW:"#d2e9f7",BLANK:"#ffffff"}},181:function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"d",(function(){return r})),n.d(t,"b",(function(){return o})),n.d(t,"e",(function(){return i})),n.d(t,"c",(function(){return s}));let a=function(e){return e.SKIP_MODEL_UPDATE="skip_model_update",e.SKIP_RESULT="skip_result",e}({}),r=function(e){return e.EXCLUDE="exclude",e.INCLUDE="include",e}({}),o=function(e){return e.ACTUAL="actual",e.DIFF_FROM_TYPICAL="diff_from_typical",e.TYPICAL="typical",e}({}),i=function(e){return e.LESS_THAN="lt",e.LESS_THAN_OR_EQUAL="lte",e.GREATER_THAN="gt",e.GREATER_THAN_OR_EQUAL="gte",e}({});const s=["freq_rare","lat_long","metric","rare"]},203:function(e,t,n){"use strict";function a(e){let t=0,n=0;if(0===e.length)return t;for(let a=0;a<e.length;a++)n=e.charCodeAt(a),t=(t<<5)-t+n,t|=0;return t<0?-2*t:t}n.d(t,"a",(function(){return a}))},208:function(e,t,n){"use strict";n.d(t,"b",(function(){return p})),n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return b})),n.d(t,"d",(function(){return g})),n.d(t,"e",(function(){return h}));var a=n(25),r=n(78),o=n(75),i=n(349),s=n(415),l=n(247),c=n(150),u=n(219),d=n(321);const p={TYPICAL:"typical",ACTUAL:"actual",TYPICAL_TO_ACTUAL:"typical to actual"},m={type:r.STYLE_TYPE.DYNAMIC,options:{customColorRamp:i.d,field:{name:"record_score",origin:r.FIELD_ORIGIN.SOURCE},useCustomColorRamp:!0}},f={type:"VECTOR",properties:{fillColor:m,lineColor:m},isTimeAware:!1},y={type:"VECTOR",properties:{fillColor:{type:"STATIC",options:{color:"#98A2B2"}},lineColor:{type:"STATIC",options:{color:"#fff"}},lineWidth:{type:"STATIC",options:{size:2}},iconSize:{type:"STATIC",options:{size:6}}}};function _(e){return e.split(",").map((e=>Number(e))).reverse()}function b(e){const t=[];for(const n in p)p.hasOwnProperty(n)&&t.push({id:Object(a.htmlIdGenerator)()(),type:r.LAYER_TYPE.GEOJSON_VECTOR,sourceDescriptor:d.AnomalySource.createDescriptor({jobId:e,typicalActual:p[n]}),style:p[n]===p.TYPICAL?y:f});return t}function g(e){const t=[];for(const n in e)if(e.hasOwnProperty(n)){const{dataViewId:o,geoFields:i}=e[n];i.forEach((e=>{const i=Object(c.a)(e);t.push({id:Object(a.htmlIdGenerator)()(),type:r.LAYER_TYPE.GEOJSON_VECTOR,style:{type:"VECTOR",properties:{fillColor:{type:"STATIC",options:{color:i}},lineColor:{type:"STATIC",options:{color:i}}}},sourceDescriptor:{id:Object(a.htmlIdGenerator)()(),type:r.SOURCE_TYPES.ES_SEARCH,tooltipProperties:[e],label:n,indexPatternId:o,geoField:e,scalingType:r.SCALING_TYPES.MVT}})}))}return t}async function h(e,t,n,a){var r;const{query:i,timeFilters:c}=a,d=i&&""!==i.query;let m;const f=Object(u.a)([{id:t}]);d&&i.language===l.a.KUERY?m=Object(o.toElasticsearchQuery)(Object(o.fromKueryExpression)(i.query),f):d&&(null==i?void 0:i.language)===l.a.LUCENE&&(m=Object(o.luceneStringToDsl)(i.query));const y=[{term:{job_id:t}},{term:{result_type:"record"}}];let b={must:y};m&&m.bool?b={...b,...m.bool}:m&&b.must.push(m);const g={query:{bool:b},size:1e3,_source:{excludes:[]}};if(c){const e={range:{timestamp:{gte:`${c.from}`,lte:c.to}}};y.push(e)}let h=null;try{h=await e.anomalySearch({body:g},[t])}catch(e){}return{type:"FeatureCollection",features:(null===(r=h)||void 0===r?void 0:r.hits.hits.map((({_source:e})=>{const t=e.geo_results,a=t&&t.actual_point?_(t.actual_point):[0,0],r=t&&t.typical_point?_(t.typical_point):[0,0];let o;o=n===p.TYPICAL||n===p.ACTUAL?{type:"Point",coordinates:n===p.TYPICAL?r:a}:{type:"LineString",coordinates:[r,a]};const i={...e.partition_field_name?{[e.partition_field_name]:e.partition_field_value}:{},...e.by_field_name?{[e.by_field_name]:e.by_field_value}:{},...e.over_field_name?{[e.over_field_name]:e.over_field_value}:{}},l=Object.keys(i),c=e.influencers?e.influencers.filter((({influencer_field_name:e,influencer_field_values:t})=>t.length&&!l.includes(e))):[];return{type:"Feature",geometry:o,properties:{actual:a,typical:r,fieldName:e.field_name,functionDescription:e.function_description,timestamp:Object(s.c)(e.timestamp),record_score:Math.floor(e.record_score),...Object.keys(i).length>0?i:{},...c.length?{influencers:c}:{}}}})))||[]}}},219:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var a=n(220),r=n(139);function o(e){return{title:a.a,fields:Object(r.g)(e).map((e=>({name:e,type:"string",aggregatable:!0,searchable:!0})))}}},220:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));const a=".ml-anomalies-*"},247:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));const a={KUERY:"kuery",LUCENE:"lucene"}},252:function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"f",(function(){return u})),n.d(t,"e",(function(){return d})),n.d(t,"g",(function(){return p})),n.d(t,"c",(function(){return m})),n.d(t,"d",(function(){return f})),n.d(t,"i",(function(){return y})),n.d(t,"j",(function(){return _})),n.d(t,"h",(function(){return b})),n.d(t,"b",(function(){return g}));var a=n(140),r=n(173),o=n(181);let i=function(e){return e.BY="by",e.OVER="over",e.PARTITON="partition",e}({});const s={ADD:"+",REMOVE:"-"},l=["count","distinct_count","lat_long","mean","max","min","sum","median","varp","info_content","time"],c=["count","distinct_count","lat_long","mean","max","min","sum","median","varp","info_content","time"];function u(e){return"mlcategory"===e.entityName}function d(e){return e>=a.a.CRITICAL?r.a.critical:e>=a.a.MAJOR?r.a.major:e>=a.a.MINOR?r.a.minor:e>=a.a.WARNING?r.a.warning:e>=a.a.LOW?r.a.low:r.a.unknown}function p(e){if(void 0===e.anomaly_score_explanation)return!1;const t=e.anomaly_score_explanation.single_bucket_impact,n=e.anomaly_score_explanation.multi_bucket_impact;return void 0!==n&&0!==n&&!(void 0!==t&&t>n)&&((void 0===t||0===t)&&n>0||void 0!==t&&n>t&&(n-t)*n/t*1.7>=2)}function m(e){return e<2?1:e<4?2:e<7?3:e<12?4:5}function f(e){const t=[];return void 0!==e.partition_field_name&&t.push({fieldName:e.partition_field_name,fieldValue:e.partition_field_value,fieldType:i.PARTITON}),void 0!==e.over_field_name&&t.push({fieldName:e.over_field_name,fieldValue:e.over_field_value,fieldType:i.OVER}),void 0!==e.by_field_name&&void 0===e.over_field_name&&t.push({fieldName:e.by_field_name,fieldValue:e.by_field_value,fieldType:i.BY}),t}function y(e){return l.indexOf(e)>-1}function _(e){return c.indexOf(e)>-1}function b(e){return-1===o.c.indexOf(e.function)||void 0!==function(e){return void 0!==e.by_field_name&&void 0!==e.by_field_value?e.by_field_name:void 0!==e.over_field_name?e.over_field_name:void 0!==e.partition_field_name?e.partition_field_name:void 0}(e)}const g={toES(e){let t=e;return"mean"===t?t="avg":"distinct_count"===t?t="cardinality":"median"===t&&(t="percentiles"),t},toML(e){let t=e;return"avg"===t?t="mean":"cardinality"===t?t="distinct_count":"percentiles"===t&&(t="median"),t}}},258:function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"e",(function(){return u})),n.d(t,"f",(function(){return d})),n.d(t,"b",(function(){return p})),n.d(t,"d",(function(){return AnomalySourceTooltipProperty})),n.d(t,"c",(function(){return AnomalySourceField}));var a=n(4),r=n.n(a),o=(n(2),n(8)),i=n(5),s=n(78),l=n(6);const c=i.i18n.translate("xpack.ml.maps.anomalyLayerActualLabel",{defaultMessage:"Actual"}),u=i.i18n.translate("xpack.ml.maps.anomalyLayerTypicalLabel",{defaultMessage:"Typical"}),d=i.i18n.translate("xpack.ml.maps.anomalyLayerTypicalToActualLabel",{defaultMessage:"Typical to actual"}),p={record_score:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerRecordScoreLabel",{defaultMessage:"Record score"}),type:"number"},timestamp:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerTimeStampLabel",{defaultMessage:"Time"}),type:"string"},fieldName:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerFieldNameLabel",{defaultMessage:"Field name"}),type:"string"},functionDescription:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerFunctionDescriptionLabel",{defaultMessage:"Function"}),type:"string"},actual:{label:c,type:"string"},typical:{label:u,type:"string"},partition_field_name:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerPartitionFieldNameLabel",{defaultMessage:"Partition field name"}),type:"string"},partition_field_value:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerPartitionFieldValueLabel",{defaultMessage:"Partition field value"}),type:"string"},by_field_name:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerByFieldNameLabel",{defaultMessage:"By field name"}),type:"string"},by_field_value:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerByFieldValueLabel",{defaultMessage:"By field value"}),type:"string"},over_field_name:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerOverFieldNameLabel",{defaultMessage:"Over field name"}),type:"string"},over_field_value:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerOverFieldValueLabel",{defaultMessage:"Over field value"}),type:"string"},influencers:{label:i.i18n.translate("xpack.ml.maps.anomalyLayerInfluencersLabel",{defaultMessage:"Influencers"}),type:"string"}},m=Math.pow(10,s.DECIMAL_DEGREES_PRECISION);function f(e){return Math.round(Number(e)*m)/m}class AnomalySourceTooltipProperty{constructor(e,t){this._field=e,this._value=t}async getESFilters(){return[]}getHtmlDisplayValue(){if("influencers"===this._field)try{const e=JSON.parse(this._value);return Object(l.jsx)("ul",null,e.map((({influencer_field_name:e,influencer_field_values:t})=>Object(l.jsx)("li",null,`${e}: ${t.slice(0,3).join(", ")}`))))}catch(e){}else if("actual"===this._field||"typical"===this._field)try{const e=JSON.parse(this._value);return`[${f(e[0])}, ${f(e[1])}]`}catch(e){}return this._value.toString()}getPropertyKey(){return this._field}getPropertyName(){return p[this._field]&&p[this._field].label?p[this._field].label:this._field}getRawValue(){return this._value.toString()}isFilterable(){return!1}}class AnomalySourceField{constructor({source:e,field:t}){r()(this,"_source",void 0),r()(this,"_field",void 0),this._source=e,this._field=t}async createTooltipProperty(e){return new AnomalySourceTooltipProperty(this._field,Object(o.escape)(Array.isArray(e)?e.join():e||""))}async getDataType(){return p[this._field].type}async getLabel(){return p[this._field].label}getName(){return this._field}getMbFieldName(){return this.getName()}getOrigin(){return s.FIELD_ORIGIN.SOURCE}getRootName(){return this.getName()}getSource(){return this._source}isEqual(e){return this.getName()===e.getName()}isValid(){return!0}supportsFieldMetaFromLocalData(){return!0}supportsFieldMetaFromEs(){return!1}canValueBeFormatted(){return!1}async getExtendedStatsFieldMetaRequest(){return null}async getPercentilesFieldMetaRequest(e){return null}async getCategoricalFieldMetaRequest(e){return null}pluckRangeFromTileMetaFeature(e){return null}isCount(){return!1}}},290:function(e,t,n){"use strict";n.d(t,"a",(function(){return LayerSelector}));var a=n(4),r=n.n(a),o=n(2),i=n(25),s=n(5),l=n(208),c=n(258),u=n(6);class LayerSelector extends o.Component{constructor(...e){super(...e),r()(this,"_isMounted",!1),r()(this,"state",{}),r()(this,"onSelect",(e=>{const t=e[0].value;this._isMounted&&(this.setState({typicalActual:t}),this.props.onChange(t))}))}componentDidMount(){this._isMounted=!0}componentWillUnmount(){this._isMounted=!1}render(){const e=[{value:this.props.typicalActual,label:this.props.typicalActual}];return Object(u.jsx)(i.EuiFormRow,{label:s.i18n.translate("xpack.ml.maps.typicalActualLabel",{defaultMessage:"Type"}),display:"columnCompressed"},Object(u.jsx)(i.EuiComboBox,{singleSelection:!0,onChange:this.onSelect,options:[{value:l.b.ACTUAL,label:c.a},{value:l.b.TYPICAL,label:c.e},{value:l.b.TYPICAL_TO_ACTUAL,label:c.f}],selectedOptions:e}))}}},321:function(e,t,n){"use strict";n.r(t),n.d(t,"AnomalySource",(function(){return anomaly_source_AnomalySource}));var a=n(4),r=n.n(a),o=n(5),i=n(2),s=n(78),l=n(98),c=n(258),u=n(1),d=n(208),p=n(15),m=n(25),f=n(290),y=n(6);class update_anomaly_source_editor_UpdateAnomalySourceEditor extends i.Component{constructor(...e){super(...e),r()(this,"state",{})}render(){return Object(y.jsx)(i.Fragment,null,Object(y.jsx)(m.EuiPanel,null,Object(y.jsx)(m.EuiTitle,{size:"xs"},Object(y.jsx)("h6",null,Object(y.jsx)(p.FormattedMessage,{id:"xpack.ml.maps.settingsEditorLabel",defaultMessage:"Anomalies"}))),Object(y.jsx)(m.EuiSpacer,{size:"s"}),Object(y.jsx)(f.a,{onChange:e=>{this.props.onChange({propName:"typicalActual",value:e})},typicalActual:this.props.typicalActual})),Object(y.jsx)(m.EuiSpacer,{size:"s"}))}}class anomaly_source_AnomalySource{static createDescriptor(e){if("string"!=typeof e.jobId)throw new Error("Job id is required for anomaly layer creation");return{type:s.SOURCE_TYPES.ES_ML_ANOMALIES,jobId:e.jobId,typicalActual:e.typicalActual||d.b.ACTUAL}}constructor(e,t){r()(this,"_descriptor",void 0),this._descriptor=anomaly_source_AnomalySource.createDescriptor(e)}async getGeoJsonWithMeta(e,t,n,a){const r=await Object(d.e)(anomaly_source_AnomalySource.mlResultsService,this._descriptor.jobId,this._descriptor.typicalActual,t);return{data:r,meta:{areResultsTrimmed:1e3===r.features.length}}}canFormatFeatureProperties(){return!1}cloneDescriptor(){return{type:this._descriptor.type,jobId:this._descriptor.jobId,typicalActual:this._descriptor.typicalActual}}createField({fieldName:e}){if("record_score"!==e)throw new Error("Record score field name is required");return new c.c({source:this,field:e})}async createFieldFormatter(e){return null}destroy(){}getApplyGlobalQuery(){return!0}getApplyForceRefresh(){return!1}getApplyGlobalTime(){return!0}async getAttributions(){return[]}async getBoundsForFilters(e,t){return null}async getDisplayName(){return o.i18n.translate("xpack.ml.maps.anomalySource.displayLabel",{defaultMessage:"{typicalActual} for {jobId}",values:{typicalActual:this._descriptor.typicalActual,jobId:this._descriptor.jobId}})}getFieldByName(e){return"record_score"===e?new c.c({source:this,field:e}):null}getSourceStatus(e){const t=e?e.getMeta():null;return null!=t&&t.areResultsTrimmed?{tooltipContent:o.i18n.translate("xpack.ml.maps.resultsTrimmedMsg",{defaultMessage:"Results limited to first {count} documents.",values:{count:1e3}}),areResultsTrimmed:!0}:{tooltipContent:null,areResultsTrimmed:!1}}getType(){return this._descriptor.type}isMvt(){return!1}supportsJoins(){return!1}async getFields(){return Object.keys(c.b).map((e=>new c.c({source:this,field:e})))}getGeoGridPrecision(e){return 0}isBoundsAware(){return!1}async getImmutableProperties(e){let t;try{var n;t=await(null===(n=anomaly_source_AnomalySource.mlLocator)||void 0===n?void 0:n.getUrl({page:u.b.ANOMALY_EXPLORER,pageState:{jobIds:[this._descriptor.jobId],timeRange:e.timeFilters}}))}catch(e){}return[{label:o.i18n.translate("xpack.ml.maps.anomalySourcePropLabel",{defaultMessage:"Job Id"}),value:this._descriptor.jobId,...t?{link:t}:{}}]}async isTimeAware(){return!0}renderSourceSettingsEditor({onChange:e}){return Object(y.jsx)(update_anomaly_source_editor_UpdateAnomalySourceEditor,{onChange:e,typicalActual:this._descriptor.typicalActual})}async supportsFitToBounds(){return!0}async getLicensedFeatures(){return[]}getMaxZoom(){return s.MAX_ZOOM}getMinZoom(){return s.MIN_ZOOM}getSourceTooltipContent(e){var t;const n=e?e.getMeta():null;return{tooltipContent:o.i18n.translate("xpack.ml.maps.sourceTooltip",{defaultMessage:"Shows anomalies"}),areResultsTrimmed:null!==(t=null==n?void 0:n.areResultsTrimmed)&&void 0!==t&&t}}async getSupportedShapeTypes(){return this._descriptor.typicalActual===d.b.TYPICAL_TO_ACTUAL?[s.VECTOR_SHAPE_TYPE.LINE]:[s.VECTOR_SHAPE_TYPE.POINT]}getSyncMeta(){return{jobId:this._descriptor.jobId,typicalActual:this._descriptor.typicalActual}}async getTooltipProperties(e){const t=[];for(const n in e)n!==l.GEOJSON_FEATURE_ID_PROPERTY_NAME&&e.hasOwnProperty(n)&&t.push(new c.d(n,e[n]));return t}isFieldAware(){return!0}async getValueSuggestions(e,t){return[]}getAttributionProvider(){return null}getInspectorAdapters(){}getJoinsDisabledReason(){return null}async getLeftJoinFields(){return[]}getFeatureActions(e){return[]}isFilterByMapBounds(){return!1}isGeoGridPrecisionAware(){return!1}isQueryAware(){return!0}isRefreshTimerAware(){return!0}async getTimesliceMaskFieldName(){return null}async supportsFeatureEditing(){return!1}hasTooltipProperties(){return!0}async addFeature(){}async deleteFeature(){}getUpdateDueToTimeslice(){return!0}async getDefaultFields(){return{}}getInspectorRequestIds(){return[]}}r()(anomaly_source_AnomalySource,"mlResultsService",void 0),r()(anomaly_source_AnomalySource,"mlLocator",void 0)},349:function(e,t,n){"use strict";n.d(t,"d",(function(){return o})),n.d(t,"a",(function(){return i})),n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return l}));var a=n(140),r=n(175);const o=[{stop:a.a.LOW,color:r.a.WARNING},{stop:a.a.MINOR,color:r.a.MINOR},{stop:a.a.MAJOR,color:r.a.MAJOR},{stop:a.a.CRITICAL,color:r.a.CRITICAL}],i={BUCKET:"bucket",RECORD:"record",INFLUENCER:"influencer"},s=["partition_field","over_field","by_field"],l="job_id"},876:function(e,t,n){"use strict";n.r(t),n.d(t,"registerMapExtension",(function(){return g}));var a=n(4),r=n.n(a),o=n(78),i=n(12),s=n(1);class anomaly_source_factory_AnomalySourceFactory{constructor(e){r()(this,"type",o.SOURCE_TYPES.ES_ML_ANOMALIES),this.getStartServices=e}async getServices(){const[e,t]=await this.getStartServices(),{mlApiServicesProvider:a}=await Promise.resolve().then(n.bind(null,11)),r=t.share.url.locators.get(s.a);return{mlResultsService:a(new i.a(e.http)).results,mlLocator:r}}async create(){const{mlResultsService:e,mlLocator:t}=await this.getServices(),{AnomalySource:a}=await Promise.resolve().then(n.bind(null,321));return a.mlResultsService=e,a.mlLocator=t,a}}var l=n(2),c=n(25),u=n(208),d=n(5),p=n(8),m=n(15),f=n(6);const y=({jobsManagementPath:e,canCreateJobs:t})=>Object(f.jsx)(c.EuiEmptyPrompt,{layout:"vertical",hasBorder:!1,hasShadow:!1,color:"subdued",title:Object(f.jsx)("h2",null,Object(f.jsx)(m.FormattedMessage,{id:"xpack.ml.mapsAnomaliesLayerEmptyPrompt.createJobMessage",defaultMessage:"Create an anomaly detection job"})),body:Object(f.jsx)("p",null,Object(f.jsx)(m.FormattedMessage,{id:"xpack.ml.mapsAnomaliesLayerEmptyPrompt.emptyPromptText",defaultMessage:"Anomaly detection enables you to find unusual behaviour in your geographic data. Create a job that uses the lat_long function, which is necessary for the maps anomaly layer."})),actions:Object(f.jsx)(c.EuiButton,{color:"primary",href:e,fill:!0,iconType:"plusInCircle",isDisabled:!t,"data-test-subj":"mlMapsCreateNewJobButton"},Object(f.jsx)(m.FormattedMessage,{id:"xpack.ml.mapsAnomaliesLayerEmptyPrompt.createJobButtonText",defaultMessage:"Create job"})),"data-test-subj":"mlMapsAnomalyDetectionEmptyState"});class anomaly_job_selector_AnomalyJobSelector extends l.Component{constructor(...e){super(...e),r()(this,"_isMounted",!1),r()(this,"state",{}),r()(this,"onJobIdSelect",(e=>{const t=e[0].value;this._isMounted&&(this.setState({jobId:t}),this.props.onJobChange(t))}))}async _loadJobs(){const e=(await this.props.mlJobsService.jobIdsWithGeo()).map((e=>({label:e,value:e})));this._isMounted&&!Object(p.isEqual)(e,this.state.jobIdList)&&this.setState({jobIdList:e})}componentDidUpdate(e,t){this._loadJobs()}componentDidMount(){this._isMounted=!0,this._loadJobs()}componentWillUnmount(){this._isMounted=!1}render(){var e,t;return(null===(e=this.state.jobIdList)||void 0===e?void 0:e.length)&&(null===(t=this.state.jobIdList)||void 0===t?void 0:t.length)>0||!this.props.jobsManagementPath?Object(f.jsx)(c.EuiFormRow,{label:d.i18n.translate("xpack.ml.maps.jobIdLabel",{defaultMessage:"Job ID"}),display:"columnCompressed"},Object(f.jsx)(c.EuiComboBox,{singleSelection:!0,onChange:this.onJobIdSelect,options:this.state.jobIdList,selectedOptions:this.state.jobId?[{value:this.state.jobId,label:this.state.jobId}]:[]})):Object(f.jsx)(y,{jobsManagementPath:this.props.jobsManagementPath,canCreateJobs:this.props.canCreateJobs})}}var _=n(290);class create_anomaly_source_editor_CreateAnomalySourceEditor extends l.Component{constructor(...e){super(...e),r()(this,"_isMounted",!1),r()(this,"state",{}),r()(this,"onTypicalActualChange",(e=>{this._isMounted&&this.setState({typicalActual:e},(()=>{this.configChange()}))})),r()(this,"previewLayer",(e=>{this._isMounted&&this.setState({jobId:e},(()=>{this.configChange()}))}))}configChange(){this.state.jobId&&this.props.onSourceConfigChange({jobId:this.state.jobId,typicalActual:this.state.typicalActual||u.b.ACTUAL})}componentDidMount(){this._isMounted=!0}render(){const e=this.state.jobId?Object(f.jsx)(_.a,{onChange:this.onTypicalActualChange,typicalActual:this.state.typicalActual||u.b.ACTUAL}):null;return Object(f.jsx)(c.EuiPanel,null,Object(f.jsx)(anomaly_job_selector_AnomalyJobSelector,{onJobChange:this.previewLayer,mlJobsService:this.props.mlJobsService,jobsManagementPath:this.props.jobsManagementPath,canCreateJobs:this.props.canCreateJobs}),e)}}var b=n(321);class anomaly_layer_wizard_factory_AnomalyLayerWizardFactory{constructor(e,t,n){r()(this,"type","ML_ANOMALIES"),this.getStartServices=e,this.canGetJobs=t,this.canCreateJobs=n,this.canGetJobs=t,this.canCreateJobs=n}async getServices(){const[e,t]=await this.getStartServices(),{jobsApiProvider:a}=await Promise.resolve().then(n.bind(null,52));return{mlJobsService:a(new i.a(e.http)),mlLocator:t.share.url.locators.get(s.a)}}async create(){const{mlJobsService:e,mlLocator:t}=await this.getServices();let a;t?a=await t.getUrl({page:s.b.ANOMALY_DETECTION_JOBS_MANAGE}):console.error("Unable to get job management path.");const{anomalyLayerWizard:r}=await n.e(106).then(n.bind(null,850));return r.getIsDisabled=()=>!this.canGetJobs,r.renderWizard=({previewLayers:t})=>Object(f.jsx)(create_anomaly_source_editor_CreateAnomalySourceEditor,{onSourceConfigChange:e=>{if(!e)return void t([]);const n={id:Object(c.htmlIdGenerator)()(),type:o.LAYER_TYPE.GEOJSON_VECTOR,sourceDescriptor:b.AnomalySource.createDescriptor({jobId:e.jobId,typicalActual:e.typicalActual}),style:{type:"VECTOR",properties:{fillColor:u.a,lineColor:u.a},isTimeAware:!1}};t([n])},mlJobsService:e,jobsManagementPath:a,canCreateJobs:this.canCreateJobs}),r}}async function g(e,t,{canGetJobs:n,canCreateJobs:a}){const r=new anomaly_source_factory_AnomalySourceFactory(t.getStartServices),o=new anomaly_layer_wizard_factory_AnomalyLayerWizardFactory(t.getStartServices,n,a),i=await o.create();e.registerSource({type:r.type,ConstructorFunction:await r.create()}),e.registerLayerWizard(i)}}}]);