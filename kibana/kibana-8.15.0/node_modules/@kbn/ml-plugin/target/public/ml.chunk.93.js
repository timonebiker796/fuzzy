/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[93],{315:function(t,e,n){"use strict";n.r(e),n.d(e,"AnnotationFlyoutUI",(function(){return annotation_flyout_AnnotationFlyoutUI})),n.d(e,"AnnotationFlyout",(function(){return A}));var i=n(120),a=n.n(i),o=n(4),s=n.n(o),l=n(2),r=n.n(l),d=n(26),c=n.n(d),u=n(8),p=n(25),m=n(5),x=n(15),b=n(349),h=n(197),j=n(153),f=n(415),g=n(6);const S=({annotation:t,detectorDescription:e})=>{const n=[{title:m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.jobIdTitle",{defaultMessage:"Job ID"}),description:t.job_id},{title:m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.startTitle",{defaultMessage:"Start"}),description:Object(f.c)(t.timestamp)}];var i,a,o,s,l;return void 0!==t.end_timestamp&&n.push({title:m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.endTitle",{defaultMessage:"End"}),description:Object(f.c)(t.end_timestamp)}),void 0!==t.create_time&&void 0!==t.modified_time&&(n.push({title:m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.createdTitle",{defaultMessage:"Created"}),description:Object(f.c)(t.create_time)}),n.push({title:m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.createdByTitle",{defaultMessage:"Created by"}),description:null!==(i=t.create_username)&&void 0!==i?i:""}),n.push({title:m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.lastModifiedTitle",{defaultMessage:"Last modified"}),description:Object(f.c)(t.modified_time)}),n.push({title:m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.modifiedByTitle",{defaultMessage:"Modified by"}),description:null!==(a=t.modified_username)&&void 0!==a?a:""})),void 0!==e&&n.push({title:m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationDescriptionList.detectorTitle",{defaultMessage:"Detector"}),description:e}),void 0!==t.partition_field_name&&n.push({title:t.partition_field_name,description:null!==(o=t.partition_field_value)&&void 0!==o?o:""}),void 0!==t.over_field_name&&n.push({title:t.over_field_name,description:null!==(s=t.over_field_value)&&void 0!==s?s:""}),void 0!==t.by_field_name&&n.push({title:t.by_field_name,description:null!==(l=t.by_field_value)&&void 0!==l?l:""}),Object(g.jsx)(p.EuiDescriptionList,{"data-test-subj":"mlAnnotationDescriptionList",className:"ml-annotation-description-list",type:"column",columnWidths:[3,7],listItems:n})},y=({cancelAction:t,deleteAction:e,isVisible:n})=>Object(g.jsx)(l.Fragment,null,!0===n&&Object(g.jsx)(p.EuiConfirmModal,{title:m.i18n.translate("xpack.ml.timeSeriesExplorer.deleteAnnotationModal.deleteAnnotationTitle",{defaultMessage:"Delete this annotation?"}),onCancel:t,onConfirm:e,cancelButtonText:m.i18n.translate("xpack.ml.timeSeriesExplorer.deleteAnnotationModal.cancelButtonLabel",{defaultMessage:"Cancel"}),confirmButtonText:m.i18n.translate("xpack.ml.timeSeriesExplorer.deleteAnnotationModal.deleteButtonLabel",{defaultMessage:"Delete"}),buttonColor:"danger",defaultFocusedButton:p.EUI_MODAL_CONFIRM_BUTTON,className:"eui-textBreakWord","data-test-subj":"mlAnnotationFlyoutConfirmDeleteModal"}));var E=n(11),v=n(17);function M(t){return`${t}_name`}function _(t){return`${t}_value`}var O=n(170);class annotation_flyout_AnnotationFlyoutUI extends l.Component{constructor(...t){super(...t),s()(this,"deletionInProgress",!1),s()(this,"state",{isDeleteModalVisible:!1,applyAnnotationToSeries:!0,annotationState:null}),s()(this,"annotationSub",null),s()(this,"annotationTextChangeHandler",(t=>{if(null===this.state.annotationState)return;const{annotationUpdatesService:e}=this.props;e.setValue({...this.state.annotationState,annotation:t.target.value})})),s()(this,"cancelEditingHandler",(()=>{const{annotationUpdatesService:t}=this.props;t.setValue(null)})),s()(this,"deleteConfirmHandler",(()=>{this.setState({isDeleteModalVisible:!0})})),s()(this,"deleteHandler",(async()=>{if(this.deletionInProgress)return;const{annotationState:t}=this.state,e=Object(v.f)();if(null===t||void 0===t._id)return;this.deletionInProgress=!0;try{await E.ml.annotations.deleteAnnotation(t._id),e.addSuccess(m.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.deletedAnnotationNotificationMessage",{defaultMessage:"Deleted annotation for job with ID {jobId}.",values:{jobId:t.job_id}}))}catch(n){e.addDanger(m.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.errorWithDeletingAnnotationNotificationErrorMessage",{defaultMessage:"An error occurred deleting the annotation for job with ID {jobId}: {error}",values:{jobId:t.job_id,error:JSON.stringify(n)}}))}this.closeDeleteModal(),this.deletionInProgress=!1;const{annotationUpdatesService:n}=this.props;n.setValue(null),Object(j.c)()})),s()(this,"closeDeleteModal",(()=>{this.setState({isDeleteModalVisible:!1})})),s()(this,"validateAnnotationText",(()=>{const{annotationState:t}=this.state,e=[];if(null===t)return e;0===t.annotation.trim().length&&e.push(m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationFlyout.noAnnotationTextError",{defaultMessage:"Enter annotation text"}));const n=t.annotation.length;if(n>h.c){const t=n-h.c;e.push(m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationFlyout.maxLengthError",{defaultMessage:"{charsOver, number} {charsOver, plural, one {character} other {characters}} above maximum length of {maxChars}",values:{maxChars:h.c,charsOver:t}}))}return e})),s()(this,"saveOrUpdateAnnotation",(()=>{var t,e;const{annotationState:n}=this.state,{chartDetails:i,detectorIndex:a,annotationUpdatesService:o}=this.props;if(null===n)return;const s=Object(u.cloneDeep)(n);this.state.applyAnnotationToSeries&&null!=i&&null!==(t=i.entityData)&&void 0!==t&&t.entities&&(i.entityData.entities.forEach((t=>{const{fieldName:e,fieldValue:n}=t,i=t.fieldType;s[M(i)]=e,s[_(i)]=n})),s.detector_index=a),this.state.applyAnnotationToSeries||(delete s.detector_index,b.c.forEach((t=>{delete s[M(t)],delete s[_(t)]}))),s.event=null!==(e=s.event)&&void 0!==e?e:h.b,o.setValue(null),E.ml.annotations.indexAnnotation(s).then((()=>{Object(j.c)();const t=Object(v.f)();void 0===s._id?t.addSuccess(m.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.addedAnnotationNotificationMessage",{defaultMessage:"Added an annotation for job with ID {jobId}.",values:{jobId:s.job_id}})):t.addSuccess(m.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.updatedAnnotationNotificationMessage",{defaultMessage:"Updated annotation for job with ID {jobId}.",values:{jobId:s.job_id}}))})).catch((t=>{const e=Object(v.f)();void 0===s._id?e.addDanger(m.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.errorWithCreatingAnnotationNotificationErrorMessage",{defaultMessage:"An error occurred creating the annotation for job with ID {jobId}: {error}",values:{jobId:s.job_id,error:JSON.stringify(t)}})):e.addDanger(m.i18n.translate("xpack.ml.timeSeriesExplorer.timeSeriesChart.errorWithUpdatingAnnotationNotificationErrorMessage",{defaultMessage:"An error occurred updating the annotation for job with ID {jobId}: {error}",values:{jobId:s.job_id,error:JSON.stringify(t)}}))}))}))}componentDidMount(){const{annotationUpdatesService:t}=this.props;this.annotationSub=t.update$().subscribe((t=>{this.setState({annotationState:t})}))}componentWillUnmount(){this.annotationSub.unsubscribe()}render(){const{detectors:t,detectorIndex:e}=this.props,{annotationState:n,isDeleteModalVisible:i}=this.state;if(!n)return null;const a=void 0!==n._id,o=this.validateAnnotationText(),s=o.length>0;let l=null;!1===s&&n.annotation.length>.95*h.c&&(l=m.i18n.translate("xpack.ml.timeSeriesExplorer.annotationFlyout.approachingMaxLengthWarning",{defaultMessage:"{charsRemaining, number} {charsRemaining, plural, one {character} other {characters}} remaining",values:{charsRemaining:h.c-n.annotation.length}}));const d=t?t.find((t=>t.index===e)):void 0,c=d&&"detector_description"in d?d.detector_description:"";return Object(g.jsx)(r.a.Fragment,null,Object(g.jsx)(p.EuiFlyoutBody,null,Object(g.jsx)(S,{annotation:n,detectorDescription:c}),Object(g.jsx)(p.EuiSpacer,{size:"m"}),Object(g.jsx)(p.EuiFormRow,{label:Object(g.jsx)(x.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.annotationTextLabel",defaultMessage:"Annotation text"}),fullWidth:!0,helpText:l,isInvalid:s,error:o},Object(g.jsx)(p.EuiTextArea,{fullWidth:!0,isInvalid:s,onChange:this.annotationTextChangeHandler,placeholder:"...",value:n.annotation,"data-test-subj":"mlAnnotationsFlyoutTextInput"})),Object(g.jsx)(p.EuiFormRow,null,Object(g.jsx)(p.EuiCheckbox,{id:"xpack.ml.annotationFlyout.applyToPartition",label:Object(g.jsx)(x.FormattedMessage,{id:"xpack.ml.annotationFlyout.applyToPartitionTextLabel",defaultMessage:"Apply annotation to this series"}),checked:this.state.applyAnnotationToSeries,onChange:()=>this.setState({applyAnnotationToSeries:!this.state.applyAnnotationToSeries}),"data-test-subj":"mlAnnotationsFlyoutApplyToSeriesButton"}))),Object(g.jsx)(p.EuiFlyoutFooter,null,Object(g.jsx)(p.EuiFlexGroup,null,Object(g.jsx)(p.EuiFlexItem,{grow:!1},Object(g.jsx)(p.EuiButtonEmpty,{onClick:this.cancelEditingHandler,flush:"left","data-test-subj":"mlAnnotationsFlyoutCancelButton"},Object(g.jsx)(x.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.cancelButtonLabel",defaultMessage:"Cancel"}))),Object(g.jsx)(p.EuiFlexItem,{grow:!1,style:{marginLeft:"auto"}},a&&Object(g.jsx)(p.EuiButtonEmpty,{color:"danger",onClick:this.deleteConfirmHandler,"data-test-subj":"mlAnnotationsFlyoutDeleteButton"},Object(g.jsx)(x.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.deleteButtonLabel",defaultMessage:"Delete"}))),Object(g.jsx)(p.EuiFlexItem,{grow:!1},Object(g.jsx)(p.EuiButton,{fill:!0,isDisabled:!0===s,onClick:this.saveOrUpdateAnnotation,"data-test-subj":"annotationFlyoutUpdateOrCreateButton"},a?Object(g.jsx)(x.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.updateButtonLabel",defaultMessage:"Update"}):Object(g.jsx)(x.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.createButtonLabel",defaultMessage:"Create"}))))),Object(g.jsx)(y,{cancelAction:this.closeDeleteModal,deleteAction:this.deleteHandler,isVisible:i}))}}const A=t=>{const e=Object(l.useContext)(O.a),n=c()(e.isAnnotationInitialized$()),i=Object(l.useCallback)((()=>{e.setValue(null)}),[]);if(null==n)return null;const o=void 0!==n._id;return Object(g.jsx)(p.EuiFlyout,{onClose:i,size:"m","aria-labelledby":"Add annotation","data-test-subj":"mlAnnotationFlyout",className:"mlAnnotationFlyout"},Object(g.jsx)(p.EuiFlyoutHeader,{hasBorder:!0},Object(g.jsx)(p.EuiTitle,{size:"s","data-test-subj":"mlAnnotationFlyoutTitle"},Object(g.jsx)("h2",{id:"mlAnnotationFlyoutTitle"},o?Object(g.jsx)(x.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.editAnnotationTitle",defaultMessage:"Edit annotation"}):Object(g.jsx)(x.FormattedMessage,{id:"xpack.ml.timeSeriesExplorer.annotationFlyout.addAnnotationTitle",defaultMessage:"Add annotation"})))),Object(g.jsx)(annotation_flyout_AnnotationFlyoutUI,a()({},t,{annotationUpdatesService:e})))}}}]);