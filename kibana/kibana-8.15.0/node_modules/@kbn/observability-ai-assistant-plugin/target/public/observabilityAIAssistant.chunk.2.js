/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.observabilityAIAssistant_bundle_jsonpfunction=window.observabilityAIAssistant_bundle_jsonpfunction||[]).push([[2],{66:function(e,n,t){"use strict";t.r(n),t.d(n,"createChatService",(function(){return m}));var s=t(5),r=t(4),o=t(6),a=t(37),i=t(43),c=t(19);function u({name:e,error:n,message:t}){const s=JSON.parse("toJSON"in n&&"function"==typeof n.toJSON?n.toJSON():JSON.stringify(n));return Object(c.a)({name:e,content:{error:{...s,name:n.name,message:n.message,cause:n.cause},message:t||n.message},data:{stack:n.stack}})}function l({client:e,getScreenContexts:n,connectorId:t,conversationId:o,messages:a,persist:i,disableFunctions:p,signal:d,responseLanguage:m,instructions:b},g){return new s.Observable((f=>{const O=n(),v=O.flatMap((e=>{var n;return null!==(n=e.actions)&&void 0!==n?n:[]})),j=g({params:{body:{connectorId:t,messages:a,persist:i,disableFunctions:p,screenContexts:O,conversationId:o,responseLanguage:m,instructions:b}}}).pipe(Object(s.shareReplay)()),h=j.pipe(Object(s.filter)((e=>e.type===r.d.MessageAdd)),Object(s.map)((e=>e.message)),Object(s.toArray)(),Object(s.last)()),w=j.pipe(Object(s.last)((e=>e.type===r.d.ConversationCreate||e.type===r.d.ConversationUpdate)),Object(s.map)((e=>e.conversation.id)),Object(s.catchError)((()=>Object(s.of)(o))));j.subscribe({next:e=>{f.next(e)},error:e=>{f.error(e)}}),Object(s.combineLatest)([w,h,j.pipe(Object(s.last)())]).subscribe({next:([O,j])=>{var h;const w=null===(h=j[j.length-1])||void 0===h?void 0:h.message.function_call;if(null==w||!w.name)return void f.complete();const y=v.find((e=>e.name===w.name));function C(s){s[s.length-1].message.role!==r.c.Assistant||i?l({client:e,getScreenContexts:n,connectorId:t,conversationId:O||o,messages:a.concat(s),signal:d,persist:i,responseLanguage:m,disableFunctions:p,instructions:b},g).subscribe(f):f.complete()}if(!y){const e=u({name:w.name,error:new Error(`Requested action ${w.name} was not found`)});return f.next(e),void C([...j,e.message])}y.respond({signal:d,client:e,args:JSON.parse(w.arguments||"{}"),connectorId:t,messages:j}).then((async e=>{if(Object(s.isObservable)(e)){const n=Object(c.a)({name:w.name,content:{executed:!0}});return j.push(n.message),f.next(n),await new Promise(((n,t)=>{e.subscribe({next:e=>{e.type===r.d.MessageAdd&&j.push(e.message),f.next(e)},error:e=>{t(e)},complete:()=>{n()}})}))}return Object(c.a)({name:w.name,content:e.content,data:e.data})})).catch((e=>u({name:w.name,error:e}))).then((e=>{e&&(j.push(e.message),f.next(e)),C(j)}))},error:e=>{f.error(e)}})}))}const p=10;function d(e){return n=>n.pipe(Object(s.catchError)((e=>{if("response"in e&&"json"in e.response&&"function"==typeof e.response.json){const n=e.response.json();return Object(s.from)(n.then((n=>{throw n&&(e.body=n,n.message&&(e.message=n.message)),e})))}return Object(s.throwError)((()=>e))})),Object(s.switchMap)((e=>function(e){var n,t;const r=null===(n=e.response)||void 0===n?void 0:n.status;var o;if(!r||r>=400)throw new Error((null===(o=e.response)||void 0===o?void 0:o.statusText)||"Unexpected error");const a=null===(t=e.response.body)||void 0===t?void 0:t.getReader();if(!a)throw new Error("Could not get reader from response");return(i=a,new s.Observable((e=>{let n="";return async function t(){const{done:s,value:r}=await i.read();if(s)return n&&e.next(n),void e.complete();const o=(new TextDecoder).decode(r).split("\n");o[0]=n+o[0],n=o.pop()||"";for(const n of o)e.next(n);return t()}().catch((n=>e.error(n))),()=>{i.cancel().catch((()=>{}))}})).pipe(Object(s.share)())).pipe(Object(s.timestamp)(),Object(s.scan)(((e,n)=>{const t=e.timestamp||0;return{timestamp:Math.max(t+p,n.timestamp),value:n.value}})),Object(s.concatMap)((e=>{const n=Date.now(),t=e.timestamp-n;return t<=0?Object(s.of)(e.value):Object(s.of)(e.value).pipe(Object(s.delay)(t))})));var i}(e))),Object(s.map)((e=>JSON.parse(e))),Object(s.filter)((e=>e.type!==o.c.BufferFlush)),(e=>e.pipe(Object(s.tap)((e=>{if(e.type===o.c.ChatCompletionError){var n;const t=null!==(n=e.error.code)&&void 0!==n?n:o.b.InternalError,s=e.error.message,r=e.error.meta;throw new o.a(t,s,r)}})),Object(s.filter)((e=>e.type!==o.c.ChatCompletionError)))),function(e){return n=>{const t=new s.Observable((n=>{e.aborted&&n.error(new a.AbortError),e.addEventListener("abort",(()=>{n.error(new a.AbortError)}))}));return n.pipe(Object(s.takeUntil)(t))}}(e),Object(s.shareReplay)())}async function m({analytics:e,signal:n,registrations:t,apiClient:a}){const c=new Map,u=new Map,[{functionDefinitions:p,systemMessage:m}]=await Promise.all([a("GET /internal/observability_ai_assistant/functions",{signal:n}),...t.map((e=>e({registerRenderFunction:(e,n)=>{u.set(e,n)}})))]);function b(e,n){return Object(s.from)(a(e,{...n,asResponse:!0,rawResponse:!0})).pipe(d(n.signal))}p.forEach((e=>{c.set(e.name,e)}));const g={chat:(e,{connectorId:n,messages:t,functionCall:r,functions:a,signal:i})=>b("POST /internal/observability_ai_assistant/chat",{params:{body:{name:e,messages:t,connectorId:n,functionCall:r,functions:null!=a?a:[]}},signal:i}).pipe(Object(s.filter)((e=>e.type===o.c.ChatCompletionChunk))),complete:({getScreenContexts:e,connectorId:n,conversationId:t,messages:s,persist:r,disableFunctions:o,signal:a,responseLanguage:i,instructions:c})=>l({getScreenContexts:e,connectorId:n,conversationId:t,messages:s,persist:r,disableFunctions:o,signal:a,client:g,responseLanguage:i,instructions:c},(({params:e})=>b("POST /internal/observability_ai_assistant/chat/complete",{params:e,signal:a})))};return{sendAnalyticsEvent:n=>{Object(i.b)(e,n)},renderFunction:(e,n,t,s)=>{var r,o;const a=u.get(e);if(!a)throw new Error(`Function ${e} not found`);const i=n?JSON.parse(n):{},c={content:JSON.parse(null!==(r=t.content)&&void 0!==r?r:"{}"),data:JSON.parse(null!==(o=t.data)&&void 0!==o?o:"{}")};return null==a?void 0:a({response:c,arguments:i,onActionClick:s})},getFunctions:e=>function({filter:e,definitions:n}){return e?n.filter((n=>!e||n.name.includes(e)||n.description.includes(e))):n}({...e,definitions:p}),hasFunction:e=>c.has(e),hasRenderFunction:e=>u.has(e),getSystemMessage:()=>({"@timestamp":(new Date).toISOString(),message:{role:r.c.System,content:m}}),...g}}}}]);