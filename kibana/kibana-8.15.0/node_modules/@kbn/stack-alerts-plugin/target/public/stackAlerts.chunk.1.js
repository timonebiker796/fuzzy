/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.stackAlerts_bundle_jsonpfunction=window.stackAlerts_bundle_jsonpfunction||[]).push([[1],{38:function(e,t,s){"use strict";var r,a=function(){var e={};return function(t){if(void 0===e[t]){var s=document.querySelector(t);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}e[t]=s}return e[t]}}(),i=[];function l(e){for(var t=-1,s=0;s<i.length;s++)if(i[s].identifier===e){t=s;break}return t}function o(e,t){for(var s={},r=[],a=0;a<e.length;a++){var o=e[a],n=t.base?o[0]+t.base:o[0],u=s[n]||0,c="".concat(n," ").concat(u);s[n]=u+1;var d=l(c),p={css:o[1],media:o[2],sourceMap:o[3]};-1!==d?(i[d].references++,i[d].updater(p)):i.push({identifier:c,updater:m(p,t),references:1}),r.push(c)}return r}function n(e){var t=document.createElement("style"),r=e.attributes||{};if(void 0===r.nonce){var i=s.nc;i&&(r.nonce=i)}if(Object.keys(r).forEach((function(e){t.setAttribute(e,r[e])})),"function"==typeof e.insert)e.insert(t);else{var l=a(e.insert||"head");if(!l)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");l.appendChild(t)}return t}var u,c=(u=[],function(e,t){return u[e]=t,u.filter(Boolean).join("\n")});function d(e,t,s,r){var a=s?"":r.media?"@media ".concat(r.media," {").concat(r.css,"}"):r.css;if(e.styleSheet)e.styleSheet.cssText=c(t,a);else{var i=document.createTextNode(a),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(i,l[t]):e.appendChild(i)}}function p(e,t,s){var r=s.css,a=s.media,i=s.sourceMap;if(a?e.setAttribute("media",a):e.removeAttribute("media"),i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),e.styleSheet)e.styleSheet.cssText=r;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(r))}}var g=null,b=0;function m(e,t){var s,r,a;if(t.singleton){var i=b++;s=g||(g=n(t)),r=d.bind(null,s,i,!1),a=d.bind(null,s,i,!0)}else s=n(t),r=p.bind(null,s,t),a=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(s)};return r(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;r(e=t)}else a()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=(void 0===r&&(r=Boolean(window&&document&&document.all&&!window.atob)),r));var s=o(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var r=0;r<s.length;r++){var a=l(s[r]);i[a].references--}for(var n=o(e,t),u=0;u<s.length;u++){var c=l(s[u]);0===i[c].references&&(i[c].updater(),i.splice(c,1))}s=n}}}},39:function(e,t,s){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s=function(e,t){var s,r,a,i=e[1]||"",l=e[3];if(!l)return i;if(t&&"function"==typeof btoa){var o=(s=l,r=btoa(unescape(encodeURIComponent(JSON.stringify(s)))),a="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(r),"/*# ".concat(a," */")),n=l.sources.map((function(e){return"/*# sourceURL=".concat(l.sourceRoot||"").concat(e," */")}));return[i].concat(n).concat([o]).join("\n")}return[i].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(s,"}"):s})).join("")},t.i=function(e,s,r){"string"==typeof e&&(e=[[null,e,""]]);var a={};if(r)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(a[l]=!0)}for(var o=0;o<e.length;o++){var n=[].concat(e[o]);r&&a[n[0]]||(s&&(n[2]?n[2]="".concat(s," and ").concat(n[2]):n[2]=s),t.push(n))}},t}},40:function(e,t,s){e.exports=s(18)(4)},41:function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var r=s(2),a=s(0),i=s(7),l=s(11),o=s(4),n=s(22),u=s(1),c=s(3);const d=({index:e,esFields:t,timeField:s,errors:d,onIndexChange:p,onTimeFieldChange:g})=>{const{http:b}=Object(n.useKibana)().services,[m,h]=Object(r.useState)(!1),[j,y]=Object(r.useState)([]),[O,x]=Object(r.useState)(!1),[f,S]=Object(r.useState)([u.firstFieldOption]),E=Object(i.debounce)((async e=>{x(!0),y(await Object(u.getIndexOptions)(b,e)),x(!1)}),250);Object(r.useEffect)((()=>{const e=Object(u.getTimeFieldOptions)(t);S([u.firstFieldOption,...e])}),[t]);const F=()=>{h(!1),void 0===s&&g("")};return Object(c.jsx)(o.EuiPopover,{id:"indexPopover",button:Object(c.jsx)(o.EuiExpression,{display:"columns","data-test-subj":"selectIndexExpression",description:a.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexLabel",{defaultMessage:"index"}),value:e&&e.length>0?(e=>{const t=e.map(((t,s)=>Object(c.jsx)("p",{key:s},t,s<e.length-1?",":null)));return Object(c.jsx)("div",null,t)})(e):a.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexPlaceholder",{defaultMessage:"Select indices and a time field"}),isActive:m,onClick:()=>{h(!0)},isInvalid:!(e&&e.length>0&&""!==s)}),isOpen:m,closePopover:F,ownFocus:!0,anchorPosition:"downLeft",zIndex:8e3,display:"block"},Object(c.jsx)("div",{style:{width:"450px"}},Object(c.jsx)(o.EuiPopoverTitle,null,Object(c.jsx)(o.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(c.jsx)(o.EuiFlexItem,null,a.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexButtonLabel",{defaultMessage:"index"})),Object(c.jsx)(o.EuiFlexItem,{grow:!1},Object(c.jsx)(o.EuiButtonIcon,{"data-test-subj":"closePopover",iconType:"cross",color:"danger","aria-label":a.i18n.translate("xpack.stackAlerts.components.ui.alertParams.closeIndexPopoverLabel",{defaultMessage:"Close"}),onClick:F})))),Object(c.jsx)(o.EuiFormRow,{id:"indexSelectSearchBox",fullWidth:!0,label:Object(c.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.indicesToQueryLabel",defaultMessage:"Indices to query"}),isInvalid:d.index.length>0&&null!=e&&e.length>0,error:d.index,helpText:Object(c.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.howToBroadenSearchQueryDescription",defaultMessage:"Use * to broaden your query."})},Object(c.jsx)(o.EuiComboBox,{fullWidth:!0,async:!0,isLoading:O,isInvalid:d.index.length>0&&null!=e&&e.length>0,noSuggestions:!j.length,options:j,"data-test-subj":"thresholdIndexesComboBox",selectedOptions:(e||[]).map((e=>({label:e,value:e}))),onChange:async e=>{const t=e.map((e=>e.value)).filter(i.isString);if(p(t),0===t.length)S([u.firstFieldOption]);else{const e=await Object(u.getFields)(b,t),s=Object(u.getTimeFieldOptions)(e);S([u.firstFieldOption,...s])}},onSearchChange:E,onBlur:()=>{e||p([])}})),Object(c.jsx)(o.EuiFormRow,{id:"thresholdTimeField",fullWidth:!0,label:Object(c.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.timeFieldLabel",defaultMessage:"Time field"}),isInvalid:d.timeField.length>0&&void 0!==s,error:d.timeField},Object(c.jsx)(o.EuiSelect,{options:f,isInvalid:d.timeField.length>0&&void 0!==s,fullWidth:!0,name:"thresholdTimeField","data-test-subj":"thresholdAlertTimeFieldSelect",value:s||"",onChange:e=>{g(e.target.value)},onBlur:()=>{void 0===s&&g("")}}))))}},42:function(e,t,s){"use strict";e.exports=function e(t,s){if(t===s)return!0;if(t&&s&&"object"==typeof t&&"object"==typeof s){if(t.constructor!==s.constructor)return!1;var r,a,i;if(Array.isArray(t)){if((r=t.length)!=s.length)return!1;for(a=r;0!=a--;)if(!e(t[a],s[a]))return!1;return!0}if(t.constructor===RegExp)return t.source===s.source&&t.flags===s.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===s.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===s.toString();if((r=(i=Object.keys(t)).length)!==Object.keys(s).length)return!1;for(a=r;0!=a--;)if(!Object.prototype.hasOwnProperty.call(s,i[a]))return!1;for(a=r;0!=a--;){var l=i[a];if(!e(t[l],s[l]))return!1}return!0}return t!=t&&s!=s}},49:function(e,t){ace.define("ace/theme/github",["require","exports","module","ace/lib/dom"],(function(e,t,s){t.isDark=!1,t.cssClass="ace-github",t.cssText='.ace-github .ace_gutter {background: #e8e8e8;color: #AAA;}.ace-github  {background: #fff;color: #000;}.ace-github .ace_keyword {font-weight: bold;}.ace-github .ace_string {color: #D14;}.ace-github .ace_variable.ace_class {color: teal;}.ace-github .ace_constant.ace_numeric {color: #099;}.ace-github .ace_constant.ace_buildin {color: #0086B3;}.ace-github .ace_support.ace_function {color: #0086B3;}.ace-github .ace_comment {color: #998;font-style: italic;}.ace-github .ace_variable.ace_language  {color: #0086B3;}.ace-github .ace_paren {font-weight: bold;}.ace-github .ace_boolean {font-weight: bold;}.ace-github .ace_string.ace_regexp {color: #009926;font-weight: normal;}.ace-github .ace_variable.ace_instance {color: teal;}.ace-github .ace_constant.ace_language {font-weight: bold;}.ace-github .ace_cursor {color: black;}.ace-github.ace_focus .ace_marker-layer .ace_active-line {background: rgb(255, 255, 204);}.ace-github .ace_marker-layer .ace_active-line {background: rgb(245, 245, 245);}.ace-github .ace_marker-layer .ace_selection {background: rgb(181, 213, 255);}.ace-github.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px white;}.ace-github.ace_nobold .ace_line > span {font-weight: normal !important;}.ace-github .ace_marker-layer .ace_step {background: rgb(252, 255, 0);}.ace-github .ace_marker-layer .ace_stack {background: rgb(164, 229, 101);}.ace-github .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgb(192, 192, 192);}.ace-github .ace_gutter-active-line {background-color : rgba(0, 0, 0, 0.07);}.ace-github .ace_marker-layer .ace_selected-word {background: rgb(250, 250, 255);border: 1px solid rgb(200, 200, 250);}.ace-github .ace_invisible {color: #BFBFBF}.ace-github .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-github .ace_indent-guide {background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;}',e("../lib/dom").importCssString(t.cssText,t.cssClass)}))},50:function(e,t,s){switch(window.__kbnThemeTag__){case"v8dark":return s(51);case"v8light":return s(53)}},51:function(e,t,s){var r=s(38),a=s(52);"string"==typeof(a=a.__esModule?a.default:a)&&(a=[[e.i,a,""]]);r(a,{insert:"head",singleton:!1}),e.exports=a.locals||{}},52:function(e,t,s){(t=s(39)(!1)).push([e.i,".searchSourceAlertFilters .euiExpression__value{width:80%}.dscExpressionParam.euiExpression{margin-left:0}",""]),e.exports=t},53:function(e,t,s){var r=s(38),a=s(54);"string"==typeof(a=a.__esModule?a.default:a)&&(a=[[e.i,a,""]]);r(a,{insert:"head",singleton:!1}),e.exports=a.locals||{}},54:function(e,t,s){(t=s(39)(!1)).push([e.i,".searchSourceAlertFilters .euiExpression__value{width:80%}.dscExpressionParam.euiExpression{margin-left:0}",""]),e.exports=t},58:function(e,t,s){"use strict";s.r(t);var r=s(40),a=s.n(r),i=s(2),l=s.n(i),o=s(42),n=s.n(o),u=(s(49),s(4)),c=s(0);s(50);let d=function(e){return e.esQuery="esQuery",e.searchSource="searchSource",e.esqlQuery="esqlQuery",e}({});var p=s(23),g=s(11),b=s(30),m=s(12),h=s(37),j=s(17),y=s(8),O=s(14),x=s(1),f=s(7),S=s(5),E=s(3);const F=({esFields:e,onChangeSourceFields:t,errors:s,sourceFields:r})=>{const[a,l]=Object(i.useState)([]);return Object(i.useEffect)((()=>{const s=Object(f.uniqBy)(e.filter((e=>e.aggregatable)).flatMap((e=>{const t=S.e.find((t=>e.name===t||e.name===`${t}.keyword`));return t?[{label:t,value:e.name,"data-test-subj":`option-${t}`}]:[]})),"label");if(l(s),!r){const e=[];s.forEach((t=>{t.value&&e.length<S.d&&e.push({label:t.label,searchPath:t.value})})),t(e)}}),[e]),a.length>0?Object(E.jsx)(u.EuiFormRow,{fullWidth:!0,isInvalid:s.length>0&&void 0!==r,error:s,label:Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.components.ui.sourceFieldsSelect.title",defaultMessage:"Add more fields to alert details"})},Object(E.jsx)(u.EuiComboBox,{fullWidth:!0,placeholder:c.i18n.translate("xpack.stackAlerts.components.ui.sourceFieldsSelect.placeholder",{defaultMessage:"Select fields"}),"data-test-subj":"sourceFields",isInvalid:s.length>0&&void 0!==r,selectedOptions:(r||[]).map((e=>({label:e.label,value:e.searchPath,"data-test-subj":`option-${e.label}`}))),onChange:e=>{const s=[];e.forEach((e=>{e.value&&s.push({label:e.label,searchPath:e.value})})),t(s)},options:a})):null},v={result:null,error:null,isLoading:!1,rawResults:null,alerts:null},T={grid:{name:"q13xr8",styles:".euiDataGridHeaderCell{background:none;}.euiDataGridHeader .euiDataGridHeaderCell{border-top:none;}"}},w=({rawResults:e,alerts:t})=>Object(E.jsx)(u.EuiPanel,{style:{overflow:"hidden"},hasShadow:!1,hasBorder:!0},Object(E.jsx)(u.EuiDataGrid,{css:T.grid,"aria-label":c.i18n.translate("xpack.stackAlerts.esQuery.ui.testQueryTableAriaLabel",{defaultMessage:"Test query grid"}),"data-test-subj":"test-query-row-datagrid",columns:e.cols,columnVisibility:{visibleColumns:e.cols.map((e=>e.id)),setVisibleColumns:()=>{}},rowCount:e.rows.length,gridStyle:{border:"horizontal",rowHover:"none"},renderCellValue:({rowIndex:t,columnId:s})=>{var r;return null!==(r=e.rows[t][s])&&void 0!==r?r:"â€”"},pagination:{pageIndex:0,pageSize:10,onChangeItemsPerPage:()=>{},onChangePage:()=>{}},toolbarVisibility:!1}),Object(E.jsx)(u.EuiSpacer,{size:"m"}),t&&Object(E.jsx)(u.EuiFlexGroup,{gutterSize:"m"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiText,null,Object(E.jsx)("h5",null,c.i18n.translate("xpack.stackAlerts.esQuery.ui.testQueryAlerts",{defaultMessage:"Alerts generated"})))),t.map(((e,t)=>Object(E.jsx)(u.EuiFlexItem,{key:t,grow:!1},Object(E.jsx)(u.EuiBadge,{"data-test-subj":"alert-badge",color:"primary"},e)))))),C=({fetch:e,copyQuery:t,hasValidationErrors:s,showTable:r})=>{const{onTestQuery:a,testQueryResult:o,testQueryError:n,testQueryLoading:d,testQueryRawResults:p,testQueryAlerts:b}=function(e){const[t,s]=Object(i.useState)(v);return Object(i.useEffect)((()=>{s(v)}),[e]),{onTestQuery:Object(i.useCallback)((async()=>{s({result:null,error:null,isLoading:!0,rawResults:null,alerts:null});try{const{testResults:r,isGrouped:a,timeWindow:i,rawResults:l}=await e();if(a)s({result:c.i18n.translate("xpack.stackAlerts.esQuery.ui.testQueryGroupedResponse",{defaultMessage:"Grouped query matched {groups} groups in the last {window}.",values:{groups:r.results.length,window:i}}),error:null,isLoading:!1,rawResults:null!=l?l:null,alerts:r.results.length>0?r.results.map((e=>e.group)):null});else{var t;const e=r.results.length>0?r.results[0]:{count:0};s({result:c.i18n.translate("xpack.stackAlerts.esQuery.ui.numQueryMatchesText",{defaultMessage:"Query matched {count} documents in the last {window}.",values:{count:null!==(t=null==e?void 0:e.count)&&void 0!==t?t:0,window:i}}),error:null,isLoading:!1,rawResults:null!=l?l:null,alerts:e.count>0?["query matched"]:null})}}catch(e){var r,a,i,l,o;const t=(null==e||null===(r=e.body)||void 0===r||null===(a=r.attributes)||void 0===a||null===(i=a.error)||void 0===i||null===(l=i.root_cause[0])||void 0===l?void 0:l.reason)||(null==e||null===(o=e.body)||void 0===o?void 0:o.message);s({result:null,error:c.i18n.translate("xpack.stackAlerts.esQuery.ui.queryError",{defaultMessage:"Error testing query: {message}",values:{message:t?`${e.message}: ${t}`:e.message}}),isLoading:!1,rawResults:null,alerts:null})}}),[e]),testQueryResult:t.result,testQueryError:t.error,testQueryLoading:t.isLoading,testQueryRawResults:t.rawResults,testQueryAlerts:t.alerts}}(e),[m,h]=Object(i.useState)(null);return Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",responsive:!1,gutterSize:"s"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiButton,{"data-test-subj":"testQuery",color:"primary",iconSide:"left",iconType:"playFilled",onClick:()=>{a()},disabled:s,isLoading:d,size:"s"},Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.testQuery",defaultMessage:"Test query"}))),t&&Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiToolTip,{content:m,onMouseOut:()=>{h(null)}},Object(E.jsx)(u.EuiButtonEmpty,{"data-test-subj":"copyQuery",color:"primary",iconSide:"left",iconType:"copyClipboard",onClick:()=>{Object(u.copyToClipboard)(t())&&h(Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.queryCopiedToClipboard",defaultMessage:"Copied"}))},disabled:s,isLoading:d,size:"s"},Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.copyQuery",defaultMessage:"Copy query"})))))),d&&Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiText,{color:"subdued",size:"s"},Object(E.jsx)("p",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.testQueryIsExecuted",defaultMessage:"Query is executed."})))),o&&Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiText,{"data-test-subj":"testQuerySuccess",color:"subdued",size:"s"},Object(E.jsx)("p",null,o))),n&&Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiText,{"data-test-subj":"testQueryError",color:"danger",size:"s"},Object(E.jsx)("p",null,n))),r&&p&&Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(w,{rawResults:p,alerts:b})))};var k=s(15),_=s.n(k);const A={name:"1y0ex1",styles:"max-width:400px"};class threshold_help_popover_QueryThresholdHelpPopover extends i.Component{constructor(...e){super(...e),_()(this,"state",{isPopoverOpen:!1}),_()(this,"PopoverStyles",{name:"1y0ex1",styles:"max-width:400px"}),_()(this,"_togglePopover",(()=>{this.setState((e=>({isPopoverOpen:!e.isPopoverOpen})))})),_()(this,"_closePopover",(()=>{this.setState({isPopoverOpen:!1})}))}_renderContent(){return Object(E.jsx)("div",{css:A},Object(E.jsx)(u.EuiText,{grow:!1,size:"s"},Object(E.jsx)("p",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.threshold",defaultMessage:"Each time the rule runs, it checks whether the number of documents that match your query meets this threshold. If there is a grouped over clause, the rule checks the condition for the specified number of top groups."})),Object(E.jsx)("p",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.timeWindow",defaultMessage:"The time window indicates how far back in time to search. To avoid gaps in detection, set this value greater than or equal to the value you chose for the {checkField} field.",values:{checkField:Object(E.jsx)("b",null,"Check every")}})),Object(E.jsx)("p",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.duplicateMatches",defaultMessage:"If {excludePrevious} is turned on, a document that matches the query in multiple runs will be used in only the first threshold calculation.",values:{excludePrevious:Object(E.jsx)("b",null,"Exclude matches from previous runs")}}))))}render(){return Object(E.jsx)(u.EuiPopover,{id:"thresholdHelpPopover","data-test-subj":"thresholdHelpPopover",anchorPosition:"upLeft",button:Object(E.jsx)(u.EuiButtonIcon,{onClick:this._togglePopover,iconType:"documentation","aria-label":c.i18n.translate("xpack.stackAlerts.esQuery.ui.thresholdHelp.ariaLabel",{defaultMessage:"Help"})}),isOpen:this.state.isPopoverOpen,closePopover:this._closePopover,repositionOnScroll:!0,ownFocus:!0},Object(E.jsx)(u.EuiPopoverTitle,null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.title",defaultMessage:"Set the group, threshold and time window"})),this._renderContent())}}const R=({esFields:e,thresholdComparator:t,threshold:s,timeWindowSize:r,timeWindowUnit:a,aggType:o,aggField:n,groupBy:d,termField:p,termSize:b,size:h,sourceFields:j,errors:O,hasValidationErrors:f,onChangeSelectedAggField:S,onChangeSelectedAggType:v,onChangeSelectedGroupBy:T,onChangeSelectedTermField:w,onChangeSelectedTermSize:k,onChangeThreshold:_,onChangeThresholdComparator:A,onChangeWindowSize:R,onChangeWindowUnit:I,onChangeSizeValue:Q,onTestFetch:P,onCopyQuery:M,excludeHitsFromPreviousRun:z,onChangeExcludeHitsFromPreviousRun:W,canSelectMultiTerms:L,onChangeSourceFields:q})=>{const[D,B]=Object(i.useState)(!1);return Object(i.useEffect)((()=>{d&&B(d!==m.builtInGroupByTypes.all.value)}),[d]),Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiFormRow,{fullWidth:!0,label:[Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.conditionsPrompt",defaultMessage:"Set the group, threshold, and time window"}),Object(E.jsx)(threshold_help_popover_QueryThresholdHelpPopover,null)]},Object(E.jsx)(x.WhenExpression,{display:"fullWidth","data-test-subj":"whenExpression",aggType:null!=o?o:y.c.AGGREGATION_TYPE,onChangeSelectedAggType:v})),o&&x.builtInAggregationTypes[o].fieldRequired?Object(E.jsx)(x.OfExpression,{aggField:n,"data-test-subj":"aggTypeExpression",fields:e,aggType:o,errors:O,display:"fullWidth",onChangeSelectedAggField:S}):null,Object(E.jsx)(x.GroupByExpression,{groupBy:d||y.c.GROUP_BY,"data-test-subj":"groupByExpression",termField:p,termSize:b,errors:O,fields:e,display:"fullWidth",canSelectMultiTerms:L,onChangeSelectedGroupBy:T,onChangeSelectedTermField:w,onChangeSelectedTermSize:k}),Object(E.jsx)(x.ThresholdExpression,{"data-test-subj":"thresholdExpression",thresholdComparator:null!=t?t:y.c.THRESHOLD_COMPARATOR,threshold:null!=s?s:y.c.THRESHOLD,errors:O,display:"fullWidth",popupPosition:"upLeft",onChangeSelectedThreshold:_,onChangeSelectedThresholdComparator:A}),Object(E.jsx)(x.ForLastExpression,{"data-test-subj":"forLastExpression",popupPosition:"upLeft",timeWindowSize:null!=r?r:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!=a?a:y.c.TIME_WINDOW_UNIT,display:"fullWidth",errors:O,onChangeWindowSize:R,onChangeWindowUnit:I}),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiFormRow,{fullWidth:!0,label:[Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectSizePrompt",defaultMessage:"Set the number of documents to send"}),Object(E.jsx)(u.EuiIconTip,{position:"right",color:"subdued",type:"questionInCircle",content:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectSizePrompt.toolTip",{defaultMessage:"Specify the number of documents to pass to the configured actions when the threshold condition is met."})})]},Object(E.jsx)(x.ValueExpression,{description:c.i18n.translate("xpack.stackAlerts.esQuery.ui.sizeExpression",{defaultMessage:"Size"}),"data-test-subj":"sizeValueExpression",value:h,errors:O.size,display:"fullWidth",popupPosition:"upLeft",onChangeSelectedValue:Q})),Object(E.jsx)(u.EuiSpacer,{size:"m"}),Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiCheckbox,{disabled:D,"data-test-subj":"excludeHitsFromPreviousRunExpression",checked:z,id:"excludeHitsFromPreviousRunExpressionId",onChange:e=>{W(e.target.checked)},label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.excludePreviousHitsExpression",{defaultMessage:"Exclude matches from previous runs"})})),Object(E.jsx)(F,{onChangeSourceFields:q,esFields:e,sourceFields:j,errors:O.sourceFields}),Object(E.jsx)(u.EuiSpacer,{size:"m"}),Object(E.jsx)(C,{fetch:P,copyQuery:M,hasValidationErrors:f}))};var I=s(6),Q=s(13);const P=["pinFilter","disableFilter"],M=e=>{var t,s,r,a,o,c,d,x;const f=Object(I.e)().unifiedSearch,{dataViews:S,dataViewEditor:F,isServerless:v}=Object(I.e)(),{searchSource:T,errors:w,initialSavedQuery:C,setParam:k,ruleParams:_}=e,[A,M]=Object(i.useState)();Object(i.useEffect)((()=>M(C)),[C]);const[z,W]=Object(i.useReducer)(((e,t)=>{var s;return(e=>"filter"===e.type||"index"===e.type||"query"===e.type)(t)?(T.setParent(void 0).setField(t.type,t.payload),k("searchConfiguration",T.getSerializedFields()),"index"===t.type&&k("timeField",null===(s=T.getField("index"))||void 0===s?void 0:s.timeFieldName)):k(t.type,t.payload),{...e,[t.type]:t.payload}}),{index:T.getField("index"),query:T.getField("query"),filter:Object(b.mapAndFlattenFilters)(T.getField("filter")),threshold:null!==(t=_.threshold)&&void 0!==t?t:y.c.THRESHOLD,thresholdComparator:null!==(s=_.thresholdComparator)&&void 0!==s?s:y.c.THRESHOLD_COMPARATOR,timeWindowSize:null!==(r=_.timeWindowSize)&&void 0!==r?r:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!==(a=_.timeWindowUnit)&&void 0!==a?a:y.c.TIME_WINDOW_UNIT,aggType:null!==(o=_.aggType)&&void 0!==o?o:y.c.AGGREGATION_TYPE,aggField:_.aggField,groupBy:null!==(c=_.groupBy)&&void 0!==c?c:y.c.GROUP_BY,termSize:null!==(d=_.termSize)&&void 0!==d?d:y.c.TERM_SIZE,termField:_.termField,size:_.size?_.size:v?y.g.SIZE:y.c.SIZE,excludeHitsFromPreviousRun:null!==(x=_.excludeHitsFromPreviousRun)&&void 0!==x?x:y.c.EXCLUDE_PREVIOUS_HITS,sourceFields:_.sourceFields}),{index:L,query:q,filter:D}=z,B=Object(i.useMemo)((()=>L?[L]:[]),[L]),[H,U]=Object(i.useState)(L?Object(I.a)(L.fields.map((e=>e.toSpec()))):[]),G=Object(i.useCallback)((e=>{W({type:"index",payload:e}),W({type:"sourceFields",payload:void 0}),U(Object(I.a)(e.fields.map((e=>e.toSpec()))))}),[]),N=Object(i.useCallback)((e=>{W({type:"filter",payload:Object(b.mapAndFlattenFilters)(e)})}),[]),V=Object(i.useCallback)((({query:e})=>{n()(e,q)||W({type:"query",payload:e||{...q,query:""}})}),[q]),Z=Object(i.useCallback)((e=>{M(e);const t=e.attributes.filters;t&&W({type:"filter",payload:t})}),[]),Y=Object(i.useCallback)((e=>W({type:"timeWindowUnit",payload:e})),[]),$=Object(i.useCallback)((e=>e&&W({type:"timeWindowSize",payload:e})),[]),J=Object(i.useCallback)((e=>e&&W({type:"thresholdComparator",payload:e})),[]),X=Object(i.useCallback)((e=>W({type:"aggField",payload:e})),[]),K=Object(i.useCallback)((e=>W({type:"aggType",payload:e})),[]),ee=Object(i.useCallback)((e=>e&&W({type:"groupBy",payload:e})),[]),te=Object(i.useCallback)((e=>W({type:"termField",payload:e})),[]),se=Object(i.useCallback)((e=>e&&W({type:"termSize",payload:e})),[]),re=Object(i.useCallback)((e=>e&&W({type:"threshold",payload:e})),[]),ae=Object(i.useCallback)((e=>W({type:"size",payload:e})),[]),ie=Object(i.useCallback)((e=>W({type:"excludeHitsFromPreviousRun",payload:e})),[]),le=Object(i.useCallback)((e=>W({type:"sourceFields",payload:e})),[]),oe=`${z.timeWindowSize}${z.timeWindowUnit}`,ne=Object(i.useCallback)((()=>{var e;const t=T.createCopy(),s=Object(b.getTime)(T.getField("index"),{from:`now-${oe}`,to:"now"});return t.setField("filter",s?[s,...z.filter]:z.filter),t.setField("aggs",Object(m.buildAggregation)({aggType:_.aggType,aggField:_.aggField,termField:_.termField,termSize:_.termSize,condition:{conditionScript:Object(j.getComparatorScript)(null!==(e=_.thresholdComparator)&&void 0!==e?e:y.c.THRESHOLD_COMPARATOR,_.threshold,m.BUCKET_SELECTOR_FIELD)}})),t}),[T,oe,z,_.aggType,_.aggField,_.termField,_.termSize,_.threshold,_.thresholdComparator]),ue=Object(i.useCallback)((()=>{const e=ne();return JSON.stringify(e.getSearchRequestBody(),null,2)}),[ne]),ce=Object(i.useCallback)((async()=>{const e=Object(m.isGroupAggregation)(_.termField),t=Object(m.isCountAggregation)(_.aggType),s=ne(),{rawResponse:r}=await Object(p.lastValueFrom)(s.fetch$());return{testResults:Object(m.parseAggregationResults)({isCountAgg:t,isGroupAgg:e,esResult:r}),isGrouped:e,timeWindow:oe}}),[oe,ne,_.aggType,_.termField]);return Object(E.jsx)(i.Fragment,null,Object(E.jsx)(u.EuiFormRow,{fullWidth:!0,label:Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectDataViewPrompt",defaultMessage:"Select a data view"})},Object(E.jsx)(O.a,{dependencies:{dataViews:S,dataViewEditor:F},dataView:L,metadata:e.metadata,onSelectDataView:G,onChangeMetaData:e.onChangeMetaData})),Boolean(null==L?void 0:L.id)&&Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.defineTextQueryPrompt",defaultMessage:"Define your query"}))),Object(E.jsx)(u.EuiSpacer,{size:"xs"}),Object(E.jsx)(f.ui.SearchBar,{appName:h.b,onQuerySubmit:({query:e})=>{(null==e?void 0:e.language)!==q.language&&W({type:"query",payload:{...q,language:null==e?void 0:e.language}})},onQueryChange:V,suggestionsSize:"s",displayStyle:"inPage",query:q,indexPatterns:B,savedQuery:A,filters:D,onFiltersUpdated:N,onClearSavedQuery:()=>{M(void 0),W({type:"query",payload:{...q,query:""}})},onSavedQueryUpdated:Z,onSaved:Z,saveQueryMenuVisibility:"allowed_by_app_privilege",showQueryInput:!0,showFilterBar:!0,showDatePicker:!1,showAutoRefreshOnly:!1,showSubmitButton:!1,dateRangeFrom:void 0,dateRangeTo:void 0,hiddenFilterPanelOptions:P})),Object(E.jsx)(u.EuiSpacer,{size:"m"}),Object(E.jsx)(R,{threshold:z.threshold,thresholdComparator:z.thresholdComparator,timeWindowSize:z.timeWindowSize,timeWindowUnit:z.timeWindowUnit,size:z.size,esFields:H,aggType:z.aggType,aggField:z.aggField,groupBy:z.groupBy,termSize:z.termSize,termField:z.termField,onChangeSelectedAggField:X,onChangeSelectedAggType:K,onChangeSelectedGroupBy:ee,onChangeSelectedTermField:te,onChangeSelectedTermSize:se,onChangeThreshold:re,onChangeThresholdComparator:J,onChangeWindowSize:$,onChangeWindowUnit:Y,onChangeSizeValue:ae,errors:w,hasValidationErrors:Object(Q.a)(e.ruleParams,v),onTestFetch:ce,onCopyQuery:ue,excludeHitsFromPreviousRun:z.excludeHitsFromPreviousRun,onChangeExcludeHitsFromPreviousRun:ie,canSelectMultiTerms:y.c.CAN_SELECT_MULTI_TERMS,onChangeSourceFields:le,sourceFields:z.sourceFields}),Object(E.jsx)(u.EuiSpacer,null))},z=({ruleParams:e,errors:t,setRuleParams:s,setRuleProperty:r,metadata:a,onChangeMetaData:o})=>{const{thresholdComparator:n,threshold:c,timeWindowSize:p,timeWindowUnit:g,size:b,savedQueryId:m,searchConfiguration:h,aggType:j,aggField:O,groupBy:x,termField:f,termSize:S,excludeHitsFromPreviousRun:F,sourceFields:v}=e,{data:T,isServerless:w}=Object(I.e)(),[C,k]=Object(i.useState)(),[_,A]=Object(i.useState)(),[R,Q]=Object(i.useState)(),P=Object(i.useCallback)(((e,t)=>{s(e,t)}),[s]);return Object(i.useEffect)((()=>{(async()=>{let e=h;if(!h){const t=T.search.searchSource.createEmpty();t.setField("query",T.query.queryString.getDefaultQuery());const s=await T.dataViews.getDefaultDataView();s&&t.setField("index",s),e=t.getSerializedFields()}try{var t;const s=await T.search.searchSource.create(e);r("params",{searchConfiguration:e,timeField:null===(t=s.getField("index"))||void 0===t?void 0:t.timeFieldName,searchType:d.searchSource,timeWindowSize:null!=p?p:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!=g?g:y.c.TIME_WINDOW_UNIT,threshold:null!=c?c:y.c.THRESHOLD,thresholdComparator:null!=n?n:y.c.THRESHOLD_COMPARATOR,size:b||(w?y.g.SIZE:y.c.SIZE),aggType:null!=j?j:y.c.AGGREGATION_TYPE,aggField:O,groupBy:null!=x?x:y.c.GROUP_BY,termField:f,termSize:null!=S?S:y.c.TERM_SIZE,excludeHitsFromPreviousRun:null!=F?F:y.c.EXCLUDE_PREVIOUS_HITS,sourceFields:v}),k(s)}catch(e){Q(e)}})()}),[T.search.searchSource,T.dataViews]),Object(i.useEffect)((()=>{m&&T.query.savedQueries.getSavedQuery(m).then(A)}),[T.query.savedQueries,m]),R?Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiCallOut,{color:"danger",iconType:"warning"},Object(E.jsx)("p",null,R.message)),Object(E.jsx)(u.EuiSpacer,{size:"s"})):C?Object(E.jsx)(M,{ruleParams:e,searchSource:C,errors:t,initialSavedQuery:_,setParam:P,metadata:a,onChangeMetaData:o}):Object(E.jsx)(u.EuiEmptyPrompt,{title:Object(E.jsx)(u.EuiLoadingSpinner,{size:"xl"})})};var W=s(31),L=s(32),q=s(25);const D=({aggs:e,index:t,from:s,to:r,filter:a,size:i,searchAfterSortId:l,sortOrder:o,timeField:n,track_total_hits:u,fields:c,runtime_mappings:d,_source:p})=>{const g=n,b={allow_no_indices:!0,index:t,size:i,ignore_unavailable:!0,track_total_hits:null!=u&&u,body:{docvalue_fields:[n].map((e=>({field:e,format:"strict_date_optional_time"}))),query:{bool:{filter:[a,{bool:{filter:[{range:{[n]:{lte:r,gte:s,format:"strict_date_optional_time"}}}]}}]}},...e?{aggs:e}:{},sort:[{[g]:{order:null!=o?o:"asc",format:"strict_date_optional_time||epoch_millis"}}]},...d?{runtime_mappings:d}:{},...c?{fields:c}:{},...null!=p?{_source:p}:{}};return l?{...b,body:{...b.body,search_after:[l]}}:b};var B=s(41);const{useXJsonMode:H}=W.XJson,U=({ruleParams:e,setRuleParams:t,setRuleProperty:s,errors:r,data:a})=>{const l=Object(I.e)(),{http:o,docLinks:n,isServerless:b}=l,{index:h,timeField:O,esQuery:S,size:F,thresholdComparator:v,threshold:T,timeWindowSize:w,timeWindowUnit:C,aggType:k,aggField:_,groupBy:A,termSize:P,termField:M,excludeHitsFromPreviousRun:z,sourceFields:W}=e,[U,G]=Object(i.useState)({...e,timeWindowSize:null!=w?w:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!=C?C:y.c.TIME_WINDOW_UNIT,threshold:null!=T?T:y.c.THRESHOLD,thresholdComparator:null!=v?v:y.c.THRESHOLD_COMPARATOR,size:F||(b?y.g.SIZE:y.c.SIZE),esQuery:null!=S?S:y.c.QUERY,aggType:null!=k?k:y.c.AGGREGATION_TYPE,groupBy:null!=A?A:y.c.GROUP_BY,termSize:null!=P?P:y.c.TERM_SIZE,searchType:d.esQuery,excludeHitsFromPreviousRun:null!=z?z:y.c.EXCLUDE_PREVIOUS_HITS,sourceFields:W}),N=Object(i.useCallback)(((e,s)=>{G((t=>({...t,[e]:s}))),t(e,s)}),[t]),[V,Z]=Object(i.useState)([]),[Y,$]=Object(i.useState)([]),[J,X]=Object(i.useState)([]),{convertToJson:K,setXJson:ee,xJson:te}=H(y.c.QUERY);Object(i.useEffect)((()=>{(async()=>{s("params",U),ee(null!=S?S:y.c.QUERY),h&&h.length>0&&await se(h)})()}),[]);const se=async e=>{const t=await Object(x.getFields)(o,e);Z(t),X(Object(f.sortBy)(t.concat(Y),"name"))},re=Object(i.useCallback)((async()=>{const e=Object(m.isGroupAggregation)(M),t=Object(m.isCountAggregation)(k),s=`${w}${C}`;if(Object(Q.a)(U,b))return{testResults:{results:[],truncated:!1},isGrouped:e,timeWindow:s};const r=Object(q.parseDuration)(s),i=JSON.parse(S),l=Date.now(),{rawResponse:o}=await Object(p.lastValueFrom)(a.search.search({params:D({index:h,from:new Date(l-r).toISOString(),to:new Date(l).toISOString(),filter:i.query,size:0,searchAfterSortId:void 0,timeField:O||"",track_total_hits:!0,aggs:Object(m.buildAggregation)({aggType:k,aggField:_,termField:M,termSize:P,condition:{conditionScript:Object(j.getComparatorScript)(null!=v?v:y.c.THRESHOLD_COMPARATOR,T,m.BUCKET_SELECTOR_FIELD)}})})}));return{testResults:Object(m.parseAggregationResults)({isCountAgg:t,isGroupAgg:e,esResult:o}),isGrouped:e,timeWindow:s}}),[w,C,U,S,a.search,h,O,k,_,M,P,T,v,b]);return Object(E.jsx)(i.Fragment,null,Object(E.jsx)(u.EuiFormRow,{fullWidth:!0,label:Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectIndexPrompt",defaultMessage:"Select indices"})},Object(E.jsx)(B.a,{index:h,"data-test-subj":"indexSelectPopover",esFields:V,timeField:O,errors:r,onIndexChange:async t=>{N("index",t),0===t.length?s("params",{timeField:e.timeField,index:t,esQuery:y.c.QUERY,size:y.c.SIZE,thresholdComparator:y.c.THRESHOLD_COMPARATOR,timeWindowSize:y.c.TIME_WINDOW_SIZE,timeWindowUnit:y.c.TIME_WINDOW_UNIT,threshold:y.c.THRESHOLD,aggType:y.c.AGGREGATION_TYPE,groupBy:y.c.GROUP_BY,termSize:y.c.TERM_SIZE,searchType:d.esQuery,excludeHitsFromPreviousRun:y.c.EXCLUDE_PREVIOUS_HITS,sourceFields:void 0}):await se(t)},onTimeFieldChange:e=>N("timeField",e)})),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiFormRow,{id:"queryEditor","data-test-subj":"queryJsonEditor",fullWidth:!0,isInvalid:r.esQuery.length>0,error:r.esQuery,helpText:Object(E.jsx)(u.EuiLink,{href:n.links.query.queryDsl,target:"_blank"},Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.queryPrompt.help",defaultMessage:"Elasticsearch Query DSL documentation"})),label:Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.defineQueryPrompt",defaultMessage:"Define your query using Query DSL"})},Object(E.jsx)(L.CodeEditor,{languageId:"xjson",width:"100%",height:"200px",value:te,onChange:e=>{ee(e),N("esQuery",K(e)),(e=>{let t;try{t=Object(f.get)(JSON.parse(e),"runtime_mappings")}catch(e){}if(t){const e=Object(I.b)(t);$(e),X(Object(f.sortBy)(V.concat(e),"name"))}})(e)},options:{ariaLabel:c.i18n.translate("xpack.stackAlerts.esQuery.ui.queryEditor",{defaultMessage:"Elasticsearch query editor"}),wordWrap:"off",tabSize:2,lineNumbers:"off",lineNumbersMinChars:0,folding:!1,lineDecorationsWidth:0,overviewRulerBorder:!1}})),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(R,{threshold:null!=T?T:y.c.THRESHOLD,thresholdComparator:null!=v?v:y.c.THRESHOLD_COMPARATOR,timeWindowSize:w,timeWindowUnit:C,size:F,esFields:J,aggType:k,aggField:_,groupBy:A,termSize:P,termField:M,onChangeSelectedAggField:Object(i.useCallback)((e=>N("aggField",e)),[N]),onChangeSelectedAggType:Object(i.useCallback)((e=>N("aggType",e)),[N]),onChangeSelectedGroupBy:Object(i.useCallback)((e=>N("groupBy",e)),[N]),onChangeSelectedTermField:Object(i.useCallback)((e=>N("termField",e)),[N]),onChangeSelectedTermSize:Object(i.useCallback)((e=>N("termSize",e)),[N]),onChangeThreshold:Object(i.useCallback)((e=>N("threshold",e)),[N]),onChangeThresholdComparator:Object(i.useCallback)((e=>N("thresholdComparator",e)),[N]),onChangeWindowSize:Object(i.useCallback)((e=>N("timeWindowSize",e)),[N]),onChangeWindowUnit:Object(i.useCallback)((e=>N("timeWindowUnit",e)),[N]),onChangeSizeValue:Object(i.useCallback)((e=>N("size",e)),[N]),errors:r,hasValidationErrors:Object(Q.a)(U,b),onTestFetch:re,excludeHitsFromPreviousRun:null!=z?z:y.c.EXCLUDE_PREVIOUS_HITS,onChangeExcludeHitsFromPreviousRun:Object(i.useCallback)((e=>N("excludeHitsFromPreviousRun",e)),[N]),canSelectMultiTerms:y.c.CAN_SELECT_MULTI_TERMS,onChangeSourceFields:Object(i.useCallback)((e=>N("sourceFields",e)),[N]),sourceFields:W}),Object(E.jsx)(u.EuiSpacer,null))},G=l.a.memo((()=>Object(E.jsx)(u.EuiBetaBadge,{size:"s",label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.experimentalLabel",{defaultMessage:"Technical preview"}),tooltipContent:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.experimentalDescription",{defaultMessage:"This functionality is in technical preview and may be changed or removed completely in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features."}),tooltipPosition:"bottom"})));G.displayName="ExperimentalBadge";const N=({searchType:e,onFormTypeSelect:t})=>{const{uiSettings:s}=Object(I.e)(),r=null==s?void 0:s.get("enableESQL"),a=Object(i.useMemo)((()=>{const e=[{formType:d.searchSource,label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.kqlOrLuceneFormTypeLabel",{defaultMessage:"KQL or Lucene"}),description:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.kqlOrLuceneFormTypeDescription",{defaultMessage:"Use KQL or Lucene to define a text-based query."})},{formType:d.esQuery,label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.queryDslFormTypeLabel",{defaultMessage:"Query DSL"}),description:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.queryDslFormTypeDescription",{defaultMessage:"Use the Elasticsearch Query DSL to define a query."})}];return r&&e.push({formType:d.esqlQuery,label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.esqlFormTypeLabel",{defaultMessage:"ES|QL"}),description:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.esqlFormTypeDescription",{defaultMessage:"Use ES|QL to define a text-based query."})}),e}),[r]);if(e){const s=a.find((t=>t.formType===e));return Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",gutterSize:"s",responsive:!1},Object(E.jsx)(u.EuiFlexItem,null,Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiTitle,{size:"xs","data-test-subj":"selectedRuleFormTypeTitle"},Object(E.jsx)("h5",null,null==s?void 0:s.label))),(null==s?void 0:s.formType)===d.esqlQuery&&Object(E.jsx)(u.EuiFlexItem,null,Object(E.jsx)(G,null)))),Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiButtonIcon,{iconType:"cross",color:"danger","data-test-subj":"queryFormTypeChooserCancel","aria-label":c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.cancelSelectionAriaLabel",{defaultMessage:"Cancel selection"}),onClick:()=>t(null)}))),Object(E.jsx)(u.EuiText,{color:"subdued",size:"s","data-test-subj":"selectedRuleFormTypeDescription"},null==s?void 0:s.description),Object(E.jsx)(u.EuiSpacer,null))}return Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",{"data-test-subj":"queryFormTypeChooserTitle"},Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectQueryFormTypeLabel",defaultMessage:"Select a query type"}))),Object(E.jsx)(u.EuiListGroup,{flush:!0,gutterSize:"m",size:"m",maxWidth:!1},a.map((e=>Object(E.jsx)(u.EuiListGroupItem,{wrapText:!0,key:`form-type-${e.formType}`,"data-test-subj":`queryFormType_${e.formType}`,color:"primary",label:Object(E.jsx)("span",null,Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)("strong",null,e.label)),e.formType===d.esqlQuery&&Object(E.jsx)(u.EuiFlexItem,null,Object(E.jsx)(G,null))),Object(E.jsx)(u.EuiText,{color:"subdued",size:"s"},Object(E.jsx)("p",null,e.description))),onClick:()=>t(e.formType)})))),Object(E.jsx)(u.EuiSpacer,null))};var V=s(33),Z=s(35),Y=s(36),$=s(34);const J=({ruleParams:e,setRuleParams:t,setRuleProperty:s,errors:r})=>{const{expressions:a,http:l,fieldFormats:o,isServerless:n}=Object(I.e)(),{esqlQuery:c,timeWindowSize:b,timeWindowUnit:h,timeField:O}=e,[S,F]=Object(i.useState)({...e,timeWindowSize:null!=b?b:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!=h?h:y.c.TIME_WINDOW_UNIT,threshold:[0],thresholdComparator:y.c.THRESHOLD_COMPARATOR,size:n?y.g.SIZE:y.c.SIZE,esqlQuery:null!=c?c:{esql:""},aggType:y.c.AGGREGATION_TYPE,groupBy:y.c.GROUP_BY,termSize:y.c.TERM_SIZE,searchType:d.esqlQuery,sourceFields:[]}),[v,T]=Object(i.useState)({esql:""}),[w,k]=Object(i.useState)([m.firstFieldOption]),[_,A]=Object(i.useState)(!1),[R,P]=Object(i.useState)(!1),M=Object(i.useCallback)(((e,s)=>{F((t=>({...t,[e]:s}))),t(e,s)}),[t]);Object(i.useEffect)((()=>{(async()=>{s("params",S),T(null!=c?c:{esql:""}),c&&c.esql&&W(c),O&&k([m.firstFieldOption,{text:O,value:O}])})()}),[]);const z=Object(i.useCallback)((async()=>{const e=`${b}${h}`,t={testResults:{results:[],truncated:!1},isGrouped:!0,timeWindow:e};if(Object(Q.a)(S,n))return t;const s=Object(q.parseDuration)(e),r=Date.now();P(!0);const i=await function(e,t,s,r,a){return Object(Z.textBasedQueryStateToAstWithValidation)({query:e,time:s,dataView:a}).then((e=>{if(e){const s=t.execute(e,null),r=s.getData();let a,i;return r.pipe(Object(p.pluck)("result")).subscribe((e=>{const t=e;"error"===t.type?i=t.error.message:a=t})),Object(p.lastValueFrom)(r).then((()=>{if(i)throw new Error(i);return a}))}})).catch((e=>{throw new Error(e.message)}))}(c,a,{from:new Date(r-s).toISOString(),to:new Date(r).toISOString()},0,new $.DataView({spec:{timeFieldName:O},fieldFormats:o}));if(i){const t=Object(j.transformDatatableToEsqlTable)(i),s=Object(j.toEsQueryHits)(t);return P(!1),{testResults:Object(m.parseAggregationResults)({isCountAgg:!0,isGroupAgg:!1,esResult:{took:0,timed_out:!1,_shards:{failed:0,successful:0,total:0},hits:s}}),isGrouped:!1,timeWindow:e,rawResults:{cols:t.columns.map((e=>({id:e.name,actions:!1}))),rows:t.values.slice(0,5).map((e=>Object(j.rowToDocument)(t.columns,e)))}}}return t}),[b,h,S,c,a,o,O,n]),W=async e=>{let t=!1;const s=function(e){var t;const{ast:s}=Object(Y.getAstAndSyntaxErrors)(e),r=s.find((({name:e})=>["from","metrics"].includes(e))),a=(null!==(t=null==r?void 0:r.args)&&void 0!==t?t:[]).filter((e=>"index"===e.sourceType));return null==a?void 0:a.map((e=>e.text)).join(",")}(Object(f.get)(e,"esql")),r=await Object(x.getFields)(l,[s]),a=Object(m.getTimeFieldOptions)(r);k([m.firstFieldOption,...a]);const i=a.find((e=>"@timestamp"===e.value));i&&(M("timeField",i.value),t=!0),A(t)};return Object(E.jsx)(i.Fragment,null,Object(E.jsx)(u.EuiFormRow,{id:"queryEditor","data-test-subj":"queryEsqlEditor",fullWidth:!0,label:Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.defineEsqlQueryPrompt",defaultMessage:"Define your query using ES|QL"})},Object(E.jsx)(V.TextBasedLangEditor,{query:v,onTextLangQueryChange:e=>{T(e),M("esqlQuery",e),W(e)},expandCodeEditor:()=>!0,isCodeEditorExpanded:!0,onTextLangQuerySubmit:async()=>{},detectTimestamp:_,hideMinimizeButton:!0,hideRunQueryText:!0,isLoading:R})),Object(E.jsx)(u.EuiSpacer,null),Object(E.jsx)(u.EuiFormRow,{id:"timeField",fullWidth:!0,isInvalid:r.timeField.length>0&&void 0!==O,error:r.timeField,label:Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectEsqlQueryTimeFieldPrompt",defaultMessage:"Select a time field"})},Object(E.jsx)(u.EuiSelect,{options:w,isInvalid:r.timeField.length>0&&void 0!==O,fullWidth:!0,name:"timeField","data-test-subj":"timeFieldSelect",value:O||"",onChange:e=>{M("timeField",e.target.value)}})),Object(E.jsx)(u.EuiSpacer,null),Object(E.jsx)(u.EuiFlexGroup,{alignItems:"flexEnd"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiFormRow,{id:"timeWindowSize",isInvalid:r.timeWindowSize.length>0,error:r.timeWindowSize,label:Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.setEsqlQueryTimeWindowPrompt",defaultMessage:"Set the time window"})},Object(E.jsx)(u.EuiFieldNumber,{name:"timeWindowSize","data-test-subj":"timeWindowSizeNumber",isInvalid:r.timeWindowSize.length>0,min:0,value:b||"",onChange:e=>{const{value:t}=e.target,s=""!==t?parseInt(t,10):void 0;M("timeWindowSize",s)}}))),Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiFormRow,{id:"timeWindowUnit"},Object(E.jsx)(u.EuiSelect,{name:"timeWindowUnit","data-test-subj":"timeWindowUnitSelect",value:h,onChange:e=>{M("timeWindowUnit",e.target.value)},options:Object(m.getTimeOptions)(null!=b?b:1)})))),Object(E.jsx)(u.EuiSpacer,null),Object(E.jsx)(C,{fetch:z,hasValidationErrors:Object(Q.a)(S,n),showTable:!0}))};function X(e,t){const s=n()(e.errors,t.errors),r=n()(e.ruleParams,t.ruleParams);return s&&r}const K=Object(i.memo)(z,X);t.default=e=>{var t,s;const{ruleParams:r,errors:o,setRuleProperty:n,setRuleParams:d}=e,p=Object(I.d)(r),g=Object(I.c)(r),b=null===(t=null===(s=e.metadata)||void 0===s?void 0:s.isManagementPage)||void 0===t||t,m=Object(i.useCallback)((e=>{e?d("searchType",e):n("params",{})}),[d,n]),h=c.i18n.translate("xpack.stackAlerts.esQuery.ui.alertParams.fixErrorInExpressionBelowValidationMessage",{defaultMessage:"Expression contains errors."}),j=y.a.find((e=>{var t;return(null===(t=o[e])||void 0===t?void 0:t.length)>=1&&void 0!==r[e]})),O=!!j&&Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiCallOut,{color:"danger",size:"s","data-test-subj":"esQueryAlertExpressionError",title:["index","searchType","timeField"].includes(j)?o[j]:h}),Object(E.jsx)(u.EuiSpacer,null));return Object(E.jsx)(l.a.Fragment,null,O,b&&Object(E.jsx)(N,{searchType:r.searchType,onFormTypeSelect:m}),r.searchType&&p&&Object(E.jsx)(K,a()({},e,{ruleParams:r})),r.searchType&&!p&&!g&&Object(E.jsx)(U,a()({},e,{ruleParams:r})),r.searchType&&g&&Object(E.jsx)(J,a()({},e,{ruleParams:r})),Object(E.jsx)(u.EuiHorizontalRule,null))}}}]);