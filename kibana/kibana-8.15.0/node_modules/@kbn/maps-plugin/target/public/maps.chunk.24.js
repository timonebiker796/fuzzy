/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.maps_bundle_jsonpfunction=window.maps_bundle_jsonpfunction||[]).push([[24],{140:function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var a=n(53),i=n.n(a);const o={};let r,c,s;const l={getGeoFieldNames(){const e=[];return Object.values(o).forEach((t=>{e.push(...t.getGeoFieldNames())})),i.a.uniq(e)},getLocation:()=>r,getMapPanels:()=>Object.keys(o).map((e=>({...o[e],id:e}))),hasMultipleMaps:()=>Object.keys(o).length>1,register(e,t){o[e]=t},setLocation(e,t,n,a){c&&c!==e||(c=e,s&&clearTimeout(s),s=setTimeout((()=>{c=void 0}),500),r={lat:t,lon:n,zoom:a},Object.keys(o).forEach((i=>{if(i===e)return;const r=o[i];r.getIsMovementSynchronized()&&r.onLocationChange(t,n,a)})))},unregister(e){delete o[e],0===Object.keys(o).length&&(r=void 0)}}},649:function(e,t,n){"use strict";n.r(t),n.d(t,"getControlledBy",(function(){return G})),n.d(t,"mapEmbeddableFactory",(function(){return D}));var a=n(2),i=n(55),o=n(14),r=n(28),c=n(25),s=n(7),l=n(1),d=n(0),u=n(172),b=n(193),g=n(40),p=n.n(g),j=n(94),O=n(89),f=n(90),v=n(5),m=n(111);function S(e){return{...Object(O.r)(e),zoom:Object(O.x)(e)}}function h(e){return Object(O.p)(e).filter((e=>!e.visible)).map((e=>e.id))}var y=n(334),A=n(60),T=n(212),w=n(339),E=n(335),L=n(53),B=n.n(L),C=n(3),x=n(93),I=n(140);function F(e){if(0===e.length)return"";if(1===e.length)return e[0];const t=C.i18n.translate("xpack.maps.embeddable.geoFieldsConnector",{defaultMessage:" and "});return 2===e.length?e[0]+t+e[1]:e.slice(0,e.length-1).join(", ")+","+t+e[e.length-1]}var M=n(97),R=n(139);function P(e){const t=new l.BehaviorSubject(void 0);let n;async function a(){var a;const i=Object(O.C)(e.getState()),o=null===(a=t.getValue())||void 0===a?void 0:a.map((e=>e.id));if(Object(L.isEqual)(i.sort(),null==o?void 0:o.sort()))return;const r=Symbol();n=r;const c=await Object(M.e)(i);r===n&&t.next(c)}a();const i={};return{dataViews:t,setLayerList(t){e.dispatch(Object(f.T)(t)),a()},updateLayerById:t=>{e.dispatch(Object(f.Eb)(t)),a(),(async()=>{const n=Symbol();i[t.id]=n,await e.dispatch(Object(R.h)(t.id,!1)),n===i[t.id]&&Object(O.w)(e.getState()).autoFitToDataBounds&&e.dispatch(Object(R.a)())})()}}}function _(e,t,n,a){if(!n||!Object(s.a)(n))return{};const i=n.getAppContext();return{getTypeDisplayName:()=>d.db,onEdit:async()=>{var n;const o=Object(v.o)().getStateTransfer();await o.navigateToEditor(d.e,{path:Object(d.Mb)(a),state:{embeddableId:e,valueInput:t(),originatingApp:i.currentAppId,originatingPath:null===(n=i.getCurrentPath)||void 0===n?void 0:n.call(i)}})},isEditingEnabled:()=>Object(v.A)().save,getEditHref:async()=>Object(v.t)().basePath.prepend(Object(d.Nb)(a))}}var z=n(4);function G(e){return`mapEmbeddablePanel${e}`}const D={type:d.fb,deserializeState:e=>{var t;return e.rawState?((e,t)=>{const n=e;if(!("attributes"in n)||void 0===n.attributes)return n;try{const{attributes:e}=Object(u.a)({attributes:n.attributes}),{attributes:a}=Object(u.b)({attributes:e,references:t});return{...n,attributes:a}}catch(e){return n}})(e.rawState,null!==(t=e.references)&&void 0!==t?t:[]):{}},buildEmbeddable:async(e,t,n,g)=>{var L,M,R;const D=new b.b({mapSerializedState:e});let q;await D.whenReady();const N=()=>q,k=D.getSharingSavedObjectProps(),U=Object(v.O)(),V=G(n),$=Object(s.k)(e),Y=Object(s.j)(e),J=null===(L=Object(v.n)())||void 0===L?void 0:L.initializeReactEmbeddableDynamicActions(n,(()=>$.titlesApi.panelTitle.getValue()),e),H=null==J?void 0:J.startDynamicActions(),K=new l.BehaviorSubject(D.getAttributes().title),Z=new l.BehaviorSubject(D.getAttributes().description),Q=function({savedMap:e,state:t,syncColors$:n,uuid:a}){var i,o,r,c;const s=e.getStore(),u=new l.BehaviorSubject(null!==(i=t.hiddenLayers)&&void 0!==i?i:h(s.getState())),b=new l.BehaviorSubject(null!==(o=t.isLayerTOCOpen)&&void 0!==o?o:Object(j.f)(s.getState())),g=new l.BehaviorSubject(null!==(r=t.mapCenter)&&void 0!==r?r:S(s.getState())),y=new l.BehaviorSubject(null!==(c=t.openTOCDetails)&&void 0!==c?c:Object(j.i)(s.getState())),A=new l.BehaviorSubject(void 0),T=s.subscribe((()=>{if(!Object(O.v)(s.getState()))return;const e=h(s.getState());p()(u.value,e)||u.next(e);const t=Object(j.f)(s.getState());b.value!==t&&b.next(t);const n=S(s.getState());p()(g.value,n)||g.next(n);const a=Object(j.i)(s.getState());p()(y.value,a)||y.next(a);const i=Object(O.P)(s.getState());i!==A.value&&A.next(i)}));s.dispatch(Object(f.nb)(!0)),s.dispatch(Object(f.jb)({keydownScrollZoom:!0,showTimesliderToggleButton:!1})),s.dispatch(Object(f.Z)(function(e,t){const n=Object(v.q)().get(),a={type:d.e,name:d.e,id:e,url:Object(d.Mb)(t)};return n?{...n,child:a}:a}(a,t.savedObjectId)));const w=new l.BehaviorSubject(void 0),E=new l.BehaviorSubject(void 0),L=e.getAttributes().mapStateJSON;if(L)try{const e=JSON.parse(L);e.filters&&w.next(e.filters),e.query&&E.next(e.query),s.dispatch(Object(f.Y)({filters:e.filters,query:e.query}))}catch(e){}let B,C;return n&&(B=n.subscribe((async e=>{const t=Symbol();C=t;const n=e?await async function(){const e=Object(v.d)(),t=e?await e.palettes.getPalettes():null;if(!t)return null;const n=t.get("default"),a={syncColors:!0};return e=>{const t=[{name:e,rankAtDepth:0,totalSeriesAtDepth:1}];return n.getCategoricalColor(t,a)||"#3d3d3d"}}():null;C===t&&s.dispatch(Object(m.h)(n))}))),{cleanup:()=>{B&&B.unsubscribe(),T()},api:{dataLoading:A,filters$:w,getInspectorAdapters:()=>Object(m.d)(s.getState()),getLayerList:()=>Object(O.n)(s.getState()),onRenderComplete$:A.pipe(Object(l.filter)((e=>"boolean"==typeof e&&!e)),Object(l.debounceTime)(d.vb),Object(l.map)((()=>{}))),query$:E,reload:()=>{s.dispatch(Object(f.mb)({forceRefresh:!0}))},setEventHandlers:e=>{s.dispatch(Object(m.i)(e))}},comparators:{hiddenLayers:[u,e=>{s.dispatch(Object(f.cb)(e))},p.a],isLayerTOCOpen:[b,e=>{s.dispatch(Object(f.db)(e))}],mapCenter:[g,e=>{s.dispatch(Object(f.bb)(e))},p.a],openTOCDetails:[y,e=>{s.dispatch(Object(f.lb)(e))},p.a]},serialize:()=>({hiddenLayers:h(s.getState()),isLayerTOCOpen:Object(j.f)(s.getState()),mapBuffer:Object(O.q)(s.getState()),mapCenter:S(s.getState()),openTOCDetails:Object(j.i)(s.getState())})}}({savedMap:D,state:e,syncColors$:(W=g,Boolean(W&&"object"==typeof(null==W?void 0:W.settings))?g.settings.syncColors$:void 0),uuid:n});var W;const X=function(e){function t(){const t=Object(v.S)().getTrigger(r.APPLY_FILTER_TRIGGER);if(!t)throw new Error("Unable to get context, could not locate trigger");return{embeddable:e(),trigger:t}}return{addFilters:async(e,n=A.ACTION_GLOBAL_APPLY_FILTER)=>{const a={...t(),filters:e},i=Object(v.S)().getAction(n);if(!i)throw new Error("Unable to apply filter, could not locate action");i.execute(a)},getActionContext:t,getFilterActions:async()=>[...await Object(v.S)().getTriggerCompatibleActions(r.APPLY_FILTER_TRIGGER,{embeddable:e(),filters:[]}),...(await Object(v.S)().getTriggerCompatibleActions(c.VALUE_CLICK_TRIGGER,{embeddable:e(),data:{data:Object(T.b)("anyfield","anyvalue")}})).filter(T.a)],onSingleValueTrigger:(e,n,a)=>{const i=Object(v.S)().getAction(e);if(!i)throw new Error("Unable to apply action, could not locate action");const o={...t(),data:{data:Object(T.b)(n,a)}};i.execute(o)}}}(N),ee=function({controlledBy:e,getActionContext:t,getApi:n,savedMap:a,state:i,uuid:o}){const r=new l.BehaviorSubject(i.isMovementSynchronized);function c(){var e;return null===(e=r.value)||void 0===e||e}function d(e){r.next(e)}const u=new l.BehaviorSubject(i.filterByMapExtent);function b(){var e;return null!==(e=u.value)&&void 0!==e&&e}function g(e){u.next(e)}let p;function j(e,t,n){Object(O.w)(a.getStore().getState()).autoFitToDataBounds&&a.getStore().dispatch(Object(f.jb)({autoFitToDataBounds:!1})),a.getStore().dispatch(Object(f.bb)({lat:e,lon:t,zoom:n}))}function S(){const e=I.a.getLocation();if(e)return void j(e.lat,e.lon,e.zoom);if(!Object(O.v)(a.getStore().getState())){const e=Object(O.j)(a.getStore().getState());if(e&&e.center)return void I.a.setLocation(o,e.center.lat,e.center.lon,e.center.zoom)}const t=Object(O.r)(a.getStore().getState()),n=Object(O.x)(a.getStore().getState());I.a.setLocation(o,t.lat,t.lon,n)}const h=B.a.debounce((()=>{const n=Object(O.t)(a.getStore().getState()),i=I.a.getGeoFieldNames();if(void 0===n||0===i.length)return;p=n;const o=Object(x.h)(n,i);o.meta.controlledBy=e,o.meta.alias=C.i18n.translate("xpack.maps.embeddable.boundsFilterLabel",{defaultMessage:"{geoFieldsLabel} within map bounds",values:{geoFieldsLabel:F(i)}});const r={...t(),filters:[o],controlledBy:e},c=Object(v.S)().getAction(A.ACTION_GLOBAL_APPLY_FILTER);if(!c)throw new Error("Unable to apply map extent filter, could not locate action");c.execute(r)}),100);I.a.register(o,{getTitle:()=>{const e=n();return(e?Object(s.h)(e):void 0)||C.i18n.translate("xpack.maps.embeddable.untitleMap",{defaultMessage:"Untitled map"})},onLocationChange:j,getIsMovementSynchronized:c,setIsMovementSynchronized:e=>{d(e),e?S():!e&&a.getAutoFitToBounds()&&a.getStore().dispatch(Object(f.jb)({autoFitToDataBounds:!0}))},getIsFilterByMapExtent:b,setIsFilterByMapExtent:n=>{g(n),n?h():function(){p=void 0;const n={...t(),filters:[],controlledBy:e},a=Object(v.S)().getAction(A.ACTION_GLOBAL_APPLY_FILTER);if(!a)throw new Error("Unable to apply map extent filter, could not locate action");a.execute(n)}()},getGeoFieldNames:()=>Object(O.i)(a.getStore().getState())}),c()&&S(),a.getStore().dispatch(Object(m.j)(((e,t,n)=>{c()&&I.a.setLocation(o,e,t,n)})));const y=a.getStore().subscribe((()=>{Object(O.v)(a.getStore().getState())&&b()&&!B.a.isEqual(p,Object(O.t)(a.getStore().getState()))&&h()}));return{cleanup:()=>{I.a.unregister(o),y()},comparators:{isMovementSynchronized:[r,d],filterByMapExtent:[u,g]},getIsFilterByMapExtent:b,serialize:()=>({isMovementSynchronized:r.value,filterByMapExtent:u.value})}}({controlledBy:V,getActionContext:X.getActionContext,getApi:N,state:e,savedMap:D,uuid:n});function te(){var t;return{...e,...Y.serialize(),...$.serializeTitles(),...null!==(t=null==J?void 0:J.serializeDynamicActions())&&void 0!==t?t:{},...ee.serialize(),...Q.serialize()}}function ne(){const e=te();if(e.savedObjectId)return{rawState:Object(y.a)(e,e.savedObjectId),references:[]};const{attributes:t,references:n}=Object(u.a)({attributes:D.getAttributes()});return{rawState:Object(y.b)(e,t),references:n}}q=t({defaultPanelTitle:K,defaultPanelDescription:Z,...Y.api,...null!==(M=null==J?void 0:J.dynamicActionsApi)&&void 0!==M?M:{},...$.titlesApi,...Q.api,..._(n,te,g,e.savedObjectId),...Object(y.c)(D,ne),...P(D.getStore()),serializeState:ne,supportedTriggers:()=>[r.APPLY_FILTER_TRIGGER,c.VALUE_CLICK_TRIGGER]},{...Y.comparators,...$.titleComparators,...null!==(R=null==J?void 0:J.dynamicActionsComparator)&&void 0!==R?R:{enhancements:Object(s.i)()},...ee.comparators,...Q.comparators,attributes:Object(s.i)(),mapBuffer:Object(s.i)(),savedObjectId:Object(s.i)(),mapSettings:Object(s.i)(),hideFilterActions:Object(s.i)(),isSharable:Object(s.i)(),tooltipRenderer:Object(s.i)()});const ae=function({api:e,controlledBy:t,getIsFilterByMapExtent:n,searchSessionMapBuffer:a,store:i}){let o;const r=Object(s.g)(e).subscribe((e=>{const r=n()?void 0:e.searchSessionId,c=function(e){if(!e)return!1;const t=Object(v.J)().session.getSearchOptions(e);return!!t&&t.isRestore}(r);c!==o&&(o=c,i.dispatch(Object(f.jb)({disableInteractive:c,hideToolbarOverlay:c}))),i.dispatch(Object(f.mb)({filters:e.filters?e.filters.filter((e=>!e.meta.disabled&&e.meta.controlledBy!==t)):[],query:e.query,timeFilters:e.timeRange,timeslice:e.timeslice?{from:e.timeslice[0],to:e.timeslice[1]}:void 0,clearTimeslice:void 0===e.timeslice,forceRefresh:e.isReload,searchSessionId:r,searchSessionMapBuffer:c?a:void 0}))}));return()=>{r.unsubscribe()}}({api:q,controlledBy:V,getIsFilterByMapExtent:ee.getIsFilterByMapExtent,searchSessionMapBuffer:e.mapBuffer,store:D.getStore()});return{api:q,Component:()=>{var t;const[n,r,c,l]=Object(s.l)(K,$.titlesApi.panelTitle,Z,$.titlesApi.panelDescription);return Object(a.useEffect)((()=>()=>{ee.cleanup(),Q.cleanup(),ae(),null==H||H.stopDynamicActions()}),[]),k&&U&&"conflict"===(null==k?void 0:k.outcome)?Object(z.jsx)("div",{className:"mapEmbeddedError"},Object(z.jsx)(o.EuiEmptyPrompt,{iconType:"warning",iconColor:"danger","data-test-subj":"embeddable-maps-failure",body:U.ui.components.getEmbeddableLegacyUrlConflict({targetType:d.fb,sourceId:k.sourceId})})):Object(z.jsx)(i.Provider,{store:D.getStore()},Object(z.jsx)(w.a,{onSingleValueTrigger:X.onSingleValueTrigger,addFilters:e.hideFilterActions||Object(s.f)(q)?null:X.addFilters,getFilterActions:X.getFilterActions,getActionContext:X.getActionContext,renderTooltipContent:e.tooltipRenderer,title:null!=r?r:n,description:null!=l?l:c,waitUntilTimeLayersLoad$:Object(E.a)(D.getStore()),isSharable:null===(t=e.isSharable)||void 0===t||t}))}}}}}}]);