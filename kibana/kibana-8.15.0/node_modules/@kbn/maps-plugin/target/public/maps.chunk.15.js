/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.maps_bundle_jsonpfunction=window.maps_bundle_jsonpfunction||[]).push([[15],{142:function(e,t,s){"use strict";s.d(t,"b",(function(){return z})),s.d(t,"a",(function(){return es_pew_pew_source_ESPewPewSource}));var i=s(6),a=s.n(i),r=s(2),o=s(166),n=s.n(o),c=s(101),l=s(58),d=s(1),u=s(3),h=s(14),p=s(54),g=s(28),_=s(174),b=s(5),m=s(4);class update_source_editor_UpdateSourceEditor extends r.Component{constructor(...e){super(...e),a()(this,"_isMounted",!1),a()(this,"state",{fields:[]}),a()(this,"_onMetricsChange",(e=>{this.props.onChange({propName:"metrics",value:e})}))}componentDidMount(){this._isMounted=!0,this._loadFields()}componentWillUnmount(){this._isMounted=!1}async _loadFields(){let e;try{e=await Object(b.w)().get(this.props.indexPatternId)}catch(e){return}this._isMounted&&this.setState({fields:e.fields.filter((e=>!g.indexPatterns.isNestedField(e)))})}render(){return Object(m.jsx)(r.Fragment,null,Object(m.jsx)(h.EuiPanel,null,Object(m.jsx)(h.EuiTitle,{size:"xs"},Object(m.jsx)("h6",null,Object(m.jsx)(p.FormattedMessage,{id:"xpack.maps.source.pewPew.metricsLabel",defaultMessage:"Metrics"}))),Object(m.jsx)(h.EuiSpacer,{size:"m"}),Object(m.jsx)(_.a,{allowMultipleMetrics:!0,bucketsName:this.props.bucketsName,isJoin:!1,fields:this.state.fields,metrics:this.props.metrics,onChange:this._onMetricsChange})),Object(m.jsx)(h.EuiSpacer,{size:"s"}))}}var j=s(0),x=s(92),w=s(53),O=s.n(w),F=s(93);const I=["key","sourceCentroid"];function P(e){const t=e.split(","),s=parseFloat(t[0]);return[parseFloat(t[1]),s]}var f=s(122),y=s(112),S=s(126),M=s(117),G=s(106);const z=u.i18n.translate("xpack.maps.source.pewPewTitle",{defaultMessage:"Point to point"});class es_pew_pew_source_ESPewPewSource extends f.a{static createDescriptor(e){const t=f.a.createDescriptor(e);if(!Object(M.a)(e.sourceGeoField))throw new Error("Cannot create ESPewPewSourceDescriptor, sourceGeoField is not provided");if(!Object(M.a)(e.destGeoField))throw new Error("Cannot create ESPewPewSourceDescriptor, destGeoField is not provided");return{...t,type:j.Cb.ES_PEW_PEW,sourceGeoField:e.sourceGeoField,destGeoField:e.destGeoField}}constructor(e){super(e),a()(this,"_descriptor",void 0),this._descriptor=e}getBucketsName(){return u.i18n.translate("xpack.maps.source.pewPew.bucketsName",{defaultMessage:"paths"})}renderSourceSettingsEditor({onChange:e}){return Object(m.jsx)(update_source_editor_UpdateSourceEditor,{bucketsName:this.getBucketsName(),indexPatternId:this.getIndexPatternId(),onChange:e,metrics:this._descriptor.metrics})}isFilterByMapBounds(){return!0}supportsJoins(){return!1}getSyncMeta(e){return{...super.getSyncMeta(e),geogridPrecision:this.getGeoGridPrecision(e.zoom)}}isGeoGridPrecisionAware(){return!0}async getSupportedShapeTypes(){return[j.Hb.LINE]}async getImmutableProperties(){return[{label:Object(x.a)(),value:z},{label:Object(x.b)(),value:await this.getDisplayName()},{label:u.i18n.translate("xpack.maps.source.pewPew.sourceGeoFieldLabel",{defaultMessage:"Source"}),value:this._descriptor.sourceGeoField},{label:u.i18n.translate("xpack.maps.source.pewPew.destGeoFieldLabel",{defaultMessage:"Destination"}),value:this._descriptor.destGeoField}]}getGeoGridPrecision(e){const t=Math.ceil(e)+2;return Math.min(t,29)}async getGeoJsonWithMeta(e,t,s,i,a){const r=await this.getIndexPattern(),o=await this.makeSearchSource(t,0);o.setField("trackTotalHits",!1),o.setField("aggs",{destSplit:{terms:{script:{source:`doc['${this._descriptor.destGeoField}'].value.toString()`,lang:"painless"},order:{_count:"desc"},size:100},aggs:{sourceGrid:{geotile_grid:{field:this._descriptor.sourceGeoField,precision:this.getGeoGridPrecision(t.zoom),size:500},aggs:{sourceCentroid:{geo_centroid:{field:this._descriptor.sourceGeoField}},...this.getValueAggsDsl(r)}}}}}),o.setField("filter",[...o.getField("filter"),Object(l.buildExistsFilter)({name:this._descriptor.sourceGeoField,type:"geo_point"},r)]);const n=[],c=await this._runEsQuery({requestId:this.getId(),requestName:Object(G.b)(e),searchSource:o,registerCancelCallback:s,searchSessionId:t.searchSessionId,executionContext:Object(S.b)({description:"es_pew_pew_source:connections"},t.executionContext),requestsAdapter:a.requests,onWarning:e=>{n.push(e)}}),{featureCollection:d}=function(e){const t=[],s=O.a.get(e,"aggregations.destSplit.buckets",[]);for(let e=0;e<s.length;e++){const i=s[e],a=P(i.key),r=O.a.get(i,"sourceGrid.buckets",[]);for(let e=0;e<r.length;e++){const s=r[e],i=s.sourceCentroid;t.push({type:"Feature",geometry:{type:"LineString",coordinates:[[i.location.lon,i.location.lat],a]},id:`${a.join()},${s.key}`,properties:Object(F.j)(s,I)})}}return{featureCollection:{type:"FeatureCollection",features:t}}}(c);return{data:d,meta:{areResultsTrimmed:!1,warnings:n}}}getGeoFieldName(){return this._descriptor.destGeoField}async getBoundsForFilters(e,t){const s=await this.makeSearchSource(e,0);s.setField("trackTotalHits",!1),s.setField("aggs",{destFitToBounds:{geo_bounds:{field:this._descriptor.destGeoField}},sourceFitToBounds:{geo_bounds:{field:this._descriptor.sourceGeoField}}});const i=[];try{var a,r;const o=new AbortController;t((()=>o.abort()));const{rawResponse:n}=await Object(d.lastValueFrom)(s.fetch$({abortSignal:o.signal,legacyHitsTotal:!1,executionContext:Object(S.b)({description:"es_pew_pew_source:bounds"},e.executionContext)})),c=(null===(a=n.aggregations)||void 0===a?void 0:a.destFitToBounds).bounds;c&&(i.push([c.top_left.lon,c.top_left.lat]),i.push([c.bottom_right.lon,c.bottom_right.lat]));const l=(null===(r=n.aggregations)||void 0===r?void 0:r.sourceFitToBounds).bounds;l&&(i.push([l.top_left.lon,l.top_left.lat]),i.push([l.bottom_right.lon,l.bottom_right.lat]))}catch(e){if("AbortError"===e.name)throw new y.b;return null}return 0===i.length?null:Object(F.r)(n()(Object(c.multiPoint)(i)))}hasTooltipProperties(){return!0}}},161:function(e,t,s){"use strict";s.d(t,"a",(function(){return F}));var i=s(2),a=s(3),r=s(98),o=s(91),n=s(142),c=s(100),l=s(0),d=s(99),u=s(6),h=s.n(u),p=s(53),g=s.n(p),_=s(108),b=s(5),m=s(54),j=s(14),x=s(97),w=s(92),O=s(4);class create_source_editor_CreateSourceEditor extends i.Component{constructor(...e){super(...e),h()(this,"state",{isLoadingIndexPattern:!1,indexPattern:void 0,indexPatternId:void 0,sourceGeoField:void 0,destGeoField:void 0,indexPatternHasMultipleGeoFields:!1}),h()(this,"onIndexPatternSelect",(e=>{this.setState({indexPatternId:e},this.loadIndexPattern.bind(null,e))})),h()(this,"loadIndexPattern",(e=>{this.setState({isLoadingIndexPattern:!0,indexPattern:void 0,sourceGeoField:void 0,destGeoField:void 0,indexPatternHasMultipleGeoFields:!1},this.debouncedLoad.bind(null,e))})),h()(this,"debouncedLoad",g.a.debounce((async e=>{if(!e||0===e.length)return;let t;try{t=await Object(b.w)().get(e)}catch(e){return}if(!this._isMounted)return;if(this.state.indexPatternId!==e)return;const s=Object(x.a)(t.fields);this.setState({isLoadingIndexPattern:!1,indexPattern:t,indexPatternHasMultipleGeoFields:s.length>=2})}),300)),h()(this,"_onSourceGeoSelect",(e=>{this.setState({sourceGeoField:e},this.previewLayer)})),h()(this,"_onDestGeoSelect",(e=>{this.setState({destGeoField:e},this.previewLayer)})),h()(this,"previewLayer",(()=>{const{indexPatternId:e,sourceGeoField:t,destGeoField:s}=this.state,i=e&&t&&s?{indexPatternId:e,sourceGeoField:t,destGeoField:s}:null;this.props.onSourceConfigChange(i)}))}componentWillUnmount(){this._isMounted=!1}componentDidMount(){this._isMounted=!0}_renderGeoSelects(){if(!this.state.indexPattern||!this.state.indexPatternHasMultipleGeoFields)return null;const e=this.state.indexPattern?Object(x.a)(this.state.indexPattern.fields):void 0;return Object(O.jsx)(i.Fragment,null,Object(O.jsx)(j.EuiFormRow,{label:a.i18n.translate("xpack.maps.source.pewPew.sourceGeoFieldLabel",{defaultMessage:"Source"})},Object(O.jsx)(_.a,{placeholder:a.i18n.translate("xpack.maps.source.pewPew.sourceGeoFieldPlaceholder",{defaultMessage:"Select source geo field"}),value:this.state.sourceGeoField,onChange:this._onSourceGeoSelect,fields:e})),Object(O.jsx)(j.EuiFormRow,{label:a.i18n.translate("xpack.maps.source.pewPew.destGeoFieldLabel",{defaultMessage:"Destination"})},Object(O.jsx)(_.a,{placeholder:a.i18n.translate("xpack.maps.source.pewPew.destGeoFieldPlaceholder",{defaultMessage:"Select destination geo field"}),value:this.state.destGeoField,onChange:this._onDestGeoSelect,fields:e})))}_renderIndexPatternSelect(){const e=Object(b.v)();return Object(O.jsx)(j.EuiFormRow,{label:Object(w.b)()},Object(O.jsx)(e,{indexPatternId:this.state.indexPatternId,onChange:this.onIndexPatternSelect,placeholder:Object(w.d)(),fieldTypes:[l.A.GEO_POINT]}))}render(){let e;return this.state.indexPattern&&!this.state.indexPatternHasMultipleGeoFields&&(e=Object(O.jsx)(j.EuiCallOut,{color:"warning"},Object(O.jsx)("p",null,Object(O.jsx)(m.FormattedMessage,{id:"xpack.maps.source.pewPew.noSourceAndDestDetails",defaultMessage:"Selected data view does not contain source and destination fields."})))),Object(O.jsx)(j.EuiPanel,null,e,this._renderIndexPatternSelect(),this._renderGeoSelects())}}const F={id:l.Jb.POINT_2_POINT,order:10,categories:[l.ab.ELASTICSEARCH],description:a.i18n.translate("xpack.maps.source.pewPewDescription",{defaultMessage:"Aggregated data paths between the source and destination"}),icon:()=>Object(O.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"49",height:"25",fill:"none",viewBox:"0 0 49 25",className:"mapLayersWizardIcon"},Object(O.jsx)("circle",{cx:"38.311",cy:"12.889",r:"1.636",className:"mapLayersWizardIcon__highlight"}),Object(O.jsx)("circle",{cx:"10.85",cy:"15.12",r:"1.636",className:"mapLayersWizardIcon__highlight",transform:"rotate(-27.34 10.85 15.12)"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M10.746 14.918l12.499-3.892.162.521-12.499 3.892z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M10.746 14.918l12.499-3.892.162.521-12.499 3.892z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M10.746 14.918l12.499-3.892.162.521-12.499 3.892z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M10.746 14.918l12.499-3.892.162.521-12.499 3.892z"}),Object(O.jsx)("circle",{cx:"6.805",cy:"4.603",r:"1.636",className:"mapLayersWizardIcon__highlight",transform:"rotate(-23.178 6.805 4.603)"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M6.27 4.194l17.235 5.888-.176.516L6.094 4.71z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M6.27 4.194l17.235 5.888-.176.516L6.094 4.71z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M6.27 4.194l17.235 5.888-.176.516L6.094 4.71z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M6.27 4.194l17.235 5.888-.176.516L6.094 4.71z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M22.8 9.673l16.113 2.854-.095.538-16.113-2.855z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M22.8 9.673l16.113 2.854-.095.538-16.113-2.855z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M22.8 9.673l16.113 2.854-.095.538-16.113-2.855z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M22.8 9.673l16.113 2.854-.095.538-16.113-2.855z"}),Object(O.jsx)("circle",{cx:"19.542",cy:"22.262",r:"1.636",className:"mapLayersWizardIcon__highlight",transform:"rotate(8.84 19.542 22.262)"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M19.28 22.43l4.937-12.124.505.206-4.937 12.124z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M19.28 22.43l4.937-12.124.505.206-4.937 12.124z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M19.28 22.43l4.937-12.124.505.206-4.937 12.124z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M19.28 22.43l4.937-12.124.505.206-4.937 12.124z"}),Object(O.jsx)("circle",{cx:"42.691",cy:"3.795",r:"1.636",className:"mapLayersWizardIcon__highlight",transform:"rotate(-6.89 42.691 3.795)"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M42.715 3.993l-18.251 7.243-.202-.507 18.252-7.243z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M42.715 3.993l-18.251 7.243-.202-.507 18.252-7.243z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M42.715 3.993l-18.251 7.243-.202-.507 18.252-7.243z"}),Object(O.jsx)("path",{className:"mapLayersWizardIcon__highlight",d:"M42.715 3.993l-18.251 7.243-.202-.507 18.252-7.243z"}),Object(O.jsx)("circle",{cx:"24.578",cy:"11.109",r:"2.727",className:"mapLayersWizardIcon__highlight"})),renderWizard:({previewLayers:e})=>Object(O.jsx)(create_source_editor_CreateSourceEditor,{onSourceConfigChange:t=>{if(!t)return void e([]);const s=Object(r.i)(),i=o.b.createDescriptor({sourceDescriptor:n.a.createDescriptor(t),style:c.a.createDescriptor({[l.Ib.LINE_COLOR]:{type:l.Eb.DYNAMIC,options:{...s[l.Ib.LINE_COLOR].options,field:{name:l.k,origin:l.D.SOURCE},color:d.e[0].value}},[l.Ib.LINE_WIDTH]:{type:l.Eb.DYNAMIC,options:{...s[l.Ib.LINE_WIDTH].options,field:{name:l.k,origin:l.D.SOURCE}}}})});e([i])}}),title:n.b}},245:function(e,t,s){"use strict";var i=s(142);s.d(t,"a",(function(){return i.a})),s(161)}}]);